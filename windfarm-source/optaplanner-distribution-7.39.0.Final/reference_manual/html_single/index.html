<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="The OptaPlanner Team">
<title>OptaPlanner User Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<!-- Adobe Analytics for Red Hat - DPAL (DTM Property Auto-Loader) - part 1/2 -->
<script id="dpal" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
<!-- Google Analytics for kie team: Global site tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-39485370-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-39485370-1');
</script>

<!-- Collapsed Table of Content -->
<link rel="stylesheet" href="website/jstree/style.css" />
<link rel="stylesheet" href="website/toc.css" />
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>OptaPlanner User Guide</h1>
<div class="details">
<span id="author" class="author">The OptaPlanner Team</span><br>
<span id="email" class="email"><a href="https://www.optaplanner.org/community/team.html" class="bare">https://www.optaplanner.org/community/team.html</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#plannerIntroduction">1. OptaPlanner Introduction</a>
<ul class="sectlevel2">
<li><a href="#whatIsOptaPlanner">1.1. What is OptaPlanner?</a></li>
<li><a href="#whatIsAPlanningProblem">1.2. What is a planning problem?</a>
<ul class="sectlevel3">
<li><a href="#aPlanningProblemIsNPCompleteOrNPHard">1.2.1. A planning problem is NP-complete or NP-hard</a></li>
<li><a href="#aPlanningProblemHasConstraints">1.2.2. A planning problem has (hard and soft) constraints</a></li>
<li><a href="#aPlanningProblemHasAHugeSearchSpace">1.2.3. A planning problem has a huge search space</a></li>
</ul>
</li>
<li><a href="#requirements">1.3. Requirements</a></li>
<li><a href="#governance">1.4. Governance</a>
<ul class="sectlevel3">
<li><a href="#statusOfOptaPlanner">1.4.1. Status of OptaPlanner</a></li>
<li><a href="#releaseNotes">1.4.2. Release notes</a></li>
<li><a href="#backwardsCompatibility">1.4.3. Backwards compatibility</a></li>
<li><a href="#communityAndSupport">1.4.4. Community and support</a></li>
<li><a href="#relationshipWithKie">1.4.5. Relationship with Drools and jBPM</a></li>
</ul>
</li>
<li><a href="#downloadAndRunTheExamples">1.5. Download and run the examples</a>
<ul class="sectlevel3">
<li><a href="#getTheReleaseZipAndRunTheExamples">1.5.1. Get the release ZIP and run the examples</a></li>
<li><a href="#runTheExamplesInAnIDE">1.5.2. Run the examples in an IDE (IntelliJ, Eclipse, NetBeans)</a></li>
<li><a href="#useWithMavenGradleEtc">1.5.3. Use OptaPlanner with Maven, Gradle, Ivy, Buildr, or ANT</a></li>
<li><a href="#buildFromSource">1.5.4. Build OptaPlanner from source</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#quickStart">2. Quick start</a>
<ul class="sectlevel2">
<li><a href="#quickStartOverview">2.1. Overview</a></li>
<li><a href="#quarkusJavaQuickStart">2.2. Quarkus Java quick start</a></li>
<li><a href="#springBootJavaQuickStart">2.3. Spring Boot Java quick start</a>
<ul class="sectlevel3">
<li><a href="#_what_you_will_build">2.3.1. What you will build</a></li>
<li><a href="#_what_youll_need">2.3.2. What you&#8217;ll need</a></li>
<li><a href="#_the_build_file_and_the_dependencies">2.3.3. The build file and the dependencies</a></li>
<li><a href="#initial">2.3.4. Model the domain objects</a></li>
<li><a href="#_define_the_constraints_and_calculate_the_score">2.3.5. Define the constraints and calculate the score</a></li>
<li><a href="#_gather_the_domain_objects_in_a_planning_solution">2.3.6. Gather the domain objects in a planning solution</a></li>
<li><a href="#_create_the_solver_service">2.3.7. Create the solver service</a></li>
<li><a href="#_set_the_termination_time">2.3.8. Set the termination time</a></li>
<li><a href="#_make_the_application_executable">2.3.9. Make the application executable</a></li>
<li><a href="#_summary">2.3.10. Summary</a></li>
<li><a href="#_further_improvements_database_and_ui_integration">2.3.11. Further improvements: Database and UI integration</a></li>
</ul>
</li>
<li><a href="#plainJavaQuickStart">2.4. Java quick start</a>
<ul class="sectlevel3">
<li><a href="#cloudBalancingTutorial">2.4.1. Cloud balancing tutorial</a></li>
<li><a href="#cloudBalancingDomainModel">2.4.2. Using the domain model</a></li>
<li><a href="#cloudBalancingMainMethod">2.4.3. Run the cloud balancing Hello World</a></li>
<li><a href="#cloudBalancingSolverConfiguration">2.4.4. Solver configuration</a></li>
<li><a href="#cloudBalancingScoreConfiguration">2.4.5. Score configuration</a></li>
<li><a href="#cloudBalancingBeyondThisTutorial">2.4.6. Beyond this tutorial</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#useCasesAndExamples">3. Use cases and examples</a>
<ul class="sectlevel2">
<li><a href="#examplesOverview">3.1. Examples overview</a></li>
<li><a href="#nQueens">3.2. N queens</a>
<ul class="sectlevel3">
<li><a href="#nQueensProblemDescription">3.2.1. Problem description</a></li>
<li><a href="#nQueensProblemSize">3.2.2. Problem size</a></li>
<li><a href="#nQueensDomainModel">3.2.3. Domain model</a></li>
</ul>
</li>
<li><a href="#cloudBalancing">3.3. Cloud balancing</a></li>
<li><a href="#tsp">3.4. Traveling salesman (TSP - traveling salesman problem)</a>
<ul class="sectlevel3">
<li><a href="#tspProblemDescription">3.4.1. Problem description</a></li>
<li><a href="#tspProblemSize">3.4.2. Problem size</a></li>
<li><a href="#tspProblemDifficulty">3.4.3. Problem difficulty</a></li>
</ul>
</li>
<li><a href="#dinnerParty">3.5. Dinner party</a>
<ul class="sectlevel3">
<li><a href="#dinnerPartyProblemDescription">3.5.1. Problem description</a></li>
<li><a href="#dinnerPartyProblemSize">3.5.2. Problem size</a></li>
</ul>
</li>
<li><a href="#tennis">3.6. Tennis club scheduling</a>
<ul class="sectlevel3">
<li><a href="#tennisProblemDescription">3.6.1. Problem description</a></li>
<li><a href="#tennisProblemSize">3.6.2. Problem size</a></li>
<li><a href="#tennisDomainModel">3.6.3. Domain model</a></li>
</ul>
</li>
<li><a href="#meetingScheduling">3.7. Meeting scheduling</a>
<ul class="sectlevel3">
<li><a href="#meetingSchedulingProblemDescription">3.7.1. Problem description</a></li>
<li><a href="#meetingSchedulingProblemSize">3.7.2. Problem size</a></li>
</ul>
</li>
<li><a href="#curriculumCourse">3.8. Course timetabling (ITC 2007 Track 3 - Curriculum Course Scheduling)</a>
<ul class="sectlevel3">
<li><a href="#curriculumCourseProblemDescription">3.8.1. Problem description</a></li>
<li><a href="#curriculumCourseProblemSize">3.8.2. Problem size</a></li>
<li><a href="#curriculumCourseDomainModel">3.8.3. Domain model</a></li>
</ul>
</li>
<li><a href="#machineReassignment">3.9. Machine reassignment (Google ROADEF 2012)</a>
<ul class="sectlevel3">
<li><a href="#machineReassignmentProblemDescription">3.9.1. Problem description</a></li>
<li><a href="#machineReassignmentValueProposition">3.9.2. Value proposition</a></li>
<li><a href="#machineReassignmentProblemSize">3.9.3. Problem size</a></li>
<li><a href="#machineReassignmentDomainModel">3.9.4. Domain model</a></li>
</ul>
</li>
<li><a href="#vehicleRouting">3.10. Vehicle routing</a>
<ul class="sectlevel3">
<li><a href="#vehicleRoutingProblemDescription">3.10.1. Problem description</a></li>
<li><a href="#vehicleRoutingValueProposition">3.10.2. Value proposition</a></li>
<li><a href="#vehicleRoutingProblemSize">3.10.3. Problem size</a></li>
<li><a href="#vehicleRoutingDomainModel">3.10.4. Domain model</a></li>
</ul>
</li>
<li><a href="#projectJobScheduling">3.11. Project job scheduling</a>
<ul class="sectlevel3">
<li><a href="#projectJobSchedulingProblemDescription">3.11.1. Problem description</a></li>
<li><a href="#projectJobSchedulingProblemSize">3.11.2. Problem size</a></li>
</ul>
</li>
<li><a href="#bedAllocation">3.12. Hospital bed planning (PAS - Patient Admission Scheduling)</a>
<ul class="sectlevel3">
<li><a href="#bedAllocationProblemDescription">3.12.1. Problem description</a></li>
<li><a href="#bedAllocationProblemSize">3.12.2. Problem size</a></li>
<li><a href="#bedAllocationDomainModel">3.12.3. Domain model</a></li>
</ul>
</li>
<li><a href="#taskAssigning">3.13. Task assigning</a>
<ul class="sectlevel3">
<li><a href="#taskAssigningProblemDescription">3.13.1. Problem description</a></li>
<li><a href="#taskAssigningValueProposition">3.13.2. Value proposition</a></li>
<li><a href="#taskAssigningProblemSize">3.13.3. Problem size</a></li>
<li><a href="#taskAssigningDomainModel">3.13.4. Domain model</a></li>
</ul>
</li>
<li><a href="#examination">3.14. Exam timetabling (ITC 2007 track 1 - Examination)</a>
<ul class="sectlevel3">
<li><a href="#examinationProblemDescription">3.14.1. Problem description</a></li>
<li><a href="#examinationProblemSize">3.14.2. Problem size</a></li>
<li><a href="#examinationDomainModel">3.14.3. Domain model</a></li>
</ul>
</li>
<li><a href="#nurseRostering">3.15. Nurse rostering (INRC 2010)</a>
<ul class="sectlevel3">
<li><a href="#nurseRosteringProblemDescription">3.15.1. Problem description</a></li>
<li><a href="#nurseRosteringValueProposition">3.15.2. Value proposition</a></li>
<li><a href="#nurseRosteringProblemSize">3.15.3. Problem size</a></li>
<li><a href="#nurseRosteringDomainModel">3.15.4. Domain model</a></li>
</ul>
</li>
<li><a href="#travelingTournament">3.16. Traveling tournament problem (TTP)</a>
<ul class="sectlevel3">
<li><a href="#travelingTournamentProblemDescription">3.16.1. Problem description</a></li>
<li><a href="#travelingTournamentProblemSize">3.16.2. Problem size</a></li>
</ul>
</li>
<li><a href="#cheapTimeScheduling">3.17. Cheap time scheduling</a>
<ul class="sectlevel3">
<li><a href="#cheapTimeSchedulingProblemDescription">3.17.1. Problem description</a></li>
<li><a href="#cheapTimeSchedulingProblemSize">3.17.2. Problem size</a></li>
</ul>
</li>
<li><a href="#investment">3.18. Investment asset class allocation (portfolio optimization)</a>
<ul class="sectlevel3">
<li><a href="#investmentProblemDescription">3.18.1. Problem description</a></li>
<li><a href="#investmentProblemSize">3.18.2. Problem size</a></li>
</ul>
</li>
<li><a href="#conferenceScheduling">3.19. Conference scheduling</a>
<ul class="sectlevel3">
<li><a href="#conferenceSchedulingProblemDescription">3.19.1. Problem description</a></li>
<li><a href="#conferenceSchedulingValueProposition">3.19.2. Value proposition</a></li>
<li><a href="#conferenceSchedulingProblemSize">3.19.3. Problem size</a></li>
<li><a href="#conferenceSchedulingArchitecture">3.19.4. Architecture</a></li>
<li><a href="#conferenceSchedulingDomainModel">3.19.5. Domain model</a></li>
<li><a href="#conferenceSchedulingSearchSpace">3.19.6. Search space</a></li>
</ul>
</li>
<li><a href="#rockTour">3.20. Rock tour</a>
<ul class="sectlevel3">
<li><a href="#rockTourProblemDescription">3.20.1. Problem description</a></li>
<li><a href="#rockTourProblemSize">3.20.2. Problem size</a></li>
</ul>
</li>
<li><a href="#flightCrewScheduling">3.21. Flight crew scheduling</a>
<ul class="sectlevel3">
<li><a href="#flightCrewSchedulingProblemDescription">3.21.1. Problem description</a></li>
<li><a href="#flightCrewSchedulingProblemSize">3.21.2. Problem size</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#plannerConfiguration">4. OptaPlanner configuration</a>
<ul class="sectlevel2">
<li><a href="#plannerConfigurationOverview">4.1. Overview</a></li>
<li><a href="#solverConfiguration">4.2. Solver configuration</a>
<ul class="sectlevel3">
<li><a href="#solverConfigurationByXML">4.2.1. Solver configuration by XML</a></li>
<li><a href="#solverConfigurationByJavaAPI">4.2.2. Solver configuration by Java API</a></li>
<li><a href="#annotationAlternatives">4.2.3. Annotation alternatives</a></li>
<li><a href="#customPropertiesConfiguration">4.2.4. Custom properties configuration</a></li>
</ul>
</li>
<li><a href="#modelAPlanningProblem">4.3. Model a planning problem</a>
<ul class="sectlevel3">
<li><a href="#isThisClassAProblemFactOrPlanningEntity">4.3.1. Is this class a problem fact or planning entity?</a></li>
<li><a href="#problemFact">4.3.2. Problem fact</a></li>
<li><a href="#planningEntity">4.3.3. Planning entity</a></li>
<li><a href="#planningVariable">4.3.4. Planning variable (genuine)</a></li>
<li><a href="#planningValueAndPlanningValueRange">4.3.5. Planning value and planning value range</a></li>
<li><a href="#planningProblemAndPlanningSolution">4.3.6. Planning problem and planning solution</a></li>
</ul>
</li>
<li><a href="#useTheSolver">4.4. Use the <code>Solver</code></a>
<ul class="sectlevel3">
<li><a href="#theSolverInterface">4.4.1. The <code>Solver</code> interface</a></li>
<li><a href="#solvingAProblem">4.4.2. Solving a problem</a></li>
<li><a href="#environmentMode">4.4.3. Environment mode: are there bugs in my code?</a></li>
<li><a href="#logging">4.4.4. Logging level: what is the <code>Solver</code> doing?</a></li>
<li><a href="#randomNumberGenerator">4.4.5. Random number generator</a></li>
</ul>
</li>
<li><a href="#solverManager">4.5. SolverManager</a>
<ul class="sectlevel3">
<li><a href="#solverManagerSolveBatch">4.5.1. Solve batch problems</a></li>
<li><a href="#solverManagerSolveAndListen">4.5.2. Solve and listen to show progress to the end-user</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scoreCalculation">5. Score calculation</a>
<ul class="sectlevel2">
<li><a href="#scoreTerminology">5.1. Score terminology</a>
<ul class="sectlevel3">
<li><a href="#whatIsAScore">5.1.1. What is a score?</a></li>
<li><a href="#formalizeTheBusinessConstraints">5.1.2. Formalize the business constraints</a></li>
<li><a href="#scoreConstraintSignum">5.1.3. Score constraint signum (positive or negative)</a></li>
<li><a href="#scoreConstraintWeight">5.1.4. Score constraint weight</a></li>
<li><a href="#scoreLevel">5.1.5. Score constraint level (hard, soft, &#8230;&#8203;)</a></li>
<li><a href="#paretoScoring">5.1.6. Pareto scoring (AKA multi-objective optimization scoring)</a></li>
<li><a href="#combiningScoreTechniques">5.1.7. Combining score techniques</a></li>
<li><a href="#scoreInterface">5.1.8. <code>Score</code> interface</a></li>
<li><a href="#avoidFloatingPointNumbersInScoreCalculation">5.1.9. Avoid floating point numbers in score calculation</a></li>
</ul>
</li>
<li><a href="#scoreType">5.2. Choose a score type</a>
<ul class="sectlevel3">
<li><a href="#simpleScore">5.2.1. <code>SimpleScore</code></a></li>
<li><a href="#hardSoftScore">5.2.2. <code>HardSoftScore</code> (Recommended)</a></li>
<li><a href="#hardMediumSoftScore">5.2.3. <code>HardMediumSoftScore</code></a></li>
<li><a href="#bendableScore">5.2.4. <code>BendableScore</code></a></li>
<li><a href="#customScore">5.2.5. Implementing a custom score</a></li>
</ul>
</li>
<li><a href="#calculateTheScore">5.3. Calculate the <code>Score</code></a>
<ul class="sectlevel3">
<li><a href="#scoreCalculationTypes">5.3.1. Score calculation types</a></li>
<li><a href="#easyJavaScoreCalculation">5.3.2. Easy Java score calculation</a></li>
<li><a href="#incrementalJavaScoreCalculation">5.3.3. Incremental Java score calculation</a></li>
<li><a href="#initializingScoreTrend">5.3.4. <code>InitializingScoreTrend</code></a></li>
<li><a href="#invalidScoreDetection">5.3.5. Invalid score detection</a></li>
</ul>
</li>
<li><a href="#scoreCalculationPerformanceTricks">5.4. Score calculation performance tricks</a>
<ul class="sectlevel3">
<li><a href="#scoreCalculationPerformanceTricksOverview">5.4.1. Overview</a></li>
<li><a href="#scoreCalculationSpeed">5.4.2. Score calculation speed</a></li>
<li><a href="#incrementalScoreCalculation">5.4.3. Incremental score calculation (with deltas)</a></li>
<li><a href="#avoidCallingRemoteServicesDuringScoreCalculation">5.4.4. Avoid calling remote services during score calculation</a></li>
<li><a href="#pointlessConstraints">5.4.5. Pointless constraints</a></li>
<li><a href="#buildInHardConstraint">5.4.6. Built-in hard constraint</a></li>
<li><a href="#otherScoreCalculationPerformanceTricks">5.4.7. Other score calculation performance tricks</a></li>
<li><a href="#scoreTrap">5.4.8. Score trap</a></li>
<li><a href="#stepLimitBenchmark">5.4.9. <code>stepLimit</code> benchmark</a></li>
<li><a href="#fairnessScoreConstraints">5.4.10. Fairness score constraints</a></li>
</ul>
</li>
<li><a href="#constraintConfiguration">5.5. Constraint configuration: adjust constraint weights dynamically</a>
<ul class="sectlevel3">
<li><a href="#createAConstraintConfiguration">5.5.1. Create a constraint configuration</a></li>
<li><a href="#constraintWeight">5.5.2. Add a constraint weight for each constraint</a></li>
</ul>
</li>
<li><a href="#explainingTheScore">5.6. Explaining the score: which constraints are broken?</a>
<ul class="sectlevel3">
<li><a href="#usingScoreCalculationOutsideTheSolver">5.6.1. Using score calculation outside the <code>Solver</code></a></li>
<li><a href="#constraintMatchTotal">5.6.2. Constraint match total: break down the score by constraint</a></li>
<li><a href="#indictmentHeatMap">5.6.3. Indictment heat map: visualize the hot planning entities</a></li>
</ul>
</li>
<li><a href="#testingScoreConstraints">5.7. Testing score constraints</a></li>
</ul>
</li>
<li><a href="#constraintStreams">6. Constraint streams score calculation</a>
<ul class="sectlevel2">
<li><a href="#constraintStreamsIntroduction">6.1. Introduction</a></li>
<li><a href="#constraintStreamsConfiguration">6.2. Creating a constraint stream</a></li>
<li><a href="#constraintStreamsCardinality">6.3. Constraint stream cardinality</a></li>
<li><a href="#constraintStreamsBuildingBlocks">6.4. Building blocks</a>
<ul class="sectlevel3">
<li><a href="#constraintStreamsPenaltiesRewards">6.4.1. Penalties and rewards</a></li>
<li><a href="#constraintStreamsFilter">6.4.2. Filtering</a></li>
<li><a href="#constraintStreamsJoin">6.4.3. Joining</a></li>
<li><a href="#constraintStreamsGroupingAndCollectors">6.4.4. Grouping and collectors</a></li>
<li><a href="#constraintStreamsConditionalPropagation">6.4.5. Conditional propagation</a></li>
</ul>
</li>
<li><a href="#constraintStreamsTesting">6.5. Testing a constraint stream</a></li>
<li><a href="#constraintStreamsTestingIsolatedConstraints">6.6. Testing constraints in isolation</a>
<ul class="sectlevel3">
<li><a href="#constraintStreamsTestingAllConstraints">6.6.1. Testing all constraints together</a></li>
</ul>
</li>
<li><a href="#constraintStreamsImplementations">6.7. Variant implementation types</a></li>
</ul>
</li>
<li><a href="#droolsScoreCalculation">7. Drools score calculation</a>
<ul class="sectlevel2">
<li><a href="#droolsScoreCalculationOverview">7.1. Overview</a></li>
<li><a href="#droolsScoreRulesConfiguration">7.2. Drools score rules configuration</a>
<ul class="sectlevel3">
<li><a href="#droolsScoreCalculationScoreDrl">7.2.1. A <code>scoreDrl</code> resource on the classpath</a></li>
<li><a href="#droolsScoreCalculationScoreDrlFile">7.2.2. A <code>scoreDrlFile</code> element</a></li>
</ul>
</li>
<li><a href="#implementingAScoreRule">7.3. Implementing a score rule</a></li>
<li><a href="#weighingScoreRules">7.4. Weighing score rules</a></li>
<li><a href="#testingDroolsConstraints">7.5. Testing Drools-based constraints</a></li>
</ul>
</li>
<li><a href="#shadowVariable">8. Shadow variable</a>
<ul class="sectlevel2">
<li><a href="#shadowVariableIntroduction">8.1. Introduction</a></li>
<li><a href="#bidirectionalVariable">8.2. Bi-directional variable (inverse relation shadow variable)</a></li>
<li><a href="#anchorShadowVariable">8.3. Anchor shadow variable</a></li>
<li><a href="#customVariableListener">8.4. Custom <code>VariableListener</code></a></li>
<li><a href="#variableListenerTriggeringOrder">8.5. VariableListener triggering order</a></li>
</ul>
</li>
<li><a href="#optimizationAlgorithms">9. Optimization algorithms</a>
<ul class="sectlevel2">
<li><a href="#searchSpaceSize">9.1. Search space size in the real world</a></li>
<li><a href="#doesPlannerFindTheOptimalSolution">9.2. Does OptaPlanner find the optimal solution?</a></li>
<li><a href="#architectureOverview">9.3. Architecture overview</a></li>
<li><a href="#optimizationAlgorithmsOverview">9.4. Optimization algorithms overview</a></li>
<li><a href="#whichOptimizationAlgorithmsShouldIUse">9.5. Which optimization algorithms should I use?</a></li>
<li><a href="#powerTweaking">9.6. Power tweaking or default parameter values</a></li>
<li><a href="#solverPhase">9.7. Solver phase</a></li>
<li><a href="#scopeOverview">9.8. Scope overview</a></li>
<li><a href="#termination">9.9. Termination</a>
<ul class="sectlevel3">
<li><a href="#timeMillisSpentTermination">9.9.1. Time spent termination</a></li>
<li><a href="#unimprovedTimeMillisSpentTermination">9.9.2. Unimproved time spent termination</a></li>
<li><a href="#bestScoreTermination">9.9.3. <code>BestScoreTermination</code></a></li>
<li><a href="#bestScoreFeasibleTermination">9.9.4. <code>BestScoreFeasibleTermination</code></a></li>
<li><a href="#stepCountTermination">9.9.5. <code>StepCountTermination</code></a></li>
<li><a href="#unimprovedStepCountTermination">9.9.6. <code>UnimprovedStepCountTermination</code></a></li>
<li><a href="#scoreCalculationCountTermination">9.9.7. <code>ScoreCalculationCountTermination</code></a></li>
<li><a href="#combiningMultipleTerminations">9.9.8. Combining multiple terminations</a></li>
<li><a href="#asynchronousTermination">9.9.9. Asynchronous termination from another thread</a></li>
</ul>
</li>
<li><a href="#SolverEventListener">9.10. <code>SolverEventListener</code></a></li>
<li><a href="#customSolverPhase">9.11. Custom solver phase</a></li>
<li><a href="#noChangeSolverPhase">9.12. No change solver phase</a></li>
<li><a href="#multithreadedSolving">9.13. Multithreaded solving</a>
<ul class="sectlevel3">
<li><a href="#planningId">9.13.1. <code>@PlanningId</code></a></li>
<li><a href="#customThreadFactory">9.13.2. Custom thread factory (WildFly, Android, GAE, &#8230;&#8203;)</a></li>
<li><a href="#multithreadedIncrementalSolving">9.13.3. Multithreaded incremental solving</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#moveAndNeighborhoodSelection">10. Move and neighborhood selection</a>
<ul class="sectlevel2">
<li><a href="#moveAndNeighborhoodSelectionIntroduction">10.1. Move and neighborhood introduction</a>
<ul class="sectlevel3">
<li><a href="#whatIsAMove">10.1.1. What is a <code>Move</code>?</a></li>
<li><a href="#whatIsAMoveSelector">10.1.2. What is a <code>MoveSelector</code>?</a></li>
<li><a href="#subselectingOfEntitiesValuesAndOtherMoves">10.1.3. Subselecting of entities, values, and other moves</a></li>
</ul>
</li>
<li><a href="#genericMoveSelectors">10.2. Generic <code>MoveSelectors</code></a>
<ul class="sectlevel3">
<li><a href="#genericMoveSelectorsOverview">10.2.1. Generic <code>MoveSelectors</code> overview</a></li>
<li><a href="#changeMoveSelector">10.2.2. <code>ChangeMoveSelector</code></a></li>
<li><a href="#swapMoveSelector">10.2.3. <code>SwapMoveSelector</code></a></li>
<li><a href="#pillarMoveSelectors">10.2.4. Pillar-based move selectors</a></li>
<li><a href="#chainMoveSelectors">10.2.5. Move selectors for chained variables</a></li>
</ul>
</li>
<li><a href="#combiningMultipleMoveSelectors">10.3. Combining multiple <code>MoveSelector</code>s</a>
<ul class="sectlevel3">
<li><a href="#unionMoveSelector">10.3.1. <code>unionMoveSelector</code></a></li>
<li><a href="#cartesianProductMoveSelector">10.3.2. <code>cartesianProductMoveSelector</code></a></li>
</ul>
</li>
<li><a href="#entitySelector">10.4. <code>EntitySelector</code></a></li>
<li><a href="#valueSelector">10.5. <code>ValueSelector</code></a></li>
<li><a href="#generalSelectorFeatures">10.6. General <code>Selector</code> features</a>
<ul class="sectlevel3">
<li><a href="#cacheType">10.6.1. <code>CacheType</code>: create moves ahead of time or just in time</a></li>
<li><a href="#selectionOrder">10.6.2. <code>SelectionOrder</code>: original, sorted, random, shuffled, or probabilistic</a></li>
<li><a href="#recommendedCombinationsOfCacheTypeAndSelectionOrder">10.6.3. Recommended combinations of <code>CacheType</code> and <code>SelectionOrder</code></a></li>
<li><a href="#filteredSelection">10.6.4. Filtered selection</a></li>
<li><a href="#sortedSelection">10.6.5. Sorted selection</a></li>
<li><a href="#probabilisticSelection">10.6.6. Probabilistic selection</a></li>
<li><a href="#limitedSelection">10.6.7. Limited selection</a></li>
<li><a href="#mimicSelection">10.6.8. Mimic selection (record/replay)</a></li>
<li><a href="#nearbySelection">10.6.9. Nearby selection</a></li>
</ul>
</li>
<li><a href="#customMoves">10.7. Custom moves</a>
<ul class="sectlevel3">
<li><a href="#whichMoveTypesMightBeMissing">10.7.1. Which move types might be missing in my implementation?</a></li>
<li><a href="#customMovesIntroduction">10.7.2. Custom moves introduction</a></li>
<li><a href="#theInterfaceMove">10.7.3. The <code>Move</code> interface</a></li>
<li><a href="#generatingCustomMoves">10.7.4. Generating custom moves</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#exhaustiveSearch">11. Exhaustive search</a>
<ul class="sectlevel2">
<li><a href="#exhaustiveSearchOverview">11.1. Overview</a></li>
<li><a href="#bruteForce">11.2. Brute force</a>
<ul class="sectlevel3">
<li><a href="#bruteForceAlgorithm">11.2.1. Algorithm description</a></li>
<li><a href="#bruteForceConfiguration">11.2.2. Configuration</a></li>
</ul>
</li>
<li><a href="#branchAndBound">11.3. Branch and bound</a>
<ul class="sectlevel3">
<li><a href="#branchAndBoundAlgorithm">11.3.1. Algorithm description</a></li>
<li><a href="#branchAndBoundConfiguration">11.3.2. Configuration</a></li>
</ul>
</li>
<li><a href="#scalabilityOfExhaustiveSearch">11.4. Scalability of exhaustive search</a></li>
</ul>
</li>
<li><a href="#constructionHeuristics">12. Construction heuristics</a>
<ul class="sectlevel2">
<li><a href="#constructionHeuristicsOverview">12.1. Overview</a></li>
<li><a href="#firstFit">12.2. First fit</a>
<ul class="sectlevel3">
<li><a href="#firstFitAlgorithm">12.2.1. Algorithm description</a></li>
<li><a href="#firstFitConfiguration">12.2.2. Configuration</a></li>
</ul>
</li>
<li><a href="#firstFitDecreasing">12.3. First fit decreasing</a>
<ul class="sectlevel3">
<li><a href="#firstFitDecreasingAlgorithm">12.3.1. Algorithm description</a></li>
<li><a href="#firstFitDecreasingConfiguration">12.3.2. Configuration</a></li>
</ul>
</li>
<li><a href="#weakestFit">12.4. Weakest fit</a>
<ul class="sectlevel3">
<li><a href="#weakestFitAlgorithm">12.4.1. Algorithm description</a></li>
<li><a href="#weakestFitConfiguration">12.4.2. Configuration</a></li>
</ul>
</li>
<li><a href="#weakestFitDecreasing">12.5. Weakest fit decreasing</a>
<ul class="sectlevel3">
<li><a href="#weakestFitDecreasingAlgorithm">12.5.1. Algorithm description</a></li>
<li><a href="#weakestFitDecreasingConfiguration">12.5.2. Configuration</a></li>
</ul>
</li>
<li><a href="#strongestFit">12.6. Strongest fit</a>
<ul class="sectlevel3">
<li><a href="#strongestFitAlgorithm">12.6.1. Algorithm description</a></li>
<li><a href="#strongestFitConfiguration">12.6.2. Configuration</a></li>
</ul>
</li>
<li><a href="#strongestFitDecreasing">12.7. Strongest fit decreasing</a>
<ul class="sectlevel3">
<li><a href="#strongestFitDecreasingAlgorithm">12.7.1. Algorithm description</a></li>
<li><a href="#strongestFitDecreasingConfiguration">12.7.2. Configuration</a></li>
</ul>
</li>
<li><a href="#allocateEntityFromQueue">12.8. Allocate entity from queue</a>
<ul class="sectlevel3">
<li><a href="#allocateEntityFromQueueAlgorithm">12.8.1. Algorithm description</a></li>
<li><a href="#allocateEntityFromQueueConfiguration">12.8.2. Configuration</a></li>
<li><a href="#allocateEntityFromQueueMultipleEntityClasses">12.8.3. Multiple entity classes</a></li>
<li><a href="#constructionHeuristicsPickEarlyType">12.8.4. Pick early type</a></li>
</ul>
</li>
<li><a href="#allocateToValueFromQueue">12.9. Allocate to value from queue</a>
<ul class="sectlevel3">
<li><a href="#allocateToValueFromQueueAlgorithm">12.9.1. Algorithm description</a></li>
<li><a href="#allocateToValueFromQueueConfiguration">12.9.2. Configuration</a></li>
</ul>
</li>
<li><a href="#cheapestInsertion">12.10. Cheapest insertion</a>
<ul class="sectlevel3">
<li><a href="#cheapestInsertionAlgorithm">12.10.1. Algorithm description</a></li>
<li><a href="#cheapestInsertionConfiguration">12.10.2. Configuration</a></li>
</ul>
</li>
<li><a href="#regretInsertion">12.11. Regret insertion</a>
<ul class="sectlevel3">
<li><a href="#regretInsertionAlgorithm">12.11.1. Algorithm description</a></li>
<li><a href="#regretInsertionConfiguration">12.11.2. Configuration</a></li>
</ul>
</li>
<li><a href="#allocateFromPool">12.12. Allocate from pool</a>
<ul class="sectlevel3">
<li><a href="#allocateFromPoolAlgorithm">12.12.1. Algorithm description</a></li>
<li><a href="#allocateFromPoolConfiguration">12.12.2. Configuration</a></li>
</ul>
</li>
<li><a href="#scalingConstructionHeuristics">12.13. Scaling construction heuristics</a>
<ul class="sectlevel3">
<li><a href="#initializingScoreTrendShortcuts">12.13.1. InitializingScoreTrend shortcuts</a></li>
<li><a href="#scalingMultiplePlanningVariablesInConstructionHeuristics">12.13.2. Scaling multiple planning variables in construction heuristics</a></li>
<li><a href="#otherScalingTechniquesInConstructionHeuristics">12.13.3. Other scaling techniques in construction heuristics</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#localSearch">13. Local search</a>
<ul class="sectlevel2">
<li><a href="#localSearchOverview">13.1. Overview</a></li>
<li><a href="#localSearchConcepts">13.2. Local search concepts</a>
<ul class="sectlevel3">
<li><a href="#localSearchStepByStep">13.2.1. Step by step</a></li>
<li><a href="#localSearchConceptsDecideTheNextStep">13.2.2. Decide the next step</a></li>
<li><a href="#localSearchAcceptor">13.2.3. Acceptor</a></li>
<li><a href="#localSearchForager">13.2.4. Forager</a></li>
</ul>
</li>
<li><a href="#hillClimbing">13.3. Hill climbing (simple local search)</a>
<ul class="sectlevel3">
<li><a href="#hillClimbingAlgorithm">13.3.1. Algorithm description</a></li>
<li><a href="#hillClimbingStuckInLocalOptima">13.3.2. Stuck in local optima</a></li>
<li><a href="#hillClimbingConfigure">13.3.3. Configuration</a></li>
</ul>
</li>
<li><a href="#tabuSearch">13.4. Tabu search</a>
<ul class="sectlevel3">
<li><a href="#tabuSearchAlgorithm">13.4.1. Algorithm description</a></li>
<li><a href="#tabuSearchConfiguration">13.4.2. Configuration</a></li>
</ul>
</li>
<li><a href="#simulatedAnnealing">13.5. Simulated annealing</a>
<ul class="sectlevel3">
<li><a href="#simulatedAnnealingAlgorithm">13.5.1. Algorithm description</a></li>
<li><a href="#simulatedAnnealingConfiguration">13.5.2. Configuration</a></li>
</ul>
</li>
<li><a href="#lateAcceptance">13.6. Late acceptance</a>
<ul class="sectlevel3">
<li><a href="#lateAcceptanceAlgorithm">13.6.1. Algorithm description</a></li>
<li><a href="#lateAcceptanceConfiguration">13.6.2. Configuration</a></li>
</ul>
</li>
<li><a href="#greatDeluge">13.7. Great Deluge</a>
<ul class="sectlevel3">
<li><a href="#greatDelugeAlgorithm">13.7.1. Algorithm Description</a></li>
<li><a href="#greatDelugeConfiguration">13.7.2. Configuration</a></li>
</ul>
</li>
<li><a href="#stepCountingHillClimbing">13.8. Step counting hill climbing</a>
<ul class="sectlevel3">
<li><a href="#stepCountingHillClimbingAlgorithm">13.8.1. Algorithm description</a></li>
<li><a href="#stepCountingHillClimbingConfiguration">13.8.2. Configuration</a></li>
</ul>
</li>
<li><a href="#strategicOscillation">13.9. Strategic oscillation</a>
<ul class="sectlevel3">
<li><a href="#strategicOscillationAlgorithm">13.9.1. Algorithm description</a></li>
<li><a href="#strategicOscillationConfiguration">13.9.2. Configuration</a></li>
</ul>
</li>
<li><a href="#variableNeighborhoodDescent">13.10. Variable neighborhood descent</a>
<ul class="sectlevel3">
<li><a href="#variableNeighborhoodDescentAlgorithm">13.10.1. Algorithm description</a></li>
<li><a href="#variableNeighborhoodDescentConfiguration">13.10.2. Configuration</a></li>
</ul>
</li>
<li><a href="#customTerminationSelectorOrAcceptor">13.11. Using a custom <code>Termination</code>, <code>MoveSelector</code>, <code>EntitySelector</code>, <code>ValueSelector</code>, or <code>Acceptor</code></a></li>
</ul>
</li>
<li><a href="#evolutionaryAlgorithms">14. Evolutionary algorithms</a>
<ul class="sectlevel2">
<li><a href="#evolutionaryAlgorithmsOverview">14.1. Overview</a></li>
<li><a href="#evolutionaryStrategies">14.2. Evolutionary strategies</a></li>
<li><a href="#geneticAlgorithms">14.3. Genetic algorithms</a></li>
</ul>
</li>
<li><a href="#hyperheuristics">15. Hyperheuristics</a>
<ul class="sectlevel2">
<li><a href="#hyperheuristicsOverview">15.1. Overview</a></li>
</ul>
</li>
<li><a href="#partitionedSearch">16. Partitioned search</a>
<ul class="sectlevel2">
<li><a href="#partitionedSearchAlgorithm">16.1. Algorithm description</a></li>
<li><a href="#partitionedSearchConfiguration">16.2. Configuration</a></li>
<li><a href="#partitioningASolution">16.3. Partitioning a solution</a>
<ul class="sectlevel3">
<li><a href="#customSolutionPartitioner">16.3.1. Custom <code>SolutionPartitioner</code></a></li>
</ul>
</li>
<li><a href="#runnablePartThreadLimit">16.4. Runnable part thread limit</a></li>
</ul>
</li>
<li><a href="#benchmarker">17. Benchmarking and tweaking</a>
<ul class="sectlevel2">
<li><a href="#findTheBestSolverConfiguration">17.1. Find the best solver configuration</a></li>
<li><a href="#benchmarkConfiguration">17.2. Benchmark configuration</a>
<ul class="sectlevel3">
<li><a href="#addADependencyOnBenchmarkJar">17.2.1. Add a dependency on <code>optaplanner-benchmark</code></a></li>
<li><a href="#runASimpleBenchmark">17.2.2. Run a simple benchmark</a></li>
<li><a href="#buildAndRunAPlannerBenchmark">17.2.3. Configure and run an advanced benchmark</a></li>
<li><a href="#solutionFileIO">17.2.4. <code>SolutionFileIO</code>: input and output of solution files</a></li>
<li><a href="#warmingUpTheHotSpotCompiler">17.2.5. Warming up the HotSpot compiler</a></li>
<li><a href="#benchmarkBlueprint">17.2.6. Benchmark blueprint: a predefined configuration</a></li>
<li><a href="#writeTheOutputSolutionOfBenchmarkRuns">17.2.7. Write the output solution of benchmark runs</a></li>
<li><a href="#benchmarkLogging">17.2.8. Benchmark logging</a></li>
</ul>
</li>
<li><a href="#benchmarkReport">17.3. Benchmark report</a>
<ul class="sectlevel3">
<li><a href="#benchmarkHtmlReport">17.3.1. HTML report</a></li>
<li><a href="#rankingTheSolvers">17.3.2. Ranking the solvers</a></li>
</ul>
</li>
<li><a href="#benchmarkReportSummaryStatistics">17.4. Summary statistics</a>
<ul class="sectlevel3">
<li><a href="#benchmarkReportBestScoreSummary">17.4.1. Best score summary (graph and table)</a></li>
<li><a href="#benchmarkReportBestScoreScalabilitySummary">17.4.2. Best score scalability summary (graph)</a></li>
<li><a href="#benchmarkReportBestScoreDistributionSummary">17.4.3. Best score distribution summary (graph)</a></li>
<li><a href="#benchmarkReportWinningScoreDifferenceSummary">17.4.4. Winning score difference summary (graph And table)</a></li>
<li><a href="#benchmarkReportWorstScoreDifferencePercentageSummary">17.4.5. Worst score difference percentage (ROI) summary (graph And table)</a></li>
<li><a href="#benchmarkReportScoreCalculationSpeedSummary">17.4.6. Score calculation speed summary (graph And table)</a></li>
<li><a href="#benchmarkReportTimeSpentSummary">17.4.7. Time spent summary (graph And table)</a></li>
<li><a href="#benchmarkReportTimeSpentScalabilitySummary">17.4.8. Time spent scalability summary (graph)</a></li>
<li><a href="#benchmarkReportBestScorePerTimeSpentSummary">17.4.9. Best score per time spent summary (graph)</a></li>
</ul>
</li>
<li><a href="#benchmarkReportStatisticPerDataset">17.5. Statistic per dataset (graph and CSV)</a>
<ul class="sectlevel3">
<li><a href="#enableAProblemStatistic">17.5.1. Enable a problem statistic</a></li>
<li><a href="#benchmarkReportBestScoreOverTimeStatistic">17.5.2. Best score over time statistic (graph and CSV)</a></li>
<li><a href="#benchmarkReportStepScoreOverTimeStatistic">17.5.3. Step score over time statistic (graph and CSV)</a></li>
<li><a href="#benchmarkReportScoreCalculationSpeedOverTimeStatistic">17.5.4. Score calculation speed over time statistic (graph and CSV)</a></li>
<li><a href="#benchmarkReportBestSolutionMutationOverTimeStatistic">17.5.5. Best solution mutation over time statistic (graph and CSV)</a></li>
<li><a href="#benchmarkReportMoveCountPerStepStatistic">17.5.6. Move count per step statistic (graph and CSV)</a></li>
<li><a href="#benchmarkReportMemoryUseStatistic">17.5.7. Memory use statistic (graph and CSV)</a></li>
</ul>
</li>
<li><a href="#benchmarkReportStatisticPerSingleBenchmark">17.6. Statistic per single benchmark (graph and CSV)</a>
<ul class="sectlevel3">
<li><a href="#enableASingleStatistic">17.6.1. Enable a single statistic</a></li>
<li><a href="#benchmarkReportConstraintMatchTotalBestScoreOverTimeStatistic">17.6.2. Constraint match total best score over time statistic (graph and CSV)</a></li>
<li><a href="#benchmarkReportConstraintMatchTotalStepScoreOverTimeStatistic">17.6.3. Constraint match total step score over time statistic (graph and CSV)</a></li>
<li><a href="#benchmarkReportPickedMoveTypeBestScoreDiffOverTimeStatistic">17.6.4. Picked move type best score diff over time statistic (graph and CSV)</a></li>
<li><a href="#benchmarkReportPickedMoveTypeStepScoreDiffOverTimeStatistic">17.6.5. Picked move type step score diff over time statistic (graph and CSV)</a></li>
</ul>
</li>
<li><a href="#advancedBenchmarking">17.7. Advanced benchmarking</a>
<ul class="sectlevel3">
<li><a href="#benchmarkingPerformanceTricks">17.7.1. Benchmarking performance tricks</a></li>
<li><a href="#statisticalBenchmarking">17.7.2. Statistical benchmarking</a></li>
<li><a href="#templateBasedBenchmarking">17.7.3. Template-based benchmarking and matrix benchmarking</a></li>
<li><a href="#benchmarkReportAggregation">17.7.4. Benchmark report aggregation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#repeatedPlanning">18. Repeated planning</a>
<ul class="sectlevel2">
<li><a href="#introductionToRepeatedPlanning">18.1. Introduction to repeated planning</a></li>
<li><a href="#backupPlanning">18.2. Backup planning</a></li>
<li><a href="#overconstrainedPlanning">18.3. Overconstrained planning</a>
<ul class="sectlevel3">
<li><a href="#overconstrainedPlanningWithNullableVariables">18.3.1. Overconstrained planning with nullable variables</a></li>
<li><a href="#overconstrainedPlanningWithVirutalValues">18.3.2. Overconstrained planning with virtual values</a></li>
</ul>
</li>
<li><a href="#continuousPlanning">18.4. Continuous planning (windowed planning)</a>
<ul class="sectlevel3">
<li><a href="#pinnedPlanningEntities">18.4.1. Pinned planning entities</a></li>
<li><a href="#nonvolatileReplanning">18.4.2. Nonvolatile replanning to minimize disruption (semi-movable planning entities)</a></li>
</ul>
</li>
<li><a href="#realTimePlanning">18.5. Real-time planning</a>
<ul class="sectlevel3">
<li><a href="#problemFactChange">18.5.1. <code>ProblemFactChange</code></a></li>
<li><a href="#daemon">18.5.2. Daemon: <code>solve()</code> does not return</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#integration">19. Integration</a>
<ul class="sectlevel2">
<li><a href="#integrationOverview">19.1. Overview</a></li>
<li><a href="#integrationWithPersistentStorage">19.2. Persistent storage</a>
<ul class="sectlevel3">
<li><a href="#integrationWithJpaAndHibernate">19.2.1. Database: JPA and Hibernate</a></li>
<li><a href="#integrationWithXStream">19.2.2. XML or JSON: XStream</a></li>
<li><a href="#integrationWithJaxb">19.2.3. XML or JSON: JAXB</a></li>
<li><a href="#integrationWithJackson">19.2.4. JSON: Jackson</a></li>
<li><a href="#integrationWithJsonb">19.2.5. JSON: JSON-B</a></li>
</ul>
</li>
<li><a href="#integrationWithQuarkus">19.3. Quarkus</a></li>
<li><a href="#integrationWithSpringBoot">19.4. Spring Boot</a></li>
<li><a href="#integrationWithSoaAndEsb">19.5. SOA and ESB</a>
<ul class="sectlevel3">
<li><a href="#integrationWithCamel">19.5.1. Camel and Karaf</a></li>
</ul>
</li>
<li><a href="#integrationWithOtherEnvironments">19.6. Other environments</a>
<ul class="sectlevel3">
<li><a href="#integrationWithJBossModules">19.6.1. JBoss Modules, WildFly, and JBoss EAP</a></li>
<li><a href="#integrationWithJPMS">19.6.2. Java platform module system (Jigsaw)</a></li>
<li><a href="#integrationWithOSGi">19.6.3. OSGi</a></li>
<li><a href="#integrationWithAndroid">19.6.4. Android</a></li>
</ul>
</li>
<li><a href="#integrationWithHumanPlanners">19.7. Integration with human planners (politics)</a></li>
<li><a href="#sizingHardwareAndSoftware">19.8. Sizing hardware and software</a></li>
</ul>
</li>
<li><a href="#designPatterns">20. Design patterns</a>
<ul class="sectlevel2">
<li><a href="#designPatternsIntroduction">20.1. Design patterns introduction</a></li>
<li><a href="#domainModelingGuide">20.2. Domain Modeling Guidelines</a></li>
<li><a href="#assigningTimeToPlanningEntities">20.3. Assigning time to planning entities</a>
<ul class="sectlevel3">
<li><a href="#timeslotPattern">20.3.1. Timeslot pattern:  assign to a fixed-length timeslot</a></li>
<li><a href="#timeGrainPattern">20.3.2. TimeGrain pattern: assign to a starting TimeGrain</a></li>
<li><a href="#chainedThroughTimePattern">20.3.3. Chained through time pattern: assign in a chain that determines starting time</a></li>
<li><a href="#timeBucketPattern">20.3.4. Time bucket pattern: assign to a capacitated bucket per time period</a></li>
</ul>
</li>
<li><a href="#multiStagePlanning">20.4. Multi-stage Planning</a></li>
<li><a href="#cloudArchitecturePatterns">20.5. Cloud architecture patterns</a></li>
</ul>
</li>
<li><a href="#development">21. Development</a>
<ul class="sectlevel2">
<li><a href="#methodologyOverview">21.1. Methodology overview</a></li>
<li><a href="#developmentGuidelines">21.2. Development guidelines</a>
<ul class="sectlevel3">
<li><a href="#_fail_fast">21.2.1. Fail fast</a></li>
<li><a href="#_exception_messages">21.2.2. Exception messages</a></li>
<li><a href="#_generics">21.2.3. Generics</a></li>
<li><a href="#_lifecycle">21.2.4. Lifecycle</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="./shared/optaPlannerLogo.png" alt="optaPlannerLogo">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="plannerIntroduction"><a class="anchor" href="#plannerIntroduction"></a><a class="link" href="#plannerIntroduction">1. OptaPlanner Introduction</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="whatIsOptaPlanner"><a class="anchor" href="#whatIsOptaPlanner"></a><a class="link" href="#whatIsOptaPlanner">1.1. What is OptaPlanner?</a></h3>
<div class="paragraph">
<p>Every organization faces planning problems: providing products or services with a limited set of <em>constrained</em> resources (employees, assets, time and money). OptaPlanner optimizes such planning to do more business with less resources.
This is known as <em>Constraint Satisfaction Programming</em> (which is part of the <em>Operations Research</em> discipline).</p>
</div>
<div class="paragraph">
<p><a href="https://www.optaplanner.org">OptaPlanner</a> is a lightweight, embeddable constraint satisfaction engine which optimizes planning problems. It solves use cases such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Employee shift rostering</strong>: timetabling nurses, repairmen, &#8230;&#8203;</p>
</li>
<li>
<p><strong>Agenda scheduling</strong>: scheduling meetings, appointments, maintenance jobs, advertisements, &#8230;&#8203;</p>
</li>
<li>
<p><strong>Educational timetabling</strong>: scheduling lessons, courses, exams, conference presentations, &#8230;&#8203;</p>
</li>
<li>
<p><strong>Vehicle routing</strong>: planning vehicle routes (trucks, trains, boats, airplanes, &#8230;&#8203;) for moving freight and/or passengers through multiple destinations using known mapping tools &#8230;&#8203;</p>
</li>
<li>
<p><strong>Bin packing</strong>: filling containers, trucks, ships, and storage warehouses with items, but also packing information across computer resources, as in cloud computing &#8230;&#8203;</p>
</li>
<li>
<p><strong>Job shop scheduling</strong>: planning car assembly lines, machine queue planning, workforce task planning, &#8230;&#8203;</p>
</li>
<li>
<p><strong>Cutting stock</strong>: minimizing waste while cutting paper, steel, carpet, &#8230;&#8203;</p>
</li>
<li>
<p><strong>Sport scheduling</strong>: planning games and training schedules for football leagues, baseball leagues, &#8230;&#8203;</p>
</li>
<li>
<p><strong>Financial optimization</strong>: investment portfolio optimization, risk spreading, &#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./PlannerIntroduction/WhatIsOptaPlanner/useCaseOverview.png" alt="useCaseOverview">
</div>
</div>
</div>
<div class="sect2">
<h3 id="whatIsAPlanningProblem"><a class="anchor" href="#whatIsAPlanningProblem"></a><a class="link" href="#whatIsAPlanningProblem">1.2. What is a planning problem?</a></h3>
<div class="imageblock text-center">
<div class="content">
<img src="./PlannerIntroduction/WhatIsAPlanningProblem/whatIsAPlanningProblem.png" alt="whatIsAPlanningProblem">
</div>
</div>
<div class="paragraph">
<p>A planning problem has an optimal goal, based on limited resources and under specific constraints. Optimal goals can be any number of things, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Maximized profits - the optimal goal results in the highest possible profit.</p>
</li>
<li>
<p>Minimized ecological footprint - the optimal goal has the least amount of environmental impact.</p>
</li>
<li>
<p>Maximized satisfaction for employees or customers - the optimal goal prioritizes the needs of employees or customers.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The ability to achieve these goals relies on the number of resources available, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The number of people.</p>
</li>
<li>
<p>Amount of time.</p>
</li>
<li>
<p>Budget.</p>
</li>
<li>
<p>Physical assets, for example, machinery, vehicles, computers, buildings, etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Specific constraints related to these resources must also be taken into account, such as the number of hours a person works, their ability to use certain machines, or compatibility between pieces of equipment.</p>
</div>
<div class="paragraph">
<p>OptaPlanner helps Java<sup>TM</sup> programmers solve constraint satisfaction problems efficiently. Under the hood, it combines optimization heuristics and metaheuristics with very efficient score calculation.</p>
</div>
<div class="sect3">
<h4 id="aPlanningProblemIsNPCompleteOrNPHard"><a class="anchor" href="#aPlanningProblemIsNPCompleteOrNPHard"></a><a class="link" href="#aPlanningProblemIsNPCompleteOrNPHard">1.2.1. A planning problem is NP-complete or NP-hard</a></h4>
<div class="paragraph">
<p>All the use cases above are <em>probably</em> <a href="https://en.wikipedia.org/wiki/NP-completeness">NP-complete/NP-hard</a>,
which means in layman&#8217;s terms:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It&#8217;s easy to verify a given solution to a problem in reasonable time.</p>
</li>
<li>
<p>There is no silver bullet to find the optimal solution of a problem in reasonable time (*).</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>(*) At least, none of the smartest computer scientists in the world have found such a silver bullet yet.
But if they find one for 1 NP-complete problem, it will work for every NP-complete problem.</p>
</div>
<div class="paragraph">
<p>In fact, there&#8217;s a $ 1,000,000 reward for anyone that proves if <a href="https://en.wikipedia.org/wiki/P_%3D_NP_problem">such a silver bullet actually exists or not</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implication of this is pretty dire: solving your problem is probably harder than you anticipated, because the two common techniques won&#8217;t suffice:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Brute Force algorithm (even a smarter variant) will take too long.</p>
</li>
<li>
<p>A quick algorithm, for example in bin packing, <em>putting in the largest items first</em>, will return a solution that is far from optimal.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By using advanced optimization algorithms, <strong>OptaPlanner does find a good solution in reasonable time for such planning problems.</strong></p>
</div>
</div>
<div class="sect3">
<h4 id="aPlanningProblemHasConstraints"><a class="anchor" href="#aPlanningProblemHasConstraints"></a><a class="link" href="#aPlanningProblemHasConstraints">1.2.2. A planning problem has (hard and soft) constraints</a></h4>
<div class="paragraph">
<p>Usually, a planning problem has at least two levels of constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <em>(negative) hard constraint</em> must not be broken. For example: <em>1 teacher can not teach 2 different lessons at the same time</em>.</p>
</li>
<li>
<p>A <em>(negative) soft constraint</em> should not be broken if it can be avoided. For example: <em>Teacher A does not like to teach on Friday afternoon</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some problems have positive constraints too:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <em>positive soft constraint (or reward)</em> should be fulfilled if possible. For example: <em>Teacher B likes to teach on Monday morning</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some basic problems (such as <a href="#nQueens">N queens</a>) only have hard constraints.
Some problems have three or more levels of constraints, for example hard, medium and soft constraints.</p>
</div>
<div class="paragraph">
<p>These constraints define the <em>score calculation</em> (AKA <em>fitness function</em>) of a planning problem.
Each solution of a planning problem can be graded with a score. <strong>With OptaPlanner, score constraints are written in an Object Oriented language, such as Java<sup>TM</sup> code or Drools rules</strong>.
Such code is easy, flexible and scalable.</p>
</div>
</div>
<div class="sect3">
<h4 id="aPlanningProblemHasAHugeSearchSpace"><a class="anchor" href="#aPlanningProblemHasAHugeSearchSpace"></a><a class="link" href="#aPlanningProblemHasAHugeSearchSpace">1.2.3. A planning problem has a huge search space</a></h4>
<div class="paragraph">
<p>A planning problem has a number of <em>solutions</em>.
There are several categories of solutions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <em>possible solution</em> is any solution, whether or not it breaks any number of constraints. Planning problems tend to have an incredibly large number of possible solutions. Many of those solutions are worthless.</p>
</li>
<li>
<p>A <em>feasible solution</em> is a solution that does not break any (negative) hard constraints. The number of feasible solutions tends to be relative to the number of possible solutions. Sometimes there are no feasible solutions. Every feasible solution is a possible solution.</p>
</li>
<li>
<p>An <em>optimal solution</em> is a solution with the highest score. Planning problems tend to have 1 or a few optimal solutions. There is always at least 1 optimal solution, even in the case that there are no feasible solutions and the optimal solution isn&#8217;t feasible.</p>
</li>
<li>
<p>The <em>best solution found</em> is the solution with the highest score found by an implementation in a given amount of time. The best solution found is likely to be feasible and, given enough time, it&#8217;s an optimal solution.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Counterintuitively, the number of possible solutions is huge (if calculated correctly), even with a small dataset.
As you can see in the examples, most instances have a lot more possible solutions than the minimal number of atoms in the known universe (10^80). Because there is no silver bullet to find the optimal solution, any implementation is forced to evaluate at least a subset of all those possible solutions.</p>
</div>
<div class="paragraph">
<p>OptaPlanner supports several optimization algorithms to efficiently wade through that incredibly large number of possible solutions.
Depending on the use case, some optimization algorithms perform better than others, but it&#8217;s impossible to tell in advance. <strong>With OptaPlanner, it is easy to switch the optimization algorithm</strong>, by changing the solver configuration in a few lines of XML or code.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="requirements"><a class="anchor" href="#requirements"></a><a class="link" href="#requirements">1.3. Requirements</a></h3>
<div class="paragraph">
<p>OptaPlanner is <em>open source</em> software, released under <a href="http://www.apache.org/licenses/LICENSE-2.0.html">the Apache License 2.0</a>.
This license is very liberal and allows reuse for commercial purposes.
Read <a href="http://www.apache.org/foundation/licence-FAQ.html#WhatDoesItMEAN">the layman&#8217;s explanation</a>.</p>
</div>
<div class="paragraph">
<p>OptaPlanner is 100% pure Java<sup>TM</sup> and runs on any JVM 8 or higher.
It <a href="#integration">integrates very easily</a> with other Java<sup>TM</sup> technologies.
OptaPlanner is available in <a href="#useWithMavenGradleEtc">the Maven Central Repository</a>.</p>
</div>
<div class="paragraph">
<p>OptaPlanner works on any Java Virtual Machine and is compatible with Standard Java, Enterprise Java, and all JVM languages.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./PlannerIntroduction/Requirements/compatibility.png" alt="compatibility">
</div>
</div>
</div>
<div class="sect2">
<h3 id="governance"><a class="anchor" href="#governance"></a><a class="link" href="#governance">1.4. Governance</a></h3>
<div class="sect3">
<h4 id="statusOfOptaPlanner"><a class="anchor" href="#statusOfOptaPlanner"></a><a class="link" href="#statusOfOptaPlanner">1.4.1. Status of OptaPlanner</a></h4>
<div class="paragraph">
<p>OptaPlanner is stable, reliable and scalable. It has been heavily tested with unit, integration, and stress tests, and is used in production throughout the world. One example handles over 50 000 variables with 5000 variables each, multiple constraint types and billions of possible constraint matches.</p>
</div>
</div>
<div class="sect3">
<h4 id="releaseNotes"><a class="anchor" href="#releaseNotes"></a><a class="link" href="#releaseNotes">1.4.2. Release notes</a></h4>
<div class="paragraph">
<p>We release every month. <a href="https://www.optaplanner.org/download/releaseNotes/">Read the release notes of each release on our website.</a></p>
</div>
</div>
<div class="sect3">
<h4 id="backwardsCompatibility"><a class="anchor" href="#backwardsCompatibility"></a><a class="link" href="#backwardsCompatibility">1.4.3. Backwards compatibility</a></h4>
<div class="paragraph">
<p>OptaPlanner separates its API and implementation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Public API</strong>: All classes in the package namespace <strong>org.optaplanner.core.api</strong> are 100% <strong>backwards compatible</strong> in future releases (especially minor and hotfix releases). In rare circumstances, if the major version number changes, a few specific classes might have a few backwards incompatible changes, but those will be clearly documented in <a href="https://www.optaplanner.org/download/upgradeRecipe/">the upgrade recipe</a>.</p>
</li>
<li>
<p><strong>XML configuration</strong>: The XML solver configuration is backwards compatible for all elements, except for elements that require the use of non public API classes. The XML solver configuration is defined by the classes in the package namespace <strong>org.optaplanner.core.config</strong>.</p>
</li>
<li>
<p><strong>Implementation classes</strong>: All classes in the package namespace <strong>org.optaplanner.core.impl</strong> are <em>not</em> backwards compatible: they will change in future major or minor releases (but probably not in hotfix releases). <a href="https://www.optaplanner.org/download/upgradeRecipe/">The upgrade recipe</a> describes every such relevant change and on how to quickly deal with it when upgrading to a newer version.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This documentation covers some <code>impl</code> classes too.
Those documented <code>impl</code> classes are reliable and safe to use (unless explicitly marked as experimental in this documentation), but we&#8217;re just not entirely comfortable yet to write their signatures in stone.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="communityAndSupport"><a class="anchor" href="#communityAndSupport"></a><a class="link" href="#communityAndSupport">1.4.4. Community and support</a></h4>
<div class="paragraph">
<p>For news and articles, check <a href="https://www.optaplanner.org/blog/">our blog</a>,
<a href="https://twitter.com/OptaPlanner">twitter</a> (including <a href="https://twitter.com/GeoffreyDeSmet">Geoffrey&#8217;s twitter</a>)
and <a href="https://www.facebook.com/OptaPlanner">facebook</a>.<br>
<strong>If you&#8217;re happy with OptaPlanner, make us happy by posting a tweet or blog article about it.</strong></p>
</div>
<div class="paragraph">
<p>Public questions are welcome on <a href="https://www.optaplanner.org/community/getHelp.html">here</a>.
Bugs and feature requests are welcome in <a href="https://issues.redhat.com/browse/PLANNER">our issue tracker</a>.
Pull requests are very welcome on GitHub and get priority treatment! By open sourcing your improvements, you 'll benefit from our peer review and from our improvements made on top of your improvements.</p>
</div>
<div class="paragraph">
<p>Red Hat sponsors OptaPlanner development by employing the core team.
For enterprise support and consulting, take a look at <a href="https://www.optaplanner.org/product/services.html">these services</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="relationshipWithKie"><a class="anchor" href="#relationshipWithKie"></a><a class="link" href="#relationshipWithKie">1.4.5. Relationship with Drools and jBPM</a></h4>
<div class="paragraph">
<p>OptaPlanner is part of the <a href="http://www.kiegroup.org">KIE group of projects</a>.
It releases regularly (often once or twice per month) together with the <a href="http://www.drools.org/">Drools</a> rule engine and the <a href="http://www.jbpm.org/">jBPM</a> workflow engine.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./PlannerIntroduction/Governance/kieFunctionalityOverview.png" alt="kieFunctionalityOverview">
</div>
</div>
<div class="paragraph">
<p>See <a href="#architectureOverview">the architecture overview</a> to learn more about the optional integration with Drools.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="downloadAndRunTheExamples"><a class="anchor" href="#downloadAndRunTheExamples"></a><a class="link" href="#downloadAndRunTheExamples">1.5. Download and run the examples</a></h3>
<div class="sect3">
<h4 id="getTheReleaseZipAndRunTheExamples"><a class="anchor" href="#getTheReleaseZipAndRunTheExamples"></a><a class="link" href="#getTheReleaseZipAndRunTheExamples">1.5.1. Get the release ZIP and run the examples</a></h4>
<div class="paragraph">
<p>To try it now:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download a release zip of OptaPlanner from <a href="https://www.optaplanner.org">the OptaPlanner website</a> and unzip it.</p>
</li>
<li>
<p>Open the directory <em class="path">examples</em> and run the script.</p>
<div class="paragraph">
<p>Linux or Mac:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="sh" class="language-sh hljs">$ cd examples
$ ./runExamples.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="sh" class="language-sh hljs">$ cd examples
$ runExamples.bat</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./PlannerIntroduction/DownloadAndRunTheExamples/distributionZip.png" alt="distributionZip">
</div>
</div>
<div class="paragraph">
<p>The Examples GUI application will open.
Pick an example to try it out:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./PlannerIntroduction/DownloadAndRunTheExamples/plannerExamplesAppScreenshot.png" alt="plannerExamplesAppScreenshot">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>OptaPlanner itself has no GUI dependencies.
It runs just as well on a server or a mobile JVM as it does on the desktop.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="runTheExamplesInAnIDE"><a class="anchor" href="#runTheExamplesInAnIDE"></a><a class="link" href="#runTheExamplesInAnIDE">1.5.2. Run the examples in an IDE (IntelliJ, Eclipse, NetBeans)</a></h4>
<div class="paragraph">
<p>To run the examples in your favorite IDE:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In IntelliJ IDEA, NetBeans or a non-vanilla Eclipse:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open the file <em class="path">examples/sources/pom.xml</em> as a new project, the maven integration will take care of the rest.</p>
</li>
<li>
<p>Run the examples from the project.</p>
</li>
</ol>
</div>
</li>
<li>
<p>In a vanilla Eclipse (which lacks the M2Eclipse plugin):</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a new project for the directory <em class="path">examples/sources</em> .</p>
</li>
<li>
<p>Add all the jars to the classpath from the directory <em class="path">binaries</em> and the directory <em class="path">examples/binaries</em> , except for the file <em class="path">examples/binaries/optaplanner-examples-*.jar</em> .</p>
</li>
<li>
<p>Add the Java source directory <em class="path">src/main/java</em> and the Java resources directory <em class="path">src/main/resources</em> .</p>
</li>
<li>
<p>Create a run configuration:</p>
<div class="ulist">
<ul>
<li>
<p>Main class: <code>org.optaplanner.examples.app.OptaPlannerExamplesApp</code></p>
</li>
<li>
<p>VM parameters (optional): <code>-Xmx512M -server</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>To run a specific example directly and skip the example selection window, run its <code>App</code> class (for example <code>CloudBalancingApp</code>) instead of <code>OptaPlannerExamplesApp</code>.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Run that run configuration.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="useWithMavenGradleEtc"><a class="anchor" href="#useWithMavenGradleEtc"></a><a class="link" href="#useWithMavenGradleEtc">1.5.3. Use OptaPlanner with Maven, Gradle, Ivy, Buildr, or ANT</a></h4>
<div class="paragraph">
<p>The OptaPlanner jars are available in <a href="http://search.maven.org/#search|ga|1|org.optaplanner">the central maven repository</a>
(and the snapshots in <a href="https://repository.jboss.org/nexus/index.html#nexus-search;gav~org.optaplanner~~~~">the JBoss maven repository</a>).</p>
</div>
<div class="paragraph">
<p>If you use Maven, add a dependency to <code>optaplanner-core</code> in your <code>pom.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;dependency&gt;
      &lt;groupId&gt;org.optaplanner&lt;/groupId&gt;
      &lt;artifactId&gt;optaplanner-core&lt;/artifactId&gt;
      &lt;version&gt;...&lt;/version&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or better yet, import the <code>optaplanner-bom</code> in <code>dependencyManagement</code> to avoid duplicating version numbers
when adding other optaplanner dependencies later on:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;project&gt;
  ...
  &lt;dependencyManagement&gt;
    &lt;dependencies&gt;
      &lt;dependency&gt;
        &lt;groupId&gt;org.optaplanner&lt;/groupId&gt;
        &lt;artifactId&gt;optaplanner-bom&lt;/artifactId&gt;
        &lt;type&gt;pom&lt;/type&gt;
        &lt;version&gt;...&lt;/version&gt;
        &lt;scope&gt;import&lt;/scope&gt;
      &lt;/dependency&gt;
    &lt;/dependencies&gt;
  &lt;/dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.optaplanner&lt;/groupId&gt;
      &lt;artifactId&gt;optaplanner-core&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.optaplanner&lt;/groupId&gt;
      &lt;artifactId&gt;optaplanner-persistence-jpa&lt;/artifactId&gt;
    &lt;/dependency&gt;
    ...
  &lt;/dependencies&gt;
&lt;/project&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you use Gradle, add a dependency to <code>optaplanner-core</code> in your <code>build.gradle</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">dependencies {
  implementation 'org.optaplanner:optaplanner-core:#{site.pom.latestFinal.version}'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is similar for Ivy and Buildr.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re still using ANT (without Ivy), copy all the jars from the download zip&#8217;s <code>binaries</code> directory in your classpath.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The download zip&#8217;s <code>binaries</code> directory contains far more jars then <code>optaplanner-core</code> actually uses.
It also contains the jars used by other modules, such as <code>optaplanner-benchmark</code>.</p>
</div>
<div class="paragraph">
<p>Check the maven repository <code>pom.xml</code> files to determine the minimal dependency set of <code>optaplanner-core</code> etc.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="buildFromSource"><a class="anchor" href="#buildFromSource"></a><a class="link" href="#buildFromSource">1.5.4. Build OptaPlanner from source</a></h4>
<div class="paragraph">
<p><strong>Prerequisites</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set up <a href="https://git-scm.com/">Git</a>.</p>
</li>
<li>
<p>Authenticate on GitHub using either HTTPS or SSH.</p>
<div class="ulist">
<ul>
<li>
<p>See <a href="https://help.github.com/articles/set-up-git/">GitHub</a> for more information about setting up and authenticating Git.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Set up <a href="http://maven.apache.org/">Maven</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Build and run the examples from source.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Clone <code>optaplanner</code> from GitHub (or alternatively, download <a href="https://github.com/kiegroup/optaplanner/zipball/master">the zipball</a>):</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="sh" class="language-sh hljs">$ git clone https://github.com/kiegroup/optaplanner.git
...</code></pre>
</div>
</div>
</li>
<li>
<p>Build it with Maven:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="sh" class="language-sh hljs">$ cd optaplanner
$ mvn clean install -DskipTests
...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The first time, Maven might take a long time, because it needs to download jars.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Run the examples:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="sh" class="language-sh hljs">$ cd optaplanner-examples
$ mvn exec:java
...</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the sources in your favorite IDE.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><em>Optional</em>: use a Java profiler.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="quickStart"><a class="anchor" href="#quickStart"></a><a class="link" href="#quickStart">2. Quick start</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="quickStartOverview"><a class="anchor" href="#quickStartOverview"></a><a class="link" href="#quickStartOverview">2.1. Overview</a></h3>
<div class="paragraph">
<p>Each <em>quick start</em> gets you up and running with OptaPlanner quickly.
Pick the quick start that best aligns with your requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#quarkusJavaQuickStart"><strong>Quarkus Java</strong></a> (recommended)</p>
<div class="ulist">
<ul>
<li>
<p>Build a REST application that uses OptaPlanner to optimize a school timetable for students and teachers.</p>
</li>
<li>
<p><a href="https://quarkus.io">Quarkus</a> is an extremely fast platform in the Java ecosystem.
It is ideal for rapid incremental development, as well as deployment into the cloud. It also supports native compilation.</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#springBootJavaQuickStart"><strong>Spring Boot Java</strong></a></p>
<div class="ulist">
<ul>
<li>
<p>Build a REST application that uses OptaPlanner to optimize a school timetable for students and teachers.</p>
</li>
<li>
<p>Spring Boot is a popular platform in the Java ecosystem.</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#plainJavaQuickStart"><strong>Java</strong></a> (plain Java SE)</p>
<div class="ulist">
<ul>
<li>
<p>Build a normal Java application that uses OptaPlanner to optimize assignments of processes to computers.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="quarkusJavaQuickStart"><a class="anchor" href="#quarkusJavaQuickStart"></a><a class="link" href="#quarkusJavaQuickStart">2.2. Quarkus Java quick start</a></h3>
<div class="paragraph">
<p><strong><a href="https://quarkus.io/guides/optaplanner">Read the OptaPlanner on Quarkus guide.</a></strong></p>
</div>
</div>
<div class="sect2">
<h3 id="springBootJavaQuickStart"><a class="anchor" href="#springBootJavaQuickStart"></a><a class="link" href="#springBootJavaQuickStart">2.3. Spring Boot Java quick start</a></h3>
<div class="paragraph">
<p>This guide walks you through the process of creating a Spring Boot
application with OptaPlanner&#8217;s constraint solving Artificial Intelligence (AI).</p>
</div>
<div class="sect3">
<h4 id="_what_you_will_build"><a class="anchor" href="#_what_you_will_build"></a><a class="link" href="#_what_you_will_build">2.3.1. What you will build</a></h4>
<div class="paragraph">
<p>You will build a REST application that optimizes a school timetable for students and teachers:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./QuickStart/SpringBoot/timeTableAppScreenshot.png" alt="timeTableAppScreenshot">
</div>
</div>
<div class="paragraph">
<p>Your service will assign <code>Lesson</code> instances to <code>Timeslot</code> and <code>Room</code> instances automatically
by using AI to adhere to hard and soft scheduling <em>constraints</em>, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A room can have at most one lesson at the same time.</p>
</li>
<li>
<p>A teacher can teach at most one lesson at the same time.</p>
</li>
<li>
<p>A student can attend at most one lesson at the same time.</p>
</li>
<li>
<p>A teacher prefers to teach in a single room.</p>
</li>
<li>
<p>A teacher prefers to teach sequential lessons and dislikes gaps between lessons.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Mathematically speaking, school timetabling is an <em>NP-hard</em> problem.
That means it is difficult to scale.
Simply brute force iterating through all possible combinations takes millions of years
for a non-trivial dataset, even on a supercomputer.
Luckily, AI constraint solvers such as OptaPlanner have advanced algorithms
that deliver a near-optimal solution in a reasonable amount of time.</p>
</div>
</div>
<div class="sect3">
<h4 id="_what_youll_need"><a class="anchor" href="#_what_youll_need"></a><a class="link" href="#_what_youll_need">2.3.2. What you&#8217;ll need</a></h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.oracle.com/java/technologies/javase-downloads.html">JDK 8 or later</a></p>
</li>
<li>
<p><a href="https://maven.apache.org/download.cgi">Maven 3.2+</a> or <a href="https://gradle.org/install/">Gradle4+</a></p>
</li>
<li>
<p>An IDE, such as <a href="https://www.jetbrains.com/idea">IntelliJ IDEA</a>, VSCode, Eclipse or NetBeans</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_the_build_file_and_the_dependencies"><a class="anchor" href="#_the_build_file_and_the_dependencies"></a><a class="link" href="#_the_build_file_and_the_dependencies">2.3.3. The build file and the dependencies</a></h4>
<div class="paragraph">
<p>Use <a href="https://start.spring.io/">Spring Initializr</a> to generate an application
with the following dependencies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring Web (<code>spring-boot-starter-web</code>)</p>
</li>
<li>
<p>OptaPlanner (<code>optaplanner-spring-boot-starter</code>)</p>
<div class="ulist">
<ul>
<li>
<p>Currently <code>optaplanner-spring-boot-starter</code> isn&#8217;t included in Spring Initializr yet.
Add it manually in your build file.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you choose Maven, your <code>pom.xml</code> file has the following content:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.2.6.RELEASE&lt;/version&gt;
    &lt;/parent&gt;

    &lt;groupId&gt;com.example&lt;/groupId&gt;
    &lt;artifactId&gt;constraint-solving-ai-optaplanner&lt;/artifactId&gt;
    &lt;version&gt;0.1.0-SNAPSHOT&lt;/version&gt;
    &lt;name&gt;Constraint Solving AI with OptaPlanner&lt;/name&gt;
    &lt;description&gt;A Spring Boot OptaPlanner example to generate a school timetable.&lt;/description&gt;

    &lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.optaplanner&lt;/groupId&gt;
            &lt;artifactId&gt;optaplanner-spring-boot-starter&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
            &lt;exclusions&gt;
                &lt;exclusion&gt;
                    &lt;groupId&gt;org.junit.vintage&lt;/groupId&gt;
                    &lt;artifactId&gt;junit-vintage-engine&lt;/artifactId&gt;
                &lt;/exclusion&gt;
            &lt;/exclusions&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.optaplanner&lt;/groupId&gt;
                &lt;artifactId&gt;optaplanner-spring-boot-starter&lt;/artifactId&gt;
                &lt;version&gt;7.39.0.Final&lt;/version&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;
    &lt;/dependencyManagement&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;

&lt;/project&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>On the other hand, in Gradle, your <code>build.gradle</code> file has this content:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="groovy" class="language-groovy hljs">plugins {
    id "org.springframework.boot" version "2.2.6.RELEASE"
    id "io.spring.dependency-management" version "1.0.9.RELEASE"
    id "java"
}

group = "com.example"
version = "0.1.0-SNAPSHOT"
sourceCompatibility = "1.8"

repositories {
    mavenCentral()
}

dependencies {
    implementation "org.springframework.boot:spring-boot-starter-web"
    implementation "org.optaplanner:optaplanner-spring-boot-starter:7.39.0.Final"
    testImplementation("org.springframework.boot:spring-boot-starter-test") {
        exclude group: "org.junit.vintage", module: "junit-vintage-engine"
    }
}

test {
    useJUnitPlatform()
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="initial"><a class="anchor" href="#initial"></a><a class="link" href="#initial">2.3.4. Model the domain objects</a></h4>
<div class="paragraph">
<p>Your goal is to assign each lesson to a time slot and a room.
You will create these classes:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./QuickStart/SpringBoot/timeTableClassDiagramPure.png" alt="timeTableClassDiagramPure">
</div>
</div>
<div class="sect4">
<h5 id="_timeslot"><a class="anchor" href="#_timeslot"></a><a class="link" href="#_timeslot">2.3.4.1. Timeslot</a></h5>
<div class="paragraph">
<p>The <code>Timeslot</code> class represents a time interval when lessons are taught,
for example, <code>Monday 10:30 - 11:30</code> or <code>Tuesday 13:30 - 14:30</code>.
For simplicity&#8217;s sake, all time slots have the same duration
and there are no time slots during lunch or other breaks.</p>
</div>
<div class="paragraph">
<p>A time slot has no date, because a high school schedule just repeats every week.
So there is no need for <a href="https://docs.optaplanner.org/latestFinal/optaplanner-docs/html_single/index.html#continuousPlanning">continuous planning</a>.</p>
</div>
<div class="paragraph">
<p>Create the <code>src/main/java/com/example/domain/Timeslot.java</code> class:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.example.domain;

import java.time.DayOfWeek;
import java.time.LocalTime;

public class Timeslot {

    private DayOfWeek dayOfWeek;
    private LocalTime startTime;
    private LocalTime endTime;

    private Timeslot() {
    }

    public Timeslot(DayOfWeek dayOfWeek, LocalTime startTime, LocalTime endTime) {
        this.dayOfWeek = dayOfWeek;
        this.startTime = startTime;
        this.endTime = endTime;
    }

    @Override
    public String toString() {
        return dayOfWeek + " " + startTime.toString();
    }

    // ********************************
    // Getters and setters
    // ********************************

    public DayOfWeek getDayOfWeek() {
        return dayOfWeek;
    }

    public LocalTime getStartTime() {
        return startTime;
    }

    public LocalTime getEndTime() {
        return endTime;
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Because no <code>Timeslot</code> instances change during solving, a <code>Timeslot</code> is called a <em>problem fact</em>.
Such classes do not require any OptaPlanner specific annotations.</p>
</div>
<div class="paragraph">
<p>Notice the <code>toString()</code> method keeps the output short,
so it is easier to read OptaPlanner&#8217;s <code>DEBUG</code> or <code>TRACE</code> log, as shown later.</p>
</div>
</div>
<div class="sect4">
<h5 id="_room"><a class="anchor" href="#_room"></a><a class="link" href="#_room">2.3.4.2. Room</a></h5>
<div class="paragraph">
<p>The <code>Room</code> class represents a location where lessons are taught,
for example, <code>Room A</code> or <code>Room B</code>.
For simplicity&#8217;s sake, all rooms are without capacity limits
and they can accommodate all lessons.</p>
</div>
<div class="paragraph">
<p>Create the <code>src/main/java/com/example/domain/Room.java</code> class:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.example.domain;

public class Room {

    private String name;

    private Room() {
    }

    public Room(String name) {
        this.name = name;
    }

    @Override
    public String toString() {
        return name;
    }

    // ********************************
    // Getters and setters
    // ********************************

    public String getName() {
        return name;
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>Room</code> instances do not change during solving, so <code>Room</code> is also a <em>problem fact</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_lesson"><a class="anchor" href="#_lesson"></a><a class="link" href="#_lesson">2.3.4.3. Lesson</a></h5>
<div class="paragraph">
<p>During a lesson, represented by the <code>Lesson</code> class,
a teacher teaches a subject to a group of students,
for example, <code>Math by A.Turing for 9th grade</code> or <code>Chemistry by M.Curie for 10th grade</code>.
If a subject is taught multiple times per week by the same teacher to the same student group,
there are multiple <code>Lesson</code> instances that are only distinguishable by <code>id</code>.
For example, the 9th grade has six math lessons a week.</p>
</div>
<div class="paragraph">
<p>During solving, OptaPlanner changes the <code>timeslot</code> and <code>room</code> fields of the <code>Lesson</code> class,
to assign each lesson to a time slot and a room.
Because OptaPlanner changes these fields, <code>Lesson</code> is a <em>planning entity</em>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./QuickStart/SpringBoot/timeTableClassDiagramAnnotated.png" alt="timeTableClassDiagramAnnotated">
</div>
</div>
<div class="paragraph">
<p>Most of the fields in the previous diagram contain input data, except for the orange fields:
A lesson&#8217;s <code>timeslot</code> and <code>room</code> fields are unassigned (<code>null</code>) in the input data
and assigned (not <code>null</code>) in the output data.
OptaPlanner changes these fields during solving.
Such fields are called planning variables.
In order for OptaPlanner to recognize them,
both the <code>timeslot</code> and <code>room</code> fields require an <code>@PlanningVariable</code> annotation.
Their containing class, <code>Lesson</code>, requires an <code>@PlanningEntity</code> annotation.</p>
</div>
<div class="paragraph">
<p>Create the <code>src/main/java/com/example/domain/Lesson.java</code> class:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.example.domain;

import org.optaplanner.core.api.domain.entity.PlanningEntity;
import org.optaplanner.core.api.domain.variable.PlanningVariable;

@PlanningEntity
public class Lesson {

    private Long id;

    private String subject;
    private String teacher;
    private String studentGroup;

    @PlanningVariable(valueRangeProviderRefs = "timeslotRange")
    private Timeslot timeslot;

    @PlanningVariable(valueRangeProviderRefs = "roomRange")
    private Room room;

    private Lesson() {
    }

    public Lesson(Long id, String subject, String teacher, String studentGroup) {
        this.id = id;
        this.subject = subject;
        this.teacher = teacher;
        this.studentGroup = studentGroup;
    }

    @Override
    public String toString() {
        return subject + "(" + id + ")";
    }

    // ********************************
    // Getters and setters
    // ********************************

    public Long getId() {
        return id;
    }

    public String getSubject() {
        return subject;
    }

    public String getTeacher() {
        return teacher;
    }

    public String getStudentGroup() {
        return studentGroup;
    }

    public Timeslot getTimeslot() {
        return timeslot;
    }

    public void setTimeslot(Timeslot timeslot) {
        this.timeslot = timeslot;
    }

    public Room getRoom() {
        return room;
    }

    public void setRoom(Room room) {
        this.room = room;
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>Lesson</code> class has an <code>@PlanningEntity</code> annotation,
so OptaPlanner knows that this class changes during solving
because it contains one or more planning variables.</p>
</div>
<div class="paragraph">
<p>The <code>timeslot</code> field has an <code>@PlanningVariable</code> annotation,
so OptaPlanner knows that it can change its value.
In order to find potential <code>Timeslot</code> instances to assign to this field,
OptaPlanner uses the <code>valueRangeProviderRefs</code> property to connect to a value range provider
(explained later) that provides a <code>List&lt;Timeslot&gt;</code> to pick from.</p>
</div>
<div class="paragraph">
<p>The <code>room</code> field also has an <code>@PlanningVariable</code> annotation, for the same reasons.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Determining the <code>@PlanningVariable</code> fields for an arbitrary constraint solving use case
is often challenging the first time.
Read <a href="https://docs.optaplanner.org/latestFinal/optaplanner-docs/html_single/index.html#domainModelingGuide">the domain modeling guidelines</a>
to avoid common pitfalls.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_define_the_constraints_and_calculate_the_score"><a class="anchor" href="#_define_the_constraints_and_calculate_the_score"></a><a class="link" href="#_define_the_constraints_and_calculate_the_score">2.3.5. Define the constraints and calculate the score</a></h4>
<div class="paragraph">
<p>A <em>score</em> represents the quality of a given solution.
The higher the better.
OptaPlanner looks for the best solution, which is the solution with the highest score found in the available time.
It could be the <em>optimal</em> solution.</p>
</div>
<div class="paragraph">
<p>Because this use case has hard and soft constraints,
use the <code>HardSoftScore</code> class to represent the score:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Hard constraints must not be broken. For example: <em>A room can have at most one lesson at the same time.</em></p>
</li>
<li>
<p>Soft constraints should not be broken. For example: <em>A teacher prefers to teach in a single room.</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hard constraints are weighted against other hard constraints.
Soft constraints are weighted too, against other soft constraints.
<strong>Hard constraints always outweigh soft constraints</strong>, regardless of their respective weights.</p>
</div>
<div class="paragraph">
<p>To calculate the score, you could implement an <code>EasyScoreCalculator</code> class:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class TimeTableEasyScoreCalculator implements EasyScoreCalculator&lt;TimeTable&gt; {

    @Override
    public HardSoftScore calculateScore(TimeTable timeTable) {
        List&lt;Lesson&gt; lessonList = timeTable.getLessonList();
        int hardScore = 0;
        for (Lesson a : lessonList) {
            for (Lesson b : lessonList) {
                if (a.getTimeslot() != null &amp;&amp; a.getTimeslot().equals(b.getTimeslot())
                        &amp;&amp; a.getId() &lt; b.getId()) {
                    // A room can accommodate at most one lesson at the same time.
                    if (a.getRoom() != null &amp;&amp; a.getRoom().equals(b.getRoom())) {
                        hardScore--;
                    }
                    // A teacher can teach at most one lesson at the same time.
                    if (a.getTeacher().equals(b.getTeacher())) {
                        hardScore--;
                    }
                    // A student can attend at most one lesson at the same time.
                    if (a.getStudentGroup().equals(b.getStudentGroup())) {
                        hardScore--;
                    }
                }
            }
        }
        int softScore = 0;
        // Soft constraints are only implemented in the "complete" implementation
        return HardSoftScore.of(hardScore, softScore);
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Unfortunately <strong>that does not scale well</strong>, because it is non-incremental:
every time a lesson is assigned to a different time slot or room,
all lessons are re-evaluated to calculate the new score.</p>
</div>
<div class="paragraph">
<p>Instead, create a <code>src/main/java/com/example/solver/TimeTableConstraintProvider.java</code> class
to perform incremental score calculation.
It uses OptaPlanner&#8217;s ConstraintStream API which is inspired by Java 8 Streams and SQL:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.example.solver;

import com.example.domain.Lesson;
import org.optaplanner.core.api.score.buildin.hardsoft.HardSoftScore;
import org.optaplanner.core.api.score.stream.Constraint;
import org.optaplanner.core.api.score.stream.ConstraintFactory;
import org.optaplanner.core.api.score.stream.ConstraintProvider;
import org.optaplanner.core.api.score.stream.Joiners;

public class TimeTableConstraintProvider implements ConstraintProvider {

    @Override
    public Constraint[] defineConstraints(ConstraintFactory constraintFactory) {
        return new Constraint[] {
                // Hard constraints
                roomConflict(constraintFactory),
                teacherConflict(constraintFactory),
                studentGroupConflict(constraintFactory),
                // Soft constraints are only implemented in the "complete" implementation
        };
    }

    private Constraint roomConflict(ConstraintFactory constraintFactory) {
        // A room can accommodate at most one lesson at the same time.

        // Select a lesson ...
        return constraintFactory.from(Lesson.class)
                // ... and pair it with another lesson ...
                .join(Lesson.class,
                        // ... in the same timeslot ...
                        Joiners.equal(Lesson::getTimeslot),
                        // ... in the same room ...
                        Joiners.equal(Lesson::getRoom),
                        // ... and the pair is unique (different id, no reverse pairs)
                        Joiners.lessThan(Lesson::getId))
                // then penalize each pair with a hard weight.
                .penalize("Room conflict", HardSoftScore.ONE_HARD);
    }

    private Constraint teacherConflict(ConstraintFactory constraintFactory) {
        // A teacher can teach at most one lesson at the same time.
        return constraintFactory.from(Lesson.class)
                .join(Lesson.class,
                        Joiners.equal(Lesson::getTimeslot),
                        Joiners.equal(Lesson::getTeacher),
                        Joiners.lessThan(Lesson::getId))
                .penalize("Teacher conflict", HardSoftScore.ONE_HARD);
    }

    private Constraint studentGroupConflict(ConstraintFactory constraintFactory) {
        // A student can attend at most one lesson at the same time.
        return constraintFactory.from(Lesson.class)
                .join(Lesson.class,
                        Joiners.equal(Lesson::getTimeslot),
                        Joiners.equal(Lesson::getStudentGroup),
                        Joiners.lessThan(Lesson::getId))
                .penalize("Student group conflict", HardSoftScore.ONE_HARD);
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>ConstraintProvider</code> scales an order of magnitude better than the <code>EasyScoreCalculator</code>: <em>O</em>(n) instead of <em>O</em>(n²).</p>
</div>
</div>
<div class="sect3">
<h4 id="_gather_the_domain_objects_in_a_planning_solution"><a class="anchor" href="#_gather_the_domain_objects_in_a_planning_solution"></a><a class="link" href="#_gather_the_domain_objects_in_a_planning_solution">2.3.6. Gather the domain objects in a planning solution</a></h4>
<div class="paragraph">
<p>A <code>TimeTable</code> wraps all <code>Timeslot</code>, <code>Room</code>, and <code>Lesson</code> instances of a single dataset.
Furthermore, because it contains all lessons, each with a specific planning variable state,
it is a <em>planning solution</em> and it has a score:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If lessons are still unassigned, then it is an <em>uninitialized</em> solution,
for example, a solution with the score <code>-4init/0hard/0soft</code>.</p>
</li>
<li>
<p>If it breaks hard constraints, then it is an <em>infeasible</em> solution,
for example, a solution with the score <code>-2hard/-3soft</code>.</p>
</li>
<li>
<p>If it adheres to all hard constraints, then it is a <em>feasible</em> solution,
for example, a solution with the score <code>0hard/-7soft</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Create the <code>src/main/java/com/example/domain/TimeTable.java</code> class:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.example.domain;

import java.util.List;

import org.optaplanner.core.api.domain.solution.PlanningEntityCollectionProperty;
import org.optaplanner.core.api.domain.solution.PlanningScore;
import org.optaplanner.core.api.domain.solution.PlanningSolution;
import org.optaplanner.core.api.domain.solution.drools.ProblemFactCollectionProperty;
import org.optaplanner.core.api.domain.valuerange.ValueRangeProvider;
import org.optaplanner.core.api.score.buildin.hardsoft.HardSoftScore;

@PlanningSolution
public class TimeTable {

    @ValueRangeProvider(id = "timeslotRange")
    @ProblemFactCollectionProperty
    private List&lt;Timeslot&gt; timeslotList;

    @ValueRangeProvider(id = "roomRange")
    @ProblemFactCollectionProperty
    private List&lt;Room&gt; roomList;

    @PlanningEntityCollectionProperty
    private List&lt;Lesson&gt; lessonList;

    @PlanningScore
    private HardSoftScore score;

    private TimeTable() {
    }

    public TimeTable(List&lt;Timeslot&gt; timeslotList, List&lt;Room&gt; roomList,
            List&lt;Lesson&gt; lessonList) {
        this.timeslotList = timeslotList;
        this.roomList = roomList;
        this.lessonList = lessonList;
    }

    // ********************************
    // Getters and setters
    // ********************************

    public List&lt;Timeslot&gt; getTimeslotList() {
        return timeslotList;
    }

    public List&lt;Room&gt; getRoomList() {
        return roomList;
    }

    public List&lt;Lesson&gt; getLessonList() {
        return lessonList;
    }

    public HardSoftScore getScore() {
        return score;
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>TimeTable</code> class has an <code>@PlanningSolution</code> annotation,
so OptaPlanner knows that this class contains all of the input and output data.</p>
</div>
<div class="paragraph">
<p>Specifically, this class is the input of the problem:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>timeslotList</code> field with all time slots</p>
<div class="ulist">
<ul>
<li>
<p>This is a list of problem facts, because they do not change during solving.</p>
</li>
</ul>
</div>
</li>
<li>
<p>A <code>roomList</code> field with all rooms</p>
<div class="ulist">
<ul>
<li>
<p>This is a list of problem facts, because they do not change during solving.</p>
</li>
</ul>
</div>
</li>
<li>
<p>A <code>lessonList</code> field with all lessons</p>
<div class="ulist">
<ul>
<li>
<p>This is a list of planning entities, because they change during solving.</p>
</li>
<li>
<p>Of each <code>Lesson</code>:</p>
<div class="ulist">
<ul>
<li>
<p>The values of the <code>timeslot</code> and <code>room</code> fields are typically still <code>null</code>, so unassigned.
They are planning variables.</p>
</li>
<li>
<p>The other fields, such as <code>subject</code>, <code>teacher</code> and <code>studentGroup</code>, are filled in.
These fields are problem properties.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>However, this class is also the output of the solution:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>lessonList</code> field for which each <code>Lesson</code> instance has non-null <code>timeslot</code> and <code>room</code> fields after solving</p>
</li>
<li>
<p>A <code>score</code> field that represents the quality of the output solution, for example, <code>0hard/-5soft</code></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_the_value_range_providers"><a class="anchor" href="#_the_value_range_providers"></a><a class="link" href="#_the_value_range_providers">2.3.6.1. The value range providers</a></h5>
<div class="paragraph">
<p>That <code>timeslotList</code> field is a value range provider.
It holds the <code>Timeslot</code> instances which OptaPlanner can pick from to assign to the <code>timeslot</code> field of <code>Lesson</code> instances.
The <code>timeslotList</code> field has an <code>@ValueRangeProvider</code> annotation to connect those two,
by matching the <code>id</code> with the <code>valueRangeProviderRefs</code> of the <code>@PlanningVariable</code> in the <code>Lesson</code>.</p>
</div>
<div class="paragraph">
<p>Following the same logic, the <code>roomList</code> field also has an <code>@ValueRangeProvider</code> annotation.</p>
</div>
</div>
<div class="sect4">
<h5 id="_the_problem_fact_and_planning_entity_properties"><a class="anchor" href="#_the_problem_fact_and_planning_entity_properties"></a><a class="link" href="#_the_problem_fact_and_planning_entity_properties">2.3.6.2. The problem fact and planning entity properties</a></h5>
<div class="paragraph">
<p>Furthermore, OptaPlanner needs to know which <code>Lesson</code> instances it can change
as well as how to retrieve the <code>Timeslot</code> and <code>Room</code> instances used for score calculation
by your <code>TimeTableConstraintProvider</code>.</p>
</div>
<div class="paragraph">
<p>The <code>timeslotList</code> and <code>roomList</code> fields have an <code>@ProblemFactCollectionProperty</code> annotation,
so your <code>TimeTableConstraintProvider</code> can select <em>from</em> those instances.</p>
</div>
<div class="paragraph">
<p>The <code>lessonList</code> has an <code>@PlanningEntityCollectionProperty</code> annotation,
so OptaPlanner can change them during solving
and your <code>TimeTableConstraintProvider</code> can select <em>from</em> those too.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_create_the_solver_service"><a class="anchor" href="#_create_the_solver_service"></a><a class="link" href="#_create_the_solver_service">2.3.7. Create the solver service</a></h4>
<div class="paragraph">
<p>Now you are ready to put everything together and create a REST service.
But solving planning problems on REST threads causes HTTP timeout issues.
Therefore, the Spring Boot starter injects a <code>SolverManager</code>,
which runs solvers in a separate thread pool
and can solve multiple datasets in parallel.</p>
</div>
<div class="paragraph">
<p>Create the <code>src/main/java/com/example/solver/TimeTableController.java</code> class:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.example.solver;

import java.util.UUID;
import java.util.concurrent.ExecutionException;

import com.example.domain.TimeTable;
import org.optaplanner.core.api.solver.SolverJob;
import org.optaplanner.core.api.solver.SolverManager;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/timeTable")
public class TimeTableController {

    @Autowired
    private SolverManager&lt;TimeTable, UUID&gt; solverManager;

    @PostMapping("/solve")
    public TimeTable solve(@RequestBody TimeTable problem) {
        UUID problemId = UUID.randomUUID();
        // Submit the problem to start solving
        SolverJob&lt;TimeTable, UUID&gt; solverJob = solverManager.solve(problemId, problem);
        TimeTable solution;
        try {
            // Wait until the solving ends
            solution = solverJob.getFinalBestSolution();
        } catch (InterruptedException | ExecutionException e) {
            throw new IllegalStateException("Solving failed.", e);
        }
        return solution;
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>For simplicity&#8217;s sake, this initial implementation waits for the solver to finish,
which can still cause an HTTP timeout.
The <em>complete</em> implementation avoids HTTP timeouts much more elegantly.</p>
</div>
</div>
<div class="sect3">
<h4 id="_set_the_termination_time"><a class="anchor" href="#_set_the_termination_time"></a><a class="link" href="#_set_the_termination_time">2.3.8. Set the termination time</a></h4>
<div class="paragraph">
<p>Without a termination setting or a termination event, the solver runs forever.
To avoid that, limit the solving time to five seconds.
That is short enough to avoid the HTTP timeout.</p>
</div>
<div class="paragraph">
<p>Create the <code>src/main/resources/application.properties</code> file:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs"># The solver runs only for 5 seconds to avoid a HTTP timeout in this simple implementation.
# It's recommended to run for at least 5 minutes ("5m") otherwise.
optaplanner.solver.termination.spent-limit=5s</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_make_the_application_executable"><a class="anchor" href="#_make_the_application_executable"></a><a class="link" href="#_make_the_application_executable">2.3.9. Make the application executable</a></h4>
<div class="paragraph">
<p>Package everything into a single, executable JAR file driven by a standard Java <code>main()</code> method:</p>
</div>
<div class="paragraph">
<p>Replace the <code>DemoApplication.java</code> class created by Spring Initializr
with the <code>src/main/java/com/example/TimeTableSpringBootApp.java</code> class:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.example;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class TimeTableSpringBootApp {

    public static void main(String[] args) {
        SpringApplication.run(TimeTableSpringBootApp.class, args);
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Run that class as the main class of a normal Java application.</p>
</div>
<div class="sect4">
<h5 id="_try_the_application"><a class="anchor" href="#_try_the_application"></a><a class="link" href="#_try_the_application">2.3.9.1. Try the application</a></h5>
<div class="paragraph">
<p>Now that the application is running, you can test the REST service.
You can use any REST client you wish.
The following example uses the Linux command <code>curl</code> to send a POST request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ curl -i -X POST http://localhost:8080/timeTable/solve -H "Content-Type:application/json" -d '{"timeslotList":[{"dayOfWeek":"MONDAY","startTime":"08:30:00","endTime":"09:30:00"},{"dayOfWeek":"MONDAY","startTime":"09:30:00","endTime":"10:30:00"}],"roomList":[{"name":"Room A"},{"name":"Room B"}],"lessonList":[{"id":1,"subject":"Math","teacher":"A. Turing","studentGroup":"9th grade"},{"id":2,"subject":"Chemistry","teacher":"M. Curie","studentGroup":"9th grade"},{"id":3,"subject":"French","teacher":"M. Curie","studentGroup":"10th grade"},{"id":4,"subject":"History","teacher":"I. Jones","studentGroup":"10th grade"}]}'</pre>
</div>
</div>
<div class="paragraph">
<p>After about five seconds, according to the termination spent time defined in your <code>application.properties</code>,
the service returns an output similar to the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>HTTP/1.1 200
Content-Type: application/json
...

{"timeslotList":...,"roomList":...,"lessonList":[{"id":1,"subject":"Math","teacher":"A. Turing","studentGroup":"9th grade","timeslot":{"dayOfWeek":"MONDAY","startTime":"08:30:00","endTime":"09:30:00"},"room":{"name":"Room A"}},{"id":2,"subject":"Chemistry","teacher":"M. Curie","studentGroup":"9th grade","timeslot":{"dayOfWeek":"MONDAY","startTime":"09:30:00","endTime":"10:30:00"},"room":{"name":"Room A"}},{"id":3,"subject":"French","teacher":"M. Curie","studentGroup":"10th grade","timeslot":{"dayOfWeek":"MONDAY","startTime":"08:30:00","endTime":"09:30:00"},"room":{"name":"Room B"}},{"id":4,"subject":"History","teacher":"I. Jones","studentGroup":"10th grade","timeslot":{"dayOfWeek":"MONDAY","startTime":"09:30:00","endTime":"10:30:00"},"room":{"name":"Room B"}}],"score":"0hard/0soft"}</pre>
</div>
</div>
<div class="paragraph">
<p>Notice that your application assigned all four lessons to one of the two time slots and one of the two rooms.
Also notice that it conforms to all hard constraints.
For example, M. Curie&#8217;s two lessons are in different time slots.</p>
</div>
<div class="paragraph">
<p>On the server side, the <code>info</code> log show what OptaPlanner did in those five seconds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">... Solving started: time spent (33), best score (-8init/0hard/0soft), environment mode (REPRODUCIBLE), random (JDK with seed 0).
... Construction Heuristic phase (0) ended: time spent (73), best score (0hard/0soft), score calculation speed (459/sec), step total (4).
... Local Search phase (1) ended: time spent (5000), best score (0hard/0soft), score calculation speed (28949/sec), step total (28398).
... Solving ended: time spent (5000), best score (0hard/0soft), score calculation speed (28524/sec), phase total (2), environment mode (REPRODUCIBLE).</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_test_the_application"><a class="anchor" href="#_test_the_application"></a><a class="link" href="#_test_the_application">2.3.9.2. Test the application</a></h5>
<div class="paragraph">
<p>A good application includes test coverage.
In a JUnit test, generate a test dataset and send it to the <code>TimeTableController</code> to solve.</p>
</div>
<div class="paragraph">
<p>Create the <code>src/test/java/com/example/solver/TimeTableControllerTest.java</code> class:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.example.solver;

import java.time.DayOfWeek;
import java.time.LocalTime;
import java.util.ArrayList;
import java.util.List;

import com.example.domain.Lesson;
import com.example.domain.Room;
import com.example.domain.TimeTable;
import com.example.domain.Timeslot;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.Timeout;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertTrue;

@SpringBootTest(properties = {
        "optaplanner.solver.termination.spent-limit=1h", // Effectively disable this termination in favor of the best-score-limit
        "optaplanner.solver.termination.best-score-limit=0hard/*soft"})
public class TimeTableControllerTest {

    @Autowired
    private TimeTableController timeTableController;

    @Test
    @Timeout(600_000)
    public void solve() {
        TimeTable problem = generateProblem();
        TimeTable solution = timeTableController.solve(problem);
        assertFalse(solution.getLessonList().isEmpty());
        for (Lesson lesson : solution.getLessonList()) {
            assertNotNull(lesson.getTimeslot());
            assertNotNull(lesson.getRoom());
        }
        assertTrue(solution.getScore().isFeasible());
    }

    private TimeTable generateProblem() {
        List&lt;Timeslot&gt; timeslotList = new ArrayList&lt;&gt;();
        timeslotList.add(new Timeslot(DayOfWeek.MONDAY, LocalTime.of(8, 30), LocalTime.of(9, 30)));
        timeslotList.add(new Timeslot(DayOfWeek.MONDAY, LocalTime.of(9, 30), LocalTime.of(10, 30)));
        timeslotList.add(new Timeslot(DayOfWeek.MONDAY, LocalTime.of(10, 30), LocalTime.of(11, 30)));
        timeslotList.add(new Timeslot(DayOfWeek.MONDAY, LocalTime.of(13, 30), LocalTime.of(14, 30)));
        timeslotList.add(new Timeslot(DayOfWeek.MONDAY, LocalTime.of(14, 30), LocalTime.of(15, 30)));

        List&lt;Room&gt; roomList = new ArrayList&lt;&gt;();
        roomList.add(new Room("Room A"));
        roomList.add(new Room("Room B"));
        roomList.add(new Room("Room C"));

        List&lt;Lesson&gt; lessonList = new ArrayList&lt;&gt;();
        lessonList.add(new Lesson(101L, "Math", "B. May", "9th grade"));
        lessonList.add(new Lesson(102L, "Physics", "M. Curie", "9th grade"));
        lessonList.add(new Lesson(103L, "Geography", "M. Polo", "9th grade"));
        lessonList.add(new Lesson(104L, "English", "I. Jones", "9th grade"));
        lessonList.add(new Lesson(105L, "Spanish", "P. Cruz", "9th grade"));

        lessonList.add(new Lesson(201L, "Math", "B. May", "10th grade"));
        lessonList.add(new Lesson(202L, "Chemistry", "M. Curie", "10th grade"));
        lessonList.add(new Lesson(203L, "History", "I. Jones", "10th grade"));
        lessonList.add(new Lesson(204L, "English", "P. Cruz", "10th grade"));
        lessonList.add(new Lesson(205L, "French", "M. Curie", "10th grade"));
        return new TimeTable(timeslotList, roomList, lessonList);
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This test verifies that after solving, all lessons are assigned to a time slot and a room.
It also verifies that it found a feasible solution (no hard constraints broken).</p>
</div>
<div class="paragraph">
<p>Normally, the solver finds a feasible solution in less than 200 milliseconds.
Notice how the <code>@SpringBootTest</code> annotation&#8217;s <code>properties</code> overwrites the solver termination
to terminate as soon as a feasible solution (<code>0hard/*soft</code>) is found.
This avoids hard coding a solver time, because the unit test might run on arbitrary hardware.
This approach ensures that the test runs long enough to find a feasible solution, even on slow machines.
But it does not run a millisecond longer than it strictly must, even on fast machines.</p>
</div>
</div>
<div class="sect4">
<h5 id="_logging"><a class="anchor" href="#_logging"></a><a class="link" href="#_logging">2.3.9.3. Logging</a></h5>
<div class="paragraph">
<p>When adding constraints in your <code>ConstraintProvider</code>,
keep an eye on the <em>score calculation speed</em> in the <code>info</code> log,
after solving for the same amount of time, to assess the performance impact:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>... Solving ended: ..., score calculation speed (29455/sec), ...</pre>
</div>
</div>
<div class="paragraph">
<p>To understand how OptaPlanner is solving your problem internally,
change the logging in the <code>application.properties</code> file or with a <code>-D</code> system property:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">logging.level.org.optaplanner=debug</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Use <code>debug</code> logging to show every <em>step</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">... Solving started: time spent (67), best score (-20init/0hard/0soft), environment mode (REPRODUCIBLE), random (JDK with seed 0).
...     CH step (0), time spent (128), score (-18init/0hard/0soft), selected move count (15), picked move ([Math(101) {null -&gt; Room A}, Math(101) {null -&gt; MONDAY 08:30}]).
...     CH step (1), time spent (145), score (-16init/0hard/0soft), selected move count (15), picked move ([Physics(102) {null -&gt; Room A}, Physics(102) {null -&gt; MONDAY 09:30}]).
...</pre>
</div>
</div>
<div class="paragraph">
<p>Use <code>trace</code> logging to show every <em>step</em> and every <em>move</em> per step.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_summary"><a class="anchor" href="#_summary"></a><a class="link" href="#_summary">2.3.10. Summary</a></h4>
<div class="paragraph">
<p>Congratulations!
You have just developed a <a href="https://spring.io/">Spring</a> application with <a href="https://www.optaplanner.org/">OptaPlanner</a>!</p>
</div>
</div>
<div class="sect3">
<h4 id="_further_improvements_database_and_ui_integration"><a class="anchor" href="#_further_improvements_database_and_ui_integration"></a><a class="link" href="#_further_improvements_database_and_ui_integration">2.3.11. Further improvements: Database and UI integration</a></h4>
<div class="paragraph">
<p>Now try adding database and UI integration:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create <a href="https://spring.io/guides/gs/accessing-data-jpa/">JPA repositories</a> for <code>Timeslot</code>, <code>Room</code>, and <code>Lesson</code>.</p>
</li>
<li>
<p><a href="https://spring.io/guides/gs/accessing-data-rest/">Expose them through REST</a>.</p>
</li>
<li>
<p>Build a <code>TimeTableRepository</code> facade to read and write a <code>TimeTable</code> in a single transaction.</p>
</li>
<li>
<p>Adjust the <code>TimeTableController</code> accordingly:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.example.solver;

import com.example.domain.TimeTable;
import com.example.persistence.TimeTableRepository;
import org.optaplanner.core.api.score.ScoreManager;
import org.optaplanner.core.api.solver.SolverManager;
import org.optaplanner.core.api.solver.SolverStatus;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/timeTable")
public class TimeTableController {

    @Autowired
    private TimeTableRepository timeTableRepository;
    @Autowired
    private SolverManager&lt;TimeTable, Long&gt; solverManager;
    @Autowired
    private ScoreManager&lt;TimeTable&gt; scoreManager;

    // To try, GET http://localhost:8080/timeTable
    @GetMapping()
    public TimeTable getTimeTable() {
        // Get the solver status before loading the solution
        // to avoid the race condition that the solver terminates between them
        SolverStatus solverStatus = getSolverStatus();
        TimeTable solution = timeTableRepository.findById(TimeTableRepository.SINGLETON_TIME_TABLE_ID);
        scoreManager.updateScore(solution); // Sets the score
        solution.setSolverStatus(solverStatus);
        return solution;
    }

    @PostMapping("/solve")
    public void solve() {
        solverManager.solveAndListen(TimeTableRepository.SINGLETON_TIME_TABLE_ID,
                timeTableRepository::findById,
                timeTableRepository::save);
    }

    public SolverStatus getSolverStatus() {
        return solverManager.getSolverStatus(TimeTableRepository.SINGLETON_TIME_TABLE_ID);
    }

    @PostMapping("/stopSolving")
    public void stopSolving() {
        solverManager.terminateEarly(TimeTableRepository.SINGLETON_TIME_TABLE_ID);
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>For simplicity&#8217;s sake, this code handles only one <code>TimeTable</code>,
but it is straightforward to enable multi-tenancy and handle multiple <code>TimeTable</code> instances of different high schools in parallel.</p>
</div>
<div class="paragraph">
<p>The <code>getTimeTable()</code> method returns the latest time table from the database.
It uses the <code>ScoreManager</code> (which is automatically injected)
to calculate the score of that time table, so the UI can show the score.</p>
</div>
<div class="paragraph">
<p>The <code>solve()</code> method starts a job to solve the current time table and store the time slot and room assignments in the database.
It uses the <code>SolverManager.solveAndListen()</code> method to listen to intermediate best solutions
and update the database accordingly.
This enables the UI to show progress while the backend is still solving.</p>
</div>
</li>
<li>
<p>Adjust the <code>TimeTableControllerTest</code> accordingly, now that the <code>solve()</code> method returns immediately.
Poll for the latest solution until the solver finishes solving:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.example.solver;

import com.example.domain.Lesson;
import com.example.domain.TimeTable;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.Timeout;
import org.optaplanner.core.api.solver.SolverStatus;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertTrue;

@SpringBootTest(properties = {
        "optaplanner.solver.termination.spent-limit=1h", // Effectively disable this termination in favor of the best-score-limit
        "optaplanner.solver.termination.best-score-limit=0hard/*soft"})
public class TimeTableControllerTest {

    @Autowired
    private TimeTableController timeTableController;

    @Test
    @Timeout(600_000)
    public void solveDemoDataUntilFeasible() throws InterruptedException {
        timeTableController.solve();
        TimeTable timeTable = timeTableController.getTimeTable();
        while (timeTable.getSolverStatus() != SolverStatus.NOT_SOLVING) {
            // Quick polling (not a Test Thread Sleep anti-pattern)
            // Test is still fast on fast machines and doesn't randomly fail on slow machines.
            Thread.sleep(20L);
            timeTable = timeTableController.getTimeTable();
        }
        assertFalse(timeTable.getLessonList().isEmpty());
        for (Lesson lesson : timeTable.getLessonList()) {
            assertNotNull(lesson.getTimeslot());
            assertNotNull(lesson.getRoom());
        }
        assertTrue(timeTable.getScore().isFeasible());
    }

}</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Build an attractive web UI on top of these REST methods to visualize the timetable.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Take a look at the example&#8217;s source code to see how this all turns out.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="plainJavaQuickStart"><a class="anchor" href="#plainJavaQuickStart"></a><a class="link" href="#plainJavaQuickStart">2.4. Java quick start</a></h3>
<div class="sect3">
<h4 id="cloudBalancingTutorial"><a class="anchor" href="#cloudBalancingTutorial"></a><a class="link" href="#cloudBalancingTutorial">2.4.1. Cloud balancing tutorial</a></h4>
<div class="sect4">
<h5 id="cloudBalancingProblemDescription"><a class="anchor" href="#cloudBalancingProblemDescription"></a><a class="link" href="#cloudBalancingProblemDescription">2.4.1.1. Problem description</a></h5>
<div class="paragraph">
<p>Suppose your company owns a number of cloud computers and needs to run a number of processes on those computers.
Assign each process to a computer.</p>
</div>
<div class="paragraph">
<p>The following hard constraints must be fulfilled:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Every computer must be able to handle the minimum hardware requirements of the sum of its processes:</p>
<div class="ulist">
<ul>
<li>
<p><strong>CPU capacity</strong>: The CPU power of a computer must be at least the sum of the CPU power required by the processes assigned to that computer.</p>
</li>
<li>
<p><strong>Memory capacity</strong>: The RAM memory of a computer must be at least the sum of the RAM memory required by the processes assigned to that computer.</p>
</li>
<li>
<p><strong>Network capacity</strong>: The network bandwidth of a computer must be at least the sum of the network bandwidth required by the processes assigned to that computer.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following soft constraints should be optimized:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each computer that has one or more processes assigned, incurs a maintenance cost (which is fixed per computer).</p>
<div class="ulist">
<ul>
<li>
<p><strong>Cost</strong>: Minimize the total maintenance cost.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>This problem is a form of <em>bin packing</em>.
The following is a simplified example, in which we assign four processes to two computers with two constraints (CPU and RAM) with a simple algorithm:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./QuickStart/PlainJava/CloudBalancingTutorial/cloudBalanceUseCase.png" alt="cloudBalanceUseCase">
</div>
</div>
<div class="paragraph">
<p>The simple algorithm used here is the <em>First Fit Decreasing</em> algorithm, which assigns the bigger processes first and assigns the smaller processes to the remaining space.
As you can see, it is not optimal, as it does not leave enough room to assign the yellow process <code>D</code>.</p>
</div>
<div class="paragraph">
<p>OptaPlanner does find the more optimal solution by using additional, smarter algorithms.
It also scales: both in data (more processes, more computers) and constraints (more hardware requirements, other constraints).
So let&#8217;s see how OptaPlanner can be used in this scenario.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an executive summary of this example and <a href="#machineReassignment">an advanced implementation with more constraints</a>:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./QuickStart/PlainJava/CloudBalancingTutorial/cloudOptimizationValueProposition.png" alt="cloudOptimizationValueProposition">
</div>
</div>
</div>
<div class="sect4">
<h5 id="cloudBalancingProblemSize"><a class="anchor" href="#cloudBalancingProblemSize"></a><a class="link" href="#cloudBalancingProblemSize">2.4.1.2. Problem size</a></h5>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Cloud Balancing Problem Size</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Problem Size</th>
<th class="tableblock halign-left valign-top">Computers</th>
<th class="tableblock halign-left valign-top">Processes</th>
<th class="tableblock halign-left valign-top">Search Space</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2computers-6processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3computers-9processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10^4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4computers-012processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10^7</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">100computers-300processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">300</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10^600</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">200computers-600processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">600</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10^1380</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">400computers-1200processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">400</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10^3122</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">800computers-2400processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">800</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2400</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10^6967</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="cloudBalancingDomainModel"><a class="anchor" href="#cloudBalancingDomainModel"></a><a class="link" href="#cloudBalancingDomainModel">2.4.2. Using the domain model</a></h4>
<div class="sect4">
<h5 id="cloudBalancingDomainModelDesign"><a class="anchor" href="#cloudBalancingDomainModelDesign"></a><a class="link" href="#cloudBalancingDomainModelDesign">2.4.2.1. Domain model design</a></h5>
<div class="paragraph">
<p>Using a <a href="#domainModelingGuide">domain model</a> helps determine which classes are planning entities and which of their properties are planning variables. It also helps to simplify constraints, improve performance, and increase flexibility for future needs.</p>
</div>
<div class="paragraph">
<p>To create a domain model, define all the objects that represent the input data for the problem. In this simple example, the objects are processes and computers.</p>
</div>
<div class="paragraph">
<p>A separate object in the domain model must represent a full data set of problem, which contains the input data as well as a solution. In this example, this object holds a list of computers and a list of processes. Each process is assigned to a computer; the distribution of processes between computers is the solution.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Draw a class diagram of your domain model.</p>
</li>
<li>
<p>Normalize it to remove duplicate data.</p>
</li>
<li>
<p>Write down some sample instances for each class.</p>
<div class="ulist">
<ul>
<li>
<p><code>Computer</code>: represents a computer with certain hardware and maintenance costs.</p>
<div class="paragraph">
<p>In this example, the sample instances for the <code>Computer</code> class are: <code>cpuPower</code>, <code>memory</code>, <code>networkBandwidth</code>, <code>cost</code>.</p>
</div>
</li>
<li>
<p><code>Process</code>: represents a process with a demand. Needs to be assigned to a <code>Computer</code> by OptaPlanner.</p>
<div class="paragraph">
<p>Sample instances for <code>Process</code> are: <code>requiredCpuPower</code>, <code>requiredMemory</code>, and <code>requiredNetworkBandwidth</code>.</p>
</div>
</li>
<li>
<p><code>CloudBalance</code>: represents a problem. Contains every <code>Computer</code> and <code>Process</code> for a certain data set.</p>
<div class="paragraph">
<p>For an object representing the full data set and solution, a sample instance holding the <em>score</em> must be present. OptaPlanner can calculate and compare the scores for different solutions; the solution with the highest score is the optimal solution. Therefore, the sample instance for <code>CloudBalance</code> is <code>score</code>.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Determine which relationships (or fields) change during planning.</p>
<div class="ulist">
<ul>
<li>
<p><em>Planning entity</em>: The class (or classes) that OptaPlanner can change during solving. In this example, it is the class <code>Process</code>, because OptaPlanner can assign processes to computers.</p>
</li>
<li>
<p><em>Problem fact</em>: A class representing input data that OptaPlanner can not change.</p>
</li>
<li>
<p><em>Planning variable</em>: The property (or properties) of a planning entity class that changes during solving. In this example, it is the property <code>computer</code> on the class <code>Process</code>.</p>
</li>
<li>
<p><em>Planning solution</em>: The class that represents a solution to the problem. This class must represent the full data set and contain all planning entities. In this example that is the class <code>CloudBalance</code>.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>In the UML class diagram below, the OptaPlanner concepts are already annotated:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./QuickStart/PlainJava/CloudBalancingDomainModel/cloudBalanceClassDiagram.png" alt="cloudBalanceClassDiagram">
</div>
</div>
</div>
<div class="sect4">
<h5 id="cloudBalancingDomainModelImplementation"><a class="anchor" href="#cloudBalancingDomainModelImplementation"></a><a class="link" href="#cloudBalancingDomainModelImplementation">2.4.2.2. Domain model implementation</a></h5>
<div class="sect5">
<h6 id="cloudBalancingClassComputer"><a class="anchor" href="#cloudBalancingClassComputer"></a><a class="link" href="#cloudBalancingClassComputer">2.4.2.2.1. The <code>Computer</code> class</a></h6>
<div class="paragraph">
<p>The <code>Computer</code> class is a POJO (Plain Old Java Object). Usually, you will have more of this kind of classes with input data.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. CloudComputer.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class CloudComputer ... {

    private int cpuPower;
    private int memory;
    private int networkBandwidth;
    private int cost;

    ... // getters
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="cloudBalancingClassProcess"><a class="anchor" href="#cloudBalancingClassProcess"></a><a class="link" href="#cloudBalancingClassProcess">2.4.2.2.2. The <code>Process</code> class</a></h6>
<div class="paragraph">
<p>The <code>Process</code> class is particularly important. It is the class that is modified during solving.</p>
</div>
<div class="paragraph">
<p>We need to tell OptaPlanner that it can change the property <code>computer</code>. To do this:
. Annotate the class with <code>@PlanningEntity</code>.
. Annotate the getter <code>getComputer()</code> with <code>@PlanningVariable</code>.</p>
</div>
<div class="paragraph">
<p>Of course, the property <code>computer</code> needs a setter too, so OptaPlanner can change it during solving.</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. CloudProcess.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningEntity(...)
public class CloudProcess ... {

    private int requiredCpuPower;
    private int requiredMemory;
    private int requiredNetworkBandwidth;

    private CloudComputer computer;

    ... // getters

    @PlanningVariable(valueRangeProviderRefs = {"computerRange"})
    public CloudComputer getComputer() {
        return computer;
    }

    public void setComputer(CloudComputer computer) {
        computer = computer;
    }

    // ************************************************************************
    // Complex methods
    // ************************************************************************

    ...

}</code></pre>
</div>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>OptaPlanner needs to know which values it can choose from to assign to the property <code>computer</code>. Those values are retrieved from the method <code>CloudBalance.getComputerList()</code> on the planning solution, which returns a list of all computers in the current data set.</p>
</li>
<li>
<p>The <code>@PlanningVariable</code>'s <code>valueRangeProviderRefs</code> parameter on <code>CloudProcess.getComputer()</code> needs to match with the <code>@ValueRangeProvider</code>'s <code>id</code> on <code>CloudBalance.getComputerList()</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Instead of getter annotations, it is also possible to use <a href="#annotationAlternatives">field annotations</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="cloudBalancingClassCloudBalance"><a class="anchor" href="#cloudBalancingClassCloudBalance"></a><a class="link" href="#cloudBalancingClassCloudBalance">2.4.2.2.3. The <code>CloudBalance</code> class</a></h6>
<div class="paragraph">
<p>The <code>CloudBalance</code> class has a <em class="path">@PlanningSolution</em>
 annotation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It holds a list of all computers and a list of all processes.</p>
</li>
<li>
<p>It represents both the planning problem and (if it is initialized) the planning solution.</p>
</li>
<li>
<p>To save a solution, OptaPlanner initializes a new instance of the class.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>processList</code> property holds a list of processes. OptaPlanner can change the processes, allocating them to different computers. Therefore, a process is a planning entity and the list of processes is a collection of planning entities. We annotate the getter <code>getProcessList()</code> with <code>@PlanningEntityCollectionProperty</code>.</p>
</li>
<li>
<p>The <code>computerList</code> property holds a list of computers. OptaPlanner can not change the computers. Therefore, a computer is a problem fact. Especially for score calculation with Drools, the property <code>computerList</code> needs to be annotated with a <code>@ProblemFactCollectionProperty</code> so that OptaPlanner can retrieve the list of computers (problem facts) and make it available to the Drools engine.</p>
</li>
<li>
<p>The <code>CloudBalance</code> class also has a <code>@PlanningScore</code> annotated property <code>score</code>, which is the <code>Score</code> of that solution in its current state.
OptaPlanner automatically updates it when it calculates a <code>Score</code> for a solution instance. Therefore, this property needs a setter.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">Example 3. CloudBalance.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
public class CloudBalance ... {

    private List&lt;CloudComputer&gt; computerList;

    private List&lt;CloudProcess&gt; processList;

    private HardSoftScore score;

    @ValueRangeProvider(id = "computerRange")
    @ProblemFactCollectionProperty
    public List&lt;CloudComputer&gt; getComputerList() {
        return computerList;
    }

    @PlanningEntityCollectionProperty
    public List&lt;CloudProcess&gt; getProcessList() {
        return processList;
    }

    @PlanningScore
    public HardSoftScore getScore() {
        return score;
    }

    public void setScore(HardSoftScore score) {
        this.score = score;
    }

    ...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cloudBalancingMainMethod"><a class="anchor" href="#cloudBalancingMainMethod"></a><a class="link" href="#cloudBalancingMainMethod">2.4.3. Run the cloud balancing Hello World</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#runTheExamplesInAnIDE">Download and configure the examples in your preferred IDE.</a></p>
</li>
<li>
<p>Create a run configuration with the following main class: <code>org.optaplanner.examples.cloudbalancing.app.CloudBalancingHelloWorld</code></p>
<div class="paragraph">
<p>By default, the Cloud Balancing Hello World is configured to run for 120 seconds.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>It will execute the following code:</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. CloudBalancingHelloWorld.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class CloudBalancingHelloWorld {

    public static void main(String[] args) {
        // Build the Solver
        SolverFactory&lt;CloudBalance&gt; solverFactory = SolverFactory.createFromXmlResource(
                "org/optaplanner/examples/cloudbalancing/solver/cloudBalancingSolverConfig.xml");
        Solver&lt;CloudBalance&gt; solver = solverFactory.buildSolver();

        // Load a problem with 400 computers and 1200 processes
        CloudBalance unsolvedCloudBalance = new CloudBalancingGenerator().createCloudBalance(400, 1200);

        // Solve the problem
        CloudBalance solvedCloudBalance = solver.solve(unsolvedCloudBalance);

        // Display the result
        System.out.println("\nSolved cloudBalance with 400 computers and 1200 processes:\n"
                + toDisplayString(solvedCloudBalance));
    }

    ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The code example does the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Build the <code>Solver</code> based on a solver configuration (in this case <a href="#solverConfigurationByXML">an XML file</a>, <code>cloudBalancingSolverConfig.xml</code>, from the classpath).</p>
<div class="paragraph">
<p>Building the <code>Solver</code> is the most complicated part of this procedure. For more detail, see <a href="#cloudBalancingSolverConfiguration">Solver Configuration</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">        SolverFactory&lt;CloudBalance&gt; solverFactory = SolverFactory.createFromXmlResource(
                "org/optaplanner/examples/cloudbalancing/solver/cloudBalancingSolverConfig.xml");
        Solver&lt;CloudBalance&gt; solver = solverFactory.buildSolver();</code></pre>
</div>
</div>
</li>
<li>
<p>Load the problem.</p>
<div class="paragraph">
<p><code>CloudBalancingGenerator</code> generates a random problem: you will replace this with a class that loads a real problem, for example from a database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">        CloudBalance unsolvedCloudBalance = new CloudBalancingGenerator().createCloudBalance(400, 1200);</code></pre>
</div>
</div>
</li>
<li>
<p>Solve the problem.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">        CloudBalance solvedCloudBalance = solver.solve(unsolvedCloudBalance);</code></pre>
</div>
</div>
</li>
<li>
<p>Display the result.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">        System.out.println("\nSolved cloudBalance with 400 computers and 1200 processes:\n"
                + toDisplayString(solvedCloudBalance));</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="cloudBalancingSolverConfiguration"><a class="anchor" href="#cloudBalancingSolverConfiguration"></a><a class="link" href="#cloudBalancingSolverConfiguration">2.4.4. Solver configuration</a></h4>
<div class="paragraph">
<p>The solver configuration file determines how the solving process works; it is considered a part of the code.
The file is named <code>cloudBalancingSolverConfig.xml</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 5. cloudBalancingSolverConfig.xml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;solver&gt;
  &lt;!-- Domain model configuration --&gt;
  &lt;solutionClass&gt;org.optaplanner.examples.cloudbalancing.domain.CloudBalance&lt;/solutionClass&gt;
  &lt;entityClass&gt;org.optaplanner.examples.cloudbalancing.domain.CloudProcess&lt;/entityClass&gt;

  &lt;!-- Score configuration --&gt;
  &lt;scoreDirectorFactory&gt;
    &lt;easyScoreCalculatorClass&gt;org.optaplanner.examples.cloudbalancing.optional.score.CloudBalancingEasyScoreCalculator&lt;/easyScoreCalculatorClass&gt;
    &lt;!--&lt;scoreDrl&gt;org/optaplanner/examples/cloudbalancing/solver/cloudBalancingConstraints.drl&lt;/scoreDrl&gt;--&gt;
  &lt;/scoreDirectorFactory&gt;

  &lt;!-- Optimization algorithms configuration --&gt;
  &lt;termination&gt;
    &lt;secondsSpentLimit&gt;30&lt;/secondsSpentLimit&gt;
  &lt;/termination&gt;
&lt;/solver&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This solver configuration consists of three parts:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Domain model configuration</strong>: <em>What can OptaPlanner change?</em></p>
<div class="paragraph">
<p>We need to make OptaPlanner aware of our domain classes, annotated with <code>@PlanningEntity</code> and <code>@PlanningSolution</code> annotations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;solutionClass&gt;org.optaplanner.examples.cloudbalancing.domain.CloudBalance&lt;/solutionClass&gt;
  &lt;entityClass&gt;org.optaplanner.examples.cloudbalancing.domain.CloudProcess&lt;/entityClass&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Score configuration</strong>: <em>How should OptaPlanner optimize the planning variables?
What is our goal?</em></p>
<div class="paragraph">
<p>Since we have hard and soft constraints, we use a <code>HardSoftScore</code>.
But we need to tell OptaPlanner how to calculate the score, depending on our business requirements.
Further down, we will look into two alternatives to calculate the score: using an easy Java implementation, or using Drools DRL.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;scoreDirectorFactory&gt;
    &lt;easyScoreCalculatorClass&gt;org.optaplanner.examples.cloudbalancing.optional.score.CloudBalancingEasyScoreCalculator&lt;/easyScoreCalculatorClass&gt;
    &lt;!--&lt;scoreDrl&gt;org/optaplanner/examples/cloudbalancing/solver/cloudBalancingConstraints.drl&lt;/scoreDrl&gt;--&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Optimization algorithms configuration</strong>: <em>How should OptaPlanner optimize it?</em></p>
<div class="paragraph">
<p>In this case, we use the default <a href="#optimizationAlgorithms">optimization algorithms</a> (because no explicit optimization algorithms are configured) for 30 seconds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;termination&gt;
    &lt;secondsSpentLimit&gt;30&lt;/secondsSpentLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>OptaPlanner should get a good result in seconds (and even in less than 15 milliseconds with
<a href="#realTimePlanning">real-time planning</a>), but the more time it has, the better the result will be.
Advanced use cases might use different <a href="#termination">termination criteria</a> than a hard time limit.</p>
</div>
<div class="paragraph">
<p>The default algorithms will already easily surpass human planners and most in-house implementations.
Use the <a href="#benchmarker">Benchmarker</a> to <a href="#powerTweaking">power tweak</a> to get even better results.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="cloudBalancingScoreConfiguration"><a class="anchor" href="#cloudBalancingScoreConfiguration"></a><a class="link" href="#cloudBalancingScoreConfiguration">2.4.5. Score configuration</a></h4>
<div class="paragraph">
<p>OptaPlanner searches for the solution with the highest <code>Score</code>.
This example uses a <code>HardSoftScore</code>, which means OptaPlanner looks for the solution with no hard constraints broken (fulfill hardware requirements) and as little as possible soft constraints broken (minimize maintenance cost).</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./QuickStart/PlainJava/CloudBalancingScoreConfiguration/scoreComparisonCloudBalancing.png" alt="scoreComparisonCloudBalancing">
</div>
</div>
<div class="paragraph">
<p>Of course, OptaPlanner needs to be told about these domain-specific score constraints.
There are several ways to implement such a score function:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#cloudBalancingEasyJavaScoreConfiguration">Easy Java</a></p>
</li>
<li>
<p>Incremental Java</p>
</li>
<li>
<p><a href="#cloudBalancingDroolsScoreConfiguration">Drools</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="cloudBalancingEasyJavaScoreConfiguration"><a class="anchor" href="#cloudBalancingEasyJavaScoreConfiguration"></a><a class="link" href="#cloudBalancingEasyJavaScoreConfiguration">2.4.5.1. Easy Java score configuration</a></h5>
<div class="paragraph">
<p>One way to define a score function is to implement the interface <code>EasyScoreCalculator</code> in plain Java.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;scoreDirectorFactory&gt;
    &lt;easyScoreCalculatorClass&gt;org.optaplanner.examples.cloudbalancing.optional.score.CloudBalancingEasyScoreCalculator&lt;/easyScoreCalculatorClass&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just implement the <code>calculateScore(Solution)</code> method to return a <code>HardSoftScore</code> instance.</p>
</div>
<div class="exampleblock">
<div class="title">Example 6. CloudBalancingEasyScoreCalculator.java</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class CloudBalancingEasyScoreCalculator implements EasyScoreCalculator&lt;CloudBalance&gt; {

    /**
     * A very simple implementation. The double loop can easily be removed by using Maps as shown in
     * {@link CloudBalancingMapBasedEasyScoreCalculator#calculateScore(CloudBalance)}.
     */
    public HardSoftScore calculateScore(CloudBalance cloudBalance) {
        int hardScore = 0;
        int softScore = 0;
        for (CloudComputer computer : cloudBalance.getComputerList()) {
            int cpuPowerUsage = 0;
            int memoryUsage = 0;
            int networkBandwidthUsage = 0;
            boolean used = false;

            // Calculate usage
            for (CloudProcess process : cloudBalance.getProcessList()) {
                if (computer.equals(process.getComputer())) {
                    cpuPowerUsage += process.getRequiredCpuPower();
                    memoryUsage += process.getRequiredMemory();
                    networkBandwidthUsage += process.getRequiredNetworkBandwidth();
                    used = true;
                }
            }

            // Hard constraints
            int cpuPowerAvailable = computer.getCpuPower() - cpuPowerUsage;
            if (cpuPowerAvailable &lt; 0) {
                hardScore += cpuPowerAvailable;
            }
            int memoryAvailable = computer.getMemory() - memoryUsage;
            if (memoryAvailable &lt; 0) {
                hardScore += memoryAvailable;
            }
            int networkBandwidthAvailable = computer.getNetworkBandwidth() - networkBandwidthUsage;
            if (networkBandwidthAvailable &lt; 0) {
                hardScore += networkBandwidthAvailable;
            }

            // Soft constraints
            if (used) {
                softScore -= computer.getCost();
            }
        }
        return HardSoftScore.valueOf(hardScore, softScore);
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Even if we optimize the code above to use <code>Map</code>s to iterate through the <code>processList</code> only once, <em>it is still slow</em> because it does not do <a href="#incrementalScoreCalculation">incremental score calculation</a>.
To fix that, either use incremental Java score calculation or Drools score calculation.</p>
</div>
</div>
<div class="sect4">
<h5 id="cloudBalancingDroolsScoreConfiguration"><a class="anchor" href="#cloudBalancingDroolsScoreConfiguration"></a><a class="link" href="#cloudBalancingDroolsScoreConfiguration">2.4.5.2. Drools score configuration</a></h5>
<div class="paragraph">
<p>Drools score calculation uses incremental calculation, where every score constraint is written as one or more score rules.</p>
</div>
<div class="paragraph">
<p>Using the Drools rule engine for score calculation, allows you to integrate with other Drools technologies, such as decision tables (XLS or web based), the KIE Workbench, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p><strong>Prerequisite</strong>
To use the Drools rule engine as a score function, simply add a <code>scoreDrl</code> resource in the classpath:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDrl&gt;org/optaplanner/examples/cloudbalancing/solver/cloudBalancingConstraints.drl&lt;/scoreDrl&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We want to make sure that all computers have enough CPU, RAM and network bandwidth to support all their processes, so we make these hard constraints:</p>
<div class="exampleblock">
<div class="title">Example 7. cloudBalancingConstraints.drl - Hard Constraints</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">...

import org.optaplanner.examples.cloudbalancing.domain.CloudBalance;
import org.optaplanner.examples.cloudbalancing.domain.CloudComputer;
import org.optaplanner.examples.cloudbalancing.domain.CloudProcess;

global HardSoftScoreHolder scoreHolder;

// ############################################################################
// Hard constraints
// ############################################################################

rule "requiredCpuPowerTotal"
    when
        $computer : CloudComputer($cpuPower : cpuPower)
        accumulate(
            CloudProcess(
                computer == $computer,
                $requiredCpuPower : requiredCpuPower);
            $requiredCpuPowerTotal : sum($requiredCpuPower);
            $requiredCpuPowerTotal &gt; $cpuPower
        )
    then
        scoreHolder.addHardConstraintMatch(kcontext, $cpuPower - $requiredCpuPowerTotal);
end

rule "requiredMemoryTotal"
    ...
end

rule "requiredNetworkBandwidthTotal"
    ...
end</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>If those constraints are met, we want to minimize the maintenance cost, so we add that as a soft constraint:</p>
<div class="exampleblock">
<div class="title">Example 8. cloudBalancingConstraints.drl - Soft Constraints</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">// ############################################################################
// Soft constraints
// ############################################################################

rule "computerCost"
    when
        $computer : CloudComputer($cost : cost)
        exists CloudProcess(computer == $computer)
    then
        scoreHolder.addSoftConstraintMatch(kcontext, - $cost);
end</code></pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cloudBalancingBeyondThisTutorial"><a class="anchor" href="#cloudBalancingBeyondThisTutorial"></a><a class="link" href="#cloudBalancingBeyondThisTutorial">2.4.6. Beyond this tutorial</a></h4>
<div class="paragraph">
<p>Now that this simple example works, you can try going further.
For example, you can enrich the domain model and add extra constraints such as these:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each <code>Process</code> belongs to a <code>Service</code>. A computer might crash, so processes running the same service must be assigned to different computers.</p>
</li>
<li>
<p>Each <code>Computer</code> is located in a <code>Building</code>. A building might burn down, so processes of the same services should (or must) be assigned to computers in different buildings.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="useCasesAndExamples"><a class="anchor" href="#useCasesAndExamples"></a><a class="link" href="#useCasesAndExamples">3. Use cases and examples</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="examplesOverview"><a class="anchor" href="#examplesOverview"></a><a class="link" href="#examplesOverview">3.1. Examples overview</a></h3>
<div class="paragraph">
<p>OptaPlanner has several examples.
In this manual we explain mainly using the <em>n</em> queens example and cloud balancing example.
So it is advisable to read at least those sections.</p>
</div>
<div class="paragraph">
<p>Some of the examples solve problems that are presented in academic contests.
The <code>Contest</code> column in the following table lists the contests.
It also identifies an example as being either <em>realistic</em> or <em>unrealistic</em> for the purpose of a contest.
A <em>realistic contest</em> is <em>an official, independent contest</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>that clearly defines a real-world use case.</p>
</li>
<li>
<p>with real-world constraints.</p>
</li>
<li>
<p>with multiple, real-world datasets.</p>
</li>
<li>
<p>that expects reproducible results within a specific time limit on specific hardware.</p>
</li>
<li>
<p>that has had serious participation from the academic and/or enterprise Operations Research community.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Realistic contests provide an objective comparison of OptaPlanner with competitive software and academic research.</p>
</div>
<div class="paragraph">
<p>The source code of all these examples is available in the distribution zip under <em class="path">examples/sources</em>
and also in git under <em class="path">optaplanner/optaplanner-examples</em>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Examples overview</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Example</th>
<th class="tableblock halign-left valign-top">Domain</th>
<th class="tableblock halign-left valign-top">Size</th>
<th class="tableblock halign-left valign-top">Contest</th>
<th class="tableblock halign-left valign-top">Special features used</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#nQueens">N queens</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
<div class="ulist">
<ul>
<li>
<p>1 variable</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>256</code></p>
</li>
<li>
<p>Value &#8656; <code>256</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^616</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Pointless (<a href="https://en.wikipedia.org/wiki/Eight_queens_puzzle#Explicit_solutions">cheatable</a>)</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>None</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#cloudBalancing">Cloud balancing</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
<div class="ulist">
<ul>
<li>
<p>1 variable</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>2400</code></p>
</li>
<li>
<p>Value &#8656; <code>800</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^6967</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>No</p>
</li>
<li>
<p>Defined by us</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><a href="#realTimePlanning">Real-time planning</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tsp">Traveling salesman</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
<div class="ulist">
<ul>
<li>
<p>1 chained variable</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>980</code></p>
</li>
<li>
<p>Value &#8656; <code>980</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^2504</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Unrealistic</p>
</li>
<li>
<p><a href="http://www.math.uwaterloo.ca/tsp/">TSP web</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><a href="#realTimePlanning">Real-time planning</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#dinnerParty">Dinner party</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
<div class="ulist">
<ul>
<li>
<p>1 variable</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>144</code></p>
</li>
<li>
<p>Value &#8656; <code>72</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^310</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Unrealistic</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Decision Table spreadsheet (XLS) for score constraints</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tennis">Tennis club scheduling</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
<div class="ulist">
<ul>
<li>
<p>1 variable</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>72</code></p>
</li>
<li>
<p>Value &#8656; <code>7</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^60</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>No</p>
</li>
<li>
<p>Defined by us</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><a href="#fairnessScoreConstraints">Fairness score constraints</a></p>
</li>
<li>
<p><a href="#pinnedPlanningEntities">Pinned entities</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#meetingScheduling">Meeting scheduling</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
<div class="ulist">
<ul>
<li>
<p>2 variables</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>10</code></p>
</li>
<li>
<p>Value &#8656; <code>320</code> and &#8656; <code>5</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^320</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>No</p>
</li>
<li>
<p>Defined by us</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><a href="#timeGrainPattern">TimeGrain pattern</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#curriculumCourse">Course timetabling</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
<div class="ulist">
<ul>
<li>
<p>2 variables</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>434</code></p>
</li>
<li>
<p>Value &#8656; <code>25</code> and &#8656; <code>20</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^1171</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Realistic</p>
</li>
<li>
<p><a href="http://www.cs.qub.ac.uk/itc2007/curriculmcourse/course_curriculm_index.htm">ITC 2007 track 3</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><a href="#pinnedPlanningEntities">Pinned entities</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#machineReassignment">Machine reassignment</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
<div class="ulist">
<ul>
<li>
<p>1 variable</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>50000</code></p>
</li>
<li>
<p>Value &#8656; <code>5000</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^184948</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Nearly realistic</p>
</li>
<li>
<p><a href="http://challenge.roadef.org/2012/en/">ROADEF 2012</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><a href="#realTimePlanning">Real-time planning</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#vehicleRouting">Vehicle routing</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
<div class="ulist">
<ul>
<li>
<p>1 chained variable</p>
</li>
</ul>
</div>
</li>
<li>
<p>1 shadow entity class</p>
<div class="ulist">
<ul>
<li>
<p>1 automatic shadow variable</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>2740</code></p>
</li>
<li>
<p>Value &#8656; <code>2795</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^8380</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Unrealistic</p>
</li>
<li>
<p><a href="http://neo.lcc.uma.es/vrp/">VRP web</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><a href="#shadowVariable">Shadow variable</a></p>
</li>
<li>
<p><a href="#realTimePlanning">Real-time planning</a></p>
</li>
<li>
<p><a href="#nearbySelection">Nearby selection</a></p>
</li>
<li>
<p>Real road distances</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#vehicleRouting">Vehicle routing</a> with time windows</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>All of Vehicle routing</p>
</li>
<li>
<p>1 shadow variable</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>2740</code></p>
</li>
<li>
<p>Value &#8656; <code>2795</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^8380</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Unrealistic</p>
</li>
<li>
<p><a href="http://neo.lcc.uma.es/vrp/">VRP web</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>All of Vehicle routing</p>
</li>
<li>
<p>Custom <a href="#customVariableListener">VariableListener</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#projectJobScheduling">Project job scheduling</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
<div class="ulist">
<ul>
<li>
<p>2 variables</p>
</li>
<li>
<p>1 shadow variable</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>640</code></p>
</li>
<li>
<p>Value &#8656; <code>?</code> and &#8656; <code>?</code></p>
</li>
<li>
<p>Search space &#8656; <code>?</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Nearly realistic</p>
</li>
<li>
<p><a href="http://gent.cs.kuleuven.be/mista2013challenge/">MISTA 2013</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><a href="#bendableScore">Bendable score</a></p>
</li>
<li>
<p>Custom <a href="#customVariableListener">VariableListener</a></p>
</li>
<li>
<p><a href="#valueRangeFactory">ValueRangeFactory</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#bedAllocation">Hospital bed planning</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
<div class="ulist">
<ul>
<li>
<p>1 nullable variable</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>2750</code></p>
</li>
<li>
<p>Value &#8656; <code>471</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^6851</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Unrealistic</p>
</li>
<li>
<p><a href="https://people.cs.kuleuven.be/~wim.vancroonenburg/pas/">Kaho PAS</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><a href="#overconstrainedPlanning">Overconstrained planning</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#taskAssigning">Task assigning</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
<div class="ulist">
<ul>
<li>
<p>1 chained variable</p>
</li>
<li>
<p>1 shadow variable</p>
</li>
</ul>
</div>
</li>
<li>
<p>1 shadow entity class</p>
<div class="ulist">
<ul>
<li>
<p>1 automatic shadow variable</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>500</code></p>
</li>
<li>
<p>Value &#8656; <code>520</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^1168</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>No</p>
</li>
<li>
<p>Defined by us</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><a href="#bendableScore">Bendable score</a></p>
</li>
<li>
<p><a href="#chainedThroughTimePattern">Chained through time pattern</a></p>
</li>
<li>
<p>Custom <a href="#customVariableListener">VariableListener</a></p>
</li>
<li>
<p><a href="#continuousPlanning">Continuous planning</a></p>
</li>
<li>
<p><a href="#realTimePlanning">Real-time planning</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#examination">Exam timetabling</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>2 entity classes (same hierarchy)</p>
<div class="ulist">
<ul>
<li>
<p>2 variables</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>1096</code></p>
</li>
<li>
<p>Value &#8656; <code>80</code> and &#8656; <code>49</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^3374</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Realistic</p>
</li>
<li>
<p><a href="http://www.cs.qub.ac.uk/itc2007/examtrack/exam_track_index.htm">ITC 2007 track 1</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Custom <a href="#customVariableListener">VariableListener</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#nurseRostering">Nurse rostering</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
<div class="ulist">
<ul>
<li>
<p>1 variable</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>752</code></p>
</li>
<li>
<p>Value &#8656; <code>50</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^1277</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Realistic</p>
</li>
<li>
<p><a href="https://www.kuleuven-kulak.be/~u0041139/nrpcompetition/nrpcompetition_description.pdf">INRC 2010</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><a href="#continuousPlanning">Continuous planning</a></p>
</li>
<li>
<p><a href="#realTimePlanning">Real-time planning</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#travelingTournament">Traveling tournament</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
<div class="ulist">
<ul>
<li>
<p>1 variable</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>1560</code></p>
</li>
<li>
<p>Value &#8656; <code>78</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^2301</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Unrealistic</p>
</li>
<li>
<p><a href="http://mat.tepper.cmu.edu/TOURN/">TTP</a></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Custom <a href="#moveListFactory">MoveListFactory</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#cheapTimeScheduling">Cheap time scheduling</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
<div class="ulist">
<ul>
<li>
<p>2 variables</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>500</code></p>
</li>
<li>
<p>Value &#8656; <code>100</code> and &#8656; <code>288</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^20078</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Nearly realistic</p>
</li>
<li>
<p>ICON challenge 2014</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><a href="#annotationAlternatives">Field annotations</a></p>
</li>
<li>
<p><a href="#valueRangeFactory">ValueRangeFactory</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#investment">Investment</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
</li>
<li>
<p>1 variable</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>11</code></p>
</li>
<li>
<p>Value = <code>1000</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^4</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>No</p>
</li>
<li>
<p>Defined by us</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><a href="#valueRangeFactory">ValueRangeFactory</a></p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#conferenceScheduling">Conference scheduling</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
<div class="ulist">
<ul>
<li>
<p>2 variables</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>216</code></p>
</li>
<li>
<p>Value &#8656; <code>18</code> and &#8656; <code>20</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^552</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>No</p>
</li>
<li>
<p>Defined by us</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#rockTour">Rock tour</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
<div class="ulist">
<ul>
<li>
<p>1 chained variable</p>
</li>
<li>
<p>4 shadow variables</p>
</li>
</ul>
</div>
</li>
<li>
<p>1 shadow entity class</p>
<div class="ulist">
<ul>
<li>
<p>1 automatic shadow variable</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>47</code></p>
</li>
<li>
<p>Value &#8656; <code>48</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^59</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>No</p>
</li>
<li>
<p>Defined by us</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#flightCrewScheduling">Flight crew scheduling</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>1 entity class</p>
<div class="ulist">
<ul>
<li>
<p>1 variable</p>
</li>
</ul>
</div>
</li>
<li>
<p>1 shadow entity class</p>
<div class="ulist">
<ul>
<li>
<p>1 automatic shadow variable</p>
</li>
</ul>
</div>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Entity &#8656; <code>4375</code></p>
</li>
<li>
<p>Value &#8656; <code>750</code></p>
</li>
<li>
<p>Search space &#8656; <code>10^12578</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>No</p>
</li>
<li>
<p>Defined by us</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="nQueens"><a class="anchor" href="#nQueens"></a><a class="link" href="#nQueens">3.2. N queens</a></h3>
<div class="sect3">
<h4 id="nQueensProblemDescription"><a class="anchor" href="#nQueensProblemDescription"></a><a class="link" href="#nQueensProblemDescription">3.2.1. Problem description</a></h4>
<div class="paragraph">
<p>Place <em>n</em> queens on a <em>n</em> sized chessboard so that no two queens can attack each other.
The most common <em>n</em> queens puzzle is the eight queens puzzle, with <em>n = 8</em>:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/NQueens/nQueensScreenshot.png" alt="nQueensScreenshot">
</div>
</div>
<div class="paragraph">
<p>Constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use a chessboard of <em>n</em> columns and <em>n</em> rows.</p>
</li>
<li>
<p>Place <em>n</em> queens on the chessboard.</p>
</li>
<li>
<p>No two queens can attack each other. A queen can attack any other queen on the same horizontal, vertical or diagonal line.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This documentation heavily uses the four queens puzzle as the primary example.</p>
</div>
<div class="paragraph">
<p>A proposed solution could be:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/NQueens/partiallySolvedNQueens04Explained.png" alt="partiallySolvedNQueens04Explained">
</div>
<div class="title">Figure 1. A Wrong Solution for the Four Queens Puzzle</div>
</div>
<div class="paragraph">
<p>The above solution is wrong because queens <code>A1</code> and <code>B0</code> can attack each other (so can queens <code>B0</code> and <code>D0</code>). Removing queen <code>B0</code> would respect the "no two queens can attack each other" constraint, but would break the "place <em>n</em> queens" constraint.</p>
</div>
<div class="paragraph">
<p>Below is a correct solution:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/NQueens/solvedNQueens04.png" alt="solvedNQueens04">
</div>
<div class="title">Figure 2. A Correct Solution for the Four Queens Puzzle</div>
</div>
<div class="paragraph">
<p>All the constraints have been met, so the solution is correct.</p>
</div>
<div class="paragraph">
<p>Note that most <em>n</em> queens puzzles have multiple correct solutions.
We will focus on finding a single correct solution for a given <em>n</em>, not on finding the number of possible correct solutions for a given <em>n</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="nQueensProblemSize"><a class="anchor" href="#nQueensProblemSize"></a><a class="link" href="#nQueensProblemSize">3.2.2. Problem size</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">4queens   has   4 queens with a search space of    256.
8queens   has   8 queens with a search space of   10^7.
16queens  has  16 queens with a search space of  10^19.
32queens  has  32 queens with a search space of  10^48.
64queens  has  64 queens with a search space of 10^115.
256queens has 256 queens with a search space of 10^616.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation of the <em>n</em> queens example has not been optimized because it functions as a beginner example. Nevertheless, it can easily handle 64 queens.
With a few changes it has been shown to easily handle 5000 queens and more.</p>
</div>
</div>
<div class="sect3">
<h4 id="nQueensDomainModel"><a class="anchor" href="#nQueensDomainModel"></a><a class="link" href="#nQueensDomainModel">3.2.3. Domain model</a></h4>
<div class="paragraph">
<p>This example uses the domain model to solve the four queens problem.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Creating a Domain Model</strong>
A good domain model will make it easier to understand and solve your planning problem.</p>
<div class="paragraph">
<p>This is the domain model for the <em>n</em> queens example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class Column {

    private int index;

    // ... getters and setters
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class Row {

    private int index;

    // ... getters and setters
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class Queen {

    private Column column;
    private Row row;

    public int getAscendingDiagonalIndex() {...}
    public int getDescendingDiagonalIndex() {...}

    // ... getters and setters
}</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Calculating the Search Space.</strong></p>
<div class="paragraph">
<p>A <code>Queen</code> instance has a <code>Column</code> (for example: 0 is column A, 1 is column B, &#8230;&#8203;) and a <code>Row</code> (its row, for example: 0 is row 0, 1 is row 1, &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>The ascending diagonal line and the descending diagonal line can be calculated based on the column and the row.</p>
</div>
<div class="paragraph">
<p>The column and row indexes start from the upper left corner of the chessboard.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class NQueens {

    private int n;
    private List&lt;Column&gt; columnList;
    private List&lt;Row&gt; rowList;

    private List&lt;Queen&gt; queenList;

    private SimpleScore score;

    // ... getters and setters
}</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Finding the Solution</strong></p>
<div class="paragraph">
<p>A single <code>NQueens</code> instance contains a list of all <code>Queen</code> instances.
It is the solution implementation which is supplied to, solved by, and retrieved from the <code>Solver</code>.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Notice that in the four queens example, NQueens&#8217;s <code>getN()</code> method will always return four.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. A Solution for Four Queens Shown in the Domain Model</caption>
<colgroup>
<col style="width: 54.5454%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.091%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">A solution</th>
<th class="tableblock halign-left valign-top">Queen</th>
<th class="tableblock halign-left valign-top">columnIndex</th>
<th class="tableblock halign-left valign-top">rowIndex</th>
<th class="tableblock halign-left valign-top">ascendingDiagonalIndex (columnIndex + rowIndex)</th>
<th class="tableblock halign-left valign-top">descendingDiagonalIndex (columnIndex - rowIndex)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" rowspan="4"><div class="content"><div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/NQueens/partiallySolvedNQueens04Explained.png" alt="partiallySolvedNQueens04Explained">
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>1 (**)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>B0</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>0 (*)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>1 (**)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>C2</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>D0</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>0 (*)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When two queens share the same column, row or diagonal line, such as (*) and (**), they can attack each other.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cloudBalancing"><a class="anchor" href="#cloudBalancing"></a><a class="link" href="#cloudBalancing">3.3. Cloud balancing</a></h3>
<div class="paragraph">
<p>This example is explained in <a href="#cloudBalancingTutorial">a tutorial</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="tsp"><a class="anchor" href="#tsp"></a><a class="link" href="#tsp">3.4. Traveling salesman (TSP - traveling salesman problem)</a></h3>
<div class="sect3">
<h4 id="tspProblemDescription"><a class="anchor" href="#tspProblemDescription"></a><a class="link" href="#tspProblemDescription">3.4.1. Problem description</a></h4>
<div class="paragraph">
<p>Given a list of cities, find the shortest tour for a salesman that visits each city exactly once.</p>
</div>
<div class="paragraph">
<p>The problem is defined by <a href="https://en.wikipedia.org/wiki/Travelling_salesman_problem">Wikipedia</a>.
It is <a href="http://www.math.uwaterloo.ca/tsp/">one of the most intensively studied problems</a> in computational mathematics.
Yet, in the real world, it is often only part of a planning problem, along with other constraints, such as employee shift rostering constraints.</p>
</div>
</div>
<div class="sect3">
<h4 id="tspProblemSize"><a class="anchor" href="#tspProblemSize"></a><a class="link" href="#tspProblemSize">3.4.2. Problem size</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">dj38     has  38 cities with a search space of   10^43.
europe40 has  40 cities with a search space of   10^46.
st70     has  70 cities with a search space of   10^98.
pcb442   has 442 cities with a search space of  10^976.
lu980    has 980 cities with a search space of 10^2504.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tspProblemDifficulty"><a class="anchor" href="#tspProblemDifficulty"></a><a class="link" href="#tspProblemDifficulty">3.4.3. Problem difficulty</a></h4>
<div class="paragraph">
<p>Despite TSP&#8217;s simple definition, the problem is surprisingly hard to solve.
Because it is an NP-hard problem (like most planning problems), the optimal solution for a specific problem dataset can change a lot when that problem dataset is slightly altered:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/TravellingSalesman/tspOptimalSolutionVolatility.png" alt="tspOptimalSolutionVolatility">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dinnerParty"><a class="anchor" href="#dinnerParty"></a><a class="link" href="#dinnerParty">3.5. Dinner party</a></h3>
<div class="sect3">
<h4 id="dinnerPartyProblemDescription"><a class="anchor" href="#dinnerPartyProblemDescription"></a><a class="link" href="#dinnerPartyProblemDescription">3.5.1. Problem description</a></h4>
<div class="paragraph">
<p>Miss Manners is throwing another dinner party.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>This time she invited 144 guests and prepared 12 round tables with 12 seats each.</p>
</li>
<li>
<p>Every guest should sit next to someone (left and right) of the opposite gender.</p>
</li>
<li>
<p>And that neighbour should have at least one hobby in common with the guest.</p>
</li>
<li>
<p>At every table, there should be two politicians, two doctors, two socialites, two coaches, two teachers and two programmers.</p>
</li>
<li>
<p>And the two politicians, two doctors, two coaches and two programmers should not be the same kind at a table.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Drools Expert also has the normal Miss Manners example (which is much smaller) and employs an exhaustive heuristic to solve it.
OptaPlanner&#8217;s implementation is far more scalable because it uses heuristics to find the best solution and Drools Expert to calculate the score of each solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="dinnerPartyProblemSize"><a class="anchor" href="#dinnerPartyProblemSize"></a><a class="link" href="#dinnerPartyProblemSize">3.5.2. Problem size</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">wedding01 has 18 jobs, 144 guests, 288 hobby practicians, 12 tables and 144 seats with a search space of 10^310.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tennis"><a class="anchor" href="#tennis"></a><a class="link" href="#tennis">3.6. Tennis club scheduling</a></h3>
<div class="sect3">
<h4 id="tennisProblemDescription"><a class="anchor" href="#tennisProblemDescription"></a><a class="link" href="#tennisProblemDescription">3.6.1. Problem description</a></h4>
<div class="paragraph">
<p>Every week the tennis club has four teams playing round robin against each other.
Assign those four spots to the teams fairly.</p>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Conflict: A team can only play once per day.</p>
</li>
<li>
<p>Unavailability: Some teams are unavailable on some dates.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Medium constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fair assignment: All teams should play an (almost) equal number of times.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Evenly confrontation: Each team should play against every other team an equal number of times.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="tennisProblemSize"><a class="anchor" href="#tennisProblemSize"></a><a class="link" href="#tennisProblemSize">3.6.2. Problem size</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">munich-7teams has 7 teams, 18 days, 12 unavailabilityPenalties and 72 teamAssignments with a search space of 10^60.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tennisDomainModel"><a class="anchor" href="#tennisDomainModel"></a><a class="link" href="#tennisDomainModel">3.6.3. Domain model</a></h4>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/TennisScheduling/tennisClassDiagram.png" alt="tennisClassDiagram">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="meetingScheduling"><a class="anchor" href="#meetingScheduling"></a><a class="link" href="#meetingScheduling">3.7. Meeting scheduling</a></h3>
<div class="sect3">
<h4 id="meetingSchedulingProblemDescription"><a class="anchor" href="#meetingSchedulingProblemDescription"></a><a class="link" href="#meetingSchedulingProblemDescription">3.7.1. Problem description</a></h4>
<div class="paragraph">
<p>Assign each meeting to a starting time and a room.
Meetings have different durations.</p>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Room conflict: two meetings must not use the same room at the same time.</p>
</li>
<li>
<p>Required attendance: A person cannot have two required meetings at the same time.</p>
</li>
<li>
<p>Required room capacity: A meeting must not be in a room that doesn&#8217;t fit all of the meeting&#8217;s attendees.</p>
</li>
<li>
<p>Start and end on same day: A meeting shouldn&#8217;t be scheduled over multiple days.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Medium constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Preferred attendance: A person cannot have two preferred meetings at the same time, nor a preferred and a required meeting at the same time.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Sooner rather than later: Schedule all meetings as soon as possible.</p>
</li>
<li>
<p>A break between meetings: Any two meetings should have at least one time grain break between them.</p>
</li>
<li>
<p>Overlapping meetings: To minimize the number of meetings in parallel so people don&#8217;t have to choose one meeting over the other.</p>
</li>
<li>
<p>Assign larger rooms first: If a larger room is available any meeting should be assigned to that room in order to accommodate as many people as possible
even if they haven&#8217;t signed up to that meeting.</p>
</li>
<li>
<p>Room stability: If a person has two consecutive meetings with two or less time grains break between them they better be in the same room.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="meetingSchedulingProblemSize"><a class="anchor" href="#meetingSchedulingProblemSize"></a><a class="link" href="#meetingSchedulingProblemSize">3.7.2. Problem size</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">50meetings-160timegrains-5rooms  has  50 meetings, 160 timeGrains and 5 rooms with a search space of 10^145.
100meetings-320timegrains-5rooms has 100 meetings, 320 timeGrains and 5 rooms with a search space of 10^320.
200meetings-640timegrains-5rooms has 200 meetings, 640 timeGrains and 5 rooms with a search space of 10^701.
400meetings-1280timegrains-5rooms has 400 meetings, 1280 timeGrains and 5 rooms with a search space of 10^1522.
800meetings-2560timegrains-5rooms has 800 meetings, 2560 timeGrains and 5 rooms with a search space of 10^3285.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="curriculumCourse"><a class="anchor" href="#curriculumCourse"></a><a class="link" href="#curriculumCourse">3.8. Course timetabling (ITC 2007 Track 3 - Curriculum Course Scheduling)</a></h3>
<div class="sect3">
<h4 id="curriculumCourseProblemDescription"><a class="anchor" href="#curriculumCourseProblemDescription"></a><a class="link" href="#curriculumCourseProblemDescription">3.8.1. Problem description</a></h4>
<div class="paragraph">
<p>Schedule each lecture into a timeslot and into a room.</p>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Teacher conflict: A teacher must not have two lectures in the same period.</p>
</li>
<li>
<p>Curriculum conflict: A curriculum must not have two lectures in the same period.</p>
</li>
<li>
<p>Room occupancy: two lectures must not be in the same room in the same period.</p>
</li>
<li>
<p>Unavailable period (specified per dataset): A specific lecture must not be assigned to a specific period.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Room capacity: A room&#8217;s capacity should not be less than the number of students in its lecture.</p>
</li>
<li>
<p>Minimum working days: Lectures of the same course should be spread out into a minimum number of days.</p>
</li>
<li>
<p>Curriculum compactness: Lectures belonging to the same curriculum should be adjacent to each other (so in consecutive periods).</p>
</li>
<li>
<p>Room stability: Lectures of the same course should be assigned to the same room.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The problem is defined by <a href="http://www.cs.qub.ac.uk/itc2007/curriculmcourse/course_curriculm_index.htm">the International Timetabling Competition 2007 track 3</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="curriculumCourseProblemSize"><a class="anchor" href="#curriculumCourseProblemSize"></a><a class="link" href="#curriculumCourseProblemSize">3.8.2. Problem size</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">comp01 has 24 teachers,  14 curricula,  30 courses, 160 lectures, 30 periods,  6 rooms and   53 unavailable period constraints with a search space of  10^360.
comp02 has 71 teachers,  70 curricula,  82 courses, 283 lectures, 25 periods, 16 rooms and  513 unavailable period constraints with a search space of  10^736.
comp03 has 61 teachers,  68 curricula,  72 courses, 251 lectures, 25 periods, 16 rooms and  382 unavailable period constraints with a search space of  10^653.
comp04 has 70 teachers,  57 curricula,  79 courses, 286 lectures, 25 periods, 18 rooms and  396 unavailable period constraints with a search space of  10^758.
comp05 has 47 teachers, 139 curricula,  54 courses, 152 lectures, 36 periods,  9 rooms and  771 unavailable period constraints with a search space of  10^381.
comp06 has 87 teachers,  70 curricula, 108 courses, 361 lectures, 25 periods, 18 rooms and  632 unavailable period constraints with a search space of  10^957.
comp07 has 99 teachers,  77 curricula, 131 courses, 434 lectures, 25 periods, 20 rooms and  667 unavailable period constraints with a search space of 10^1171.
comp08 has 76 teachers,  61 curricula,  86 courses, 324 lectures, 25 periods, 18 rooms and  478 unavailable period constraints with a search space of  10^859.
comp09 has 68 teachers,  75 curricula,  76 courses, 279 lectures, 25 periods, 18 rooms and  405 unavailable period constraints with a search space of  10^740.
comp10 has 88 teachers,  67 curricula, 115 courses, 370 lectures, 25 periods, 18 rooms and  694 unavailable period constraints with a search space of  10^981.
comp11 has 24 teachers,  13 curricula,  30 courses, 162 lectures, 45 periods,  5 rooms and   94 unavailable period constraints with a search space of  10^381.
comp12 has 74 teachers, 150 curricula,  88 courses, 218 lectures, 36 periods, 11 rooms and 1368 unavailable period constraints with a search space of  10^566.
comp13 has 77 teachers,  66 curricula,  82 courses, 308 lectures, 25 periods, 19 rooms and  468 unavailable period constraints with a search space of  10^824.
comp14 has 68 teachers,  60 curricula,  85 courses, 275 lectures, 25 periods, 17 rooms and  486 unavailable period constraints with a search space of  10^722.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="curriculumCourseDomainModel"><a class="anchor" href="#curriculumCourseDomainModel"></a><a class="link" href="#curriculumCourseDomainModel">3.8.3. Domain model</a></h4>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/CourseTimetabling/curriculumCourseClassDiagram.png" alt="curriculumCourseClassDiagram">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="machineReassignment"><a class="anchor" href="#machineReassignment"></a><a class="link" href="#machineReassignment">3.9. Machine reassignment (Google ROADEF 2012)</a></h3>
<div class="sect3">
<h4 id="machineReassignmentProblemDescription"><a class="anchor" href="#machineReassignmentProblemDescription"></a><a class="link" href="#machineReassignmentProblemDescription">3.9.1. Problem description</a></h4>
<div class="paragraph">
<p>Assign each process to a machine.
All processes already have an original (unoptimized) assignment.
Each process requires an amount of each resource (such as CPU, RAM, &#8230;&#8203;). This is a more complex version of the Cloud Balancing example.</p>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Maximum capacity: The maximum capacity for each resource for each machine must not be exceeded.</p>
</li>
<li>
<p>Conflict: Processes of the same service must run on distinct machines.</p>
</li>
<li>
<p>Spread: Processes of the same service must be spread out across locations.</p>
</li>
<li>
<p>Dependency: The processes of a service depending on another service must run in the neighborhood of a process of the other service.</p>
</li>
<li>
<p>Transient usage: Some resources are transient and count towards the maximum capacity of both the original machine as the newly assigned machine.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Load: The safety capacity for each resource for each machine should not be exceeded.</p>
</li>
<li>
<p>Balance: Leave room for future assignments by balancing the available resources on each machine.</p>
</li>
<li>
<p>Process move cost: A process has a move cost.</p>
</li>
<li>
<p>Service move cost: A service has a move cost.</p>
</li>
<li>
<p>Machine move cost: Moving a process from machine A to machine B has another A-B specific move cost.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The problem is defined by <a href="http://challenge.roadef.org/2012/en/">the Google ROADEF/EURO Challenge 2012</a>.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/MachineReassignment/cloudOptimizationIsLikeTetris.png" alt="cloudOptimizationIsLikeTetris">
</div>
</div>
</div>
<div class="sect3">
<h4 id="machineReassignmentValueProposition"><a class="anchor" href="#machineReassignmentValueProposition"></a><a class="link" href="#machineReassignmentValueProposition">3.9.2. Value proposition</a></h4>
<div class="imageblock text-center">
<div class="content">
<img src="./QuickStart/PlainJava/CloudBalancingTutorial/cloudOptimizationValueProposition.png" alt="cloudOptimizationValueProposition">
</div>
</div>
</div>
<div class="sect3">
<h4 id="machineReassignmentProblemSize"><a class="anchor" href="#machineReassignmentProblemSize"></a><a class="link" href="#machineReassignmentProblemSize">3.9.3. Problem size</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">model_a1_1 has  2 resources,  1 neighborhoods,   4 locations,    4 machines,    79 services,   100 processes and 1 balancePenalties with a search space of     10^60.
model_a1_2 has  4 resources,  2 neighborhoods,   4 locations,  100 machines,   980 services,  1000 processes and 0 balancePenalties with a search space of   10^2000.
model_a1_3 has  3 resources,  5 neighborhoods,  25 locations,  100 machines,   216 services,  1000 processes and 0 balancePenalties with a search space of   10^2000.
model_a1_4 has  3 resources, 50 neighborhoods,  50 locations,   50 machines,   142 services,  1000 processes and 1 balancePenalties with a search space of   10^1698.
model_a1_5 has  4 resources,  2 neighborhoods,   4 locations,   12 machines,   981 services,  1000 processes and 1 balancePenalties with a search space of   10^1079.
model_a2_1 has  3 resources,  1 neighborhoods,   1 locations,  100 machines,  1000 services,  1000 processes and 0 balancePenalties with a search space of   10^2000.
model_a2_2 has 12 resources,  5 neighborhoods,  25 locations,  100 machines,   170 services,  1000 processes and 0 balancePenalties with a search space of   10^2000.
model_a2_3 has 12 resources,  5 neighborhoods,  25 locations,  100 machines,   129 services,  1000 processes and 0 balancePenalties with a search space of   10^2000.
model_a2_4 has 12 resources,  5 neighborhoods,  25 locations,   50 machines,   180 services,  1000 processes and 1 balancePenalties with a search space of   10^1698.
model_a2_5 has 12 resources,  5 neighborhoods,  25 locations,   50 machines,   153 services,  1000 processes and 0 balancePenalties with a search space of   10^1698.
model_b_1  has 12 resources,  5 neighborhoods,  10 locations,  100 machines,  2512 services,  5000 processes and 0 balancePenalties with a search space of  10^10000.
model_b_2  has 12 resources,  5 neighborhoods,  10 locations,  100 machines,  2462 services,  5000 processes and 1 balancePenalties with a search space of  10^10000.
model_b_3  has  6 resources,  5 neighborhoods,  10 locations,  100 machines, 15025 services, 20000 processes and 0 balancePenalties with a search space of  10^40000.
model_b_4  has  6 resources,  5 neighborhoods,  50 locations,  500 machines,  1732 services, 20000 processes and 1 balancePenalties with a search space of  10^53979.
model_b_5  has  6 resources,  5 neighborhoods,  10 locations,  100 machines, 35082 services, 40000 processes and 0 balancePenalties with a search space of  10^80000.
model_b_6  has  6 resources,  5 neighborhoods,  50 locations,  200 machines, 14680 services, 40000 processes and 1 balancePenalties with a search space of  10^92041.
model_b_7  has  6 resources,  5 neighborhoods,  50 locations, 4000 machines, 15050 services, 40000 processes and 1 balancePenalties with a search space of 10^144082.
model_b_8  has  3 resources,  5 neighborhoods,  10 locations,  100 machines, 45030 services, 50000 processes and 0 balancePenalties with a search space of 10^100000.
model_b_9  has  3 resources,  5 neighborhoods, 100 locations, 1000 machines,  4609 services, 50000 processes and 1 balancePenalties with a search space of 10^150000.
model_b_10 has  3 resources,  5 neighborhoods, 100 locations, 5000 machines,  4896 services, 50000 processes and 1 balancePenalties with a search space of 10^184948.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="machineReassignmentDomainModel"><a class="anchor" href="#machineReassignmentDomainModel"></a><a class="link" href="#machineReassignmentDomainModel">3.9.4. Domain model</a></h4>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/MachineReassignment/machineReassignmentClassDiagram.png" alt="machineReassignmentClassDiagram">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="vehicleRouting"><a class="anchor" href="#vehicleRouting"></a><a class="link" href="#vehicleRouting">3.10. Vehicle routing</a></h3>
<div class="sect3">
<h4 id="vehicleRoutingProblemDescription"><a class="anchor" href="#vehicleRoutingProblemDescription"></a><a class="link" href="#vehicleRoutingProblemDescription">3.10.1. Problem description</a></h4>
<div class="paragraph">
<p>Using a fleet of vehicles, pick up the objects of each customer and bring them to the depot.
Each vehicle can service multiple customers, but it has a limited capacity.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/VehicleRouting/vehicleRoutingUseCase.png" alt="vehicleRoutingUseCase">
</div>
</div>
<div class="paragraph">
<p>Besides the basic case (CVRP), there is also a variant with time windows (CVRPTW).</p>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Vehicle capacity: a vehicle cannot carry more items then its capacity.</p>
</li>
<li>
<p>Time windows (only in CVRPTW):</p>
<div class="ulist">
<ul>
<li>
<p>Travel time: Traveling from one location to another takes time.</p>
</li>
<li>
<p>Customer service duration: a vehicle must stay at the customer for the length of the service duration.</p>
</li>
<li>
<p>Customer ready time: a vehicle may arrive before the customer&#8217;s ready time, but it must wait until the ready time before servicing.</p>
</li>
<li>
<p>Customer due time: a vehicle must arrive on time, before the customer&#8217;s due time.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Total distance: minimize the total distance driven (fuel consumption) of all vehicles.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The capacitated vehicle routing problem (CVRP) and its timewindowed variant (CVRPTW) are defined by <a href="http://neo.lcc.uma.es/vrp/">the VRP web</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="vehicleRoutingValueProposition"><a class="anchor" href="#vehicleRoutingValueProposition"></a><a class="link" href="#vehicleRoutingValueProposition">3.10.2. Value proposition</a></h4>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/VehicleRouting/vehicleRoutingValueProposition.png" alt="vehicleRoutingValueProposition">
</div>
</div>
</div>
<div class="sect3">
<h4 id="vehicleRoutingProblemSize"><a class="anchor" href="#vehicleRoutingProblemSize"></a><a class="link" href="#vehicleRoutingProblemSize">3.10.3. Problem size</a></h4>
<div class="paragraph">
<p>CVRP instances (without time windows):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">belgium-n50-k10             has  1 depots, 10 vehicles and   49 customers with a search space of   10^74.
belgium-n100-k10            has  1 depots, 10 vehicles and   99 customers with a search space of  10^170.
belgium-n500-k20            has  1 depots, 20 vehicles and  499 customers with a search space of 10^1168.
belgium-n1000-k20           has  1 depots, 20 vehicles and  999 customers with a search space of 10^2607.
belgium-n2750-k55           has  1 depots, 55 vehicles and 2749 customers with a search space of 10^8380.
belgium-road-km-n50-k10     has  1 depots, 10 vehicles and   49 customers with a search space of   10^74.
belgium-road-km-n100-k10    has  1 depots, 10 vehicles and   99 customers with a search space of  10^170.
belgium-road-km-n500-k20    has  1 depots, 20 vehicles and  499 customers with a search space of 10^1168.
belgium-road-km-n1000-k20   has  1 depots, 20 vehicles and  999 customers with a search space of 10^2607.
belgium-road-km-n2750-k55   has  1 depots, 55 vehicles and 2749 customers with a search space of 10^8380.
belgium-road-time-n50-k10   has  1 depots, 10 vehicles and   49 customers with a search space of   10^74.
belgium-road-time-n100-k10  has  1 depots, 10 vehicles and   99 customers with a search space of  10^170.
belgium-road-time-n500-k20  has  1 depots, 20 vehicles and  499 customers with a search space of 10^1168.
belgium-road-time-n1000-k20 has  1 depots, 20 vehicles and  999 customers with a search space of 10^2607.
belgium-road-time-n2750-k55 has  1 depots, 55 vehicles and 2749 customers with a search space of 10^8380.
belgium-d2-n50-k10          has  2 depots, 10 vehicles and   48 customers with a search space of   10^74.
belgium-d3-n100-k10         has  3 depots, 10 vehicles and   97 customers with a search space of  10^170.
belgium-d5-n500-k20         has  5 depots, 20 vehicles and  495 customers with a search space of 10^1168.
belgium-d8-n1000-k20        has  8 depots, 20 vehicles and  992 customers with a search space of 10^2607.
belgium-d10-n2750-k55       has 10 depots, 55 vehicles and 2740 customers with a search space of 10^8380.

A-n32-k5  has 1 depots,  5 vehicles and  31 customers with a search space of  10^40.
A-n33-k5  has 1 depots,  5 vehicles and  32 customers with a search space of  10^41.
A-n33-k6  has 1 depots,  6 vehicles and  32 customers with a search space of  10^42.
A-n34-k5  has 1 depots,  5 vehicles and  33 customers with a search space of  10^43.
A-n36-k5  has 1 depots,  5 vehicles and  35 customers with a search space of  10^46.
A-n37-k5  has 1 depots,  5 vehicles and  36 customers with a search space of  10^48.
A-n37-k6  has 1 depots,  6 vehicles and  36 customers with a search space of  10^49.
A-n38-k5  has 1 depots,  5 vehicles and  37 customers with a search space of  10^49.
A-n39-k5  has 1 depots,  5 vehicles and  38 customers with a search space of  10^51.
A-n39-k6  has 1 depots,  6 vehicles and  38 customers with a search space of  10^52.
A-n44-k7  has 1 depots,  7 vehicles and  43 customers with a search space of  10^61.
A-n45-k6  has 1 depots,  6 vehicles and  44 customers with a search space of  10^62.
A-n45-k7  has 1 depots,  7 vehicles and  44 customers with a search space of  10^63.
A-n46-k7  has 1 depots,  7 vehicles and  45 customers with a search space of  10^65.
A-n48-k7  has 1 depots,  7 vehicles and  47 customers with a search space of  10^68.
A-n53-k7  has 1 depots,  7 vehicles and  52 customers with a search space of  10^77.
A-n54-k7  has 1 depots,  7 vehicles and  53 customers with a search space of  10^79.
A-n55-k9  has 1 depots,  9 vehicles and  54 customers with a search space of  10^82.
A-n60-k9  has 1 depots,  9 vehicles and  59 customers with a search space of  10^91.
A-n61-k9  has 1 depots,  9 vehicles and  60 customers with a search space of  10^93.
A-n62-k8  has 1 depots,  8 vehicles and  61 customers with a search space of  10^94.
A-n63-k9  has 1 depots,  9 vehicles and  62 customers with a search space of  10^97.
A-n63-k10 has 1 depots, 10 vehicles and  62 customers with a search space of  10^98.
A-n64-k9  has 1 depots,  9 vehicles and  63 customers with a search space of  10^99.
A-n65-k9  has 1 depots,  9 vehicles and  64 customers with a search space of 10^101.
A-n69-k9  has 1 depots,  9 vehicles and  68 customers with a search space of 10^108.
A-n80-k10 has 1 depots, 10 vehicles and  79 customers with a search space of 10^130.
F-n45-k4  has 1 depots,  4 vehicles and  44 customers with a search space of  10^60.
F-n72-k4  has 1 depots,  4 vehicles and  71 customers with a search space of 10^108.
F-n135-k7 has 1 depots,  7 vehicles and 134 customers with a search space of 10^240.</code></pre>
</div>
</div>
<div class="paragraph">
<p>CVRPTW instances (with time windows):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">belgium-tw-d2-n50-k10    has  2 depots, 10 vehicles and   48 customers with a search space of   10^74.
belgium-tw-d3-n100-k10   has  3 depots, 10 vehicles and   97 customers with a search space of  10^170.
belgium-tw-d5-n500-k20   has  5 depots, 20 vehicles and  495 customers with a search space of 10^1168.
belgium-tw-d8-n1000-k20  has  8 depots, 20 vehicles and  992 customers with a search space of 10^2607.
belgium-tw-d10-n2750-k55 has 10 depots, 55 vehicles and 2740 customers with a search space of 10^8380.
belgium-tw-n50-k10       has  1 depots, 10 vehicles and   49 customers with a search space of   10^74.
belgium-tw-n100-k10      has  1 depots, 10 vehicles and   99 customers with a search space of  10^170.
belgium-tw-n500-k20      has  1 depots, 20 vehicles and  499 customers with a search space of 10^1168.
belgium-tw-n1000-k20     has  1 depots, 20 vehicles and  999 customers with a search space of 10^2607.
belgium-tw-n2750-k55     has  1 depots, 55 vehicles and 2749 customers with a search space of 10^8380.

Solomon_025_C101       has 1 depots,  25 vehicles and   25 customers with a search space of   10^40.
Solomon_025_C201       has 1 depots,  25 vehicles and   25 customers with a search space of   10^40.
Solomon_025_R101       has 1 depots,  25 vehicles and   25 customers with a search space of   10^40.
Solomon_025_R201       has 1 depots,  25 vehicles and   25 customers with a search space of   10^40.
Solomon_025_RC101      has 1 depots,  25 vehicles and   25 customers with a search space of   10^40.
Solomon_025_RC201      has 1 depots,  25 vehicles and   25 customers with a search space of   10^40.
Solomon_100_C101       has 1 depots,  25 vehicles and  100 customers with a search space of  10^185.
Solomon_100_C201       has 1 depots,  25 vehicles and  100 customers with a search space of  10^185.
Solomon_100_R101       has 1 depots,  25 vehicles and  100 customers with a search space of  10^185.
Solomon_100_R201       has 1 depots,  25 vehicles and  100 customers with a search space of  10^185.
Solomon_100_RC101      has 1 depots,  25 vehicles and  100 customers with a search space of  10^185.
Solomon_100_RC201      has 1 depots,  25 vehicles and  100 customers with a search space of  10^185.
Homberger_0200_C1_2_1  has 1 depots,  50 vehicles and  200 customers with a search space of  10^429.
Homberger_0200_C2_2_1  has 1 depots,  50 vehicles and  200 customers with a search space of  10^429.
Homberger_0200_R1_2_1  has 1 depots,  50 vehicles and  200 customers with a search space of  10^429.
Homberger_0200_R2_2_1  has 1 depots,  50 vehicles and  200 customers with a search space of  10^429.
Homberger_0200_RC1_2_1 has 1 depots,  50 vehicles and  200 customers with a search space of  10^429.
Homberger_0200_RC2_2_1 has 1 depots,  50 vehicles and  200 customers with a search space of  10^429.
Homberger_0400_C1_4_1  has 1 depots, 100 vehicles and  400 customers with a search space of  10^978.
Homberger_0400_C2_4_1  has 1 depots, 100 vehicles and  400 customers with a search space of  10^978.
Homberger_0400_R1_4_1  has 1 depots, 100 vehicles and  400 customers with a search space of  10^978.
Homberger_0400_R2_4_1  has 1 depots, 100 vehicles and  400 customers with a search space of  10^978.
Homberger_0400_RC1_4_1 has 1 depots, 100 vehicles and  400 customers with a search space of  10^978.
Homberger_0400_RC2_4_1 has 1 depots, 100 vehicles and  400 customers with a search space of  10^978.
Homberger_0600_C1_6_1  has 1 depots, 150 vehicles and  600 customers with a search space of 10^1571.
Homberger_0600_C2_6_1  has 1 depots, 150 vehicles and  600 customers with a search space of 10^1571.
Homberger_0600_R1_6_1  has 1 depots, 150 vehicles and  600 customers with a search space of 10^1571.
Homberger_0600_R2_6_1  has 1 depots, 150 vehicles and  600 customers with a search space of 10^1571.
Homberger_0600_RC1_6_1 has 1 depots, 150 vehicles and  600 customers with a search space of 10^1571.
Homberger_0600_RC2_6_1 has 1 depots, 150 vehicles and  600 customers with a search space of 10^1571.
Homberger_0800_C1_8_1  has 1 depots, 200 vehicles and  800 customers with a search space of 10^2195.
Homberger_0800_C2_8_1  has 1 depots, 200 vehicles and  800 customers with a search space of 10^2195.
Homberger_0800_R1_8_1  has 1 depots, 200 vehicles and  800 customers with a search space of 10^2195.
Homberger_0800_R2_8_1  has 1 depots, 200 vehicles and  800 customers with a search space of 10^2195.
Homberger_0800_RC1_8_1 has 1 depots, 200 vehicles and  800 customers with a search space of 10^2195.
Homberger_0800_RC2_8_1 has 1 depots, 200 vehicles and  800 customers with a search space of 10^2195.
Homberger_1000_C110_1  has 1 depots, 250 vehicles and 1000 customers with a search space of 10^2840.
Homberger_1000_C210_1  has 1 depots, 250 vehicles and 1000 customers with a search space of 10^2840.
Homberger_1000_R110_1  has 1 depots, 250 vehicles and 1000 customers with a search space of 10^2840.
Homberger_1000_R210_1  has 1 depots, 250 vehicles and 1000 customers with a search space of 10^2840.
Homberger_1000_RC110_1 has 1 depots, 250 vehicles and 1000 customers with a search space of 10^2840.
Homberger_1000_RC210_1 has 1 depots, 250 vehicles and 1000 customers with a search space of 10^2840.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="vehicleRoutingDomainModel"><a class="anchor" href="#vehicleRoutingDomainModel"></a><a class="link" href="#vehicleRoutingDomainModel">3.10.4. Domain model</a></h4>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/VehicleRouting/vehicleRoutingClassDiagram.png" alt="vehicleRoutingClassDiagram">
</div>
</div>
<div class="paragraph">
<p>The vehicle routing with timewindows domain model makes heavily use of <a href="#shadowVariable">shadow variables</a>.
This allows it to express its constraints more naturally, because properties such as <code>arrivalTime</code> and <code>departureTime</code>, are directly available on the domain model.</p>
</div>
<div class="sect4">
<h5 id="roadDistancesInsteadOfAirDistances"><a class="anchor" href="#roadDistancesInsteadOfAirDistances"></a><a class="link" href="#roadDistancesInsteadOfAirDistances">3.10.4.1. Road distances instead of air distances</a></h5>
<div class="paragraph">
<p>In the real world, vehicles cannot follow a straight line from location to location: they have to use roads and highways.
From a business point of view, this matters a lot:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/VehicleRouting/vehicleRoutingDistanceType.png" alt="vehicleRoutingDistanceType">
</div>
</div>
<div class="paragraph">
<p>For the optimization algorithm, this does not matter much, as long as the distance between two points can be looked up (and are preferably precalculated). The road cost does not even need to be a distance, it can also be travel time, fuel cost, or a weighted function of those.
There are several technologies available to precalculate road costs, such as <a href="https://graphhopper.com/">GraphHopper</a> (embeddable, offline Java engine), <a href="http://open.mapquestapi.com/directions/#matrix">Open MapQuest</a> (web service) and <a href="https://developers.google.com/maps/documentation/webservices/client-library">Google Maps Client API</a> (web service).</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/VehicleRouting/integrationWithRealMaps.png" alt="integrationWithRealMaps">
</div>
</div>
<div class="paragraph">
<p>There are also several technologies to render it, such as <a href="http://leafletjs.com">Leaflet</a> and <a href="https://developers.google.com/maps/">Google Maps for developers</a>. The <a href="https://github.com/kiegroup/optaweb-vehicle-routing">OptaWeb Vehicle Routing project</a> has an example which demonstrates such rendering:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/VehicleRouting/vehicleRoutingLeafletAndGoogleMaps.png" alt="vehicleRoutingLeafletAndGoogleMaps">
</div>
</div>
<div class="paragraph">
<p>It is even possible to render the actual road routes with GraphHopper or Google Map Directions, but because of route overlaps on highways, it can become harder to see the standstill order:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/VehicleRouting/vehicleRoutingGoogleMapsDirections.png" alt="vehicleRoutingGoogleMapsDirections">
</div>
</div>
<div class="paragraph">
<p>Take special care that the road costs between two points use the same optimization criteria as the one used in OptaPlanner.
For example, GraphHopper etc will by default return the fastest route, not the shortest route.
Don&#8217;t use the km (or miles) distances of the fastest GPS routes to optimize the shortest trip in OptaPlanner: this leads to a suboptimal solution as shown below:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/VehicleRouting/roadDistanceTriangleInequality.png" alt="roadDistanceTriangleInequality">
</div>
</div>
<div class="paragraph">
<p>Contrary to popular belief, most users do not want the shortest route: they want the fastest route instead.
They prefer highways over normal roads.
They prefer normal roads over dirt roads.
In the real world, the fastest and shortest route are rarely the same.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="projectJobScheduling"><a class="anchor" href="#projectJobScheduling"></a><a class="link" href="#projectJobScheduling">3.11. Project job scheduling</a></h3>
<div class="sect3">
<h4 id="projectJobSchedulingProblemDescription"><a class="anchor" href="#projectJobSchedulingProblemDescription"></a><a class="link" href="#projectJobSchedulingProblemDescription">3.11.1. Problem description</a></h4>
<div class="paragraph">
<p>Schedule all jobs in time and execution mode to minimize project delays.
Each job is part of a project.
A job can be executed in different ways: each way is an execution mode that implies a different duration but also different resource usages.
This is a form of flexible <em>job shop scheduling</em>.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/ProjectJobScheduling/projectJobSchedulingUseCase.png" alt="projectJobSchedulingUseCase">
</div>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Job precedence: a job can only start when all its predecessor jobs are finished.</p>
</li>
<li>
<p>Resource capacity: do not use more resources than available.</p>
<div class="ulist">
<ul>
<li>
<p>Resources are local (shared between jobs of the same project) or global (shared between all jobs)</p>
</li>
<li>
<p>Resources are renewable (capacity available per day) or nonrenewable (capacity available for all days)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Medium constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Total project delay: minimize the duration (makespan) of each project.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Total makespan: minimize the duration of the whole multi-project schedule.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The problem is defined by <a href="http://gent.cs.kuleuven.be/mista2013challenge/">the MISTA 2013 challenge</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="projectJobSchedulingProblemSize"><a class="anchor" href="#projectJobSchedulingProblemSize"></a><a class="link" href="#projectJobSchedulingProblemSize">3.11.2. Problem size</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">Schedule A-1  has  2 projects,  24 jobs,   64 execution modes,  7 resources and  150 resource requirements.
Schedule A-2  has  2 projects,  44 jobs,  124 execution modes,  7 resources and  420 resource requirements.
Schedule A-3  has  2 projects,  64 jobs,  184 execution modes,  7 resources and  630 resource requirements.
Schedule A-4  has  5 projects,  60 jobs,  160 execution modes, 16 resources and  390 resource requirements.
Schedule A-5  has  5 projects, 110 jobs,  310 execution modes, 16 resources and  900 resource requirements.
Schedule A-6  has  5 projects, 160 jobs,  460 execution modes, 16 resources and 1440 resource requirements.
Schedule A-7  has 10 projects, 120 jobs,  320 execution modes, 22 resources and  900 resource requirements.
Schedule A-8  has 10 projects, 220 jobs,  620 execution modes, 22 resources and 1860 resource requirements.
Schedule A-9  has 10 projects, 320 jobs,  920 execution modes, 31 resources and 2880 resource requirements.
Schedule A-10 has 10 projects, 320 jobs,  920 execution modes, 31 resources and 2970 resource requirements.
Schedule B-1  has 10 projects, 120 jobs,  320 execution modes, 31 resources and  900 resource requirements.
Schedule B-2  has 10 projects, 220 jobs,  620 execution modes, 22 resources and 1740 resource requirements.
Schedule B-3  has 10 projects, 320 jobs,  920 execution modes, 31 resources and 3060 resource requirements.
Schedule B-4  has 15 projects, 180 jobs,  480 execution modes, 46 resources and 1530 resource requirements.
Schedule B-5  has 15 projects, 330 jobs,  930 execution modes, 46 resources and 2760 resource requirements.
Schedule B-6  has 15 projects, 480 jobs, 1380 execution modes, 46 resources and 4500 resource requirements.
Schedule B-7  has 20 projects, 240 jobs,  640 execution modes, 61 resources and 1710 resource requirements.
Schedule B-8  has 20 projects, 440 jobs, 1240 execution modes, 42 resources and 3180 resource requirements.
Schedule B-9  has 20 projects, 640 jobs, 1840 execution modes, 61 resources and 5940 resource requirements.
Schedule B-10 has 20 projects, 460 jobs, 1300 execution modes, 42 resources and 4260 resource requirements.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="bedAllocation"><a class="anchor" href="#bedAllocation"></a><a class="link" href="#bedAllocation">3.12. Hospital bed planning (PAS - Patient Admission Scheduling)</a></h3>
<div class="sect3">
<h4 id="bedAllocationProblemDescription"><a class="anchor" href="#bedAllocationProblemDescription"></a><a class="link" href="#bedAllocationProblemDescription">3.12.1. Problem description</a></h4>
<div class="paragraph">
<p>Assign each patient (that will come to the hospital) into a bed for each night that the patient will stay in the hospital.
Each bed belongs to a room and each room belongs to a department.
The arrival and departure dates of the patients is fixed: only a bed needs to be assigned for each night.</p>
</div>
<div class="paragraph">
<p>This problem features <a href="#overconstrainedPlanning">overconstrained</a> datasets.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/BedAllocation/patientAdmissionScheduleUseCase.png" alt="patientAdmissionScheduleUseCase">
</div>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Two patients must not be assigned to the same bed in the same night. Weight: <code>-1000hard * conflictNightCount</code>.</p>
</li>
<li>
<p>A room can have a gender limitation: only females, only males, the same gender in the same night or no gender limitation at all. Weight: <code>-50hard * nightCount</code>.</p>
</li>
<li>
<p>A department can have a minimum or maximum age. Weight: <code>-100hard * nightCount</code>.</p>
</li>
<li>
<p>A patient can require a room with specific equipment(s). Weight: <code>-50hard * nightCount</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Medium constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Assign every patient to a bed, unless the dataset is overconstrained. Weight: <code>-1medium * nightCount</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A patient can prefer a maximum room size, for example if he/she wants a single room. Weight: <code>-8soft * nightCount</code>.</p>
</li>
<li>
<p>A patient is best assigned to a department that specializes in his/her problem. Weight: <code>-10soft * nightCount</code>.</p>
</li>
<li>
<p>A patient is best assigned to a room that specializes in his/her problem. Weight: <code>-20soft * nightCount</code>.</p>
<div class="ulist">
<ul>
<li>
<p>That room speciality should be priority 1. Weight: <code>-10soft * (priority - 1) * nightCount</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>A patient can prefer a room with specific equipment(s). Weight: <code>-20soft * nightCount</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The problem is a variant on <a href="https://people.cs.kuleuven.be/~wim.vancroonenburg/pas/">Kaho&#8217;s Patient Scheduling</a> and the datasets come from real world hospitals.</p>
</div>
</div>
<div class="sect3">
<h4 id="bedAllocationProblemSize"><a class="anchor" href="#bedAllocationProblemSize"></a><a class="link" href="#bedAllocationProblemSize">3.12.2. Problem size</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">testdata01 has 4 specialisms, 2 equipments, 4 departments,  98 rooms, 286 beds, 14 nights,  652 patients and  652 admissions with a search space of 10^1601.
testdata02 has 6 specialisms, 2 equipments, 6 departments, 151 rooms, 465 beds, 14 nights,  755 patients and  755 admissions with a search space of 10^2013.
testdata03 has 5 specialisms, 2 equipments, 5 departments, 131 rooms, 395 beds, 14 nights,  708 patients and  708 admissions with a search space of 10^1838.
testdata04 has 6 specialisms, 2 equipments, 6 departments, 155 rooms, 471 beds, 14 nights,  746 patients and  746 admissions with a search space of 10^1994.
testdata05 has 4 specialisms, 2 equipments, 4 departments, 102 rooms, 325 beds, 14 nights,  587 patients and  587 admissions with a search space of 10^1474.
testdata06 has 4 specialisms, 2 equipments, 4 departments, 104 rooms, 313 beds, 14 nights,  685 patients and  685 admissions with a search space of 10^1709.
testdata07 has 6 specialisms, 4 equipments, 6 departments, 162 rooms, 472 beds, 14 nights,  519 patients and  519 admissions with a search space of 10^1387.
testdata08 has 6 specialisms, 4 equipments, 6 departments, 148 rooms, 441 beds, 21 nights,  895 patients and  895 admissions with a search space of 10^2366.
testdata09 has 4 specialisms, 4 equipments, 4 departments, 105 rooms, 310 beds, 28 nights, 1400 patients and 1400 admissions with a search space of 10^3487.
testdata10 has 4 specialisms, 4 equipments, 4 departments, 104 rooms, 308 beds, 56 nights, 1575 patients and 1575 admissions with a search space of 10^3919.
testdata11 has 4 specialisms, 4 equipments, 4 departments, 107 rooms, 318 beds, 91 nights, 2514 patients and 2514 admissions with a search space of 10^6291.
testdata12 has 4 specialisms, 4 equipments, 4 departments, 105 rooms, 310 beds, 84 nights, 2750 patients and 2750 admissions with a search space of 10^6851.
testdata13 has 5 specialisms, 4 equipments, 5 departments, 125 rooms, 368 beds, 28 nights,  907 patients and 1109 admissions with a search space of 10^2845.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="bedAllocationDomainModel"><a class="anchor" href="#bedAllocationDomainModel"></a><a class="link" href="#bedAllocationDomainModel">3.12.3. Domain model</a></h4>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/BedAllocation/hospitalBedAllocationClassDiagram.png" alt="hospitalBedAllocationClassDiagram">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="taskAssigning"><a class="anchor" href="#taskAssigning"></a><a class="link" href="#taskAssigning">3.13. Task assigning</a></h3>
<div class="sect3">
<h4 id="taskAssigningProblemDescription"><a class="anchor" href="#taskAssigningProblemDescription"></a><a class="link" href="#taskAssigningProblemDescription">3.13.1. Problem description</a></h4>
<div class="paragraph">
<p>Assign each task to a spot in an employee&#8217;s queue.
Each task has a duration which is affected by the employee&#8217;s affinity level with the task&#8217;s customer.</p>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Skill: Each task requires one or more skills. The employee must possess all these skills.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft level 0 constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Critical tasks: Complete critical tasks first, sooner than major and minor tasks.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft level 1 constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Minimize makespan: Reduce the time to complete all tasks.</p>
<div class="ulist">
<ul>
<li>
<p>Start with the longest working employee first, then the second longest working employee and so forth, to create <a href="#fairnessScoreConstraints">fairness and load balancing</a>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft level 2 constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Major tasks: Complete major tasks as soon as possible, sooner than minor tasks.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft level 3 constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Minor tasks: Complete minor tasks as soon as possible.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="taskAssigningValueProposition"><a class="anchor" href="#taskAssigningValueProposition"></a><a class="link" href="#taskAssigningValueProposition">3.13.2. Value proposition</a></h4>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/TaskAssigning/taskAssigningValueProposition.png" alt="taskAssigningValueProposition">
</div>
</div>
</div>
<div class="sect3">
<h4 id="taskAssigningProblemSize"><a class="anchor" href="#taskAssigningProblemSize"></a><a class="link" href="#taskAssigningProblemSize">3.13.3. Problem size</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">24tasks-8employees   has  24 tasks, 6 skills,  8 employees,   4 task types and  4 customers with a search space of   10^30.
50tasks-5employees   has  50 tasks, 5 skills,  5 employees,  10 task types and 10 customers with a search space of   10^69.
100tasks-5employees  has 100 tasks, 5 skills,  5 employees,  20 task types and 15 customers with a search space of  10^164.
500tasks-20employees has 500 tasks, 6 skills, 20 employees, 100 task types and 60 customers with a search space of 10^1168.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="taskAssigningDomainModel"><a class="anchor" href="#taskAssigningDomainModel"></a><a class="link" href="#taskAssigningDomainModel">3.13.4. Domain model</a></h4>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/TaskAssigning/taskAssigningClassDiagram.png" alt="taskAssigningClassDiagram">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="examination"><a class="anchor" href="#examination"></a><a class="link" href="#examination">3.14. Exam timetabling (ITC 2007 track 1 - Examination)</a></h3>
<div class="sect3">
<h4 id="examinationProblemDescription"><a class="anchor" href="#examinationProblemDescription"></a><a class="link" href="#examinationProblemDescription">3.14.1. Problem description</a></h4>
<div class="paragraph">
<p>Schedule each exam into a period and into a room.
Multiple exams can share the same room during the same period.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/ExamTimetabling/examinationTimetablingUseCase.png" alt="examinationTimetablingUseCase">
</div>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Exam conflict: two exams that share students must not occur in the same period.</p>
</li>
<li>
<p>Room capacity: A room&#8217;s seating capacity must suffice at all times.</p>
</li>
<li>
<p>Period duration: A period&#8217;s duration must suffice for all of its exams.</p>
</li>
<li>
<p>Period related hard constraints (specified per dataset):</p>
<div class="ulist">
<ul>
<li>
<p>Coincidence: two specified exams must use the same period (but possibly another room).</p>
</li>
<li>
<p>Exclusion: two specified exams must not use the same period.</p>
</li>
<li>
<p>After: A specified exam must occur in a period after another specified exam&#8217;s period.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Room related hard constraints (specified per dataset):</p>
<div class="ulist">
<ul>
<li>
<p>Exclusive: one specified exam should not have to share its room with any other exam.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints (each of which has a parametrized penalty):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The same student should not have two exams in a row.</p>
</li>
<li>
<p>The same student should not have two exams on the same day.</p>
</li>
<li>
<p>Period spread: two exams that share students should be a number of periods apart.</p>
</li>
<li>
<p>Mixed durations: two exams that share a room should not have different durations.</p>
</li>
<li>
<p>Front load: Large exams should be scheduled earlier in the schedule.</p>
</li>
<li>
<p>Period penalty (specified per dataset): Some periods have a penalty when used.</p>
</li>
<li>
<p>Room penalty (specified per dataset): Some rooms have a penalty when used.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It uses large test data sets of real-life universities.</p>
</div>
<div class="paragraph">
<p>The problem is defined by <a href="http://www.cs.qub.ac.uk/itc2007/examtrack/exam_track_index.htm">the International Timetabling Competition 2007 track 1</a>.
Geoffrey De Smet finished 4th in that competition with a very early version of OptaPlanner.
Many improvements have been made since then.</p>
</div>
</div>
<div class="sect3">
<h4 id="examinationProblemSize"><a class="anchor" href="#examinationProblemSize"></a><a class="link" href="#examinationProblemSize">3.14.2. Problem size</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">exam_comp_set1 has  7883 students,  607 exams, 54 periods,  7 rooms,  12 period constraints and  0 room constraints with a search space of 10^1564.
exam_comp_set2 has 12484 students,  870 exams, 40 periods, 49 rooms,  12 period constraints and  2 room constraints with a search space of 10^2864.
exam_comp_set3 has 16365 students,  934 exams, 36 periods, 48 rooms, 168 period constraints and 15 room constraints with a search space of 10^3023.
exam_comp_set4 has  4421 students,  273 exams, 21 periods,  1 rooms,  40 period constraints and  0 room constraints with a search space of  10^360.
exam_comp_set5 has  8719 students, 1018 exams, 42 periods,  3 rooms,  27 period constraints and  0 room constraints with a search space of 10^2138.
exam_comp_set6 has  7909 students,  242 exams, 16 periods,  8 rooms,  22 period constraints and  0 room constraints with a search space of  10^509.
exam_comp_set7 has 13795 students, 1096 exams, 80 periods, 15 rooms,  28 period constraints and  0 room constraints with a search space of 10^3374.
exam_comp_set8 has  7718 students,  598 exams, 80 periods,  8 rooms,  20 period constraints and  1 room constraints with a search space of 10^1678.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="examinationDomainModel"><a class="anchor" href="#examinationDomainModel"></a><a class="link" href="#examinationDomainModel">3.14.3. Domain model</a></h4>
<div class="paragraph">
<p>Below you can see the main examination domain classes:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/ExamTimetabling/examinationDomainDiagram.png" alt="examinationDomainDiagram">
</div>
<div class="title">Figure 3. Examination Domain Class Diagram</div>
</div>
<div class="paragraph">
<p>Notice that we&#8217;ve split up the exam concept into an <code>Exam</code> class and a <code>Topic</code> class.
The <code>Exam</code> instances change during solving (this is the planning entity class), when their period or room property changes.
The <code>Topic</code>, <code>Period</code> and <code>Room</code> instances never change during solving (these are problem facts, just like some other classes).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="nurseRostering"><a class="anchor" href="#nurseRostering"></a><a class="link" href="#nurseRostering">3.15. Nurse rostering (INRC 2010)</a></h3>
<div class="sect3">
<h4 id="nurseRosteringProblemDescription"><a class="anchor" href="#nurseRosteringProblemDescription"></a><a class="link" href="#nurseRosteringProblemDescription">3.15.1. Problem description</a></h4>
<div class="paragraph">
<p>For each shift, assign a nurse to work that shift.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/NurseRostering/employeeShiftRosteringUseCase.png" alt="employeeShiftRosteringUseCase">
</div>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>No unassigned shifts</strong> (built-in): Every shift need to be assigned to an employee.</p>
</li>
<li>
<p><strong>Shift conflict</strong>: An employee can have only one shift per day.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Contract obligations. The business frequently violates these, so they decided to define these as soft constraints instead of hard constraints.</p>
<div class="ulist">
<ul>
<li>
<p><strong>Minimum and maximum assignments</strong>: Each employee needs to work more than x shifts and less than y shifts (depending on their contract).</p>
</li>
<li>
<p><strong>Minimum and maximum consecutive working days</strong>: Each employee needs to work between x and y days in a row (depending on their contract).</p>
</li>
<li>
<p><strong>Minimum and maximum consecutive free days</strong>: Each employee needs to be free between x and y days in a row (depending on their contract).</p>
</li>
<li>
<p><strong>Minimum and maximum consecutive working weekends</strong>: Each employee needs to work between x and y weekends in a row (depending on their contract).</p>
</li>
<li>
<p><strong>Complete weekends</strong>: Each employee needs to work every day in a weekend or not at all.</p>
</li>
<li>
<p><strong>Identical shift types during weekend</strong>: Each weekend shift for the same weekend of the same employee must be the same shift type.</p>
</li>
<li>
<p><strong>Unwanted patterns</strong>: A combination of unwanted shift types in a row. For example: a late shift followed by an early shift followed by a late shift.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Employee wishes:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Day on request</strong>: An employee wants to work on a specific day.</p>
</li>
<li>
<p><strong>Day off request</strong>: An employee does not want to work on a specific day.</p>
</li>
<li>
<p><strong>Shift on request</strong>: An employee wants to be assigned to a specific shift.</p>
</li>
<li>
<p><strong>Shift off request</strong>: An employee does not want to be assigned to a specific shift.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Alternative skill</strong>: An employee assigned to a skill should have a proficiency in every skill required by that shift.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The problem is defined by <a href="https://www.kuleuven-kulak.be/~u0041139/nrpcompetition/nrpcompetition_description.pdf">the International Nurse Rostering Competition 2010</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="nurseRosteringValueProposition"><a class="anchor" href="#nurseRosteringValueProposition"></a><a class="link" href="#nurseRosteringValueProposition">3.15.2. Value proposition</a></h4>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/NurseRostering/employeeRosteringValueProposition.png" alt="employeeRosteringValueProposition">
</div>
</div>
</div>
<div class="sect3">
<h4 id="nurseRosteringProblemSize"><a class="anchor" href="#nurseRosteringProblemSize"></a><a class="link" href="#nurseRosteringProblemSize">3.15.3. Problem size</a></h4>
<div class="paragraph">
<p>There are three dataset types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>sprint: must be solved in seconds.</p>
</li>
<li>
<p>medium: must be solved in minutes.</p>
</li>
<li>
<p>long: must be solved in hours.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">toy1          has 1 skills, 3 shiftTypes, 2 patterns, 1 contracts,  6 employees,  7 shiftDates,  35 shiftAssignments and   0 requests with a search space of   10^27.
toy2          has 1 skills, 3 shiftTypes, 3 patterns, 2 contracts, 20 employees, 28 shiftDates, 180 shiftAssignments and 140 requests with a search space of  10^234.

sprint01      has 1 skills, 4 shiftTypes, 3 patterns, 4 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint02      has 1 skills, 4 shiftTypes, 3 patterns, 4 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint03      has 1 skills, 4 shiftTypes, 3 patterns, 4 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint04      has 1 skills, 4 shiftTypes, 3 patterns, 4 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint05      has 1 skills, 4 shiftTypes, 3 patterns, 4 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint06      has 1 skills, 4 shiftTypes, 3 patterns, 4 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint07      has 1 skills, 4 shiftTypes, 3 patterns, 4 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint08      has 1 skills, 4 shiftTypes, 3 patterns, 4 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint09      has 1 skills, 4 shiftTypes, 3 patterns, 4 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint10      has 1 skills, 4 shiftTypes, 3 patterns, 4 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint_hint01 has 1 skills, 4 shiftTypes, 8 patterns, 3 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint_hint02 has 1 skills, 4 shiftTypes, 0 patterns, 3 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint_hint03 has 1 skills, 4 shiftTypes, 8 patterns, 3 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint_late01 has 1 skills, 4 shiftTypes, 8 patterns, 3 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint_late02 has 1 skills, 3 shiftTypes, 4 patterns, 3 contracts, 10 employees, 28 shiftDates, 144 shiftAssignments and 139 requests with a search space of  10^144.
sprint_late03 has 1 skills, 4 shiftTypes, 8 patterns, 3 contracts, 10 employees, 28 shiftDates, 160 shiftAssignments and 150 requests with a search space of  10^160.
sprint_late04 has 1 skills, 4 shiftTypes, 8 patterns, 3 contracts, 10 employees, 28 shiftDates, 160 shiftAssignments and 150 requests with a search space of  10^160.
sprint_late05 has 1 skills, 4 shiftTypes, 8 patterns, 3 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint_late06 has 1 skills, 4 shiftTypes, 0 patterns, 3 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint_late07 has 1 skills, 4 shiftTypes, 0 patterns, 3 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.
sprint_late08 has 1 skills, 4 shiftTypes, 0 patterns, 3 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and   0 requests with a search space of  10^152.
sprint_late09 has 1 skills, 4 shiftTypes, 0 patterns, 3 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and   0 requests with a search space of  10^152.
sprint_late10 has 1 skills, 4 shiftTypes, 0 patterns, 3 contracts, 10 employees, 28 shiftDates, 152 shiftAssignments and 150 requests with a search space of  10^152.

medium01      has 1 skills, 4 shiftTypes, 0 patterns, 4 contracts, 31 employees, 28 shiftDates, 608 shiftAssignments and 403 requests with a search space of  10^906.
medium02      has 1 skills, 4 shiftTypes, 0 patterns, 4 contracts, 31 employees, 28 shiftDates, 608 shiftAssignments and 403 requests with a search space of  10^906.
medium03      has 1 skills, 4 shiftTypes, 0 patterns, 4 contracts, 31 employees, 28 shiftDates, 608 shiftAssignments and 403 requests with a search space of  10^906.
medium04      has 1 skills, 4 shiftTypes, 0 patterns, 4 contracts, 31 employees, 28 shiftDates, 608 shiftAssignments and 403 requests with a search space of  10^906.
medium05      has 1 skills, 4 shiftTypes, 0 patterns, 4 contracts, 31 employees, 28 shiftDates, 608 shiftAssignments and 403 requests with a search space of  10^906.
medium_hint01 has 1 skills, 4 shiftTypes, 7 patterns, 4 contracts, 30 employees, 28 shiftDates, 428 shiftAssignments and 390 requests with a search space of  10^632.
medium_hint02 has 1 skills, 4 shiftTypes, 7 patterns, 3 contracts, 30 employees, 28 shiftDates, 428 shiftAssignments and 390 requests with a search space of  10^632.
medium_hint03 has 1 skills, 4 shiftTypes, 7 patterns, 4 contracts, 30 employees, 28 shiftDates, 428 shiftAssignments and 390 requests with a search space of  10^632.
medium_late01 has 1 skills, 4 shiftTypes, 7 patterns, 4 contracts, 30 employees, 28 shiftDates, 424 shiftAssignments and 390 requests with a search space of  10^626.
medium_late02 has 1 skills, 4 shiftTypes, 7 patterns, 3 contracts, 30 employees, 28 shiftDates, 428 shiftAssignments and 390 requests with a search space of  10^632.
medium_late03 has 1 skills, 4 shiftTypes, 0 patterns, 4 contracts, 30 employees, 28 shiftDates, 428 shiftAssignments and 390 requests with a search space of  10^632.
medium_late04 has 1 skills, 4 shiftTypes, 7 patterns, 3 contracts, 30 employees, 28 shiftDates, 416 shiftAssignments and 390 requests with a search space of  10^614.
medium_late05 has 2 skills, 5 shiftTypes, 7 patterns, 4 contracts, 30 employees, 28 shiftDates, 452 shiftAssignments and 390 requests with a search space of  10^667.

long01        has 2 skills, 5 shiftTypes, 3 patterns, 3 contracts, 49 employees, 28 shiftDates, 740 shiftAssignments and 735 requests with a search space of 10^1250.
long02        has 2 skills, 5 shiftTypes, 3 patterns, 3 contracts, 49 employees, 28 shiftDates, 740 shiftAssignments and 735 requests with a search space of 10^1250.
long03        has 2 skills, 5 shiftTypes, 3 patterns, 3 contracts, 49 employees, 28 shiftDates, 740 shiftAssignments and 735 requests with a search space of 10^1250.
long04        has 2 skills, 5 shiftTypes, 3 patterns, 3 contracts, 49 employees, 28 shiftDates, 740 shiftAssignments and 735 requests with a search space of 10^1250.
long05        has 2 skills, 5 shiftTypes, 3 patterns, 3 contracts, 49 employees, 28 shiftDates, 740 shiftAssignments and 735 requests with a search space of 10^1250.
long_hint01   has 2 skills, 5 shiftTypes, 9 patterns, 3 contracts, 50 employees, 28 shiftDates, 740 shiftAssignments and   0 requests with a search space of 10^1257.
long_hint02   has 2 skills, 5 shiftTypes, 7 patterns, 3 contracts, 50 employees, 28 shiftDates, 740 shiftAssignments and   0 requests with a search space of 10^1257.
long_hint03   has 2 skills, 5 shiftTypes, 7 patterns, 3 contracts, 50 employees, 28 shiftDates, 740 shiftAssignments and   0 requests with a search space of 10^1257.
long_late01   has 2 skills, 5 shiftTypes, 9 patterns, 3 contracts, 50 employees, 28 shiftDates, 752 shiftAssignments and   0 requests with a search space of 10^1277.
long_late02   has 2 skills, 5 shiftTypes, 9 patterns, 4 contracts, 50 employees, 28 shiftDates, 752 shiftAssignments and   0 requests with a search space of 10^1277.
long_late03   has 2 skills, 5 shiftTypes, 9 patterns, 3 contracts, 50 employees, 28 shiftDates, 752 shiftAssignments and   0 requests with a search space of 10^1277.
long_late04   has 2 skills, 5 shiftTypes, 9 patterns, 4 contracts, 50 employees, 28 shiftDates, 752 shiftAssignments and   0 requests with a search space of 10^1277.
long_late05   has 2 skills, 5 shiftTypes, 9 patterns, 3 contracts, 50 employees, 28 shiftDates, 740 shiftAssignments and   0 requests with a search space of 10^1257.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="nurseRosteringDomainModel"><a class="anchor" href="#nurseRosteringDomainModel"></a><a class="link" href="#nurseRosteringDomainModel">3.15.4. Domain model</a></h4>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/NurseRostering/nurseRosteringClassDiagram.png" alt="nurseRosteringClassDiagram">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="travelingTournament"><a class="anchor" href="#travelingTournament"></a><a class="link" href="#travelingTournament">3.16. Traveling tournament problem (TTP)</a></h3>
<div class="sect3">
<h4 id="travelingTournamentProblemDescription"><a class="anchor" href="#travelingTournamentProblemDescription"></a><a class="link" href="#travelingTournamentProblemDescription">3.16.1. Problem description</a></h4>
<div class="paragraph">
<p>Schedule matches between <em>n</em> teams.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/TravellingTournament/travelingTournamentUseCase.png" alt="travelingTournamentUseCase">
</div>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each team plays twice against every other team: once home and once away.</p>
</li>
<li>
<p>Each team has exactly one match on each timeslot.</p>
</li>
<li>
<p>No team must have more than three consecutive home or three consecutive away matches.</p>
</li>
<li>
<p>No repeaters: no two consecutive matches of the same two opposing teams.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Minimize the total distance traveled by all teams.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The problem is defined on <a href="http://mat.tepper.cmu.edu/TOURN/">Michael Trick&#8217;s website (which contains the world records too)</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="travelingTournamentProblemSize"><a class="anchor" href="#travelingTournamentProblemSize"></a><a class="link" href="#travelingTournamentProblemSize">3.16.2. Problem size</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">1-nl04     has  6 days,  4 teams and   12 matches with a search space of    10^5.
1-nl06     has 10 days,  6 teams and   30 matches with a search space of   10^19.
1-nl08     has 14 days,  8 teams and   56 matches with a search space of   10^43.
1-nl10     has 18 days, 10 teams and   90 matches with a search space of   10^79.
1-nl12     has 22 days, 12 teams and  132 matches with a search space of  10^126.
1-nl14     has 26 days, 14 teams and  182 matches with a search space of  10^186.
1-nl16     has 30 days, 16 teams and  240 matches with a search space of  10^259.
2-bra24    has 46 days, 24 teams and  552 matches with a search space of  10^692.
3-nfl16    has 30 days, 16 teams and  240 matches with a search space of  10^259.
3-nfl18    has 34 days, 18 teams and  306 matches with a search space of  10^346.
3-nfl20    has 38 days, 20 teams and  380 matches with a search space of  10^447.
3-nfl22    has 42 days, 22 teams and  462 matches with a search space of  10^562.
3-nfl24    has 46 days, 24 teams and  552 matches with a search space of  10^692.
3-nfl26    has 50 days, 26 teams and  650 matches with a search space of  10^838.
3-nfl28    has 54 days, 28 teams and  756 matches with a search space of  10^999.
3-nfl30    has 58 days, 30 teams and  870 matches with a search space of 10^1175.
3-nfl32    has 62 days, 32 teams and  992 matches with a search space of 10^1367.
4-super04  has  6 days,  4 teams and   12 matches with a search space of    10^5.
4-super06  has 10 days,  6 teams and   30 matches with a search space of   10^19.
4-super08  has 14 days,  8 teams and   56 matches with a search space of   10^43.
4-super10  has 18 days, 10 teams and   90 matches with a search space of   10^79.
4-super12  has 22 days, 12 teams and  132 matches with a search space of  10^126.
4-super14  has 26 days, 14 teams and  182 matches with a search space of  10^186.
5-galaxy04 has  6 days,  4 teams and   12 matches with a search space of    10^5.
5-galaxy06 has 10 days,  6 teams and   30 matches with a search space of   10^19.
5-galaxy08 has 14 days,  8 teams and   56 matches with a search space of   10^43.
5-galaxy10 has 18 days, 10 teams and   90 matches with a search space of   10^79.
5-galaxy12 has 22 days, 12 teams and  132 matches with a search space of  10^126.
5-galaxy14 has 26 days, 14 teams and  182 matches with a search space of  10^186.
5-galaxy16 has 30 days, 16 teams and  240 matches with a search space of  10^259.
5-galaxy18 has 34 days, 18 teams and  306 matches with a search space of  10^346.
5-galaxy20 has 38 days, 20 teams and  380 matches with a search space of  10^447.
5-galaxy22 has 42 days, 22 teams and  462 matches with a search space of  10^562.
5-galaxy24 has 46 days, 24 teams and  552 matches with a search space of  10^692.
5-galaxy26 has 50 days, 26 teams and  650 matches with a search space of  10^838.
5-galaxy28 has 54 days, 28 teams and  756 matches with a search space of  10^999.
5-galaxy30 has 58 days, 30 teams and  870 matches with a search space of 10^1175.
5-galaxy32 has 62 days, 32 teams and  992 matches with a search space of 10^1367.
5-galaxy34 has 66 days, 34 teams and 1122 matches with a search space of 10^1576.
5-galaxy36 has 70 days, 36 teams and 1260 matches with a search space of 10^1801.
5-galaxy38 has 74 days, 38 teams and 1406 matches with a search space of 10^2042.
5-galaxy40 has 78 days, 40 teams and 1560 matches with a search space of 10^2301.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cheapTimeScheduling"><a class="anchor" href="#cheapTimeScheduling"></a><a class="link" href="#cheapTimeScheduling">3.17. Cheap time scheduling</a></h3>
<div class="sect3">
<h4 id="cheapTimeSchedulingProblemDescription"><a class="anchor" href="#cheapTimeSchedulingProblemDescription"></a><a class="link" href="#cheapTimeSchedulingProblemDescription">3.17.1. Problem description</a></h4>
<div class="paragraph">
<p>Schedule all tasks in time and on a machine to minimize power cost.
Power prices differs in time.
This is a form of <em>job shop scheduling</em>.</p>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Start time limits: each task must start between its earliest start and latest start limit.</p>
</li>
<li>
<p>Maximum capacity: the maximum capacity for each resource for each machine must not be exceeded.</p>
</li>
<li>
<p>Startup and shutdown: each machine must be active in the periods during which it has assigned tasks. Between tasks it is allowed to be idle to avoid startup and shutdown costs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Medium constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Power cost: minimize the total power cost of the whole schedule.</p>
<div class="ulist">
<ul>
<li>
<p>Machine power cost: Each active or idle machine consumes power, which infers a power cost (depending on the power price during that time).</p>
</li>
<li>
<p>Task power cost: Each task consumes power too, which infers a power cost (depending on the power price during its time).</p>
</li>
<li>
<p>Machine startup and shutdown cost: Every time a machine starts up or shuts down, an extra cost is inflicted.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints (addendum to the original problem definition):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Start early: prefer starting a task sooner rather than later.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The problem is defined by the ICON challenge 2014.</p>
</div>
</div>
<div class="sect3">
<h4 id="cheapTimeSchedulingProblemSize"><a class="anchor" href="#cheapTimeSchedulingProblemSize"></a><a class="link" href="#cheapTimeSchedulingProblemSize">3.17.2. Problem size</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">sample01   has 3 resources,   2 machines, 288 periods and   25 tasks with a search space of    10^53.
sample02   has 3 resources,   2 machines, 288 periods and   50 tasks with a search space of   10^114.
sample03   has 3 resources,   2 machines, 288 periods and  100 tasks with a search space of   10^226.
sample04   has 3 resources,   5 machines, 288 periods and  100 tasks with a search space of   10^266.
sample05   has 3 resources,   2 machines, 288 periods and  250 tasks with a search space of   10^584.
sample06   has 3 resources,   5 machines, 288 periods and  250 tasks with a search space of   10^673.
sample07   has 3 resources,   2 machines, 288 periods and 1000 tasks with a search space of  10^2388.
sample08   has 3 resources,   5 machines, 288 periods and 1000 tasks with a search space of  10^2748.
sample09   has 4 resources,  20 machines, 288 periods and 2000 tasks with a search space of  10^6668.
instance00 has 1 resources,  10 machines, 288 periods and  200 tasks with a search space of   10^595.
instance01 has 1 resources,  10 machines, 288 periods and  200 tasks with a search space of   10^599.
instance02 has 1 resources,  10 machines, 288 periods and  200 tasks with a search space of   10^599.
instance03 has 1 resources,  10 machines, 288 periods and  200 tasks with a search space of   10^591.
instance04 has 1 resources,  10 machines, 288 periods and  200 tasks with a search space of   10^590.
instance05 has 2 resources,  25 machines, 288 periods and  200 tasks with a search space of   10^667.
instance06 has 2 resources,  25 machines, 288 periods and  200 tasks with a search space of   10^660.
instance07 has 2 resources,  25 machines, 288 periods and  200 tasks with a search space of   10^662.
instance08 has 2 resources,  25 machines, 288 periods and  200 tasks with a search space of   10^651.
instance09 has 2 resources,  25 machines, 288 periods and  200 tasks with a search space of   10^659.
instance10 has 2 resources,  20 machines, 288 periods and  500 tasks with a search space of  10^1657.
instance11 has 2 resources,  20 machines, 288 periods and  500 tasks with a search space of  10^1644.
instance12 has 2 resources,  20 machines, 288 periods and  500 tasks with a search space of  10^1637.
instance13 has 2 resources,  20 machines, 288 periods and  500 tasks with a search space of  10^1659.
instance14 has 2 resources,  20 machines, 288 periods and  500 tasks with a search space of  10^1643.
instance15 has 3 resources,  40 machines, 288 periods and  500 tasks with a search space of  10^1782.
instance16 has 3 resources,  40 machines, 288 periods and  500 tasks with a search space of  10^1778.
instance17 has 3 resources,  40 machines, 288 periods and  500 tasks with a search space of  10^1764.
instance18 has 3 resources,  40 machines, 288 periods and  500 tasks with a search space of  10^1769.
instance19 has 3 resources,  40 machines, 288 periods and  500 tasks with a search space of  10^1778.
instance20 has 3 resources,  50 machines, 288 periods and 1000 tasks with a search space of  10^3689.
instance21 has 3 resources,  50 machines, 288 periods and 1000 tasks with a search space of  10^3678.
instance22 has 3 resources,  50 machines, 288 periods and 1000 tasks with a search space of  10^3706.
instance23 has 3 resources,  50 machines, 288 periods and 1000 tasks with a search space of  10^3676.
instance24 has 3 resources,  50 machines, 288 periods and 1000 tasks with a search space of  10^3681.
instance25 has 3 resources,  60 machines, 288 periods and 1000 tasks with a search space of  10^3774.
instance26 has 3 resources,  60 machines, 288 periods and 1000 tasks with a search space of  10^3737.
instance27 has 3 resources,  60 machines, 288 periods and 1000 tasks with a search space of  10^3744.
instance28 has 3 resources,  60 machines, 288 periods and 1000 tasks with a search space of  10^3731.
instance29 has 3 resources,  60 machines, 288 periods and 1000 tasks with a search space of  10^3746.
instance30 has 4 resources,  70 machines, 288 periods and 2000 tasks with a search space of  10^7718.
instance31 has 4 resources,  70 machines, 288 periods and 2000 tasks with a search space of  10^7740.
instance32 has 4 resources,  70 machines, 288 periods and 2000 tasks with a search space of  10^7686.
instance33 has 4 resources,  70 machines, 288 periods and 2000 tasks with a search space of  10^7672.
instance34 has 4 resources,  70 machines, 288 periods and 2000 tasks with a search space of  10^7695.
instance35 has 4 resources,  80 machines, 288 periods and 2000 tasks with a search space of  10^7807.
instance36 has 4 resources,  80 machines, 288 periods and 2000 tasks with a search space of  10^7814.
instance37 has 4 resources,  80 machines, 288 periods and 2000 tasks with a search space of  10^7764.
instance38 has 4 resources,  80 machines, 288 periods and 2000 tasks with a search space of  10^7736.
instance39 has 4 resources,  80 machines, 288 periods and 2000 tasks with a search space of  10^7783.
instance40 has 4 resources,  90 machines, 288 periods and 4000 tasks with a search space of 10^15976.
instance41 has 4 resources,  90 machines, 288 periods and 4000 tasks with a search space of 10^15935.
instance42 has 4 resources,  90 machines, 288 periods and 4000 tasks with a search space of 10^15887.
instance43 has 4 resources,  90 machines, 288 periods and 4000 tasks with a search space of 10^15896.
instance44 has 4 resources,  90 machines, 288 periods and 4000 tasks with a search space of 10^15885.
instance45 has 4 resources, 100 machines, 288 periods and 5000 tasks with a search space of 10^20173.
instance46 has 4 resources, 100 machines, 288 periods and 5000 tasks with a search space of 10^20132.
instance47 has 4 resources, 100 machines, 288 periods and 5000 tasks with a search space of 10^20126.
instance48 has 4 resources, 100 machines, 288 periods and 5000 tasks with a search space of 10^20110.
instance49 has 4 resources, 100 machines, 288 periods and 5000 tasks with a search space of 10^20078.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="investment"><a class="anchor" href="#investment"></a><a class="link" href="#investment">3.18. Investment asset class allocation (portfolio optimization)</a></h3>
<div class="sect3">
<h4 id="investmentProblemDescription"><a class="anchor" href="#investmentProblemDescription"></a><a class="link" href="#investmentProblemDescription">3.18.1. Problem description</a></h4>
<div class="paragraph">
<p>Decide the relative quantity to invest in each asset class.</p>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Risk maximum: the total standard deviation must not be higher than the standard deviation maximum.</p>
<div class="ulist">
<ul>
<li>
<p>Total standard deviation calculation takes asset class correlations into account by applying <a href="https://en.wikipedia.org/wiki/Modern_portfolio_theory">Markowitz Portfolio Theory</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Region maximum: Each region has a quantity maximum.</p>
</li>
<li>
<p>Sector maximum: Each sector has a quantity maximum.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Maximize expected return.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="investmentProblemSize"><a class="anchor" href="#investmentProblemSize"></a><a class="link" href="#investmentProblemSize">3.18.2. Problem size</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">de_smet_1 has 1 regions, 3 sectors and 11 asset classes with a search space of 10^4.
irrinki_1 has 2 regions, 3 sectors and 6 asset classes with a search space of 10^3.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Larger datasets have not been created or tested yet, but should not pose a problem.
A good source of data is <a href="https://www.portfoliovisualizer.com/asset-correlations">this Asset Correlation website</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="conferenceScheduling"><a class="anchor" href="#conferenceScheduling"></a><a class="link" href="#conferenceScheduling">3.19. Conference scheduling</a></h3>
<div class="sect3">
<h4 id="conferenceSchedulingProblemDescription"><a class="anchor" href="#conferenceSchedulingProblemDescription"></a><a class="link" href="#conferenceSchedulingProblemDescription">3.19.1. Problem description</a></h4>
<div class="paragraph">
<p>Assign each conference talk to a timeslot and a room, after the talks have been accepted.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/ConferenceScheduling/conferenceSchedulingMilestonesTimeline.png" alt="conferenceSchedulingMilestonesTimeline">
</div>
</div>
<div class="paragraph">
<p>Timeslots can overlap. It reads/writes to/from an <code>*.xlsx</code> file that can be edited with LibreOffice or Excel.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/ConferenceScheduling/conferenceSchedulingProblem.png" alt="conferenceSchedulingProblem">
</div>
</div>
<div class="paragraph">
<p>Built-in hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Talk type of timeslot: The type of a talk must match the timeslot&#8217;s talk type.</p>
</li>
<li>
<p>Room unavailable timeslots: A talk&#8217;s room must be available during the talk&#8217;s timeslot.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hard constraints (unless configured otherwise):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Room conflict: Two talks can&#8217;t use the same room during overlapping timeslots.</p>
</li>
<li>
<p>Speaker unavailable timeslots: Every talk&#8217;s speaker must be available during the talk&#8217;s timeslot.</p>
</li>
<li>
<p>Speaker conflict: Two talks can&#8217;t share a speaker during overlapping timeslots.</p>
</li>
<li>
<p>Talk prerequisite talks: A talk must be scheduled after all its prerequisite talks.</p>
</li>
<li>
<p>Talk mutually-exclusive-talks tags: Talks that share such tags must not be scheduled in overlapping timeslots.</p>
</li>
<li>
<p>Consecutive talks pause: A speaker who has more than one talk must have a break between them.</p>
</li>
<li>
<p>Generic purpose timeslot and room tags</p>
<div class="ulist">
<ul>
<li>
<p>Speaker required timeslot tags: If a speaker has a required timeslot tag, then all his/her talks must be assigned to a timeslot with that tag.</p>
</li>
<li>
<p>Speaker prohibited timeslot tags: If a speaker has a prohibited timeslot tag, then all his/her talks cannot be assigned to a timeslot with that tag.</p>
</li>
<li>
<p>Talk required timeslot tags: If a talk has a required timeslot tag, then it must be assigned to a timeslot with that tag.</p>
</li>
<li>
<p>Talk prohibited timeslot tags: If a talk has a prohibited timeslot tag, then it cannot be assigned to a timeslot with that tag.</p>
</li>
<li>
<p>Speaker required room tags: If a speaker has a required room tag, then all his/her talks must be assigned to a room with that tag.</p>
</li>
<li>
<p>Speaker prohibited room tags: If a speaker has a prohibited room tag, then all his/her talks cannot be assigned to a room with that tag.</p>
</li>
<li>
<p>Talk required room tags: If a talk has a required room tag, then it must be assigned to a room with that tag.</p>
</li>
<li>
<p>Talk prohibited room tags: If a talk has a prohibited room tag, then it cannot be assigned to a room with that tag.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Medium constraints (unless configured otherwise):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Published timeslot: A published talk must not be scheduled at a different timeslot than currently published.
If a hard constraint&#8217;s input data changes after publishing (such as speaker unavailability), then this medium constraint will be
minimally broken to attain a new feasible solution.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints (unless configured otherwise):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Published room: Minimize the number of talks scheduled in different rooms than published ones.</p>
</li>
<li>
<p>Theme track conflict: Minimize the number of talks that share a same theme tag during overlapping timeslots.</p>
</li>
<li>
<p>Theme track room stability: Talks with common theme track tag should be scheduled in the same room throughout the day.</p>
</li>
<li>
<p>Sector conflict: Minimize the number of talks that share a same sector tag during overlapping timeslots.</p>
</li>
<li>
<p>Content audience level flow violation: For every content tag, schedule the introductory talks before the advanced talks.</p>
</li>
<li>
<p>Audience level diversity: For every timeslot, maximize the number of talks with a different audience level.</p>
</li>
<li>
<p>Language diversity: For every timeslot, maximize the number of talks with a different language.</p>
</li>
<li>
<p>Same day talks: All talks that share a theme track tag or content tag should be scheduled in the minimum number of days
(ideally in the same day).</p>
</li>
<li>
<p>Popular talks: Talks with higher <code>favoriteCount</code> should be scheduled in larger rooms.</p>
</li>
<li>
<p>Crowd control: Talks with higher <code>crowdControlRisk</code> should be scheduled in pairs at the same timeslot
to avoid having most participants going to the same room.</p>
</li>
<li>
<p>Generic purpose timeslot and room tags</p>
<div class="ulist">
<ul>
<li>
<p>Speaker preferred timeslot tag: If a speaker has a preferred timeslot tag, then all his/her talks should be assigned to a timeslot with that tag.</p>
</li>
<li>
<p>Speaker undesired timeslot tag: If a speaker has an undesired timeslot tag, then all his/her talks should not be assigned to a timeslot with that tag.</p>
</li>
<li>
<p>Talk preferred timeslot tag: If a talk has a preferred timeslot tag, then it should be assigned to a timeslot with that tag.</p>
</li>
<li>
<p>Talk undesired timeslot tag: If a talk has an undesired timeslot tag, then it should not be assigned to a timeslot with that tag.</p>
</li>
<li>
<p>Speaker preferred room tag: If a speaker has a preferred room tag, then all his/her talks should be assigned to a room with that tag.</p>
</li>
<li>
<p>Speaker undesired room tag: If a speaker has an undesired room tag, then all his/her talks should not be assigned to a room with that tag.</p>
</li>
<li>
<p>Talk preferred room tag: If a talk has a preferred room tag, then it should be assigned to a room with that tag.</p>
</li>
<li>
<p>Talk undesired room tag: If a talk has an undesired room tag, then it should not be assigned to a room with that tag.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Every constraint can be configured to use a different score level (hard/medium/soft) or a different score weight.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/ConferenceScheduling/conferenceSchedulingConstraints.png" alt="conferenceSchedulingConstraints">
</div>
</div>
</div>
<div class="sect3">
<h4 id="conferenceSchedulingValueProposition"><a class="anchor" href="#conferenceSchedulingValueProposition"></a><a class="link" href="#conferenceSchedulingValueProposition">3.19.2. Value proposition</a></h4>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/ConferenceScheduling/conferenceSchedulingValueProposition.png" alt="conferenceSchedulingValueProposition">
</div>
</div>
</div>
<div class="sect3">
<h4 id="conferenceSchedulingProblemSize"><a class="anchor" href="#conferenceSchedulingProblemSize"></a><a class="link" href="#conferenceSchedulingProblemSize">3.19.3. Problem size</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">18talks-6timeslots-5rooms    has  18 talks,  6 timeslots and  5 rooms with a search space of  10^26.
36talks-12timeslots-5rooms   has  36 talks, 12 timeslots and  5 rooms with a search space of  10^64.
72talks-12timeslots-10rooms  has  72 talks, 12 timeslots and 10 rooms with a search space of 10^149.
108talks-18timeslots-10rooms has 108 talks, 18 timeslots and 10 rooms with a search space of 10^243.
216talks-18timeslots-20rooms has 216 talks, 18 timeslots and 20 rooms with a search space of 10^552.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="conferenceSchedulingArchitecture"><a class="anchor" href="#conferenceSchedulingArchitecture"></a><a class="link" href="#conferenceSchedulingArchitecture">3.19.4. Architecture</a></h4>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/ConferenceScheduling/conferenceSchedulingArchitecture.png" alt="conferenceSchedulingArchitecture">
</div>
</div>
</div>
<div class="sect3">
<h4 id="conferenceSchedulingDomainModel"><a class="anchor" href="#conferenceSchedulingDomainModel"></a><a class="link" href="#conferenceSchedulingDomainModel">3.19.5. Domain model</a></h4>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/ConferenceScheduling/conferenceSchedulingClassDiagram.png" alt="conferenceSchedulingClassDiagram">
</div>
</div>
</div>
<div class="sect3">
<h4 id="conferenceSchedulingSearchSpace"><a class="anchor" href="#conferenceSchedulingSearchSpace"></a><a class="link" href="#conferenceSchedulingSearchSpace">3.19.6. Search space</a></h4>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/ConferenceScheduling/conferenceSchedulingOptimalIsImperfect.png" alt="conferenceSchedulingOptimalIsImperfect">
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./UseCasesAndExamples/ConferenceScheduling/conferenceSchedulingSearchSpace.png" alt="conferenceSchedulingSearchSpace">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="rockTour"><a class="anchor" href="#rockTour"></a><a class="link" href="#rockTour">3.20. Rock tour</a></h3>
<div class="sect3">
<h4 id="rockTourProblemDescription"><a class="anchor" href="#rockTourProblemDescription"></a><a class="link" href="#rockTourProblemDescription">3.20.1. Problem description</a></h4>
<div class="paragraph">
<p>Drive the rock bus from show to show, but schedule shows only on available days.</p>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Schedule every required show.</p>
</li>
<li>
<p>Schedule as many shows as possible.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Medium constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Maximize revenue opportunity.</p>
</li>
<li>
<p>Minimize driving time.</p>
</li>
<li>
<p>Visit sooner than later.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Avoid long driving times.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="rockTourProblemSize"><a class="anchor" href="#rockTourProblemSize"></a><a class="link" href="#rockTourProblemSize">3.20.2. Problem size</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">47shows has 47 shows with a search space of 10^59.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="flightCrewScheduling"><a class="anchor" href="#flightCrewScheduling"></a><a class="link" href="#flightCrewScheduling">3.21. Flight crew scheduling</a></h3>
<div class="sect3">
<h4 id="flightCrewSchedulingProblemDescription"><a class="anchor" href="#flightCrewSchedulingProblemDescription"></a><a class="link" href="#flightCrewSchedulingProblemDescription">3.21.1. Problem description</a></h4>
<div class="paragraph">
<p>Assign flights to pilots and flight attendants.</p>
</div>
<div class="paragraph">
<p>Hard constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Required skill: each flight assignment has a required skill.
For example, flight AB0001 requires 2 pilots and 3 flight attendants.</p>
</li>
<li>
<p>Flight conflict: each employee can only attend one flight at the same time</p>
</li>
<li>
<p>Transfer between two flights: between two flights, an employee must be able to transfer from the arrival airport to the departure airport.
For example, Ann arrives in Brussels at 10:00 and departs in Amsterdam at 15:00.</p>
</li>
<li>
<p>Employee unavailability: the employee must be available on the day of the flight.
For example, Ann is on vacation on 1-Feb.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Soft constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>First assignment departing from home</p>
</li>
<li>
<p>Last assignment arriving at home</p>
</li>
<li>
<p>Load balance flight duration total per employee</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="flightCrewSchedulingProblemSize"><a class="anchor" href="#flightCrewSchedulingProblemSize"></a><a class="link" href="#flightCrewSchedulingProblemSize">3.21.2. Problem size</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">175flights-7days-Europe  has 2 skills, 50 airports, 150 employees, 175 flights and  875 flight assignments with a search space of  10^1904.
700flights-28days-Europe has 2 skills, 50 airports, 150 employees, 700 flights and 3500 flight assignments with a search space of  10^7616.
875flights-7days-Europe  has 2 skills, 50 airports, 750 employees, 875 flights and 4375 flight assignments with a search space of 10^12578.
175flights-7days-US      has 2 skills, 48 airports, 150 employees, 175 flights and  875 flight assignments with a search space of  10^1904.</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="plannerConfiguration"><a class="anchor" href="#plannerConfiguration"></a><a class="link" href="#plannerConfiguration">4. OptaPlanner configuration</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="plannerConfigurationOverview"><a class="anchor" href="#plannerConfigurationOverview"></a><a class="link" href="#plannerConfigurationOverview">4.1. Overview</a></h3>
<div class="paragraph">
<p>Solving a planning problem with OptaPlanner consists of the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Model your planning problem</strong> as a class annotated with the <code>@PlanningSolution</code> annotation, for example the <code>NQueens</code> class.</p>
</li>
<li>
<p><strong>Configure a <code></strong>Solver<strong></code></strong>, for example a First Fit and Tabu Search solver for any <code>NQueens</code> instance.</p>
</li>
<li>
<p><strong>Load a problem data set</strong> from your data layer, for example a Four Queens instance. That is the planning problem.</p>
</li>
<li>
<p><strong>Solve it</strong> with <code>Solver.solve(problem)</code> which returns the best solution found.</p>
</li>
</ol>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./PlannerConfiguration/inputOutputOverview.png" alt="inputOutputOverview">
</div>
</div>
</div>
<div class="sect2">
<h3 id="solverConfiguration"><a class="anchor" href="#solverConfiguration"></a><a class="link" href="#solverConfiguration">4.2. Solver configuration</a></h3>
<div class="sect3">
<h4 id="solverConfigurationByXML"><a class="anchor" href="#solverConfigurationByXML"></a><a class="link" href="#solverConfigurationByXML">4.2.1. Solver configuration by XML</a></h4>
<div class="paragraph">
<p>Build a <code>Solver</code> instance with the <code>SolverFactory</code>.
Configure the <code>SolverFactory</code> with a solver configuration XML file, provided as a classpath resource (as defined by <code>ClassLoader.getResource()</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">       SolverFactory&lt;NQueens&gt; solverFactory = SolverFactory.createFromXmlResource(
               "org/optaplanner/examples/nqueens/solver/nqueensSolverConfig.xml");
       Solver&lt;NQueens&gt; solver = solverFactory.buildSolver();</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a typical project (following the Maven directory structure),
that solverConfig XML file would be located at <code>$PROJECT_DIR/src/main/resources/org/optaplanner/examples/nqueens/solver/nqueensSolverConfig.xml</code>.
Alternatively, a <code>SolverFactory</code> can be created from a <code>File</code> with <code>SolverFactory.createFromXmlFile()</code>.
However, for portability reasons, a classpath resource is recommended.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>On some environments (<a href="#integrationWithOSGi">OSGi</a>, <a href="#integrationWithJBossModules">JBoss modules</a>, &#8230;&#8203;), classpath resources (such as the solver config, score DRLs and domain classes) in your jars might not be available to the default <code>ClassLoader</code> of the <code>optaplanner-core</code> jar.
In those cases, provide the <code>ClassLoader</code> of your classes as a parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">       SolverFactory&lt;NQueens&gt; solverFactory = SolverFactory.createFromXmlResource(
               ".../nqueensSolverConfig.xml", getClass().getClassLoader());</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Both a <code>Solver</code> and a <code>SolverFactory</code> have a generic type called <code>Solution_</code>, which is the class representing a <a href="#planningProblemAndPlanningSolution">planning problem and solution</a>.</p>
</div>
<div class="paragraph">
<p>A solver configuration XML file looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;solver&gt;
  &lt;!-- Define the model --&gt;
  &lt;solutionClass&gt;org.optaplanner.examples.nqueens.domain.NQueens&lt;/solutionClass&gt;
  &lt;entityClass&gt;org.optaplanner.examples.nqueens.domain.Queen&lt;/entityClass&gt;

  &lt;!-- Define the score function --&gt;
  &lt;scoreDirectorFactory&gt;
    &lt;scoreDrl&gt;org/optaplanner/examples/nqueens/solver/nQueensConstraints.drl&lt;/scoreDrl&gt;
  &lt;/scoreDirectorFactory&gt;

  &lt;!-- Configure the optimization algorithms (optional) --&gt;
  &lt;termination&gt;
    ...
  &lt;/termination&gt;
  &lt;constructionHeuristic&gt;
    ...
  &lt;/constructionHeuristic&gt;
  &lt;localSearch&gt;
    ...
  &lt;/localSearch&gt;
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the three parts in it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define the model.</p>
</li>
<li>
<p>Define the score function.</p>
</li>
<li>
<p>Optionally configure the optimization algorithm(s).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These various parts of a configuration are explained further in this manual.</p>
</div>
<div class="paragraph">
<p><strong>OptaPlanner makes it relatively easy to switch optimization algorithm(s) just by changing the configuration.</strong> There is even a <a href="#benchmarker">Benchmarker</a> which allows you to play out different configurations against each other and report the most appropriate configuration for your use case.</p>
</div>
</div>
<div class="sect3">
<h4 id="solverConfigurationByJavaAPI"><a class="anchor" href="#solverConfigurationByJavaAPI"></a><a class="link" href="#solverConfigurationByJavaAPI">4.2.2. Solver configuration by Java API</a></h4>
<div class="paragraph">
<p>A solver configuration can also be configured with the <code>SolverConfig</code> API.
This is especially useful to change some values dynamically at runtime.
For example, to change the running time based on system property, before building the <code>Solver</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">        SolverConfig solverConfig = SolverConfig.createFromXmlResource(
                "org/optaplanner/examples/nqueens/solver/nqueensSolverConfig.xml");
        solverConfig.withTerminationConfig(new TerminationConfig()
                        .withMinutesSpentLimit(userInput));

        SolverFactory&lt;NQueens&gt; solverFactory = SolverFactory.create(solverConfig);
        Solver&lt;NQueens&gt; solver = solverFactory.buildSolver();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Every element in the solver configuration XML is available as a <code>*Config</code> class
or a property on a <code>*Config</code> class in the package namespace <code>org.optaplanner.core.config</code>.
These <code>*Config</code> classes are the Java representation of the XML format.
They build the runtime components (of the package namespace <code>org.optaplanner.core.impl</code>)
and assemble them into an efficient <code>Solver</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To configure a <code>SolverFactory</code> dynamically for each user request,
build a template <code>SolverConfig</code> during initialization
and copy it with the copy constructor for each user request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    private SolverConfig template;

    public void init() {
        template = SolverConfig.createFromXmlResource(
                "org/optaplanner/examples/nqueens/solver/nqueensSolverConfig.xml");
        template.setTerminationConfig(new TerminationConfig());
    }

    // Called concurrently from different threads
    public void userRequest(..., long userInput) {
        SolverConfig solverConfig = new SolverConfig(template); // Copy it
        solverConfig.getTerminationConfig().setMinutesSpentLimit(userInput);
        SolverFactory&lt;NQueens&gt; solverFactory = SolverFactory.create(solverConfig);
        Solver&lt;NQueens&gt; solver = solverFactory.buildSolver();
        ...
    }</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="annotationAlternatives"><a class="anchor" href="#annotationAlternatives"></a><a class="link" href="#annotationAlternatives">4.2.3. Annotation alternatives</a></h4>
<div class="paragraph">
<p>OptaPlanner needs to be told which classes in your domain model are planning entities, which properties are planning variables, etc.
There are several ways to deliver this information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add class annotations and JavaBean property annotations on the domain model (recommended).
The property annotations must be on the getter method, not on the setter method.
Such a getter does not need to be public.</p>
</li>
<li>
<p>Add class annotations and field annotations on the domain model.
Such a field does not need to be public.</p>
</li>
<li>
<p>No annotations: externalize the domain configuration in an XML file.
This is <a href="https://issues.redhat.com/browse/PLANNER-151">not yet supported</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This manual focuses on the first manner, but every feature supports all three manners, even if it&#8217;s not explicitly mentioned.</p>
</div>
</div>
<div class="sect3">
<h4 id="customPropertiesConfiguration"><a class="anchor" href="#customPropertiesConfiguration"></a><a class="link" href="#customPropertiesConfiguration">4.2.4. Custom properties configuration</a></h4>
<div class="paragraph">
<p>Solver configuration elements, that instantiate classes and explicitly mention it, support custom properties.
Custom properties are useful to tweak dynamic values through the <a href="#benchmarker">Benchmarker</a>.
For example, presume your <code>EasyScoreCalculator</code> has heavy calculations (which are cached)
and you want to increase the cache size in one benchmark:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;scoreDirectorFactory&gt;
    &lt;easyScoreCalculatorClass&gt;...MyEasyScoreCalculator&lt;/easyScoreCalculatorClass&gt;
    &lt;easyScoreCalculatorCustomProperties&gt;
      &lt;myCacheSize&gt;1000&lt;/myCacheSize&gt;&lt;!-- Override value --&gt;
    &lt;/easyScoreCalculatorCustomProperties&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add a public setter for each custom property, which is called when a <code>Solver</code> is built.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class MyEasyScoreCalculator extends EasyScoreCalculator&lt;MySolution&gt; {

        private int myCacheSize = 500; // Default value

        @SuppressWarnings("unused")
        public void setMyCacheSize(int myCacheSize) {
            this.myCacheSize = myCacheSize;
        }

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Most value types are supported (including <code>boolean</code>, <code>int</code>, <code>double</code>, <code>BigDecimal</code>, <code>String</code> and enums).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="modelAPlanningProblem"><a class="anchor" href="#modelAPlanningProblem"></a><a class="link" href="#modelAPlanningProblem">4.3. Model a planning problem</a></h3>
<div class="sect3">
<h4 id="isThisClassAProblemFactOrPlanningEntity"><a class="anchor" href="#isThisClassAProblemFactOrPlanningEntity"></a><a class="link" href="#isThisClassAProblemFactOrPlanningEntity">4.3.1. Is this class a problem fact or planning entity?</a></h4>
<div class="paragraph">
<p>Look at a dataset of your planning problem.
You will recognize domain classes in there, each of which can be categorized as one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An unrelated class: not used by any of the score constraints. From a planning standpoint, this data is obsolete.</p>
</li>
<li>
<p>A <strong>problem fact</strong> class: used by the score constraints, but does NOT change during planning (as long as the problem stays the same). For example: <code>Bed</code>, <code>Room</code>, <code>Shift</code>, <code>Employee</code>, <code>Topic</code>, <code>Period</code>, &#8230;&#8203; All the properties of a problem fact class are problem properties.</p>
</li>
<li>
<p>A <strong>planning entity</strong> class: used by the score constraints and changes during planning. For example: <code>BedDesignation</code>, <code>ShiftAssignment</code>, <code>Exam</code>, &#8230;&#8203; The properties that change during planning are planning variables. The other properties are problem properties.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ask yourself: <em>What class changes during planning?</em> <em>Which class has variables that I want the <code></em>Solver<em></code> to change for me?</em> That class is a planning entity.
Most use cases have only one planning entity class.
Most use cases also have only one planning variable per planning entity class.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In <a href="#realTimePlanning">real-time planning</a>, even though the problem itself changes, problem facts do not really change during planning, instead they change between planning (because the Solver temporarily stops to apply the problem fact changes).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To create a good domain model, read the <a href="#domainModelingGuide">domain modeling guide</a>.</p>
</div>
<div class="paragraph">
<p><strong>In OptaPlanner, all problem facts and planning entities are plain old JavaBeans (POJOs).</strong> Load them from a database, an XML file, a data repository, a REST service, a noSQL cloud, &#8230;&#8203; (see <a href="#integration">integration</a>): it doesn&#8217;t matter.</p>
</div>
</div>
<div class="sect3">
<h4 id="problemFact"><a class="anchor" href="#problemFact"></a><a class="link" href="#problemFact">4.3.2. Problem fact</a></h4>
<div class="paragraph">
<p>A problem fact is any JavaBean (POJO) with getters that does not change during planning.
Implementing the interface <code>Serializable</code> is recommended (but not required). For example in n queens, the columns and rows are problem facts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class Column implements Serializable {

    private int index;

    // ... getters
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class Row implements Serializable {

    private int index;

    // ... getters
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A problem fact can reference other problem facts of course:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class Course implements Serializable {

    private String code;

    private Teacher teacher; // Other problem fact
    private int lectureSize;
    private int minWorkingDaySize;

    private List&lt;Curriculum&gt; curriculumList; // Other problem facts
    private int studentSize;

    // ... getters
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A problem fact class does <em>not</em> require any OptaPlanner specific code.
For example, you can reuse your domain classes, which might have JPA annotations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Generally, better designed domain classes lead to simpler and more efficient score constraints.
Therefore, when dealing with a messy (denormalized) legacy system, it can sometimes be worthwhile to convert the messy domain model into a OptaPlanner specific model first.
For example: if your domain model has two <code>Teacher</code> instances for the same teacher that teaches at two different departments, it is harder to write a correct score constraint that constrains a teacher&#8217;s spare time on the original model than on an adjusted model.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can sometimes also introduce <a href="#cachedProblemFact"><em>a cached problem fact</em></a> to enrich the domain model for planning only.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="planningEntity"><a class="anchor" href="#planningEntity"></a><a class="link" href="#planningEntity">4.3.3. Planning entity</a></h4>
<div class="sect4">
<h5 id="planningEntityAnnotation"><a class="anchor" href="#planningEntityAnnotation"></a><a class="link" href="#planningEntityAnnotation">4.3.3.1. Planning entity annotation</a></h5>
<div class="paragraph">
<p>A planning entity is a JavaBean (POJO) that changes during solving, for example a <code>Queen</code> that changes to another row.
A planning problem has multiple planning entities, for example for a single n queens problem, each <code>Queen</code> is a planning entity.
But there is usually only one planning entity class, for example the <code>Queen</code> class.</p>
</div>
<div class="paragraph">
<p>A planning entity class needs to be annotated with the <code>@PlanningEntity</code> annotation.</p>
</div>
<div class="paragraph">
<p>Each planning entity class has one or more <em>planning variables</em> (which can be <a href="#planningVariable">genuine</a> or <a href="#shadowVariable">shadows</a>).
It should also have one or more <em>defining</em> properties.
For example in n queens, a <code>Queen</code> is defined by its <code>Column</code> and has a planning variable <code>Row</code>.
This means that a Queen&#8217;s column never changes during solving, while its row does change.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningEntity
public class Queen {

    private Column column;

    // Planning variables: changes during planning, between score calculations.
    private Row row;

    // ... getters and setters
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A planning entity class can have multiple planning variables.
For example, a <code>Lecture</code> is defined by its <code>Course</code> and its index in that course (because one course has multiple lectures).
Each <code>Lecture</code> needs to be scheduled into a <code>Period</code> and a <code>Room</code> so it has two planning variables (period and room).
For example: the course Mathematics has eight lectures per week, of which the first lecture is Monday morning at 08:00 in room 212.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningEntity
public class Lecture {

    private Course course;
    private int lectureIndexInCourse;

    // Planning variables: changes during planning, between score calculations.
    private Period period;
    private Room room;

    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The solver configuration needs to declare each planning entity class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">&lt;solver&gt;
  ...
  &lt;entityClass&gt;org.optaplanner.examples.nqueens.domain.Queen&lt;/entityClass&gt;
  ...
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some uses cases have multiple planning entity classes.
For example: route freight and trains into railway network arcs, where each freight can use multiple trains over its journey and each train can carry multiple freights per arc.
Having multiple planning entity classes directly raises the implementation complexity of your use case.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><em>Do not create unnecessary planning entity classes.</em> This leads to difficult <code>Move</code> implementations and slower score calculation.</p>
</div>
<div class="paragraph">
<p>For example, do not create a planning entity class to hold the total free time of a teacher, which needs to be kept up to date as the <code>Lecture</code> planning entities change.
Instead, calculate the free time in the score constraints (or as a <a href="#shadowVariable">shadow variable</a>) and put the result per teacher into a logically inserted score object.</p>
</div>
<div class="paragraph">
<p>If historic data needs to be considered too, then create problem fact to hold the total of the historic assignments up to, but <em>not including</em>, the planning window (so that it does not change when a planning entity changes) and let the score constraints take it into account.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="planningEntityDifficulty"><a class="anchor" href="#planningEntityDifficulty"></a><a class="link" href="#planningEntityDifficulty">4.3.3.2. Planning entity difficulty</a></h5>
<div class="paragraph">
<p>Some optimization algorithms work more efficiently if they have an estimation of which planning entities are more difficult to plan.
For example: in bin packing bigger items are harder to fit, in course scheduling lectures with more students are more difficult to schedule, and in n queens the middle queens are more difficult to fit on the board.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Do not try to use planning entity difficulty to implement a business
          constraint.</strong> It will not affect the score function: if we have infinite solving time, the returned solution will be the same.</p>
</div>
<div class="paragraph">
<p>To attain a schedule in which certain entities are scheduled earlier in the schedule, <a href="#formalizeTheBusinessConstraints">add a score constraint</a> to change the score function so it prefers such solutions.
Only consider adding planning entity difficulty too if it can make the solver more efficient.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To allow the heuristics to take advantage of that domain specific information, set a <code>difficultyComparatorClass</code> to the <code>@PlanningEntity</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningEntity(difficultyComparatorClass = CloudProcessDifficultyComparator.class)
public class CloudProcess {
    // ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class CloudProcessDifficultyComparator implements Comparator&lt;CloudProcess&gt; {

    public int compare(CloudProcess a, CloudProcess b) {
        return new CompareToBuilder()
                .append(a.getRequiredMultiplicand(), b.getRequiredMultiplicand())
                .append(a.getId(), b.getId())
                .toComparison();
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can also set a <code>difficultyWeightFactoryClass</code> to the <code>@PlanningEntity</code> annotation,
so that you have access to the rest of the problem facts from the solution too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningEntity(difficultyWeightFactoryClass = QueenDifficultyWeightFactory.class)
public class Queen {
    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="#sortedSelection">sorted selection</a> for more information.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Difficulty should be implemented ascending: easy entities are lower, difficult entities are higher.
For example, in bin packing: small item &lt; medium item &lt; big item.</p>
</div>
<div class="paragraph">
<p>Although most algorithms start with the more difficult entities first, they just reverse the ordering.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>None of the current planning variable states should be used to compare planning entity difficulty.</em> During Construction Heuristics, those variables are likely to be <code>null</code> anyway.
For example, a <code>Queen</code>'s <code>row</code> variable should not be used.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="planningVariable"><a class="anchor" href="#planningVariable"></a><a class="link" href="#planningVariable">4.3.4. Planning variable (genuine)</a></h4>
<div class="sect4">
<h5 id="planningVariableAnnotation"><a class="anchor" href="#planningVariableAnnotation"></a><a class="link" href="#planningVariableAnnotation">4.3.4.1. Planning variable annotation</a></h5>
<div class="paragraph">
<p>A planning variable is a JavaBean property (so a getter and setter) on a planning entity.
It points to a planning value, which changes during planning.
For example, a <code>Queen</code>'s <code>row</code> property is a genuine planning variable.
Note that even though a <code>Queen</code>'s <code>row</code> property changes to another <code>Row</code> during planning, no <code>Row</code> instance itself is changed.
Normally planning variables are genuine, but advanced cases can also have <a href="#shadowVariable">shadows</a>.</p>
</div>
<div class="paragraph">
<p>A genuine planning variable getter needs to be annotated with the <code>@PlanningVariable</code> annotation, which needs a non-empty <code>valueRangeProviderRefs</code> property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningEntity
public class Queen {
    ...

    private Row row;

    @PlanningVariable(valueRangeProviderRefs = {"rowRange"})
    public Row getRow() {
        return row;
    }

    public void setRow(Row row) {
        this.row = row;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>valueRangeProviderRefs</code> property defines what are the possible planning values for this planning variable.
It references one or more <code>@ValueRangeProvider</code> <code>id</code>'s.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A @PlanningVariable annotation needs to be on a member in a class with a @PlanningEntity annotation.
It is ignored on parent classes or subclasses without that annotation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="#annotationAlternatives">Annotating the field</a> instead of the property works too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningEntity
public class Queen {
    ...

    @PlanningVariable(valueRangeProviderRefs = {"rowRange"})
    private Row row;

}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="nullablePlanningVariable"><a class="anchor" href="#nullablePlanningVariable"></a><a class="link" href="#nullablePlanningVariable">4.3.4.2. Nullable planning variable</a></h5>
<div class="paragraph">
<p>By default, an initialized planning variable cannot be <code>null</code>, so an initialized solution will never use <code>null</code> for any of its planning variables.
In an over-constrained use case, this can be counterproductive.
For example: in task assignment with too many tasks for the workforce, we would rather leave low priority tasks unassigned instead of assigning them to an overloaded worker.</p>
</div>
<div class="paragraph">
<p>To allow an initialized planning variable to be <code>null</code>, set <code>nullable</code> to <code>true</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @PlanningVariable(..., nullable = true)
    public Worker getWorker() {
        return worker;
    }</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>OptaPlanner will automatically add the value <code>null</code> to the value range.
There is no need to add <code>null</code> in a collection used by a <code>ValueRangeProvider</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Using a nullable planning variable implies that your score calculation is responsible for punishing (or even rewarding) variables with a null value.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Currently <a href="#chainedPlanningVariable">chained</a> planning variables are not compatible with <code>nullable</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="#repeatedPlanning">Repeated planning</a> (especially <a href="#realTimePlanning">real-time planning</a>) does not mix well with a nullable planning variable.
Every time the Solver starts or a problem fact change is made, the <a href="#constructionHeuristics">Construction Heuristics</a>
will try to initialize all the <code>null</code> variables again, which can be a huge waste of time.
One way to deal with this is to filter the entity selector of the placer in the construction heuristic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;solverConfig&gt;
  ...
  &lt;constructionHeuristics&gt;
    &lt;queuedEntityPlacer&gt;
      &lt;entitySelector id="entitySelector1"&gt;
        &lt;filterClass&gt;...&lt;/filterClass&gt;
      &lt;/entitySelector&gt;
    &lt;/queuedEntityPlacer&gt;
    ...
    &lt;changeMoveselector&gt;
      &lt;entitySelector mimicRef="entitySelector1" /&gt;
    &lt;/changeMoveselector&gt;
    ...
  &lt;/constructionHeuristics&gt;
 ...
&lt;/solverConfig&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="whenIsAPlanningVariableInitialized"><a class="anchor" href="#whenIsAPlanningVariableInitialized"></a><a class="link" href="#whenIsAPlanningVariableInitialized">4.3.4.3. When is a planning variable considered initialized?</a></h5>
<div class="paragraph">
<p>A planning variable is considered initialized if its value is not <code>null</code> or if the variable is <code>nullable</code>.
So a nullable variable is always considered initialized.</p>
</div>
<div class="paragraph">
<p>A planning entity is initialized if all of its planning variables are initialized.</p>
</div>
<div class="paragraph">
<p>A solution is initialized if all of its planning entities are initialized.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="planningValueAndPlanningValueRange"><a class="anchor" href="#planningValueAndPlanningValueRange"></a><a class="link" href="#planningValueAndPlanningValueRange">4.3.5. Planning value and planning value range</a></h4>
<div class="sect4">
<h5 id="planningValue"><a class="anchor" href="#planningValue"></a><a class="link" href="#planningValue">4.3.5.1. Planning value</a></h5>
<div class="paragraph">
<p>A planning value is a possible value for a genuine planning variable.
Usually, a planning value is a problem fact, but it can also be any object, for example a <code>double</code>.
It can even be another planning entity or even an interface implemented by both a planning entity and a problem fact.</p>
</div>
<div class="paragraph">
<p>A planning value range is the set of possible planning values for a planning variable.
This set can be a countable (for example row <code>1</code>, <code>2</code>, <code>3</code> or <code>4</code>) or uncountable (for example any <code>double</code> between <code>0.0</code> and <code>1.0</code>).</p>
</div>
</div>
<div class="sect4">
<h5 id="planningValueRangeProvider"><a class="anchor" href="#planningValueRangeProvider"></a><a class="link" href="#planningValueRangeProvider">4.3.5.2. Planning value range provider</a></h5>
<div class="sect5">
<h6 id="planningValueRangeProviderOverview"><a class="anchor" href="#planningValueRangeProviderOverview"></a><a class="link" href="#planningValueRangeProviderOverview">4.3.5.2.1. Overview</a></h6>
<div class="paragraph">
<p>The value range of a planning variable is defined with the <code>@ValueRangeProvider</code> annotation.
A <code>@ValueRangeProvider</code> annotation always has a property <code>id</code>, which is referenced by the <code>@PlanningVariable</code>'s property <code>valueRangeProviderRefs</code>.</p>
</div>
<div class="paragraph">
<p>This annotation can be located on two types of methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On the Solution: All planning entities share the same value range.</p>
</li>
<li>
<p>On the planning entity: The value range differs per planning entity. This is less common.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A @ValueRangeProvider annotation needs to be on a member in a class with a @PlanningSolution or a @PlanningEntity annotation.
It is ignored on parent classes or subclasses without those annotations.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The return type of that method can be three types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Collection</code>: The value range is defined by a <code>Collection</code> (usually a <code>List</code>) of its possible values.</p>
</li>
<li>
<p>Array: The value range is defined by an array of its possible values.</p>
</li>
<li>
<p><code>ValueRange</code>: The value range is defined by its bounds. This is less common.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="valueRangeProviderOnSolution"><a class="anchor" href="#valueRangeProviderOnSolution"></a><a class="link" href="#valueRangeProviderOnSolution">4.3.5.2.2. <code>ValueRangeProvider</code> on the solution</a></h6>
<div class="paragraph">
<p>All instances of the same planning entity class share the same set of possible planning values for that planning variable.
This is the most common way to configure a value range.</p>
</div>
<div class="paragraph">
<p>The <code>@PlanningSolution</code> implementation has method that returns a <code>Collection</code> (or a <code>ValueRange</code>).
Any value from that <code>Collection</code> is a possible planning value for this planning variable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @PlanningVariable(valueRangeProviderRefs = {"rowRange"})
    public Row getRow() {
        return row;
    }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
public class NQueens {
    ...

    @ValueRangeProvider(id = "rowRange")
    public List&lt;Row&gt; getRowList() {
        return rowList;
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>That <code>Collection</code> (or <code>ValueRange</code>) must not contain the value <code>null</code>, not even for a <a href="#nullablePlanningVariable">nullable planning variable</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="#annotationAlternatives">Annotating the field</a> instead of the property works too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
public class NQueens {
    ...

    @ValueRangeProvider(id = "rowRange")
    private List&lt;Row&gt; rowList;

}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="valueRangeProviderOnPlanningEntity"><a class="anchor" href="#valueRangeProviderOnPlanningEntity"></a><a class="link" href="#valueRangeProviderOnPlanningEntity">4.3.5.2.3. <code>ValueRangeProvider</code> on the Planning Entity</a></h6>
<div class="paragraph">
<p>Each planning entity has its own value range (a set of possible planning values) for the planning variable.
For example, if a teacher can <strong>never</strong> teach in a room that does not belong to his department, lectures of that teacher can limit their room value range to the rooms of his department.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @PlanningVariable(valueRangeProviderRefs = {"departmentRoomRange"})
    public Room getRoom() {
        return room;
    }

    @ValueRangeProvider(id = "departmentRoomRange")
    public List&lt;Room&gt; getPossibleRoomList() {
        return getCourse().getTeacher().getDepartment().getRoomList();
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Never use this to enforce a soft constraint (or even a hard constraint when the problem might not have a feasible solution). For example: <em>Unless there is no other way</em>, a teacher can not teach in a room that does not belong to his department.
In this case, the teacher should <em>not</em> be limited in his room value range (because sometimes there is no other way).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By limiting the value range specifically of one planning entity, you are effectively creating a <em>built-in hard constraint</em>.
This can have the benefit of severely lowering the number of possible solutions; however, it can also take away the freedom of the optimization algorithms to temporarily break that constraint in order to escape from a local optimum.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A planning entity should <em>not</em> use other planning entities to determine its value range.
That would only try to make the planning entity solve the planning problem itself and interfere with the optimization algorithms.</p>
</div>
<div class="paragraph">
<p>Every entity has its own <code>List</code> instance, unless multiple entities have the same value range.
For example, if teacher A and B belong to the same department, they use the same <code>List&lt;Room&gt;</code> instance.
Furthermore, each <code>List</code> contains a subset of the same set of planning value instances.
For example, if department A and B can both use room X, then their <code>List&lt;Room&gt;</code> instances contain the same <code>Room</code> instance.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A <code>ValueRangeProvider</code> on the planning entity consumes more memory than <code>ValueRangeProvider</code> on the Solution and disables certain automatic performance optimizations.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A <code>ValueRangeProvider</code> on the planning entity is not currently compatible with a <a href="#chainedPlanningVariable">chained</a> variable.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="valueRangeFactory"><a class="anchor" href="#valueRangeFactory"></a><a class="link" href="#valueRangeFactory">4.3.5.2.4. <code>ValueRangeFactory</code></a></h6>
<div class="paragraph">
<p>Instead of a <code>Collection</code>, you can also return a <code>ValueRange</code> or <code>CountableValueRange</code>, build by the <code>ValueRangeFactory</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @ValueRangeProvider(id = "delayRange")
    public CountableValueRange&lt;Integer&gt; getDelayRange() {
        return ValueRangeFactory.createIntValueRange(0, 5000);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>ValueRange</code> uses far less memory, because it only holds the bounds.
In the example above, a <code>Collection</code> would need to hold all <code>5000</code> ints, instead of just the two bounds.</p>
</div>
<div class="paragraph">
<p>Furthermore, an <code>incrementUnit</code> can be specified, for example if you have to buy stocks in units of 200 pieces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @ValueRangeProvider(id = "stockAmountRange")
    public CountableValueRange&lt;Integer&gt; getStockAmountRange() {
         // Range: 0, 200, 400, 600, ..., 9999600, 9999800, 10000000
        return ValueRangeFactory.createIntValueRange(0, 10000000, 200);
    }</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Return <code>CountableValueRange</code> instead of <code>ValueRange</code> whenever possible (so OptaPlanner knows that it&#8217;s countable).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>ValueRangeFactory</code> has creation methods for several value class types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>boolean</code>: A boolean range.</p>
</li>
<li>
<p><code>int</code>: A 32bit integer range.</p>
</li>
<li>
<p><code>long</code>: A 64bit integer range.</p>
</li>
<li>
<p><code>double</code>: A 64bit floating point range which only supports random selection (because it does not implement <code>CountableValueRange</code>).</p>
</li>
<li>
<p><code>BigInteger</code>: An arbitrary-precision integer range.</p>
</li>
<li>
<p><code>BigDecimal</code>: A decimal point range. By default, the increment unit is the lowest non-zero value in the scale of the bounds.</p>
</li>
<li>
<p><code>Temporal</code> (such as <code>LocalDate</code>, <code>LocalDateTime</code>, &#8230;&#8203;): A time range.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="combineValueRangeProviders"><a class="anchor" href="#combineValueRangeProviders"></a><a class="link" href="#combineValueRangeProviders">4.3.5.2.5. Combine <code>ValueRangeProviders</code></a></h6>
<div class="paragraph">
<p>Value range providers can be combined, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @PlanningVariable(valueRangeProviderRefs = {"companyCarRange", "personalCarRange"})
    public Car getCar() {
        return car;
    }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @ValueRangeProvider(id = "companyCarRange")
    public List&lt;CompanyCar&gt; getCompanyCarList() {
        return companyCarList;
    }

    @ValueRangeProvider(id = "personalCarRange")
    public List&lt;PersonalCar&gt; getPersonalCarList() {
        return personalCarList;
    }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="planningValueStrength"><a class="anchor" href="#planningValueStrength"></a><a class="link" href="#planningValueStrength">4.3.5.3. Planning value strength</a></h5>
<div class="paragraph">
<p>Some optimization algorithms work a bit more efficiently if they have an estimation of which planning values are stronger, which means they are more likely to satisfy a planning entity.
For example: in bin packing bigger containers are more likely to fit an item and in course scheduling bigger rooms are less likely to break the student capacity constraint.
Usually, the efficiency gain of planning value strength is far less than that of <a href="#planningEntityDifficulty">planning entity difficulty</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Do not try to use planning value strength to implement a business
          constraint.</strong> It will not affect the score function: if we have infinite solving time, the returned solution will be the same.</p>
</div>
<div class="paragraph">
<p>To affect the score function, <a href="#formalizeTheBusinessConstraints">add a score constraint</a>.
Only consider adding planning value strength too if it can make the solver more efficient.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To allow the heuristics to take advantage of that domain specific information, set a <code>strengthComparatorClass</code> to the <code>@PlanningVariable</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @PlanningVariable(..., strengthComparatorClass = CloudComputerStrengthComparator.class)
    public CloudComputer getComputer() {
        return computer;
    }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class CloudComputerStrengthComparator implements Comparator&lt;CloudComputer&gt; {

    public int compare(CloudComputer a, CloudComputer b) {
        return new CompareToBuilder()
                .append(a.getMultiplicand(), b.getMultiplicand())
                .append(b.getCost(), a.getCost()) // Descending (but this is debatable)
                .append(a.getId(), b.getId())
                .toComparison();
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you have multiple planning value classes in the <em>same</em> value range, the <code>strengthComparatorClass</code> needs to implement a <code>Comparator</code> of a common superclass (for example <code>Comparator&lt;Object&gt;</code>) and be able to handle comparing instances of those different classes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively, you can also set a <code>strengthWeightFactoryClass</code> to the <code>@PlanningVariable</code> annotation, so you have access to the rest of the problem facts from the solution too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @PlanningVariable(..., strengthWeightFactoryClass = RowStrengthWeightFactory.class)
    public Row getRow() {
        return row;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="#sortedSelection">sorted selection</a> for more information.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Strength should be implemented ascending: weaker values are lower, stronger values are higher.
For example in bin packing: small container &lt; medium container &lt; big container.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>None of the current planning variable state in any of the planning entities should be used to compare planning values.</em> During construction heuristics, those variables are likely to be <code>null</code>.
For example, none of the <code>row</code> variables of any <code>Queen</code> may be used to determine the strength of a <code>Row</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="chainedPlanningVariable"><a class="anchor" href="#chainedPlanningVariable"></a><a class="link" href="#chainedPlanningVariable">4.3.5.4. Chained planning variable (TSP, VRP, &#8230;&#8203;)</a></h5>
<div class="paragraph">
<p>Some use cases, such as TSP and Vehicle Routing, require <em>chaining</em>.
This means the planning entities point to each other and form a chain.
By modeling the problem as a set of chains (instead of a set of trees/loops), the search space is heavily reduced.</p>
</div>
<div class="paragraph">
<p>A planning variable that is chained either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Directly points to a problem fact (or planning entity), which is called an <em>anchor</em>.</p>
</li>
<li>
<p>Points to another planning entity with the same planning variable, which recursively points to an anchor.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here are some examples of valid and invalid chains:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./PlannerConfiguration/chainPrinciples.png" alt="chainPrinciples">
</div>
</div>
<div class="paragraph">
<p><strong>Every initialized planning entity is part of an open-ended chain that begins from an anchor.</strong> A valid model means that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A chain is never a loop. The tail is always open.</p>
</li>
<li>
<p>Every chain always has exactly one anchor. The anchor is never an instance of the planning entity class that contains the chained planning variable.</p>
</li>
<li>
<p>A chain is never a tree, it is always a line. Every anchor or planning entity has at most one trailing planning entity.</p>
</li>
<li>
<p>Every initialized planning entity is part of a chain.</p>
</li>
<li>
<p>An anchor with no planning entities pointing to it, is also considered a chain.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A planning problem instance given to the <code>Solver</code> must be valid.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If your constraints dictate a closed chain, model it as an open-ended chain (which is easier to persist in a database) and implement a score constraint for the last entity back to the anchor.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The optimization algorithms and built-in <code>Move</code>s do chain correction to guarantee that the model stays valid:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./PlannerConfiguration/chainCorrection.png" alt="chainCorrection">
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A custom <code>Move</code> implementation must leave the model in a valid state.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, in TSP the anchor is a <code>Domicile</code> (in vehicle routing it is <code>Vehicle</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class Domicile ... implements Standstill {
    ...

    public City getCity() {...}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The anchor (which is a problem fact) and the planning entity implement a common interface, for example TSP&#8217;s <code>Standstill</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface Standstill {

    City getCity();

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>That interface is the return type of the planning variable.
Furthermore, the planning variable is chained.
For example TSP&#8217;s <code>Visit</code> (in vehicle routing it is <code>Customer</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningEntity
public class Visit ... implements Standstill {
    ...

    public City getCity() {...}

    @PlanningVariable(graphType = PlanningVariableGraphType.CHAINED,
        valueRangeProviderRefs = {"domicileRange", "visitRange"})
    public Standstill getPreviousStandstill() {
        return previousStandstill;
    }

    public void setPreviousStandstill(Standstill previousStandstill) {
        this.previousStandstill = previousStandstill;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice how two value range providers are usually combined:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The value range provider that holds the anchors, for example <code>domicileList</code>.</p>
</li>
<li>
<p>The value range provider that holds the initialized planning entities, for example <code>visitList</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="planningProblemAndPlanningSolution"><a class="anchor" href="#planningProblemAndPlanningSolution"></a><a class="link" href="#planningProblemAndPlanningSolution">4.3.6. Planning problem and planning solution</a></h4>
<div class="sect4">
<h5 id="planningProblemInstance"><a class="anchor" href="#planningProblemInstance"></a><a class="link" href="#planningProblemInstance">4.3.6.1. Planning problem instance</a></h5>
<div class="paragraph">
<p>A dataset for a planning problem needs to be wrapped in a class for the <code>Solver</code> to solve.
That solution class represents both the planning problem and (if solved) a solution.
It is annotated with a <code>@PlanningSolution</code> annotation.
For example in n queens, the solution class is the <code>NQueens</code> class, which contains a <code>Column</code> list, a <code>Row</code> list, and a <code>Queen</code> list.</p>
</div>
<div class="paragraph">
<p>A planning problem is actually an unsolved planning solution or - stated differently - an uninitialized solution.
For example in n queens, that <code>NQueens</code> class has the <code>@PlanningSolution</code> annotation, yet every <code>Queen</code> in an unsolved <code>NQueens</code> class is not yet assigned to a <code>Row</code> (their <code>row</code> property is <code>null</code>). That&#8217;s not a feasible solution.
It&#8217;s not even a possible solution.
It&#8217;s an uninitialized solution.</p>
</div>
</div>
<div class="sect4">
<h5 id="solutionClass"><a class="anchor" href="#solutionClass"></a><a class="link" href="#solutionClass">4.3.6.2. Solution class</a></h5>
<div class="paragraph">
<p>A solution class holds all problem facts, planning entities and a score.
It is annotated with a <code>@PlanningSolution</code> annotation.
For example, an <code>NQueens</code> instance holds a list of all columns, all rows and all <code>Queen</code> instances:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
public class NQueens {

    // Problem facts
    private int n;
    private List&lt;Column&gt; columnList;
    private List&lt;Row&gt; rowList;

    // Planning entities
    private List&lt;Queen&gt; queenList;

    private SimpleScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The solver configuration needs to declare the planning solution class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">&lt;solver&gt;
  ...
  &lt;solutionClass&gt;org.optaplanner.examples.nqueens.domain.NQueens&lt;/solutionClass&gt;
  ...
&lt;/solver&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="planningEntitiesOfASolution"><a class="anchor" href="#planningEntitiesOfASolution"></a><a class="link" href="#planningEntitiesOfASolution">4.3.6.3. Planning entities of a solution (<code>@PlanningEntityCollectionProperty</code>)</a></h5>
<div class="paragraph">
<p>OptaPlanner needs to extract the entity instances from the solution instance.
It gets those collection(s) by calling every getter (or field) that is annotated with <code>@PlanningEntityCollectionProperty</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
public class NQueens {
    ...

    private List&lt;Queen&gt; queenList;

    @PlanningEntityCollectionProperty
    public List&lt;Queen&gt; getQueenList() {
        return queenList;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There can be multiple <code>@PlanningEntityCollectionProperty</code> annotated members.
Those can even return a <code>Collection</code> with the same entity class type.
Instead of <code>Collection</code>, it can also return an array.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A <code>@PlanningEntityCollectionProperty</code> annotation needs to be on a member in a class with a <code>@PlanningSolution</code> annotation.
It is ignored on parent classes or subclasses without that annotation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In rare cases, a planning entity might be a singleton: use <code>@PlanningEntityProperty</code> on its getter (or field) instead.</p>
</div>
<div class="paragraph">
<p>Both annotations can also be <a href="#autoDiscoverSolutionProperties">auto discovered</a> if enabled.</p>
</div>
</div>
<div class="sect4">
<h5 id="scoreOfASolution"><a class="anchor" href="#scoreOfASolution"></a><a class="link" href="#scoreOfASolution">4.3.6.4. <code>Score</code> of asSolution (<code>@PlanningScore</code>)</a></h5>
<div class="paragraph">
<p>A <code>@PlanningSolution</code> class requires a score property (or field), which is annotated with a <code>@PlanningScore</code> annotation.
The score property is <code>null</code> if the score hasn&#8217;t been calculated yet.
The <code>score</code> property is typed to the specific <code>Score</code> implementation of your use case.
For example, <code>NQueens</code> uses a <a href="#simpleScore">SimpleScore</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
public class NQueens {
    ...

    private SimpleScore score;

    @PlanningScore
    public SimpleScore getScore() {
        return score;
    }
    public void setScore(SimpleScore score) {
        this.score = score;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Most use cases use a <a href="#hardSoftScore">HardSoftScore</a> instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
public class CloudBalance {
    ...

    private HardSoftScore score;

    @PlanningScore
    public HardSoftScore getScore() {
        return score;
    }

    public void setScore(HardSoftScore score) {
        this.score = score;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some use cases use <a href="#scoreType">other score types</a>.</p>
</div>
<div class="paragraph">
<p>This annotation can also be <a href="#autoDiscoverSolutionProperties">auto discovered</a> if enabled.</p>
</div>
</div>
<div class="sect4">
<h5 id="problemFacts"><a class="anchor" href="#problemFacts"></a><a class="link" href="#problemFacts">4.3.6.5. Problem facts of a solution (<code>@ProblemFactCollectionProperty</code>)</a></h5>
<div class="paragraph">
<p>For <a href="#constraintStreams">constraint streams</a> and <a href="#droolsScoreCalculation">Drools score calculation</a>,
OptaPlanner needs to extract the problem fact instances from the solution instance.
It gets those collection(s) by calling every method (or field) that is annotated with <code>@ProblemFactCollectionProperty</code>.
All objects returned by those methods are available to use by the constraint streams or Drools rules.
For example in <code>NQueens</code> all <code>Column</code> and <code>Row</code> instances are problem facts.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
public class NQueens {
    ...

    private List&lt;Column&gt; columnList;
    private List&lt;Row&gt; rowList;

    @ProblemFactCollectionProperty
    public List&lt;Column&gt; getColumnList() {
        return columnList;
    }

    @ProblemFactCollectionProperty
    public List&lt;Row&gt; getRowList() {
        return rowList;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All planning entities are automatically inserted into the Drools working memory.
Do note add an annotation on their properties.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The problem facts methods are not called often: at most only once per solver phase per solver thread.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There can be multiple <code>@ProblemFactCollectionProperty</code> annotated members.
Those can even return a <code>Collection</code> with the same class type, but they shouldn&#8217;t return the same instance twice.
Instead of <code>Collection</code>, it can also return an array.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A @ProblemFactCollectionProperty annotation needs to be on a member in a class with a @PlanningSolution annotation.
It is ignored on parent classes or subclasses without that annotation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In rare cases, a problem fact might be a singleton: use <code>@ProblemFactProperty</code> on its method (or field) instead.</p>
</div>
<div class="paragraph">
<p>Both annotations can also be <a href="#autoDiscoverSolutionProperties">auto discovered</a> if enabled.</p>
</div>
<div class="sect5">
<h6 id="cachedProblemFact"><a class="anchor" href="#cachedProblemFact"></a><a class="link" href="#cachedProblemFact">4.3.6.5.1. Cached problem fact</a></h6>
<div class="paragraph">
<p>A cached problem fact is a problem fact that does not exist in the real domain model, but is calculated before the <code>Solver</code> really starts solving.
The problem facts methods have the opportunity to enrich the domain model with such cached problem facts, which can lead to simpler and faster score constraints.</p>
</div>
<div class="paragraph">
<p>For example in examination, a cached problem fact <code>TopicConflict</code> is created for every two <code>Topic</code>s which share at least one <code>Student</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @ProblemFactCollectionProperty
    private List&lt;TopicConflict&gt; calculateTopicConflictList() {
        List&lt;TopicConflict&gt; topicConflictList = new ArrayList&lt;TopicConflict&gt;();
        for (Topic leftTopic : topicList) {
            for (Topic rightTopic : topicList) {
                if (leftTopic.getId() &lt; rightTopic.getId()) {
                    int studentSize = 0;
                    for (Student student : leftTopic.getStudentList()) {
                        if (rightTopic.getStudentList().contains(student)) {
                            studentSize++;
                        }
                    }
                    if (studentSize &gt; 0) {
                        topicConflictList.add(new TopicConflict(leftTopic, rightTopic, studentSize));
                    }
                }
            }
        }
        return topicConflictList;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where a score constraint needs to check that no two exams with a topic that shares a student are scheduled close together (depending on the constraint: at the same time, in a row, or in the same day), the <code>TopicConflict</code> instance can be used as a problem fact, rather than having to combine every two <code>Student</code> instances.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="autoDiscoverSolutionProperties"><a class="anchor" href="#autoDiscoverSolutionProperties"></a><a class="link" href="#autoDiscoverSolutionProperties">4.3.6.6. Auto discover solution properties</a></h5>
<div class="paragraph">
<p>Instead of configuring each property (or field) annotation explicitly,
some can also be deduced automatically by OptaPlanner.
For example, on the cloud balancing example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution(autoDiscoverMemberType = AutoDiscoverMemberType.FIELD)
public class CloudBalance {

    // Auto discovered as @ProblemFactCollectionProperty
    @ValueRangeProvider(id = "computerRange") // Not (yet) auto discovered
    private List&lt;CloudComputer&gt; computerList;

    // Auto discovered as @PlanningEntityCollectionProperty
    private List&lt;CloudProcess&gt; processList;

    // Auto discovered as @PlanningScore
    private HardSoftScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>AutoDiscoverMemberType</code> can be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>NONE</code>: No auto discovery.</p>
</li>
<li>
<p><code>FIELD</code>: Auto discover all fields on the <code>@PlanningSolution</code> class</p>
</li>
<li>
<p><code>GETTER</code>: Auto discover all getters on the <code>@PlanningSolution</code> class</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The automatic annotation is based on the field type (or getter return type):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@ProblemFactProperty</code>: when it isn&#8217;t a <code>Collection</code>, an array, a <code>@PlanningEntity</code> class or a <code>Score</code></p>
</li>
<li>
<p><code>@ProblemFactCollectionProperty</code>: when it&#8217;s a <code>Collection</code> (or array) of a type that isn&#8217;t a <code>@PlanningEntity</code> class</p>
</li>
<li>
<p><code>@PlanningEntityProperty</code>: when it is a configured <code>@PlanningEntity</code> class or subclass</p>
</li>
<li>
<p><code>@PlanningEntityCollectionProperty</code>: when it&#8217;s a <code>Collection</code> (or array) of a type that is a configured <code>@PlanningEntity</code> class or subclass</p>
</li>
<li>
<p><code>@PlanningScore</code>: when it is a <code>Score</code> or subclass</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These automatic annotation can still be overwritten per field (or getter).
Specifically, a <a href="#bendableScore">BendableScore</a> always needs to override
with an explicit <code>@PlanningScore</code> annotation to define the number of hard and soft levels.</p>
</div>
</div>
<div class="sect4">
<h5 id="cloningASolution"><a class="anchor" href="#cloningASolution"></a><a class="link" href="#cloningASolution">4.3.6.7. Cloning a solution</a></h5>
<div class="paragraph">
<p>Most (if not all) optimization algorithms clone the solution each time they encounter a new best solution (so they can recall it later) or to work with multiple solutions in parallel.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There are many ways to clone, such as a shallow clone, deep clone, &#8230;&#8203; This context focuses on <em>a planning clone</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A planning clone of a solution must fulfill these requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The clone must represent the same planning problem. Usually it reuses the same instances of the problem facts and problem fact collections as the original.</p>
</li>
<li>
<p>The clone must use different, cloned instances of the entities and entity collections.
Changes to an original solution entity&#8217;s variables must not affect its clone.</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./PlannerConfiguration/solutionCloning.png" alt="solutionCloning">
</div>
</div>
<div class="paragraph">
<p><strong>Implementing a planning clone method is hard, therefore you do not need to implement it.</strong></p>
</div>
<div class="sect5">
<h6 id="fieldAccessingSolutionCloner"><a class="anchor" href="#fieldAccessingSolutionCloner"></a><a class="link" href="#fieldAccessingSolutionCloner">4.3.6.7.1. <code>FieldAccessingSolutionCloner</code></a></h6>
<div class="paragraph">
<p>This <code>SolutionCloner</code> is used by default.
It works well for most use cases.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When the <code>FieldAccessingSolutionCloner</code> clones one of your collections or maps,
it may not recognize the implementation and replace it with <code>ArrayList</code>, <code>LinkedHashSet</code>, <code>TreeSet</code>, <code>LinkedHashMap</code>
or <code>TreeMap</code> (whichever is more applicable) .
It recognizes most of the common JDK collection and map implementations.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>FieldAccessingSolutionCloner</code> does not clone problem facts by default.
If any of your problem facts needs to be deep cloned for a planning clone,
for example if the problem fact references a planning entity or the planning solution,
mark its class with a <code>@DeepPlanningClone</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@DeepPlanningClone
public class SeatDesignationDependency {
    private SeatDesignation leftSeatDesignation; // planning entity
    private SeatDesignation rightSeatDesignation; // planning entity
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, because <code>SeatDesignationDependency</code> references the planning entity <code>SeatDesignation</code>
(which is deep planning cloned automatically), it should also be deep planning cloned.</p>
</div>
<div class="paragraph">
<p>Alternatively, the <code>@DeepPlanningClone</code> annotation also works on a getter method or a field to planning clone it.
If that property is a <code>Collection</code> or a <code>Map</code>, it will shallow clone it and deep planning clone
any element thereof that is an instance of a class that has a <code>@DeepPlanningClone</code> annotation.</p>
</div>
</div>
<div class="sect5">
<h6 id="customCloning"><a class="anchor" href="#customCloning"></a><a class="link" href="#customCloning">4.3.6.7.2. Custom cloning with a <code>SolutionCloner</code></a></h6>
<div class="paragraph">
<p>To use a custom cloner, configure it on the planning solution:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution(solutionCloner = NQueensSolutionCloner.class)
public class NQueens {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, a <code>NQueens</code> planning clone only deep clones all <code>Queen</code> instances.
So when the original solution changes (later on during planning) and one or more <code>Queen</code> instances change,
the planning clone isn&#8217;t affected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class NQueensSolutionCloner implements SolutionCloner&lt;NQueens&gt; {

    @Override
    public NQueens cloneSolution(CloneLedger ledger, NQueens original) {
        NQueens clone = new NQueens();
        ledger.registerClone(original, clone);
        clone.setId(original.getId());
        clone.setN(original.getN());
        clone.setColumnList(original.getColumnList());
        clone.setRowList(original.getRowList());
        List&lt;Queen&gt; queenList = original.getQueenList();
        List&lt;Queen&gt; clonedQueenList = new ArrayList&lt;Queen&gt;(queenList.size());
        for (Queen originalQueen : queenList) {
            Queen cloneQueen = new Queen();
            ledger.registerClone(originalQueen, cloneQueen);
            cloneQueen.setId(originalQueen.getId());
            cloneQueen.setColumn(originalQueen.getColumn());
            cloneQueen.setRow(originalQueen.getRow());
            clonedQueenList.add(cloneQueen);
        }
        clone.setQueenList(clonedQueenList);
        clone.setScore(original.getScore());
        return clone;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>The <code>cloneSolution()</code> method should only deep clone the planning entities.</em>
Notice that the problem facts, such as <code>Column</code> and <code>Row</code> are normally <em>not</em> cloned: even their <code>List</code> instances are <em>not</em> cloned.
If the problem facts were cloned too, then you would have to make sure that the new planning entity clones also refer to the new problem facts clones used by the cloned solution.
For example, if you were to clone all <code>Row</code> instances, then each <code>Queen</code> clone and the <code>NQueens</code> clone itself should refer to those new <code>Row</code> clones.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Cloning an entity with a <a href="#chainedPlanningVariable">chained</a> variable is devious: a variable of an entity A might point to another entity B.
If A is cloned, then its variable must point to the clone of B, not the original B.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="createAnUninitializedSolution"><a class="anchor" href="#createAnUninitializedSolution"></a><a class="link" href="#createAnUninitializedSolution">4.3.6.8. Create an uninitialized solution</a></h5>
<div class="paragraph">
<p>Create a <code>@PlanningSolution</code> instance to represent your planning problem&#8217;s dataset, so it can be set on the <code>Solver</code> as the planning problem to solve.
For example in n queens, an <code>NQueens</code> instance is created with the required <code>Column</code> and <code>Row</code> instances and every <code>Queen</code> set to a different <code>column</code> and every <code>row</code> set to <code>null</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    private NQueens createNQueens(int n) {
        NQueens nQueens = new NQueens();
        nQueens.setId(0L);
        nQueens.setN(n);
        nQueens.setColumnList(createColumnList(nQueens));
        nQueens.setRowList(createRowList(nQueens));
        nQueens.setQueenList(createQueenList(nQueens));
        return nQueens;
    }

    private List&lt;Queen&gt; createQueenList(NQueens nQueens) {
        int n = nQueens.getN();
        List&lt;Queen&gt; queenList = new ArrayList&lt;Queen&gt;(n);
        long id = 0L;
        for (Column column : nQueens.getColumnList()) {
            Queen queen = new Queen();
            queen.setId(id);
            id++;
            queen.setColumn(column);
            // Notice that we leave the PlanningVariable properties on null
            queenList.add(queen);
        }
        return queenList;
    }</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="./PlannerConfiguration/uninitializedNQueens04.png" alt="uninitializedNQueens04">
</div>
<div class="title">Figure 4. Uninitialized Solution for the Four Queens Puzzle</div>
</div>
<div class="paragraph">
<p>Usually, most of this data comes from your data layer, and your solution implementation just aggregates that data and creates the uninitialized planning entity instances to plan:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">        private void createLectureList(CourseSchedule schedule) {
            List&lt;Course&gt; courseList = schedule.getCourseList();
            List&lt;Lecture&gt; lectureList = new ArrayList&lt;Lecture&gt;(courseList.size());
            long id = 0L;
            for (Course course : courseList) {
                for (int i = 0; i &lt; course.getLectureSize(); i++) {
                    Lecture lecture = new Lecture();
                    lecture.setId(id);
                    id++;
                    lecture.setCourse(course);
                    lecture.setLectureIndexInCourse(i);
                    // Notice that we leave the PlanningVariable properties (period and room) on null
                    lectureList.add(lecture);
                }
            }
            schedule.setLectureList(lectureList);
        }</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="useTheSolver"><a class="anchor" href="#useTheSolver"></a><a class="link" href="#useTheSolver">4.4. Use the <code>Solver</code></a></h3>
<div class="sect3">
<h4 id="theSolverInterface"><a class="anchor" href="#theSolverInterface"></a><a class="link" href="#theSolverInterface">4.4.1. The <code>Solver</code> interface</a></h4>
<div class="paragraph">
<p>A <code>Solver</code> solves your planning problem.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface Solver&lt;Solution_&gt; {

    Solution_ solve(Solution_ problem);

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>Solver</code> can only solve one planning problem instance at a time.
It is built with a <code>SolverFactory</code>, there is no need to implement it yourself.</p>
</div>
<div class="paragraph">
<p>A <code>Solver</code> should only be accessed from a single thread, except for the methods that are specifically documented in javadoc as being thread-safe.
The <code>solve()</code> method hogs the current thread.
This can cause HTTP timeouts for REST services and it requires extra code to solve multiple datasets in parallel.
To avoid such issues, use a <a href="#solverManager"><code>SolverManager</code></a> instead.</p>
</div>
</div>
<div class="sect3">
<h4 id="solvingAProblem"><a class="anchor" href="#solvingAProblem"></a><a class="link" href="#solvingAProblem">4.4.2. Solving a problem</a></h4>
<div class="paragraph">
<p>Solving a problem is quite easy once you have:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>Solver</code> built from a solver configuration</p>
</li>
<li>
<p>A <code>@PlanningSolution</code> that represents the planning problem instance</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Just provide the planning problem as argument to the <code>solve()</code> method and it will return the best solution found:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    NQueens problem = ...;
    NQueens bestSolution = solver.solve(problem);</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example in n queens, the <code>solve()</code> method will return an <code>NQueens</code> instance with every <code>Queen</code> assigned to a <code>Row</code>.</p>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="./PlannerConfiguration/solvedNQueens04.png" alt="solvedNQueens04">
</div>
<div class="title">Figure 5. Best Solution for the Four Queens Puzzle in 8ms (Also an Optimal Solution)</div>
</div>
<div class="paragraph">
<p>The <code>solve(Solution)</code> method can take a long time (depending on the problem size and the solver configuration). The <code>Solver</code> intelligently wades through <a href="#searchSpaceSize">the search space</a> of possible solutions and remembers the best solution it encounters during solving.
Depending on a number of factors (including problem size, how much time the <code>Solver</code> has, the solver configuration, &#8230;&#8203;), <a href="#doesPlannerFindTheOptimalSolution">that best solution might or might not be an optimal solution</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The solution instance given to the method <code>solve(solution)</code> is changed by the <code>Solver</code>,
but do not mistake it for the best solution.</p>
</div>
<div class="paragraph">
<p>The solution instance returned by the methods <code>solve(solution)</code> or <code>getBestSolution()</code> is most likely <a href="#cloningASolution">a planning clone</a> of the instance given to the method <code>solve(solution)</code>, which implies it is a different instance.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The solution instance given to the <code>solve(Solution)</code> method does not need to be uninitialized.
It can be partially or fully initialized, which is often the case in <a href="#repeatedPlanning">repeated planning</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="environmentMode"><a class="anchor" href="#environmentMode"></a><a class="link" href="#environmentMode">4.4.3. Environment mode: are there bugs in my code?</a></h4>
<div class="paragraph">
<p>The environment mode allows you to detect common bugs in your implementation.
It does not affect the <a href="#logging">logging level</a>.</p>
</div>
<div class="paragraph">
<p>You can set the environment mode in the solver configuration XML file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;solver&gt;
  &lt;environmentMode&gt;FAST_ASSERT&lt;/environmentMode&gt;
  ...
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A solver has a single <code>Random</code> instance.
Some solver configurations use the <code>Random</code> instance a lot more than others.
For example, Simulated Annealing depends highly on random numbers, while Tabu Search only depends on it to deal with score ties.
The environment mode influences the seed of that <code>Random</code> instance.</p>
</div>
<div class="paragraph">
<p>These are the environment modes:</p>
</div>
<div class="sect4">
<h5 id="environmentModeFullAssert"><a class="anchor" href="#environmentModeFullAssert"></a><a class="link" href="#environmentModeFullAssert">4.4.3.1. <code>FULL_ASSERT</code></a></h5>
<div class="paragraph">
<p>The FULL_ASSERT mode turns on all assertions (such as assert that the incremental score calculation is uncorrupted for each move) to fail-fast on a bug in a Move implementation, a constraint, the engine itself, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>This mode is reproducible (see the reproducible mode). It is also intrusive because it calls the method <code>calculateScore()</code> more frequently than a non-assert mode.</p>
</div>
<div class="paragraph">
<p>The FULL_ASSERT mode is horribly slow (because it does not rely on incremental score calculation).</p>
</div>
</div>
<div class="sect4">
<h5 id="environmentModeNonIntrusiveFullAssert"><a class="anchor" href="#environmentModeNonIntrusiveFullAssert"></a><a class="link" href="#environmentModeNonIntrusiveFullAssert">4.4.3.2. <code>NON_INTRUSIVE_FULL_ASSERT</code></a></h5>
<div class="paragraph">
<p>The NON_INTRUSIVE_FULL_ASSERT turns on several assertions to fail-fast on a bug in a Move implementation, a constraint, the engine itself, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>This mode is reproducible (see the reproducible mode). It is non-intrusive because it does not call the method <code>calculateScore()</code> more frequently than a non assert mode.</p>
</div>
<div class="paragraph">
<p>The NON_INTRUSIVE_FULL_ASSERT mode is horribly slow (because it does not rely on incremental score calculation).</p>
</div>
</div>
<div class="sect4">
<h5 id="environmentModeFastAssert"><a class="anchor" href="#environmentModeFastAssert"></a><a class="link" href="#environmentModeFastAssert">4.4.3.3. <code>FAST_ASSERT</code></a></h5>
<div class="paragraph">
<p>The FAST_ASSERT mode turns on most assertions (such as assert that an undoMove&#8217;s score is the same as before the Move) to fail-fast on a bug in a Move implementation, a constraint, the engine itself, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>This mode is reproducible (see the reproducible mode). It is also intrusive because it calls the method <code>calculateScore()</code> more frequently than a non assert mode.</p>
</div>
<div class="paragraph">
<p>The FAST_ASSERT mode is slow.</p>
</div>
<div class="paragraph">
<p>It is recommended to write a test case that does a short run of your planning problem with the FAST_ASSERT mode on.</p>
</div>
</div>
<div class="sect4">
<h5 id="environmentModeReproducible"><a class="anchor" href="#environmentModeReproducible"></a><a class="link" href="#environmentModeReproducible">4.4.3.4. <code>REPRODUCIBLE</code> (default)</a></h5>
<div class="paragraph">
<p>The reproducible mode is the default mode because it is recommended during development.
In this mode, two runs in the same OptaPlanner version will execute the same code in the same order. <strong>Those two
        runs will have the same result at every step</strong>, except if the note below applies.
This enables you to reproduce bugs consistently.
It also allows you to benchmark certain refactorings (such as a score constraint performance optimization) fairly across runs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Despite the reproducible mode, your application might still not be fully reproducible because of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use of <code>HashSet</code> (or another <code>Collection</code> which has an inconsistent order between JVM runs) for collections of planning entities or planning values (but not normal problem facts), especially in the solution implementation. Replace it with <code>LinkedHashSet</code>.</p>
</li>
<li>
<p>Combining a time gradient dependent algorithms (most notably Simulated Annealing) together with time spent termination. A sufficiently large difference in allocated CPU time will influence the time gradient values. Replace Simulated Annealing with Late Acceptance. Or instead, replace time spent termination with step count termination.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The reproducible mode can be slightly slower than the non-reproducible mode.
If your production environment can benefit from reproducibility, use this mode in production.</p>
</div>
<div class="paragraph">
<p>In practice, this mode uses the default, fixed <a href="#randomNumberGenerator">random seed</a> if no seed is specified, and it also disables certain concurrency optimizations (such as work stealing).</p>
</div>
</div>
<div class="sect4">
<h5 id="environmentModeProduction"><a class="anchor" href="#environmentModeProduction"></a><a class="link" href="#environmentModeProduction">4.4.3.5. <code>NON_REPRODUCIBLE</code></a></h5>
<div class="paragraph">
<p>The non-reproducible mode can be slightly faster than the reproducible mode.
Avoid using it during development as it makes debugging and bug fixing painful.
If your production environment doesn&#8217;t care about reproducibility, use this mode in production.</p>
</div>
<div class="paragraph">
<p>In practice, this mode uses no fixed <a href="#randomNumberGenerator">random seed</a> if no seed is specified.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="logging"><a class="anchor" href="#logging"></a><a class="link" href="#logging">4.4.4. Logging level: what is the <code>Solver</code> doing?</a></h4>
<div class="paragraph">
<p>The best way to illuminate the black box that is a <code>Solver</code>, is to play with the logging level:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>error</strong>: Log errors, except those that are thrown to the calling code as a <code>RuntimeException</code>.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>If an error happens, OptaPlanner normally fails fast</strong>: it throws a subclass of <code>RuntimeException</code> with a detailed message to the calling code.
It does not log it as an error itself to avoid duplicate log messages.
Except if the calling code explicitly catches and eats that <code>RuntimeException</code>, a <code>Thread</code>'s default <code>ExceptionHandler</code> will log it as an error anyway.
Meanwhile, the code is disrupted from doing further harm or obfuscating the error.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p><strong>warn</strong>: Log suspicious circumstances.</p>
</li>
<li>
<p><strong>info</strong>: Log every phase and the solver itself. See <a href="#scopeOverview">scope overview</a>.</p>
</li>
<li>
<p><strong>debug</strong>: Log every step of every phase. See <a href="#scopeOverview">scope overview</a>.</p>
</li>
<li>
<p><strong>trace</strong>: Log every move of every step of every phase. See <a href="#scopeOverview">scope overview</a>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Turning on <code>trace</code> logging, will slow down performance considerably: it is often four times slower.
However, it is invaluable during development to discover a bottleneck.</p>
</div>
<div class="paragraph">
<p>Even <code>debug</code> logging can slow down performance considerably for fast stepping algorithms (such as Late Acceptance and Simulated Annealing),
but not for slow stepping algorithms (such as Tabu Search).</p>
</div>
<div class="paragraph">
<p>Both cause congestion in <a href="#multithreadedSolving">multithreaded solving</a> with most appenders, see below.</p>
</div>
<div class="paragraph">
<p>In Eclipse, <code>debug</code> logging to the console tends to cause congestion with a score calculation speeds above 10 000 per second.
Nor IntelliJ, nor the Maven command line suffer from this problem.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, set it to <code>debug</code> logging, to see when the phases end and how fast steps are taken:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">INFO  Solving started: time spent (3), best score (-4init/0), random (JDK with seed 0).
DEBUG     CH step (0), time spent (5), score (-3init/0), selected move count (1), picked move (Queen-2 {null -&gt; Row-0}).
DEBUG     CH step (1), time spent (7), score (-2init/0), selected move count (3), picked move (Queen-1 {null -&gt; Row-2}).
DEBUG     CH step (2), time spent (10), score (-1init/0), selected move count (4), picked move (Queen-3 {null -&gt; Row-3}).
DEBUG     CH step (3), time spent (12), score (-1), selected move count (4), picked move (Queen-0 {null -&gt; Row-1}).
INFO  Construction Heuristic phase (0) ended: time spent (12), best score (-1), score calculation speed (9000/sec), step total (4).
DEBUG     LS step (0), time spent (19), score (-1),     best score (-1), accepted/selected move count (12/12), picked move (Queen-1 {Row-2 -&gt; Row-3}).
DEBUG     LS step (1), time spent (24), score (0), new best score (0), accepted/selected move count (9/12), picked move (Queen-3 {Row-3 -&gt; Row-2}).
INFO  Local Search phase (1) ended: time spent (24), best score (0), score calculation speed (4000/sec), step total (2).
INFO  Solving ended: time spent (24), best score (0), score calculation speed (7000/sec), phase total (2), environment mode (REPRODUCIBLE).</code></pre>
</div>
</div>
<div class="paragraph">
<p>All time spent values are in milliseconds.</p>
</div>
<div class="paragraph">
<p>Everything is logged to <a href="http://www.slf4j.org/">SLF4J</a>, which is a simple logging facade
which delegates every log message to Logback, Apache Commons Logging, Log4j or java.util.logging.
Add a dependency to the logging adaptor for your logging framework of choice.</p>
</div>
<div class="paragraph">
<p>If you are not using any logging framework yet, use Logback by adding this Maven dependency (there is no need to add an extra bridge dependency):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;dependency&gt;
      &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
      &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
      &lt;version&gt;1.x&lt;/version&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure the logging level on the <code>org.optaplanner</code> package in your <code>logback.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;configuration&gt;

  &lt;logger name="org.optaplanner" level="debug"/&gt;

  ...

&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If it isn&#8217;t picked up, temporarily add the system property <code>-Dlogback.debug=true</code> to figure out why.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When running multiple solvers or one <a href="#multithreadedSolving">multithreaded solver</a>,
most appenders (including the console) cause congestion with <code>debug</code> and <code>trace</code> logging.
Switch to an async appender to avoid this problem or turn off <code>debug</code> logging.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If instead, you are still using Log4J 1.x (and you do not want to switch to its faster successor, Logback), add the bridge dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;dependency&gt;
      &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
      &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;
      &lt;version&gt;1.x&lt;/version&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And configure the logging level on the package <code>org.optaplanner</code> in your <code>log4j.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;log4j:configuration xmlns:log4j="http://jakarta.apache.org/log4j/"&gt;

  &lt;category name="org.optaplanner"&gt;
    &lt;priority value="debug" /&gt;
  &lt;/category&gt;

  ...

&lt;/log4j:configuration&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In a multitenant application, multiple <code>Solver</code> instances might be running at the same time.
To separate their logging into distinct files, surround the <code>solve()</code> call with an <a href="http://logback.qos.ch/manual/mdc.html">MDC</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">        MDC.put("tenant.name",tenantName);
        MySolution bestSolution = solver.solve(problem);
        MDC.remove("tenant.name");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then configure your logger to use different files for each <code>${tenant.name}</code>.
For example in Logback, use a <code>SiftingAppender</code> in <code>logback.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;appender name="fileAppender" class="ch.qos.logback.classic.sift.SiftingAppender"&gt;
    &lt;discriminator&gt;
      &lt;key&gt;tenant.name&lt;/key&gt;
      &lt;defaultValue&gt;unknown&lt;/defaultValue&gt;
    &lt;/discriminator&gt;
    &lt;sift&gt;
      &lt;appender name="fileAppender.${tenant.name}" class="...FileAppender"&gt;
        &lt;file&gt;local/log/optaplanner-${tenant.name}.log&lt;/file&gt;
        ...
      &lt;/appender&gt;
    &lt;/sift&gt;
  &lt;/appender&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="randomNumberGenerator"><a class="anchor" href="#randomNumberGenerator"></a><a class="link" href="#randomNumberGenerator">4.4.5. Random number generator</a></h4>
<div class="paragraph">
<p>Many heuristics and metaheuristics depend on a pseudorandom number generator for move selection, to resolve score ties, probability based move acceptance, &#8230;&#8203; During solving, the same <code>Random</code> instance is reused to improve reproducibility, performance and uniform distribution of random values.</p>
</div>
<div class="paragraph">
<p>To change the random seed of that <code>Random</code> instance, specify a <code>randomSeed</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;solver&gt;
  &lt;randomSeed&gt;0&lt;/randomSeed&gt;
  ...
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To change the pseudorandom number generator implementation, specify a <code>randomType</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;solver&gt;
  &lt;randomType&gt;MERSENNE_TWISTER&lt;/randomType&gt;
  ...
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following types are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>JDK</code> (default): Standard implementation (<code>java.util.Random</code>).</p>
</li>
<li>
<p><code>MERSENNE_TWISTER</code>: Implementation by <a href="http://commons.apache.org/proper/commons-math/userguide/random.html">Commons Math</a>.</p>
</li>
<li>
<p><code>WELL512A</code>, <code>WELL1024A</code>, <code>WELL19937A</code>, <code>WELL19937C</code>, <code>WELL44497A</code> and <code>WELL44497B</code>: Implementation by <a href="http://commons.apache.org/proper/commons-math/userguide/random.html">Commons Math</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For most use cases, the randomType has no significant impact on the average quality of the best solution on multiple datasets.
If you want to confirm this on your use case, use the <a href="#benchmarker">benchmarker</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="solverManager"><a class="anchor" href="#solverManager"></a><a class="link" href="#solverManager">4.5. SolverManager</a></h3>
<div class="paragraph">
<p>A <code>SolverManager</code> is a facade for one or more <code>Solver</code> instances
to simplify solving planning problems in REST and other enterprise services.
Its <code>solve(&#8230;&#8203;)</code> methods differ from the normal <code>Solver.solve(&#8230;&#8203;)</code> method:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><code>SolverManager.solve(&#8230;&#8203;)</code> returns immediately</strong>: it schedules a problem for asynchronous solving without blocking the calling thread.
This avoids timeout issues of HTTP and other technologies.</p>
</li>
<li>
<p><strong><code>SolverManager.solve(&#8230;&#8203;)</code> solves multiple planning problems</strong> of the same domain, in parallel.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Internally a <code>SolverManager</code> manages a thread pool of solver threads, which call <code>Solver.solve(&#8230;&#8203;)</code>,
and a thread pool of consumer threads, which handle best solution changed events.</p>
</div>
<div class="paragraph">
<p>In <a href="#integrationWithQuarkus">Quarkus</a> and <a href="#integrationWithSpringBoot">Spring Boot</a>,
the <code>SolverManager</code> instance is automatically injected in your code.
Otherwise, build a <code>SolverManager</code> instance with the <code>create(&#8230;&#8203;)</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">SolverConfig solverConfig = SolverConfig.createFromXmlResource(".../cloudBalancingSolverConfig.xml");
SolverManager&lt;CloudBalance, UUID&gt; solverManager = SolverManager.create(solverConfig, new SolverManagerConfig());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each problem submitted to the <code>SolverManager.solve(&#8230;&#8203;)</code> methods needs a unique problem ID.
Later calls to <code>getSolverStatus(problemId)</code> or <code>terminateEarly(problemId)</code> use that problem ID
to distinguish between the planning problems.
The problem ID must be an immutable class, such as <code>Long</code>, <code>String</code> or <code>java.util.UUID</code>.</p>
</div>
<div class="paragraph">
<p>The <code>SolverManagerConfig</code> class has a <code>parallelSolverCount</code> property,
that controls how many solvers are run in parallel.
For example, if set to <code>4</code>, submitting five problems
has four problems solving immediately, and the fifth one starts when another one ends.
If those problems solve for 5 minutes each, the fifth problem takes 10 minutes to finish.
By default, <code>parallelSolverCount</code> is set to <code>AUTO</code>, which resolves to half the CPU cores,
regardless of the <a href="#multithreadedSolving"><code>moveThreadCount</code></a> of the solvers.</p>
</div>
<div class="paragraph">
<p>To retrieve the best solution, after solving terminates normally, use <code>SolverJob.getFinalBestSolution()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">CloudBalance problem1 = ...;
UUID problemId = UUID.randomUUID();
// Returns immediately
SolverJob&lt;CloudBalance, UUID&gt; solverJob = solverManager.solve(problemId, problem1);
...
CloudBalance solution1;
try {
    // Returns only after solving terminates
    solution1 = solverJob.getFinalBestSolution();
} catch (InterruptedException | ExecutionException e) {
    throw ...;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, there are better approaches, both for solving batch problems before an end-user needs the solution
as well as for live solving while an end-user is actively waiting for the solution, as explained below.</p>
</div>
<div class="paragraph">
<p>The current <code>SolverManager</code> implementation runs on a single computer node,
but future work aims to distribute solver loads across a cloud.</p>
</div>
<div class="sect3">
<h4 id="solverManagerSolveBatch"><a class="anchor" href="#solverManagerSolveBatch"></a><a class="link" href="#solverManagerSolveBatch">4.5.1. Solve batch problems</a></h4>
<div class="paragraph">
<p>At night, batch solving is a great approach to deliver solid plans by breakfast, because:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>There are typically few or no problem changes in the middle of the night.
Some organizations even enforce a deadline, for example, <em>submit all day off requests before midnight</em>.</p>
</li>
<li>
<p>The solvers can run for much longer, often hours, because nobody&#8217;s waiting for it and CPU resources are often cheaper.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To solve a multiple datasets in parallel (limited by <code>parallelSolverCount</code>),
call <code>solve(&#8230;&#8203;)</code> for each dataset:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class TimeTableService {

    private SolverManager&lt;TimeTable, Long&gt; solverManager;

    // Returns immediately, call it for every dataset
    public void solveBatch(Long timeTableId) {
        solverManager.solve(timeTableId,
                // Called once, when solving starts
                this::findById,
                // Called once, when solving ends
                this::save);
    }

    public TimeTable findById(Long timeTableId) {...}

    public void save(TimeTable timeTable) {...}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A solid plan delivered by breakfast is great,
even if you need to react on problem changes during the day.</p>
</div>
</div>
<div class="sect3">
<h4 id="solverManagerSolveAndListen"><a class="anchor" href="#solverManagerSolveAndListen"></a><a class="link" href="#solverManagerSolveAndListen">4.5.2. Solve and listen to show progress to the end-user</a></h4>
<div class="paragraph">
<p>When a solver is running while an end-user is waiting for that solution,
the user might need to wait for several minutes or hours before receiving a result.
To assure the user that everything is going well,
show progress by displaying the best solution and best score attained so far.</p>
</div>
<div class="paragraph">
<p>To handle intermediate best solutions, use <code>solveAndListen(&#8230;&#8203;)</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class TimeTableService {

    private SolverManager&lt;TimeTable, Long&gt; solverManager;

    // Returns immediately
    public void solveLive(Long timeTableId) {
        solverManager.solveAndListen(timeTableId,
                // Called once, when solving starts
                this::findById,
                // Called multiple times, for every best solution change
                this::save);
    }

    public TimeTable findById(Long timeTableId) {...}

    public void save(TimeTable timeTable) {...}

    public void stopSolving(Long timeTableId) {
        solverManager.terminateEarly(timeTableId);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This implementation is using the database to communicate with the UI, which polls the database.
More advanced implementations push the best solutions directly to the UI or a messaging queue.</p>
</div>
<div class="paragraph">
<p>If the user is satisfied with the intermediate best solution
and does not want to wait any longer for a better one, call <code>SolverManager.terminateEarly(problemId)</code>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scoreCalculation"><a class="anchor" href="#scoreCalculation"></a><a class="link" href="#scoreCalculation">5. Score calculation</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="scoreTerminology"><a class="anchor" href="#scoreTerminology"></a><a class="link" href="#scoreTerminology">5.1. Score terminology</a></h3>
<div class="sect3">
<h4 id="whatIsAScore"><a class="anchor" href="#whatIsAScore"></a><a class="link" href="#whatIsAScore">5.1.1. What is a score?</a></h4>
<div class="paragraph">
<p>Every <code>@PlanningSolution</code> class has a score.
The score is an objective way to compare two solutions.
The solution with the higher score is better.
The <code>Solver</code> aims to find the solution with the highest <code>Score</code> of all possible solutions.
The <em>best solution</em> is the solution with the highest <code>Score</code> that <code>Solver</code> has encountered during solving,
which might be the <em>optimal solution</em>.</p>
</div>
<div class="paragraph">
<p>OptaPlanner cannot automatically know which solution is best for your business,
so you need to tell it how to calculate the score of a given <code>@PlanningSolution</code> instance according to your business needs.
If you forget or are unable to implement an important business constraint, the solution is probably useless:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ScoreCalculation/optimalWithIncompleteConstraints.png" alt="optimalWithIncompleteConstraints">
</div>
</div>
</div>
<div class="sect3">
<h4 id="formalizeTheBusinessConstraints"><a class="anchor" href="#formalizeTheBusinessConstraints"></a><a class="link" href="#formalizeTheBusinessConstraints">5.1.2. Formalize the business constraints</a></h4>
<div class="paragraph">
<p>To implement a verbal business constraint, it needs to be formalized as a score constraint.
Luckily, defining constraints in OptaPlanner is very flexible through the following score techniques:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Score signum (positive or negative)</strong>: maximize or minimize a constraint type</p>
</li>
<li>
<p><strong>Score weight</strong>: put a cost/profit on a constraint type</p>
</li>
<li>
<p><strong>Score level (hard, soft, &#8230;&#8203;)</strong>: prioritize a group of constraint types</p>
</li>
<li>
<p><strong>Pareto scoring</strong> (rarely used)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Take the time to acquaint yourself with the first three techniques.
Once you understand them, formalizing most business constraints becomes straightforward.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not presume that your business knows all its score constraints in advance.
Expect score constraints to be added, changed or removed after the first releases.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="scoreConstraintSignum"><a class="anchor" href="#scoreConstraintSignum"></a><a class="link" href="#scoreConstraintSignum">5.1.3. Score constraint signum (positive or negative)</a></h4>
<div class="paragraph">
<p>All score techniques are based on constraints.
A constraint can be a simple pattern (such as <em>Maximize the apple harvest in the solution</em>) or a more complex pattern.
A positive constraint is a constraint you want to maximize.
A negative constraint is a constraint you want to minimize</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ScoreCalculation/positiveAndNegativeConstraints.png" alt="positiveAndNegativeConstraints">
</div>
</div>
<div class="paragraph">
<p>The image above illustrates that <strong>the optimal solution always has the highest score</strong>,
regardless if the constraints are positive or negative.</p>
</div>
<div class="paragraph">
<p>Most planning problems have only negative constraints and therefore have a negative score.
In that case, the score is the sum of the weight of the negative constraints being broken, with a perfect score of 0.
For example in n queens, the score is the negative of the number of queen pairs which can attack each other.</p>
</div>
<div class="paragraph">
<p>Negative and positive constraints can be combined, even in the same score level.</p>
</div>
<div class="paragraph">
<p>When a constraint activates (because the negative constraint is broken or the positive constraint is fulfilled)
on a certain planning entity set, it is called a <em>constraint match</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="scoreConstraintWeight"><a class="anchor" href="#scoreConstraintWeight"></a><a class="link" href="#scoreConstraintWeight">5.1.4. Score constraint weight</a></h4>
<div class="paragraph">
<p>Not all score constraints are equally important.
If breaking one constraint is equally bad as breaking another constraint x times,
then those two constraints have a different weight (but they are in the same score level).
For example in vehicle routing, you can make one <em>unhappy driver</em> constraint match count
as much as two <em>fuel tank usage</em> constraint matches:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ScoreCalculation/scoreWeighting.png" alt="scoreWeighting">
</div>
</div>
<div class="paragraph">
<p>Score weighting is easy in use cases where you can <em>put a price tag on everything</em>.
In that case, the positive constraints maximize revenue and the negative constraints minimize expenses, so together they maximize profit.
Alternatively, score weighting is also often used to create social <a href="#fairnessScoreConstraints">fairness</a>.
For example, a nurse, who requests a free day, pays a higher weight on New Years eve than on a normal day.</p>
</div>
<div class="paragraph">
<p>The weight of a constraint match can depend on the planning entities involved.
For example in cloud balancing, the weight of the soft constraint match for an active <code>Computer</code>
is the maintenance <code>cost</code> of that <code>Computer</code> (which differs per computer).</p>
</div>
<div class="paragraph">
<p>Putting a good weight on a constraint is often a difficult analytical decision,
because it is about making choices and trade-offs against other constraints.
Different stakeholders have different priorities.
<strong>Don&#8217;t waste time with constraint weight discussions at the start of an implementation,
instead add a <a href="#constraintConfiguration">constraint configuration</a>
and  allow users to change them through a UI.</strong>
A non-accurate weight is less damaging than mediocre algorithms:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ScoreCalculation/scoreTradeoffInPerspective.png" alt="scoreTradeoffInPerspective">
</div>
</div>
<div class="paragraph">
<p>Most use cases use a <code>Score</code> with <code>int</code> weights, such as <a href="#hardSoftScore">HardSoftScore</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="scoreLevel"><a class="anchor" href="#scoreLevel"></a><a class="link" href="#scoreLevel">5.1.5. Score constraint level (hard, soft, &#8230;&#8203;)</a></h4>
<div class="paragraph">
<p>Sometimes a score constraint outranks another score constraint, no matter how many times the latter is broken.
In that case, those score constraints are in different levels.
For example, a nurse cannot do two shifts at the same time (due to the constraints of physical reality),
so this outranks all nurse happiness constraints.</p>
</div>
<div class="paragraph">
<p>Most use cases have only two score levels, hard and soft.
The levels of two scores are compared lexicographically.
The first score level gets compared first.
If those differ, the remaining score levels are ignored.
For example, a score that breaks <code>0</code> hard constraints and <code>1000000</code> soft constraints is better
than a score that breaks <code>1</code> hard constraint and <code>0</code> soft constraints.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ScoreCalculation/scoreLevels.png" alt="scoreLevels">
</div>
</div>
<div class="paragraph">
<p>If there are two (or more) score levels, for example <a href="#hardSoftScore">HardSoftScore</a>,
then a score is <em>feasible</em> if no hard constraints are broken.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By default, OptaPlanner will always assign all planning variables a planning value.
If there is no feasible solution, this means the best solution will be infeasible.
To instead leave some of the planning entities unassigned, apply <a href="#overconstrainedPlanning">overconstrained planning</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For each constraint, you need to pick a score level, a score weight and a score signum.
For example: <code>-1soft</code> which has score level of <code>soft</code>, a weight of <code>1</code> and a negative signum.
Do not use a big constraint weight when your business actually wants different score levels.
That hack, known as <em>score folding</em>, is broken:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ScoreCalculation/scoreFoldingIsBroken.png" alt="scoreFoldingIsBroken">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Your business might tell you that your hard constraints all have the same weight, because they cannot be broken (so the weight does not matter). This is not true because if no feasible solution exists for a specific dataset, the least infeasible solution allows the business to estimate how many business resources they are lacking.
For example in cloud balancing, how many new computers to buy.</p>
</div>
<div class="paragraph">
<p>Furthermore, it will likely create a <a href="#scoreTrap">score trap</a>.
For example in cloud balance if a <code>Computer</code> has seven CPU too little for its <code>Process</code>es, then it must be weighted seven times as much as if it had only one CPU too little.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Three or more score levels are also supported.
For example: a company might decide that profit outranks employee satisfaction (or vice versa),
while both are outranked by the constraints of physical reality.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To model <a href="#fairnessScoreConstraints">fairness or load balancing</a>, there is no need to use lots of score levels
(even though OptaPlanner can handle many score levels).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Most use cases use a <code>Score</code> with two or three weights,
such as <a href="#hardSoftScore">HardSoftScore</a> and <a href="#hardMediumSoftScore">HardMediumSoftScore</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="paretoScoring"><a class="anchor" href="#paretoScoring"></a><a class="link" href="#paretoScoring">5.1.6. Pareto scoring (AKA multi-objective optimization scoring)</a></h4>
<div class="paragraph">
<p>Far less common is the use case of pareto optimization, which is also known as <em>multi-objective optimization</em>.
In pareto scoring, score constraints are in the same score level, yet they are not weighted against each other.
When two scores are compared, each of the score constraints are compared individually and the score with the most dominating score constraints wins.
Pareto scoring can even be combined with score levels and score constraint weighting.</p>
</div>
<div class="paragraph">
<p>Consider this example with positive constraints, where we want to get the most apples and oranges.
Since it is impossible to compare apples and oranges, we can not weigh them against each other.
Yet, despite that we can not compare them, we can state that two apples are better than one apple.
Similarly, we can state that two apples and one orange are better than just one orange.
So despite our inability to compare some Scores conclusively (at which point we declare them equal), we can find a set of optimal scores.
Those are called pareto optimal.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ScoreCalculation/paretoOptimizationScoring.png" alt="paretoOptimizationScoring">
</div>
</div>
<div class="paragraph">
<p>Scores are considered equal far more often.
It is left up to a human to choose the better out of a set of best solutions (with equal scores) found by OptaPlanner.
In the example above, the user must choose between solution A (three apples and one orange) and solution B (one apple and six oranges). It is guaranteed that OptaPlanner has not found another solution which has more apples or more oranges or even a better combination of both (such as two apples and three oranges).</p>
</div>
<div class="paragraph">
<p>To implement pareto scoring in OptaPlanner, <a href="#customScore">implement a custom <code>ScoreDefinition</code> and <code>Score</code></a> (and replace the <code>BestSolutionRecaller</code>). Future versions will provide out-of-the-box support.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A pareto <code>Score</code>'s <code>compareTo</code> method is not transitive because it does a pareto comparison.
For example: having two apples is greater than one apple.
One apple is equal to One orange.
Yet, two apples are not greater than one orange (but actually equal). Pareto comparison violates the contract of the interface <code>java.lang.Comparable</code>'s <code>compareTo</code> method, but Planners systems are <em>pareto comparison safe</em>, unless explicitly stated otherwise in this documentation.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="combiningScoreTechniques"><a class="anchor" href="#combiningScoreTechniques"></a><a class="link" href="#combiningScoreTechniques">5.1.7. Combining score techniques</a></h4>
<div class="paragraph">
<p>All the score techniques mentioned above, can be combined seamlessly:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ScoreCalculation/scoreComposition.png" alt="scoreComposition">
</div>
</div>
</div>
<div class="sect3">
<h4 id="scoreInterface"><a class="anchor" href="#scoreInterface"></a><a class="link" href="#scoreInterface">5.1.8. <code>Score</code> interface</a></h4>
<div class="paragraph">
<p>A score is represented by the <code>Score</code> interface, which naturally extends <code>Comparable</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface Score&lt;...&gt; extends Comparable&lt;...&gt; {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Score</code> implementation to use depends on your use case.
Your score might not efficiently fit in a single <code>long</code> value.
OptaPlanner has several built-in <code>Score</code> implementations, but you can implement a custom <code>Score</code> too.
Most use cases tend to use the built-in <code>HardSoftScore</code>.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ScoreCalculation/scoreClassDiagram.png" alt="scoreClassDiagram">
</div>
</div>
<div class="paragraph">
<p>All Score implementations also have an <code>initScore</code> (which is an <code>int</code>).It is mostly intended for internal use in OptaPlanner: it is the negative number of uninitialized planning variables.
From a user&#8217;s perspective this is <code>0</code>, unless a Construction Heuristic is terminated before it could initialize all planning variables (in which case <code>Score.isSolutionInitialized()</code> returns <code>false</code>).</p>
</div>
<div class="paragraph">
<p>The <code>Score</code> implementation (for example <code>HardSoftScore</code>) must be the same throughout a <code>Solver</code> runtime.
The <code>Score</code> implementation is configured in the solution domain class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
public class CloudBalance {
    ...

    @PlanningScore
    private HardSoftScore score;

}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="avoidFloatingPointNumbersInScoreCalculation"><a class="anchor" href="#avoidFloatingPointNumbersInScoreCalculation"></a><a class="link" href="#avoidFloatingPointNumbersInScoreCalculation">5.1.9. Avoid floating point numbers in score calculation</a></h4>
<div class="paragraph">
<p>Avoid the use of <code>float</code> or <code>double</code> in score calculation.
Use <code>BigDecimal</code> or scaled <code>long</code> instead.</p>
</div>
<div class="paragraph">
<p>Floating point numbers (<code>float</code> and <code>double</code>) cannot represent a decimal number correctly.
For example: a <code>double</code> cannot hold the value <code>0.05</code> correctly.
Instead, it holds the nearest representable value.
Arithmetic (including addition and subtraction) with floating point numbers, especially for planning problems, leads to incorrect decisions:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ScoreCalculation/scoreWeightType.png" alt="scoreWeightType">
</div>
</div>
<div class="paragraph">
<p>Additionally, floating point number addition is not associative:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">System.out.println( ((0.01 + 0.02) + 0.03) == (0.01 + (0.02 + 0.03)) ); // returns false</code></pre>
</div>
</div>
<div class="paragraph">
<p>This leads to <em>score corruption</em>.</p>
</div>
<div class="paragraph">
<p>Decimal numbers (<code>BigDecimal</code>) have none of these problems.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>BigDecimal arithmetic is considerably slower than <code>int</code>, <code>long</code> or <code>double</code> arithmetic.
In experiments we have seen the score calculation take five times longer.</p>
</div>
<div class="paragraph">
<p>Therefore, in many cases, it can be worthwhile to multiply <em>all</em> numbers for a single score weight by a plural of ten, so the score weight fits in a scaled <code>int</code> or <code>long</code>.
For example, if we multiply all weights by <code>1000</code>, a fuelCost of <code>0.07</code> becomes a fuelCostMillis of <code>70</code> and no longer uses a decimal score weight.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scoreType"><a class="anchor" href="#scoreType"></a><a class="link" href="#scoreType">5.2. Choose a score type</a></h3>
<div class="paragraph">
<p>Depending on the number of score levels and type of score weights you need, choose a <code>Score</code> type.
Most use cases use a <code>HardSoftScore</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To properly write a <code>Score</code> to a database (with JPA/Hibernate) or to XML/JSON (with XStream/JAXB/Jackson),
see <a href="#integration">the integration chapter</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="simpleScore"><a class="anchor" href="#simpleScore"></a><a class="link" href="#simpleScore">5.2.1. <code>SimpleScore</code></a></h4>
<div class="paragraph">
<p>A <code>SimpleScore</code> has a single <code>int</code> value, for example <code>-123</code>.
It has a single score level.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @PlanningScore
    private SimpleScore score;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Variants of this <code>Score</code> type:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SimpleLongScore</code> uses a <code>long</code> value instead of an <code>int</code> value.</p>
</li>
<li>
<p><code>SimpleBigDecimalScore</code> uses a <code>BigDecimal</code> value instead of an <code>int</code> value.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="hardSoftScore"><a class="anchor" href="#hardSoftScore"></a><a class="link" href="#hardSoftScore">5.2.2. <code>HardSoftScore</code> (Recommended)</a></h4>
<div class="paragraph">
<p>A <code>HardSoftScore</code> has a hard <code>int</code> value and a soft <code>int</code> value, for example <code>-123hard/-456soft</code>.
It has two score levels (hard and soft).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @PlanningScore
    private HardSoftScore score;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Variants of this <code>Score</code> type:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>HardSoftLongScore</code> uses <code>long</code> values instead of <code>int</code> values.</p>
</li>
<li>
<p><code>HardSoftBigDecimalScore</code> uses <code>BigDecimal</code> values instead of <code>int</code> values.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="hardMediumSoftScore"><a class="anchor" href="#hardMediumSoftScore"></a><a class="link" href="#hardMediumSoftScore">5.2.3. <code>HardMediumSoftScore</code></a></h4>
<div class="paragraph">
<p>A <code>HardMediumSoftScore</code> which has a hard <code>int</code> value, a medium <code>int</code> value and a soft <code>int</code> value, for example <code>-123hard/-456medium/-789soft</code>.
It has three score levels (hard, medium and soft).
The hard level determines if the solution is feasible,
and the medium level and soft level score values determine
how well the solution meets business goals.
Higher medium values take precedence over soft values irrespective of the soft value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @PlanningScore
    private HardMediumSoftScore score;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Variants of this <code>Score</code> type:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>HardMediumSoftLongScore</code> uses <code>long</code> values instead of <code>int</code> values.</p>
</li>
<li>
<p><code>HardMediumSoftBigDecimalScore</code> uses <code>BigDecimal</code> values instead of <code>int</code> values.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="bendableScore"><a class="anchor" href="#bendableScore"></a><a class="link" href="#bendableScore">5.2.4. <code>BendableScore</code></a></h4>
<div class="paragraph">
<p>A <code>BendableScore</code> has a configurable number of score levels.
It has an array of hard <code>int</code> values and an array of soft <code>int</code> values,
for example with two hard levels and three soft levels, the score can be <code>[-123/-456]hard/[-789/-012/-345]soft</code>.
In that case, it has five score levels.
A solution is feasible if all hard levels are at least zero.</p>
</div>
<div class="paragraph">
<p>A BendableScore with one hard level and one soft level is equivalent to a HardSoftScore,
while a BendableScore with one hard level and two soft levels is equivalent to a HardMediumSoftScore.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @PlanningScore(bendableHardLevelsSize = 2, bendableSoftLevelsSize = 3)
    private BendableScore score;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The number of hard and soft score levels need to be set at compilation time.
It is not flexible to change during solving.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not use a <code>BendableScore</code> with seven levels just because you have seven constraints.
It is extremely rare to use a different score level for each constraint, because that means one constraint match on soft 0 outweighs even a million constraint matches of soft 1.</p>
</div>
<div class="paragraph">
<p>Usually, multiple constraints share the same level and are weighted against each other.
Use <a href="#explainingTheScore">explaining the score</a> to get the weight of individual constraints in the same level.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Variants of this <code>Score</code> type:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BendableLongScore</code> uses <code>long</code> values instead of <code>int</code> values.</p>
</li>
<li>
<p><code>BendableBigDecimalScore</code> uses <code>BigDecimal</code> values instead of <code>int</code> values.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="customScore"><a class="anchor" href="#customScore"></a><a class="link" href="#customScore">5.2.5. Implementing a custom score</a></h4>
<div class="paragraph">
<p>Internally, each <code>Score</code> implementation also has a <code>ScoreDefinition</code> implementation.
For example: <code>SimpleScore</code> is defined by <code>SimpleScoreDefinition</code>.
The <code>ScoreDefinition</code> interface defines the score representation.</p>
</div>
<div class="paragraph">
<p>To implement a custom <code>Score</code>, also implement such a custom <code>ScoreDefinition</code>.
Extend <code>AbstractScoreDefinition</code> (preferably by copy pasting <code>HardSoftScoreDefinition</code>) and start from there.
Then hook your custom <code>ScoreDefinition</code> in the domain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @PlanningScore(scoreDefinitionClass = MyCustomScoreDefinition.class)
    private MyCustomScore score;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To have it integrate seamlessly with <a href="#jpaAndHibernatePersistingAScore">JPA/Hibernate</a>,
<a href="#integrationWithXStream">XStream</a>, <a href="#integrationWithJackson">Jackson</a>, &#8230;&#8203;,
you&#8217;ll need to write custom glue code too.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="calculateTheScore"><a class="anchor" href="#calculateTheScore"></a><a class="link" href="#calculateTheScore">5.3. Calculate the <code>Score</code></a></h3>
<div class="sect3">
<h4 id="scoreCalculationTypes"><a class="anchor" href="#scoreCalculationTypes"></a><a class="link" href="#scoreCalculationTypes">5.3.1. Score calculation types</a></h4>
<div class="paragraph">
<p>There are several ways to calculate the <code>Score</code> of a solution:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><a href="#easyJavaScoreCalculation">Easy Java score calculation</a></strong>: Implement all constraints together in a single method in Java (or another JVM language). Does not scale.</p>
</li>
<li>
<p><strong><a href="#constraintStreams">Constraint streams score calculation</a></strong>: Implement each constraint as a separate ConstraintStream in Java (or another JVM language). Fast and scalable.</p>
</li>
<li>
<p><strong><a href="#incrementalJavaScoreCalculation">Incremental Java score calculation</a></strong> (not recommended): Implement multiple low-level methods in Java (or another JVM language). Fast and scalable. Very difficult to implement and maintain.</p>
</li>
<li>
<p><strong><a href="#droolsScoreCalculation">Drools score calculation</a></strong>: Implement each constraint as a separate score rule in DRL. Scalable.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Every score calculation type can work with any Score definition (such as <code>HardSoftScore</code> or <code>HardMediumSoftScore</code>).
All score calculation types are Object Oriented and can reuse existing Java code.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The score calculation must be read-only.
It must not change the planning entities or the problem facts in any way.
For example, it must not call a setter method on a planning entity in the score calculation.</p>
</div>
<div class="paragraph">
<p>OptaPlanner does not recalculate the score of a solution if it can predict it (unless an <a href="#environmentMode">environmentMode assertion</a> is enabled).
For example, after a winning step is done, there is no need to calculate the score because that move was done and undone earlier.
As a result, there is no guarantee that changes applied during score calculation actually happen.</p>
</div>
<div class="paragraph">
<p>To update planning entities when the planning variable change, use <a href="#shadowVariable">shadow variables</a> instead.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="easyJavaScoreCalculation"><a class="anchor" href="#easyJavaScoreCalculation"></a><a class="link" href="#easyJavaScoreCalculation">5.3.2. Easy Java score calculation</a></h4>
<div class="paragraph">
<p>An easy way to implement your score calculation in Java.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Advantages:</p>
<div class="ulist">
<ul>
<li>
<p>Plain old Java: no learning curve</p>
</li>
<li>
<p>Opportunity to delegate score calculation to an existing code base or legacy system</p>
</li>
</ul>
</div>
</li>
<li>
<p>Disadvantages:</p>
<div class="ulist">
<ul>
<li>
<p>Slower</p>
</li>
<li>
<p>Does not scale because there is no <a href="#incrementalScoreCalculation">incremental score calculation</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Implement the one method of the interface <code>EasyScoreCalculator</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface EasyScoreCalculator&lt;Solution_&gt; {

    Score calculateScore(Solution_ solution);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example in n queens:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class NQueensEasyScoreCalculator implements EasyScoreCalculator&lt;NQueens&gt; {

    public SimpleScore calculateScore(NQueens nQueens) {
        int n = nQueens.getN();
        List&lt;Queen&gt; queenList = nQueens.getQueenList();

        int score = 0;
        for (int i = 0; i &lt; n; i++) {
            for (int j = i + 1; j &lt; n; j++) {
                Queen leftQueen = queenList.get(i);
                Queen rightQueen = queenList.get(j);
                if (leftQueen.getRow() != null &amp;&amp; rightQueen.getRow() != null) {
                    if (leftQueen.getRowIndex() == rightQueen.getRowIndex()) {
                        score--;
                    }
                    if (leftQueen.getAscendingDiagonalIndex() == rightQueen.getAscendingDiagonalIndex()) {
                        score--;
                    }
                    if (leftQueen.getDescendingDiagonalIndex() == rightQueen.getDescendingDiagonalIndex()) {
                        score--;
                    }
                }
            }
        }
        return SimpleScore.valueOf(score);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure it in the solver configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;scoreDirectorFactory&gt;
    &lt;easyScoreCalculatorClass&gt;org.optaplanner.examples.nqueens.solver.score.NQueensEasyScoreCalculator&lt;/easyScoreCalculatorClass&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To configure values of an <code>EasyScoreCalculator</code> dynamically in the solver configuration
(so the <a href="#benchmarker">Benchmarker</a> can tweak those parameters),
add the <code>easyScoreCalculatorCustomProperties</code> element and use <a href="#customPropertiesConfiguration">custom properties</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;scoreDirectorFactory&gt;
    &lt;easyScoreCalculatorClass&gt;...MyEasyScoreCalculator&lt;/easyScoreCalculatorClass&gt;
    &lt;easyScoreCalculatorCustomProperties&gt;
      &lt;myCacheSize&gt;1000&lt;/myCacheSize&gt;
    &lt;/easyScoreCalculatorCustomProperties&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="incrementalJavaScoreCalculation"><a class="anchor" href="#incrementalJavaScoreCalculation"></a><a class="link" href="#incrementalJavaScoreCalculation">5.3.3. Incremental Java score calculation</a></h4>
<div class="paragraph">
<p>A way to implement your score calculation incrementally in Java.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Advantages:</p>
<div class="ulist">
<ul>
<li>
<p>Very fast and scalable</p>
<div class="ulist">
<ul>
<li>
<p>Currently the fastest if implemented correctly</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Disadvantages:</p>
<div class="ulist">
<ul>
<li>
<p>Hard to write</p>
<div class="ulist">
<ul>
<li>
<p>A scalable implementation heavily uses maps, indexes, &#8230;&#8203; (things the Drools rule engine can do for you)</p>
</li>
<li>
<p>You have to learn, design, write and improve all these performance optimizations yourself</p>
</li>
</ul>
</div>
</li>
<li>
<p>Hard to read</p>
<div class="ulist">
<ul>
<li>
<p>Regular score constraint changes can lead to a high maintenance cost</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Implement all the methods of the interface <code>IncrementalScoreCalculator</code>
and extend the class <code>AbstractIncrementalScoreCalculator</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface IncrementalScoreCalculator&lt;Solution_&gt; {

    void resetWorkingSolution(Solution_ workingSolution);

    void beforeEntityAdded(Object entity);

    void afterEntityAdded(Object entity);

    void beforeVariableChanged(Object entity, String variableName);

    void afterVariableChanged(Object entity, String variableName);

    void beforeEntityRemoved(Object entity);

    void afterEntityRemoved(Object entity);

    Score calculateScore();

}</code></pre>
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ScoreCalculation/incrementalScoreCalculatorSequenceDiagram.png" alt="incrementalScoreCalculatorSequenceDiagram">
</div>
</div>
<div class="paragraph">
<p>For example in n queens:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class NQueensAdvancedIncrementalScoreCalculator extends AbstractIncrementalScoreCalculator&lt;NQueens&gt; {

    private Map&lt;Integer, List&lt;Queen&gt;&gt; rowIndexMap;
    private Map&lt;Integer, List&lt;Queen&gt;&gt; ascendingDiagonalIndexMap;
    private Map&lt;Integer, List&lt;Queen&gt;&gt; descendingDiagonalIndexMap;

    private int score;

    public void resetWorkingSolution(NQueens nQueens) {
        int n = nQueens.getN();
        rowIndexMap = new HashMap&lt;Integer, List&lt;Queen&gt;&gt;(n);
        ascendingDiagonalIndexMap = new HashMap&lt;Integer, List&lt;Queen&gt;&gt;(n * 2);
        descendingDiagonalIndexMap = new HashMap&lt;Integer, List&lt;Queen&gt;&gt;(n * 2);
        for (int i = 0; i &lt; n; i++) {
            rowIndexMap.put(i, new ArrayList&lt;Queen&gt;(n));
            ascendingDiagonalIndexMap.put(i, new ArrayList&lt;Queen&gt;(n));
            descendingDiagonalIndexMap.put(i, new ArrayList&lt;Queen&gt;(n));
            if (i != 0) {
                ascendingDiagonalIndexMap.put(n - 1 + i, new ArrayList&lt;Queen&gt;(n));
                descendingDiagonalIndexMap.put((-i), new ArrayList&lt;Queen&gt;(n));
            }
        }
        score = 0;
        for (Queen queen : nQueens.getQueenList()) {
            insert(queen);
        }
    }

    public void beforeEntityAdded(Object entity) {
        // Do nothing
    }

    public void afterEntityAdded(Object entity) {
        insert((Queen) entity);
    }

    public void beforeVariableChanged(Object entity, String variableName) {
        retract((Queen) entity);
    }

    public void afterVariableChanged(Object entity, String variableName) {
        insert((Queen) entity);
    }

    public void beforeEntityRemoved(Object entity) {
        retract((Queen) entity);
    }

    public void afterEntityRemoved(Object entity) {
        // Do nothing
    }

    private void insert(Queen queen) {
        Row row = queen.getRow();
        if (row != null) {
            int rowIndex = queen.getRowIndex();
            List&lt;Queen&gt; rowIndexList = rowIndexMap.get(rowIndex);
            score -= rowIndexList.size();
            rowIndexList.add(queen);
            List&lt;Queen&gt; ascendingDiagonalIndexList = ascendingDiagonalIndexMap.get(queen.getAscendingDiagonalIndex());
            score -= ascendingDiagonalIndexList.size();
            ascendingDiagonalIndexList.add(queen);
            List&lt;Queen&gt; descendingDiagonalIndexList = descendingDiagonalIndexMap.get(queen.getDescendingDiagonalIndex());
            score -= descendingDiagonalIndexList.size();
            descendingDiagonalIndexList.add(queen);
        }
    }

    private void retract(Queen queen) {
        Row row = queen.getRow();
        if (row != null) {
            List&lt;Queen&gt; rowIndexList = rowIndexMap.get(queen.getRowIndex());
            rowIndexList.remove(queen);
            score += rowIndexList.size();
            List&lt;Queen&gt; ascendingDiagonalIndexList = ascendingDiagonalIndexMap.get(queen.getAscendingDiagonalIndex());
            ascendingDiagonalIndexList.remove(queen);
            score += ascendingDiagonalIndexList.size();
            List&lt;Queen&gt; descendingDiagonalIndexList = descendingDiagonalIndexMap.get(queen.getDescendingDiagonalIndex());
            descendingDiagonalIndexList.remove(queen);
            score += descendingDiagonalIndexList.size();
        }
    }

    public SimpleScore calculateScore() {
        return SimpleScore.valueOf(score);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure it in the solver configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;scoreDirectorFactory&gt;
    &lt;incrementalScoreCalculatorClass&gt;org.optaplanner.examples.nqueens.solver.score.NQueensAdvancedIncrementalScoreCalculator&lt;/incrementalScoreCalculatorClass&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A piece of incremental score calculator code can be difficult to write and to review.
<a href="#invalidScoreDetection">Assert its correctness</a> by using an <code>EasyScoreCalculator</code> to fulfill
the assertions triggered by the <code>environmentMode</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To configure values of an <code>IncrementalScoreCalculator</code> dynamically in the solver configuration
(so the <a href="#benchmarker">Benchmarker</a> can tweak those parameters),
add the <code>incrementalScoreCalculatorCustomProperties</code> element and use <a href="#customPropertiesConfiguration">custom properties</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;scoreDirectorFactory&gt;
    &lt;incrementalScoreCalculatorClass&gt;...MyIncrementalScoreCalculator&lt;/incrementalScoreCalculatorClass&gt;
    &lt;incrementalScoreCalculatorCustomProperties&gt;
      &lt;myCacheSize&gt;1000&lt;/myCacheSize&gt;
    &lt;/incrementalScoreCalculatorCustomProperties&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="constraintMatchAwareIncrementalScoreCalculator"><a class="anchor" href="#constraintMatchAwareIncrementalScoreCalculator"></a><a class="link" href="#constraintMatchAwareIncrementalScoreCalculator">5.3.3.1. <code>ConstraintMatchAwareIncrementalScoreCalculator</code></a></h5>
<div class="paragraph">
<p>Optionally, also implement the <code>ConstraintMatchAwareIncrementalScoreCalculator</code> interface to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Explain a score by splitting it up per score constraint with <code>ScoreDirector.getConstraintMatchTotals()</code>.</p>
</li>
<li>
<p>Visualize or sort planning entities by how many constraints each one breaks with <code>ScoreDirector.getIndictmentMap()</code>.</p>
</li>
<li>
<p>Receive a detailed analysis if the <code>IncrementalScoreCalculator</code> is corrupted in <code>FAST_ASSERT</code> or <code>FULL_ASSERT</code> <code>environmentMode</code>,</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface ConstraintMatchAwareIncrementalScoreCalculator&lt;Solution_&gt; {

    void resetWorkingSolution(Solution_ workingSolution, boolean constraintMatchEnabled);

    Collection&lt;ConstraintMatchTotal&gt; getConstraintMatchTotals();

    Map&lt;Object, Indictment&gt; getIndictmentMap();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example in machine reassignment, create one ConstraintMatchTotal per constraint type
and call <code>addConstraintMatch()</code> for each constraint match:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class MachineReassignmentIncrementalScoreCalculator
        implements ConstraintMatchAwareIncrementalScoreCalculator&lt;MachineReassignment&gt; {
    ...

    @Override
    public void resetWorkingSolution(MachineReassignment workingSolution, boolean constraintMatchEnabled) {
        resetWorkingSolution(workingSolution);
        // ignore constraintMatchEnabled, it is always presumed enabled
    }

    @Override
    public Collection&lt;ConstraintMatchTotal&gt; getConstraintMatchTotals() {
        ConstraintMatchTotal maximumCapacityMatchTotal = new ConstraintMatchTotal(
                CONSTRAINT_PACKAGE, "maximumCapacity", HardSoftLongScore.ZERO);
        ...
        for (MrMachineScorePart machineScorePart : machineScorePartMap.values()) {
            for (MrMachineCapacityScorePart machineCapacityScorePart : machineScorePart.machineCapacityScorePartList) {
                if (machineCapacityScorePart.maximumAvailable &lt; 0L) {
                    maximumCapacityMatchTotal.addConstraintMatch(
                            Arrays.asList(machineCapacityScorePart.machineCapacity),
                            HardSoftLongScore.valueOf(machineCapacityScorePart.maximumAvailable, 0));
                }
            }
        }
        ...
        List&lt;ConstraintMatchTotal&gt; constraintMatchTotalList = new ArrayList&lt;&gt;(4);
        constraintMatchTotalList.add(maximumCapacityMatchTotal);
        ...
        return constraintMatchTotalList;
    }

    @Override
    public Map&lt;Object, Indictment&gt; getIndictmentMap() {
        return null; // Calculate it non-incrementally from getConstraintMatchTotals()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>That <code>getConstraintMatchTotals()</code> code often duplicates some of the logic of the normal <code>IncrementalScoreCalculator</code> methods.
Drools Score Calculation doesn&#8217;t have this disadvantage, because it is constraint match aware automatically when needed,
without any extra domain-specific code.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="initializingScoreTrend"><a class="anchor" href="#initializingScoreTrend"></a><a class="link" href="#initializingScoreTrend">5.3.4. <code>InitializingScoreTrend</code></a></h4>
<div class="paragraph">
<p>The <code>InitializingScoreTrend</code> specifies how the Score will change as more and more variables are initialized (while the already initialized variables do not change). Some optimization algorithms (such Construction Heuristics and Exhaustive Search) run faster if they have such information.</p>
</div>
<div class="paragraph">
<p>For the Score (or each <a href="#scoreLevel">score level</a> separately), specify a trend:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ANY</code> (default): Initializing an extra variable can change the score positively or negatively. Gives no performance gain.</p>
</li>
<li>
<p><code>ONLY_UP</code> (rare): Initializing an extra variable can only change the score positively. Implies that:</p>
<div class="ulist">
<ul>
<li>
<p>There are only positive constraints</p>
</li>
<li>
<p>And initializing the next variable can not unmatch a positive constraint that was matched by a previous initialized variable.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>ONLY_DOWN</code>: Initializing an extra variable can only change the score negatively. Implies that:</p>
<div class="ulist">
<ul>
<li>
<p>There are only negative constraints</p>
</li>
<li>
<p>And initializing the next variable can not unmatch a negative constraint that was matched by a previous initialized variable.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Most use cases only have negative constraints.
Many of those have an <code>InitializingScoreTrend</code> that only goes down:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDrl&gt;.../cloudBalancingConstraints.drl&lt;/scoreDrl&gt;
    &lt;initializingScoreTrend&gt;ONLY_DOWN&lt;/initializingScoreTrend&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can also specify the trend for each score level separately:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDrl&gt;.../cloudBalancingConstraints.drl&lt;/scoreDrl&gt;
    &lt;initializingScoreTrend&gt;ONLY_DOWN/ONLY_DOWN&lt;/initializingScoreTrend&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="invalidScoreDetection"><a class="anchor" href="#invalidScoreDetection"></a><a class="link" href="#invalidScoreDetection">5.3.5. Invalid score detection</a></h4>
<div class="paragraph">
<p>When you put the <a href="#environmentMode"><code>environmentMode</code></a> in <code>FULL_ASSERT</code> (or <code>FAST_ASSERT</code>),
it will detect score corruption in the <a href="#incrementalScoreCalculation">incremental score calculation</a>.
However, that will not verify that your score calculator actually implements your score constraints as your business desires.
For example, one constraint might consistently match the wrong pattern.
To verify the constraints against an independent implementation, configure a <code>assertionScoreDirectorFactory</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;environmentMode&gt;FAST_ASSERT&lt;/environmentMode&gt;
  ...
  &lt;scoreDirectorFactory&gt;
    &lt;constraintProviderClass&gt;org.optaplanner.examples.nqueens.solver.score.NQueensConstraintProvider&lt;/constraintProviderClass&gt;
    &lt;assertionScoreDirectorFactory&gt;
      &lt;easyScoreCalculatorClass&gt;org.optaplanner.examples.nqueens.solver.score.NQueensEasyScoreCalculator&lt;/easyScoreCalculatorClass&gt;
    &lt;/assertionScoreDirectorFactory&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This way, the <code>NQueensConstraintProvider</code> implementation is validated by the <code>EasyScoreCalculator</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This works well to isolate score corruption,
but to verify that the constraint implement the real business needs,
<a href="#constraintStreamsTesting">a unit test with a ConstraintVerifier</a> is usually better.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scoreCalculationPerformanceTricks"><a class="anchor" href="#scoreCalculationPerformanceTricks"></a><a class="link" href="#scoreCalculationPerformanceTricks">5.4. Score calculation performance tricks</a></h3>
<div class="sect3">
<h4 id="scoreCalculationPerformanceTricksOverview"><a class="anchor" href="#scoreCalculationPerformanceTricksOverview"></a><a class="link" href="#scoreCalculationPerformanceTricksOverview">5.4.1. Overview</a></h4>
<div class="paragraph">
<p>The <code>Solver</code> will normally spend most of its execution time running the score calculation
(which is called in its deepest loops).
Faster score calculation will return the same solution in less time with the same algorithm,
which normally means a better solution in equal time.</p>
</div>
</div>
<div class="sect3">
<h4 id="scoreCalculationSpeed"><a class="anchor" href="#scoreCalculationSpeed"></a><a class="link" href="#scoreCalculationSpeed">5.4.2. Score calculation speed</a></h4>
<div class="paragraph">
<p>After solving a problem, the <code>Solver</code> will log the <em>score calculation speed per second</em>.
This is a good measurement of Score calculation performance,
despite that it is affected by non score calculation execution time.
It depends on the problem scale of the problem dataset.
Normally, even for high scale problems, it is higher than <code>1000</code>, except if you are using an <code>EasyScoreCalculator</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When improving your score calculation, focus on maximizing the score calculation speed, instead of maximizing the best score.
A big improvement in score calculation can sometimes yield little or no best score improvement, for example when the algorithm is stuck in a local or global optima.
If you are watching the calculation speed instead, score calculation improvements are far more visible.</p>
</div>
<div class="paragraph">
<p>Furthermore, watching the calculation speed allows you to remove or add score constraints,
and still compare it with the original&#8217;s calculation speed.
Comparing the best score with the original&#8217;s best score is pointless: it&#8217;s comparing apples and oranges.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="incrementalScoreCalculation"><a class="anchor" href="#incrementalScoreCalculation"></a><a class="link" href="#incrementalScoreCalculation">5.4.3. Incremental score calculation (with deltas)</a></h4>
<div class="paragraph">
<p>When a solution changes, incremental score calculation (AKA delta based score calculation)
calculates the delta with the previous state to find the new <code>Score</code>,
instead of recalculating the entire score on every solution evaluation.</p>
</div>
<div class="paragraph">
<p>For example, when a single queen A moves from row <code>1</code> to <code>2</code>,
it will not bother to check if queen B and C can attack each other, since neither of them changed:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ScoreCalculation/incrementalScoreCalculationNQueens04.png" alt="incrementalScoreCalculationNQueens04">
</div>
</div>
<div class="paragraph">
<p>Similarly in employee rostering:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ScoreCalculation/incrementalScoreCalculationEmployeeRostering.png" alt="incrementalScoreCalculationEmployeeRostering">
</div>
</div>
<div class="paragraph">
<p>This is a huge performance and scalability gain.
<strong>Drools score calculation gives you this huge scalability gain without forcing you to write a complicated incremental score calculation algorithm.</strong>
Just let the Drools rule engine do the hard work.</p>
</div>
<div class="paragraph">
<p>Notice that the speedup is relative to the size of your planning problem (your <em>n</em>), making incremental score calculation far more scalable.</p>
</div>
</div>
<div class="sect3">
<h4 id="avoidCallingRemoteServicesDuringScoreCalculation"><a class="anchor" href="#avoidCallingRemoteServicesDuringScoreCalculation"></a><a class="link" href="#avoidCallingRemoteServicesDuringScoreCalculation">5.4.4. Avoid calling remote services during score calculation</a></h4>
<div class="paragraph">
<p>Do not call remote services in your score calculation (except if you are bridging <code>EasyScoreCalculator</code> to a legacy system). The network latency will kill your score calculation performance.
Cache the results of those remote services if possible.</p>
</div>
<div class="paragraph">
<p>If some parts of a constraint can be calculated once, when the <code>Solver</code> starts, and never change during solving,
then turn them into <a href="#cachedProblemFact">cached problem facts</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="pointlessConstraints"><a class="anchor" href="#pointlessConstraints"></a><a class="link" href="#pointlessConstraints">5.4.5. Pointless constraints</a></h4>
<div class="paragraph">
<p>If you know a certain constraint can never be broken (or it is always broken), do not write a score constraint for it.
For example in n queens, the score calculation does not check if multiple queens occupy the same column,
because a <code>Queen</code>'s <code>column</code> never changes and every solution starts with each <code>Queen</code> on a different <code>column</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not go overboard with this.
If some datasets do not use a specific constraint but others do, just return out of the constraint as soon as you can.
There is no need to dynamically change your score calculation based on the dataset.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="buildInHardConstraint"><a class="anchor" href="#buildInHardConstraint"></a><a class="link" href="#buildInHardConstraint">5.4.6. Built-in hard constraint</a></h4>
<div class="paragraph">
<p>Instead of implementing a hard constraint, it can sometimes be built in.
For example, if <code>Lecture</code> A should never be assigned to <code>Room</code> X, but it uses <code>ValueRangeProvider</code> on Solution,
so the <code>Solver</code> will often try to assign it to <code>Room</code> X too (only to find out that it breaks a hard constraint).
Use <a href="#valueRangeProviderOnPlanningEntity">a ValueRangeProvider on the planning entity</a> or <a href="#filteredSelection">filtered selection</a> to define that Course A should only be assigned a <code>Room</code> different than X.</p>
</div>
<div class="paragraph">
<p>This can give a good performance gain in some use cases, not just because the score calculation is faster,
but mainly because most optimization algorithms will spend less time evaluating infeasible solutions.
However, usually this is not a good idea because there is a real risk of trading short term benefits for long term harm:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Many optimization algorithms rely on the freedom to break hard constraints when changing planning entities,
to get out of local optima.</p>
</li>
<li>
<p>Both implementation approaches have limitations (feature compatibility, disabling automatic performance optimizations),
as explained in their documentation.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="otherScoreCalculationPerformanceTricks"><a class="anchor" href="#otherScoreCalculationPerformanceTricks"></a><a class="link" href="#otherScoreCalculationPerformanceTricks">5.4.7. Other score calculation performance tricks</a></h4>
<div class="ulist">
<ul>
<li>
<p>Verify that your score calculation happens in the correct <code>Number</code> type.
If you are making the sum of <code>int</code> values, do not let Drools sum it in a <code>double</code> which takes longer.</p>
</li>
<li>
<p>For optimal performance, always use server mode (<code>java -server</code>).
We have seen performance increases of 50% by turning on server mode.</p>
</li>
<li>
<p>For optimal performance, use the latest Java version.
For example, in the past we have seen performance increases of 30% by switching from java 1.5 to 1.6.</p>
</li>
<li>
<p>Always remember that premature optimization is the root of all evil.
Make sure your design is flexible enough to allow configuration based tweaking.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="scoreTrap"><a class="anchor" href="#scoreTrap"></a><a class="link" href="#scoreTrap">5.4.8. Score trap</a></h4>
<div class="paragraph">
<p>Make sure that none of your score constraints cause a score trap.
A trapped score constraint uses the same weight for different constraint matches, when it could just as easily use a different weight.
It effectively lumps its constraint matches together, which creates a flatlined score function for that constraint.
This can cause a solution state in which several moves need to be done to resolve or lower the weight of that single constraint.
Some examples of score traps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You need two doctors at each table, but you are only moving one doctor at a time. So the solver has no incentive to move a doctor to a table with no doctors. Punish a table with no doctors more than a table with only one doctor in that score constraint in the score function.</p>
</li>
<li>
<p>Two exams need to be conducted at the same time, but you are only moving one exam at a time. So the solver has to move one of those exams to another timeslot without moving the other in the same move. Add a coarse-grained move that moves both exams at the same time.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, consider this score trap.
If the blue item moves from an overloaded computer to an empty computer, the hard score should improve.
The trapped score implementation fails to do that:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ScoreCalculation/scoreTrap.png" alt="scoreTrap">
</div>
</div>
<div class="paragraph">
<p>The Solver should eventually get out of this trap, but it will take a lot of effort (especially if there are even more processes on the overloaded computer). Before they do that, they might actually start moving more processes into that overloaded computer, as there is no penalty for doing so.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Avoiding score traps does not mean that your score function should be smart enough to avoid local optima.
Leave it to the optimization algorithms to deal with the local optima.</p>
</div>
<div class="paragraph">
<p>Avoiding score traps means to avoid, for each score constraint individually, a flatlined score function.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Always specify the degree of infeasibility.
The business will often say "if the solution is infeasible, it does not matter how infeasible it is." While that is true for the business, it is not true for score calculation as it benefits from knowing how infeasible it is.
In practice, soft constraints usually do this naturally and it is just a matter of doing it for the hard constraints too.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are several ways to deal with a score trap:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Improve the score constraint to make a distinction in the score weight. For example, penalize <code>-1hard</code> for every missing CPU, instead of just <code>-1hard</code> if any CPU is missing.</p>
</li>
<li>
<p>If changing the score constraint is not allowed from the business perspective, add a lower score level with a score constraint that makes such a distinction. For example, penalize <code>-1subsoft</code> for every missing CPU, on top of <code>-1hard</code> if any CPU is missing. The business ignores the subsoft score level.</p>
</li>
<li>
<p>Add coarse-grained moves and union select them with the existing fine-grained moves. A coarse-grained move effectively does multiple moves to directly get out of a score trap with a single move. For example, move multiple items from the same container to another container.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="stepLimitBenchmark"><a class="anchor" href="#stepLimitBenchmark"></a><a class="link" href="#stepLimitBenchmark">5.4.9. <code>stepLimit</code> benchmark</a></h4>
<div class="paragraph">
<p>Not all score constraints have the same performance cost.
Sometimes one score constraint can kill the score calculation performance outright.
Use the <a href="#benchmarker">Benchmarker</a> to do a one minute run and check what happens to the score calculation speed if you comment out all but one of the score constraints.</p>
</div>
</div>
<div class="sect3">
<h4 id="fairnessScoreConstraints"><a class="anchor" href="#fairnessScoreConstraints"></a><a class="link" href="#fairnessScoreConstraints">5.4.10. Fairness score constraints</a></h4>
<div class="paragraph">
<p>Some use cases have a business requirement to provide a fair schedule (usually as a soft score constraint), for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fairly distribute the workload amongst the employees, to avoid envy.</p>
</li>
<li>
<p>Evenly distribute the workload amongst assets, to improve reliability.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Implementing such a constraint can seem difficult (especially because there are different ways to formalize fairness), but usually the <em>squared workload</em> implementation behaves most desirable.
For each employee/asset, count the workload <code>w</code> and subtract <code>w²</code> from the score.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ScoreCalculation/fairnessScoreConstraint.png" alt="fairnessScoreConstraint">
</div>
</div>
<div class="paragraph">
<p>As shown above, the <em>squared workload</em> implementation guarantees that if you select two employees from a given solution and make their distribution between those two employees fairer, then the resulting new solution will have a better overall score.
Do not just use the difference from the average workload, as that can lead to unfairness, as demonstrated below.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ScoreCalculation/fairnessScoreConstraintPitfall.png" alt="fairnessScoreConstraintPitfall">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Instead of the <em>squared workload</em>, it is also possible to use the <a href="https://en.wikipedia.org/wiki/Variance">variance</a>
(squared difference to the average) or the <a href="http://en.wikipedia.org/wiki/Standard_deviation">standard deviation</a>
(square root of the variance).
This has no effect on the score comparison, because the average will not change during planning.
It is just more work to implement (because the average needs to be known) and trivially slower (because the calculation is a bit longer).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the workload is perfectly balanced, the user often likes to see a <code>0</code> score, instead of the distracting <code>-34soft</code> in the image above (for the last solution which is almost perfectly balanced).
To nullify this, either add the average multiplied by the number of entities to the score or instead show the variance or standard deviation in the UI.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="constraintConfiguration"><a class="anchor" href="#constraintConfiguration"></a><a class="link" href="#constraintConfiguration">5.5. Constraint configuration: adjust constraint weights dynamically</a></h3>
<div class="paragraph">
<p>Deciding the correct <a href="#scoreConstraintWeight">weight</a> and <a href="#scoreLevel">level</a> for each constraint is not easy.
It often involves negotiating with different stakeholders and their priorities.
Furthermore, quantifying the impact of soft constraints is often a new experience for business managers, so they 'll need a number of iterations to get it right.</p>
</div>
<div class="paragraph">
<p>Don&#8217;t get stuck between a rock and a hard place.
Provide a UI to adjust the constraint weights and visualize the resulting solution, so the business managers can tweak the constraint weights themselves:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ScoreCalculation/parameterizeTheScoreWeights.png" alt="parameterizeTheScoreWeights">
</div>
</div>
<div class="sect3">
<h4 id="createAConstraintConfiguration"><a class="anchor" href="#createAConstraintConfiguration"></a><a class="link" href="#createAConstraintConfiguration">5.5.1. Create a constraint configuration</a></h4>
<div class="paragraph">
<p>First, create a new class to hold the constraint weights and other constraint parameters.
Annotate it with <code>@ConstraintConfiguration</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@ConstraintConfiguration
public class ConferenceConstraintConfiguration {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There will be exactly one instance of this class per planning solution.
The planning solution and the constraint configuration have a one to one relationship,
but they serve a different purpose, so they aren&#8217;t merged into a single class.
A <code>@ConstraintConfiguration</code> class can extend a parent <code>@ConstraintConfiguration</code> class,
which can be useful in international use cases with many regional constraints.</p>
</div>
<div class="paragraph">
<p>Add the constraint configuration on the planning solution
and annotate that field or property with <code>@ConstraintConfigurationProvider</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
public class ConferenceSolution {

    @ConstraintConfigurationProvider
    private ConferenceConstraintConfiguration constraintConfiguration;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@ConstraintConfigurationProvider</code> annotation automatically exposes the constraint configuration
as a <a href="#problemFacts">problem fact</a>, there is no need to add a <code>@ProblemFactProperty</code> annotation.</p>
</div>
<div class="paragraph">
<p>The constraint configuration class holds the <a href="#constraintWeight">constraint weights</a>,
but it can also hold constraint parameters.
For example in conference scheduling, the minimum pause constraint has a constraint weight (like any other constraint),
but it also has a constraint parameter that defines the length of the minimum pause between two talks of the same speaker.
That pause length depends on the conference (= the planning problem):
in some big conferences 20 minutes isn&#8217;t enough to go from one room to the other.
That pause length is a field in the constraint configuration without a <code>@ConstraintWeight</code> annotation.</p>
</div>
</div>
<div class="sect3">
<h4 id="constraintWeight"><a class="anchor" href="#constraintWeight"></a><a class="link" href="#constraintWeight">5.5.2. Add a constraint weight for each constraint</a></h4>
<div class="paragraph">
<p>In the constraint configuration class, add a <code>@ConstraintWeight</code> field or property for each constraint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@ConstraintConfiguration(constraintPackage = "...conferencescheduling.solver")
public class ConferenceConstraintConfiguration {

    @ConstraintWeight("Speaker conflict")
    private HardMediumSoftScore speakerConflict = HardMediumSoftScore.ofHard(10);

    @ConstraintWeight("Theme track conflict")
    private HardMediumSoftScore themeTrackConflict = HardMediumSoftScore.ofSoft(10);
    @ConstraintWeight("Content conflict")
    private HardMediumSoftScore contentConflict = HardMediumSoftScore.ofSoft(100);

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The type of the constraint weights must be the same score class as <a href="#scoreOfASolution">the planning solution&#8217;s score member</a>.
For example in conference scheduling, <code>ConferenceSolution.getScore()</code> and <code>ConferenceConstraintConfiguration.getSpeakerConflict()</code>
both return a <code>HardMediumSoftScore</code>.</p>
</div>
<div class="paragraph">
<p>A constraint weight cannot be null.
Give each constraint weight a default value, but expose them in a UI so the business users can tweak them.
The example above uses the <code>ofHard()</code>, <code>ofMedium()</code> and <code>ofSoft()</code> methods to do that.
Notice how it defaults the <em>content conflict</em> constraint as ten times more important than the <em>theme track conflict</em> constraint.
Normally, a constraint weight only uses one score level,
but it&#8217;s possible to use multiple score levels (at a small performance cost).</p>
</div>
<div class="paragraph">
<p>Each constraint has a constraint package and a constraint name, together they form the constraint id.
These connect the constraint weight with the constraint implementation.
<strong>For each constraint weight, there must be a constraint implementation with the same package and the same name.</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>@ConstraintConfiguration</code> annotation has a <code>constraintPackage</code> property that defaults to the package of the constraint configuration class.
Most cases with <a href="#droolsScoreCalculation">Drools score calculation</a>, need to override that because the DRLs use another package.
For example, the DRL below uses the package <code>&#8230;&#8203;conferencescheduling.solver</code>,
so the constraint configuration above specifies a <code>constraintPackage</code>.
Cases with <a href="#constraintStreams">Constraint streams</a>, normally don&#8217;t need to specify it.</p>
</li>
<li>
<p>The <code>@ConstraintWeight</code> annotation has a <code>value</code> which is the constraint name (for example "Speaker conflict").
It inherits the constraint package from the <code>@ConstraintConfiguration</code>,
but it can override that, for example <code>@ConstraintWeight(constraintPackage = "&#8230;&#8203;region.france", &#8230;&#8203;)</code>
to use a different constraint package than some of the other weights.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So every constraint weight ends up with a constraint package and a constraint name.
Each constraint weight links with a constraint implementation,
for example in <a href="#droolsScoreCalculation">Drools score calculation</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">package ...conferencescheduling.solver;

rule "Speaker conflict"
    when
        ...
    then
        scoreHolder.penalize(kcontext);
end

rule "Theme track conflict"
    when
        ...
    then
        scoreHolder.penalize(kcontext, ...);
end

rule "Content conflict"
    when
        ...
    then
        scoreHolder.penalize(kcontext, ...);
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each of the constraint weights defines the score level and score weight of their constraint.
The constraint implementation calls <code>reward()</code> or <code>penalize()</code> and the constraint weight is automatically applied.</p>
</div>
<div class="paragraph">
<p>If the constraint implementation provides a match weight, that <strong>match weight is multiplied with the constraint weight</strong>.
For example, the <em>content conflict</em> constraint weight defaults to <code>100soft</code>
and the constraint implementation penalizes each match based on the number of shared content tags:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @ConstraintWeight("Content conflict")
    private HardMediumSoftScore contentConflict = HardMediumSoftScore.ofSoft(100);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">rule "Content conflict"
    when
        $talk1 : Talk(...)
        $talk2 : Talk(...)
    then
        scoreHolder.penalize(kcontext,
                $talk2.overlappingContentCount($talk1));
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>So when 2 overlapping talks share only 1 content tag, the score is impacted by <code>-100soft</code>.
But when 2 overlapping talks share 3 content tags, the match weight is <code>3</code>, so the score is impacted by <code>-300soft</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="explainingTheScore"><a class="anchor" href="#explainingTheScore"></a><a class="link" href="#explainingTheScore">5.6. Explaining the score: which constraints are broken?</a></h3>
<div class="paragraph">
<p>The easiest way to explain the score during development is to print the return value of <code>explainScore()</code>, but only use that method for diagnostic purposes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">System.out.println(scoreManager.explainScore(solution));</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example in conference scheduling, this prints that talk <code>S51</code> is responsible for breaking the hard constraint <code>Speaker required room tag</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Explanation of score (-1hard/-806soft):
    Constraint match totals:
        -1hard: constraint (Speaker required room tag) has 1 matches:
            -1hard: justifications ([S51])
        -340soft: constraint (Theme track conflict) has 32 matches:
            -20soft: justifications ([S68, S66])
            -20soft: justifications ([S61, S44])
            ...
        ...
    Indictments (top 5 of 72):
        -1hard/-22soft: justification (S51) has 12 matches:
            -1hard: constraint (Speaker required room tag)
            -10soft: constraint (Theme track conflict)
            ...
        ...</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not attempt to parse this string or use it in your UI or exposed services.
Instead use the ConstraintMatch API below and do it properly.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="usingScoreCalculationOutsideTheSolver"><a class="anchor" href="#usingScoreCalculationOutsideTheSolver"></a><a class="link" href="#usingScoreCalculationOutsideTheSolver">5.6.1. Using score calculation outside the <code>Solver</code></a></h4>
<div class="paragraph">
<p>If other parts of your application, for example your webUI, need to calculate the score of a solution,
reuse the <code>ScoreDirectorFactory</code> of the <code>SolverFactory</code> to build a separate <code>ScoreDirector</code> for that webUI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">ScoreDirectorFactory&lt;CloudBalance&gt; scoreDirectorFactory = solverFactory.getScoreDirectorFactory();
try (ScoreDirector&lt;CloudBalance&gt; guiScoreDirector = scoreDirectorFactory.buildScoreDirector()) {
    ...
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>try</code> ARM will call <code>ScoreDirector.close()</code> when the <code>ScoreDirector</code> becomes useless,
to avoid a memory leak, especially with <a href="#droolsScoreCalculation">Drools score calculation</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then use it when you need to calculate the <code>Score</code> of a solution:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">guiScoreDirector.setWorkingSolution(cloudBalance);
Score score = guiScoreDirector.calculateScore();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Furthermore, the <code>ScoreDirector</code> can explain the score through constraint match totals and/or indictments:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ScoreCalculation/scoreVisualization.png" alt="scoreVisualization">
</div>
</div>
</div>
<div class="sect3">
<h4 id="constraintMatchTotal"><a class="anchor" href="#constraintMatchTotal"></a><a class="link" href="#constraintMatchTotal">5.6.2. Constraint match total: break down the score by constraint</a></h4>
<div class="paragraph">
<p>To break down the score per constraint, get the <code>ConstraintMatchTotal</code>s from the <code>ScoreDirector</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">Collection&lt;ConstraintMatchTotal&gt; constraintMatchTotals = guiScoreDirector.getConstraintMatchTotals();
for (ConstraintMatchTotal constraintMatchTotal : constraintMatchTotals) {
    String constraintName = constraintMatchTotal.getConstraintName();
    // The score impact of that constraint
    HardSoftScore totalScore = (HardSoftScore) constraintMatchTotal.getScore();

    for (ConstraintMatch constraintMatch : constraintMatchTotal.getConstraintMatchSet()) {
        List&lt;Object&gt; justificationList = constraintMatch.getJustificationList();
        HardSoftScore score = (HardSoftScore) constraintMatch.getScore();
        ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each <code>ConstraintMatchTotal</code> represents one constraint and has a part of the overall score.
The sum of all the <code>ConstraintMatchTotal.getScore()</code> equals the overall score.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="#droolsScoreCalculation">Drools score calculation</a> supports constraint matches automatically,
but <a href="#incrementalJavaScoreCalculation">incremental Java score calculation</a> requires
<a href="#constraintMatchAwareIncrementalScoreCalculator">implementing an extra interface</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="indictmentHeatMap"><a class="anchor" href="#indictmentHeatMap"></a><a class="link" href="#indictmentHeatMap">5.6.3. Indictment heat map: visualize the hot planning entities</a></h4>
<div class="paragraph">
<p>To show a heat map in the UI that highlights the planning entities and problem facts have an impact on the <code>Score</code>,
get the <code>Indictment</code> map from the <code>ScoreDirector</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">Map&lt;Object, Indictment&gt; indictmentMap = guiScoreDirector.getIndictmentMap();
for (CloudProcess process : cloudBalance.getProcessList()) {
    Indictment indictment = indictmentMap.get(process);
    if (indictment == null) {
        continue;
    }
    // The score impact of that planning entity
    HardSoftScore totalScore = (HardSoftScore) indictment.getScore();

    for (ConstraintMatch constraintMatch : indictment.getConstraintMatchSet()) {
        String constraintName = constraintMatch.getConstraintName();
        HardSoftScore score = (HardSoftScore) constraintMatch.getScore();
        ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each <code>Indictment</code> is the sum of all constraints where that justification object is involved with.
The sum of all the <code>Indictment.getScoreTotal()</code> differs from the overall score,
because multiple <code>Indictment</code>s can share the same <code>ConstraintMatch</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="#droolsScoreCalculation">Drools score calculation</a> supports constraint matches automatically,
but <a href="#incrementalJavaScoreCalculation">incremental Java score calculation</a> requires
<a href="#constraintMatchAwareIncrementalScoreCalculator">implementing an extra interface</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="testingScoreConstraints"><a class="anchor" href="#testingScoreConstraints"></a><a class="link" href="#testingScoreConstraints">5.7. Testing score constraints</a></h3>
<div class="paragraph">
<p>It&#8217;s recommended to write a unit test for each score constraint individually to check that it behaves correctly.
Different score calculation types come with different tools for testing.
For more, see <a href="#constraintStreamsTesting">testing constraint streams</a> or
<a href="#testingDroolsConstraints">testing Drools constraints</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="constraintStreams"><a class="anchor" href="#constraintStreams"></a><a class="link" href="#constraintStreams">6. Constraint streams score calculation</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Constraint streams are a Functional Programming form of incremental score calculation in plain Java that is easy to
read, write and debug.
The API should feel familiar if you&#8217;ve worked with Java 8 Streams or SQL.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The ConstraintStreams/ConstraintProvider API is an ongoing project.
It works but it has many API gaps.
Therefore, it is not rich enough yet to handle complex constraints.
<a href="#explainingTheScore">Constraint justifications</a> may not function properly.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="constraintStreamsIntroduction"><a class="anchor" href="#constraintStreamsIntroduction"></a><a class="link" href="#constraintStreamsIntroduction">6.1. Introduction</a></h3>
<div class="paragraph">
<p>Using Java 8&#8217;s Streams API, we could implement an <a href="#easyJavaScoreCalculation">easy score calculator</a>
that uses a functional approach:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    private int doNotAssignAnn() {
        int softScore = 0;
        schedule.getShiftList().stream()
                .filter(Shift::isEmployeeAnn)
                .forEach(shift -&gt; {
                    softScore -= 1;
                });
        return softScore;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, that scales poorly because it doesn&#8217;t do an <a href="#incrementalScoreCalculation">incremental calculation</a>:
When the planning variable of a single <code>Shift</code> changes, to recalculate the score,
the normal Streams API has to execute the entire stream from scratch.
The ConstraintStreams API enables you to write similar code in pure Java, while reaping the performance benefits of
incremental score calculation.
This is an example of the same code, using the Constraint Streams API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    private Constraint doNotAssignAnn(ConstraintFactory factory) {
        return factory.from(Shift.class)
                .filter(Shift::isEmployeeAnn)
                .penalize("Don't assign Ann", HardSoftScore.ONE_SOFT);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>This constraint stream iterates over all instances of class <code>Shift</code> in the <a href="#problemFacts">problem facts</a> and
<a href="#planningEntity">planning entities</a> in the <a href="#planningProblemAndPlanningSolution">planning problem</a>.
It finds every <code>Shift</code> which is assigned to employee <code>Ann</code> and for every such instance (also called a match), it adds a
soft penalty of <code>1</code> to the overall <a href="#calculateTheScore">score</a>.
The following figure illustrates this process on a problem with 4 different shifts:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ConstraintStreams/constraintStreamIntroduction.png" alt="constraintStreamIntroduction">
</div>
</div>
<div class="paragraph">
<p>If any of the instances change during solving, the constraint stream automatically detects the change
and only recalculates the minimum necessary portion of the problem that is affected by the change.
The following figure illustrates this <a href="#incrementalScoreCalculation">incremental score calculation</a>:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ConstraintStreams/constraintStreamIncrementalCalculation.png" alt="constraintStreamIncrementalCalculation">
</div>
</div>
</div>
<div class="sect2">
<h3 id="constraintStreamsConfiguration"><a class="anchor" href="#constraintStreamsConfiguration"></a><a class="link" href="#constraintStreamsConfiguration">6.2. Creating a constraint stream</a></h3>
<div class="paragraph">
<p>To use the ConstraintStreams API in your project, first write a pure Java <code>ConstraintProvider</code> implementation similar
to the following example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    public class MyConstraintProvider implements ConstraintProvider {

        @Override
        public Constraint[] defineConstraints(ConstraintFactory factory) {
            return new Constraint[] {
                    penalizeEveryShift(factory)
            };
        }

        private Constraint penalizeEveryShift(ConstraintFactory factory) {
            return factory.from(Shift.class)
                .penalize("Penalize a shift", HardSoftScore.ONE_SOFT);
        }

    }</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This example contains one constraint, <code>penalizeEveryShift(&#8230;&#8203;)</code>.
However, you can include as many as you require.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add the following code to your solver configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;solver&gt;
      &lt;scoreDirectorFactory&gt;
        &lt;constraintProviderClass&gt;com.example.MyConstraintProvider&lt;/constraintProviderClass&gt;
      &lt;/scoreDirectorFactory&gt;
      ...
    &lt;/solver&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="constraintStreamsCardinality"><a class="anchor" href="#constraintStreamsCardinality"></a><a class="link" href="#constraintStreamsCardinality">6.3. Constraint stream cardinality</a></h3>
<div class="paragraph">
<p>Constraint stream cardinality is a measure of how many objects a single constraint match consists of.
The simplest constraint stream has a cardinality of 1, meaning each constraint match only consists of 1 object.
Therefore, it is called a <code>UniConstraintStream</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    private Constraint doNotAssignAnn(ConstraintFactory factory) {
        return factory.from(Shift.class) // Returns UniStream&lt;Shift&gt;.
                ...
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some constraint stream <a href="#constraintStreamsBuildingBlocks">building blocks</a> can increase stream cardinality, such as
<a href="#constraintStreamsJoin">join</a> or <a href="#constraintStreamsGroupingAndCollectors">groupBy</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    private Constraint doNotAssignAnn(ConstraintFactory factory) {
        return factory.from(Shift.class) // Returns Uni&lt;Shift&gt;.
                .join(Employee.class)    // Returns Bi&lt;Shift, Employee&gt;.
                .join(DayOff.class)      // Returns Tri&lt;Shift, Employee, DayOff&gt;.
                .join(Country.class)     // Returns Quad&lt;Shift, Employee, DayOff, Country&gt;.
                ...
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The latter can also decrease stream cardinality:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    private Constraint doNotAssignAnn(ConstraintFactory factory) {
        return factory.from(Shift.class) // Returns UniStream&lt;Shift&gt;.
                .join(Employee.class) // Returns BiStream&lt;Shift, Employee&gt;.
                .groupBy((shift, employee) -&gt; employee) // Returns UniStream&lt;Employee&gt;.
                ...
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following constraint stream cardinalities are currently supported:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cardinality</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prefix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defining interface</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uni</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UniConstraintStream&lt;A&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BiConstraintStream&lt;A, B&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tri</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TriConstraintStream&lt;A, B, C&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Quad</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>QuadConstraintStream&lt;A, B, C, D&gt;</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="constraintStreamsBuildingBlocks"><a class="anchor" href="#constraintStreamsBuildingBlocks"></a><a class="link" href="#constraintStreamsBuildingBlocks">6.4. Building blocks</a></h3>
<div class="paragraph">
<p>Constraint streams are chains of different operations, called building blocks.
Each constraint stream starts with a <code>from(&#8230;&#8203;)</code> building block and is terminated by either a penalty or a reward.
The following example shows the simplest possible constraint stream:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    private Constraint penalizeInitializedShifts(ConstraintFactory factory) {
        return factory.from(Shift.class)
                .penalize("Initialized shift", HardSoftScore.ONE_SOFT);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>This constraint stream iterates over all known and initialized instances of <code>Shift</code>.
To include uninitialized instances, replace the <code>from()</code> building block with <code>fromUnfiltered()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    private Constraint penalizeAllShifts(ConstraintFactory factory) {
        return factory.fromUnfiltered(Shift.class)
                .penalize("A shift", HardSoftScore.ONE_SOFT);
    }</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="constraintStreamsPenaltiesRewards"><a class="anchor" href="#constraintStreamsPenaltiesRewards"></a><a class="link" href="#constraintStreamsPenaltiesRewards">6.4.1. Penalties and rewards</a></h4>
<div class="paragraph">
<p>The purpose of constraint streams is to build up a <a href="#whatIsAScore">score</a> for a <a href="#planningProblemAndPlanningSolution">solution</a>.
To do this, every constraint stream must be terminated by a call to either a <code>penalize()</code> or a <code>reward()</code>
building block.
The <code>penalize()</code> building block makes the score worse and the <code>reward()</code> building block improves the score.
Penalties and rewards have several components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Constraint package is the Java package that contains the constraint.
The default value is the package that contains the <code>ConstraintProvider</code> implementation or the value from
<a href="#constraintConfiguration">constraint configuration</a>, if implemented.</p>
</li>
<li>
<p>Constraint name is the human readable descriptive name for the constraint, which
(together with the constraint package) must be unique within the entire <code>ConstraintProvider</code> implementation.</p>
</li>
<li>
<p>Constraint weight is a constant score value indicating how much every breach of the constraint affects the score.
Valid examples include <code>SimpleScore.ONE</code>, <code>HardSoftScore.ONE_HARD</code> and <code>HardMediumSoftScore.of(1, 2, 3)</code>.</p>
</li>
<li>
<p>Constraint match weigher is an optional function indicating how many times the constraint weight should be applied in
the score.
The penalty or reward score impact is the constraint weight multiplied by the match weight.
The default value is <code>1</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The ConstraintStreams API supports many different types of penalties.
Browse the API in your IDE for the full list of method overloads.
Here are some examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Simple penalty (<code>penalize("Constraint name", SimpleScore.ONE)</code>) makes the score worse by <code>1</code> per every match in the
constraint stream.
The score type must be the same type as used on the <code>@PlanningScore</code> annotated member on the planning solution.</p>
</li>
<li>
<p>Dynamic penalty (<code>penalize("Constraint name", SimpleScore.ONE, Shift::getHours)</code>) makes the score worse by the number
of hours in every matching <code>Shift</code> in the constraint stream.
This is an example of using a constraint match weigher.</p>
</li>
<li>
<p>Configurable penalty (<code>penalizeConfigurable("Constraint name")</code>) makes the score worse using constraint weights
defined in <a href="#constraintConfiguration">constraint configuration</a>.</p>
</li>
<li>
<p>Configurable dynamic penalty(<code>penalizeConfigurable("Constraint name", Shift::getHours)</code>) makes the score worse using
constraint weights defined in <a href="#constraintConfiguration">constraint configuration</a>, multiplied by the number of hours in
every matching <code>Shift</code> in the constraint stream.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By replacing the keyword <code>penalize</code> by <code>reward</code> in the name of these building blocks, you will get operations that
affect score in the opposite direction.</p>
</div>
</div>
<div class="sect3">
<h4 id="constraintStreamsFilter"><a class="anchor" href="#constraintStreamsFilter"></a><a class="link" href="#constraintStreamsFilter">6.4.2. Filtering</a></h4>
<div class="paragraph">
<p>Filtering enables you to reduce the number of constraint matches in your stream.
It first enumerates all constraint matches and then applies a predicate to filter some matches out.
The predicate is a function that only returns <code>true</code> if the match is to continue in the stream.
The following constraint stream removes all of Beth&#8217;s shifts from all <code>Shift</code> matches:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    private Constraint penalizeAnnShifts(ConstraintFactory factory) {
        return factory.from(Shift.class)
                .filter(shift -&gt; shift.getEmployeeName().equals("Ann"))
                .penalize("Ann's shift", SimpleScore.ONE);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example retrieves a list of shifts where an employee has asked for a day off from a bi-constraint match
of <code>Shift</code> and <code>DayOff</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    private Constraint penalizeShiftsOnOffDays(ConstraintFactory factory) {
        return factory.from(Shift.class)
                .join(DayOff.class)
                .filter((shift, dayOff) -&gt; shift.date == dayOff.date &amp;&amp; shift.employee == dayOff.employee)
                .penalize("Shift on an off-day", SimpleScore.ONE);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following figure illustrates both these examples:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ConstraintStreams/constraintStreamFilter.png" alt="constraintStreamFilter">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For performance reasons, using the <a href="#constraintStreamsJoin">join</a> building block with the appropriate <code>Joiner</code> is
preferrable when possible.
Using a <code>Joiner</code> creates only the constraint matches that are necessary, while filtered join creates all possible
constraint matches and only then filters some of them out.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following functions are required for filtering constraint streams of different cardinality:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cardinality</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Filtering Predicate</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.function.Predicate&lt;A&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.function.BiPredicate&lt;A, B&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.optaplanner.core.api.function.TriPredicate&lt;A, B, C&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.optaplanner.core.api.function.QuadPredicate&lt;A, B, C, D&gt;</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="constraintStreamsJoin"><a class="anchor" href="#constraintStreamsJoin"></a><a class="link" href="#constraintStreamsJoin">6.4.3. Joining</a></h4>
<div class="paragraph">
<p>Joining is a way to increase <a href="#constraintStreamsCardinality">stream cardinality</a> and it is similar to the inner join
operation in SQL. As the following figure illustrates, a join creates a cartesian product of the streams being joined:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ConstraintStreams/constraintStreamJoinWithoutJoiners.png" alt="constraintStreamJoinWithoutJoiners">
</div>
</div>
<div class="paragraph">
<p>Doing this is inefficient because the resulting stream might contain constraint matches that are of no interest to your
constraint.
Use <code>Joiner</code> to restrict your joins only to the matches you are actually interested in, as shown in this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    import static org.optaplanner.core.api.score.stream.Joiners.*;

    ...

    private Constraint shiftOnDayOff(ConstraintFactory constraintFactory) {
        return constraintFactory.from(Shift.class)
                .join(DayOff.class,
                    equal(Shift::getDate, DayOff::getDate),
                    equal(Shift::getEmployee, DayOff::getEmployee))
                .penalize("Shift on an off-day",
                        HardSoftScore.ONE_HARD);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following figure illustrates the behavior:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ConstraintStreams/constraintStreamJoinWithJoiners.png" alt="constraintStreamJoinWithJoiners">
</div>
</div>
<div class="paragraph">
<p>The following <code>Joiner</code> types are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>equal</code> for joining constraint matches where they <code>equals()</code> one another.</p>
</li>
<li>
<p><code>greaterThan</code>, <code>greaterThanOrEqual</code>, <code>lessThan</code> and <code>lessThanOrEqual</code> for joining <code>Comparable</code> constraint matches per
the prescribed ordering.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For a full list of all supported <code>Joiner</code> implementations and their various overloads, refer to the
<code>org.optaplanner.core.api.score.stream.Joiners</code> class.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the other stream might match multiple times, but it must only impact the score once (for each element of the original
stream), use <a href="#constraintStreamsConditionalPropagation">ifExists</a> instead.
It does not create cartesian products and therefore generally performs better.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="constraintStreamsGroupingAndCollectors"><a class="anchor" href="#constraintStreamsGroupingAndCollectors"></a><a class="link" href="#constraintStreamsGroupingAndCollectors">6.4.4. Grouping and collectors</a></h4>
<div class="paragraph">
<p>Grouping collects items in a stream according to user-provider criteria (also called "group key"), similar to what a
<code>GROUP BY</code> SQL clause does. Additionally, some grouping operations also accept one or more <code>Collector</code> instances, which
provide various aggregation functions. The following figure illustrates a simple <code>groupBy()</code> operation:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ConstraintStreams/constraintStreamGroupBy.png" alt="constraintStreamGroupBy">
</div>
</div>
<div class="paragraph">
<p>For example, the following code snippet first groups all processes by the computer they run on, sums up all the power
required by the processes on that computer using the <code>ConstraintCollectors.sum(&#8230;&#8203;)</code> collector, and finally penalizes
every computer whose processes consume more power than is available.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    import static org.optaplanner.core.api.score.stream.ConstraintCollectors.*;

    ...

    private Constraint requiredCpuPowerTotal(ConstraintFactory constraintFactory) {
        return constraintFactory.from(CloudProcess.class)
                .groupBy(CloudProcess::getComputer, sum(CloudProcess::getRequiredCpuPower))
                .filter((computer, requiredCpuPower) -&gt; requiredCpuPower &gt; computer.getCpuPower())
                .penalize("requiredCpuPowerTotal",
                        HardSoftScore.ONE_HARD,
                        (computer, requiredCpuPower) -&gt; requiredCpuPower - computer.getCpuPower());
    }</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Information might be lost during grouping.
In the previous example, <code>filter()</code> and all subsequent operations no longer have direct access to the original
<code>CloudProcess</code> instance.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are several collectors available out of the box. You can also provide your own collectors by implementing the
<code>org.optaplanner.core.api.score.stream.uni.UniConstraintCollector</code> interface, or its <code>Bi&#8230;&#8203;</code>, <code>Tri&#8230;&#8203;</code> counterparts.</p>
</div>
<div class="sect4">
<h5 id="_out_of_the_box_collectors"><a class="anchor" href="#_out_of_the_box_collectors"></a><a class="link" href="#_out_of_the_box_collectors">Out-of-the-box collectors</a></h5>
<div class="paragraph">
<p>The following section focuses on the collector implementations provided out of the box. This section only describes the
<code>int</code>-based variants of the collectors in detail. Many of the collectors also provide variants for other applicable
result data types, such as <code>long</code>, <code>BigDecimal</code> or <code>Duration</code>. You can find a complete list by exploring the
<code>org.optaplanner.core.api.score.stream.ConstraintCollectors</code> class.</p>
</div>
<div class="sect5">
<h6 id="_collecting_count"><a class="anchor" href="#_collecting_count"></a><a class="link" href="#_collecting_count">Collecting <code>count()</code></a></h6>
<div class="paragraph">
<p>The <code>ConstraintCollectors.count(&#8230;&#8203;)</code> counts all elements in a group. For example, the following use of the collector
gives a number of items for two separate groups - one where the talks have unavailable speakers, and one where they
don&#8217;t.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    private Constraint speakerAvailability(ConstraintFactory factory) {
        return factory.from(Talk.class)
                .groupBy(Talk::hasAnyUnavailableSpeaker, count())
                .penalize("speakerAvailability",
                        HardSoftScore.ONE_HARD,
                        (hasUnavailableSpeaker, count) -&gt; ...);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The return value for this collector is a 32-bit signed integer (<code>int</code>). There is also a 64-bit variant, <code>countLong()</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_collecting_countdistinct"><a class="anchor" href="#_collecting_countdistinct"></a><a class="link" href="#_collecting_countdistinct">Collecting <code>countDistinct()</code></a></h6>
<div class="paragraph">
<p>The <code>ConstraintCollectors.countDistinct(&#8230;&#8203;)</code> counts any element in a group once, regardless of how many times it
occurs. For example, the following use of the collector gives a number of talks in each unique room.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    private Constraint roomCount(ConstraintFactory factory) {
        return factory.from(Talk.class)
                .groupBy(Talk::getRoom, countDistinct())
                .penalize("roomCount",
                        HardSoftScore.ONE_SOFT,
                        (room, count) -&gt; ...);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The return value for this collector is a 32-bit signed integer (<code>int</code>). There is also a 64-bit variant, <code>countLong()</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_collecting_sum"><a class="anchor" href="#_collecting_sum"></a><a class="link" href="#_collecting_sum">Collecting <code>sum()</code></a></h6>
<div class="paragraph">
<p>To sum the values of a particular property of all elements in the group, use the <code>ConstraintCollectors.sum(&#8230;&#8203;)</code>
collector. The following code snippet first groups all processes by the computer they run on and sums up all the power
required by the processes on that computer using the <code>ConstraintCollectors.sum(&#8230;&#8203;)</code> collector.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    private Constraint requiredCpuPowerTotal(ConstraintFactory constraintFactory) {
        return constraintFactory.from(CloudProcess.class)
                .groupBy(CloudProcess::getComputer, sum(CloudProcess::getRequiredCpuPower))
                .penalize("requiredCpuPowerTotal",
                        HardSoftScore.ONE_SOFT,
                        (computer, requiredCpuPower) -&gt; requiredCpuPower);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The return value for this collector is a 32-bit signed integer (<code>int</code>). There are also the following variants:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>64-bit variant <code>sumLong()</code></p>
</li>
<li>
<p><code>java.math.BigDecimal</code>-based variant <code>sumBigDecimal()</code></p>
</li>
<li>
<p><code>java.math.BigInteger</code>-based variant <code>sumBigInteger()</code></p>
</li>
<li>
<p><code>java.time.Duration</code>-based variant <code>sumDuration()</code></p>
</li>
<li>
<p><code>java.time.Period</code>-based variant <code>sumPeriod()</code></p>
</li>
<li>
<p>generic <code>sum()</code> variant for summing up custom types.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_minimums_and_maximums"><a class="anchor" href="#_minimums_and_maximums"></a><a class="link" href="#_minimums_and_maximums">Minimums and maximums</a></h6>
<div class="paragraph">
<p>To extract the minimum or maximum of a group, use the <code>ConstraintCollectors.min(&#8230;&#8203;)</code> and
<code>ConstraintCollectors.max(&#8230;&#8203;)</code> collectors respectively.</p>
</div>
<div class="paragraph">
<p>These collectors operate on values of properties which are <code>Comparable</code> (such as <code>Integer</code>, <code>String</code> or <code>Duration</code>),
although there are also variants of these collectors which allow you to provide your own <code>Comparator</code>.</p>
</div>
<div class="paragraph">
<p>The following example finds a computer which runs the most power-demanding process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    private Constraint computerWithBiggestProcess(ConstraintFactory constraintFactory) {
        return constraintFactory.from(CloudProcess.class)
                .groupBy(CloudProcess::getComputer, max(CloudProcess::getRequiredCpuPower))
                .penalize("computerWithBiggestProcess",
                        HardSoftScore.ONE_HARD,
                        (computer, biggestProcess) -&gt; ...);
    }</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>Comparator</code> and <code>Comparable</code> implementations used with <code>min(&#8230;&#8203;)</code> and <code>max(&#8230;&#8203;)</code> constraint collectors are expected to
be consistent with <code>equals(&#8230;&#8203;)</code>.
See <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Comparable.html">Javadoc for <code>Comparable</code></a> to learn more.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_collection_collectors"><a class="anchor" href="#_collection_collectors"></a><a class="link" href="#_collection_collectors">Collection collectors</a></h6>
<div class="paragraph">
<p>To extract all elements in the group into a collection, use the <code>ConstraintCollectors.toList(&#8230;&#8203;)</code> and
<code>ConstraintCollectors.toSet(&#8230;&#8203;)</code> collectors respectively.
<code>ConstraintCollectors.toCollection(&#8230;&#8203;)</code> enables you to use a custom <code>Collection</code> implementation.</p>
</div>
<div class="paragraph">
<p>The following example retrieves all processes running on a computer in a <code>List</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    private Constraint computerWithBiggestProcess(ConstraintFactory constraintFactory) {
        return constraintFactory.from(CloudProcess.class)
                .groupBy(CloudProcess::getComputer, toList())
                .penalize("computerAndItsProcesses",
                        HardSoftScore.ONE_HARD,
                        (computer, processList) -&gt; ...);
    }</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The iteration order of elements in the resulting collection is not guaranteed to be stable.
To achieve stable iteration order, use <code>ConstraintCollectors.toCollection()</code> together with a sorted collection, such as <code>TreeSet</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="constraintStreamsConditionalPropagation"><a class="anchor" href="#constraintStreamsConditionalPropagation"></a><a class="link" href="#constraintStreamsConditionalPropagation">6.4.5. Conditional propagation</a></h4>
<div class="paragraph">
<p>Conditional propagation enables you to exclude constraint matches from the constraint stream based on the presence or
absence of some other object.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ConstraintStreams/constraintStreamIfExists.png" alt="constraintStreamIfExists">
</div>
</div>
<div class="paragraph">
<p>The following example penalizes computers which have at least one process running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    private Constraint runningComputer(ConstraintFactory constraintFactory) {
        return constraintFactory.from(CloudComputer.class)
                .ifExists(CloudProcess.class, Joiners.equal(Function.identity(), CloudProcess::getComputer))
                .penalize("runningComputer",
                        HardSoftScore.ONE_SOFT,
                        computer -&gt; ...);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the use of the <code>ifExists()</code> building block.
On <code>UniConstraintStream</code>, the <code>ifExistsOther()</code> building block is also available which is useful in situations where the
<code>from()</code> constraint match type is the same as the <code>ifExists()</code> type.</p>
</div>
<div class="paragraph">
<p>Conversely, if the <code>ifNotExists()</code> building block is used (as well as the <code>ifNotExistsOther()</code> building block on
<code>UniConstraintStream</code>) you can achieve the opposite affect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    private Constraint unusedComputer(ConstraintFactory constraintFactory) {
        return constraintFactory.from(CloudComputer.class)
                .ifNotExists(CloudProcess.class, Joiners.equal(Function.identity(), CloudProcess::getComputer))
                .penalize("unusedComputer",
                        HardSoftScore.ONE_HARD,
                        computer -&gt; ...);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, only the computers without processes running are penalized.</p>
</div>
<div class="paragraph">
<p>Also note the use of the <code>Joiner</code> class to limit the constraint matches.
For a description of available joiners, see <a href="#constraintStreamsJoin">joining</a>.
Conditional propagation operates much like joining, with the exception of not increasing the
<a href="#constraintStreamsCardinality">stream cardinality</a>.
Matches from these building blocks are not available further down the stream.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For performance reasons, using conditional propagation with the appropriate <code>Joiner</code> instance is preferable to joining.
While using <code>join()</code> creates a cartesian product of the facts being joined, with conditional propagation, the resulting
stream only has at most the original number of constraint matches in it.
Joining should only be used in cases where the other fact is actually required for another operation further down
the stream.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="constraintStreamsTesting"><a class="anchor" href="#constraintStreamsTesting"></a><a class="link" href="#constraintStreamsTesting">6.5. Testing a constraint stream</a></h3>
<div class="paragraph">
<p>Constraint streams include the Constraint Verifier unit testing harness.
To use it, first add a test scoped dependency to the <code>optaplanner-test</code> JAR.</p>
</div>
</div>
<div class="sect2">
<h3 id="constraintStreamsTestingIsolatedConstraints"><a class="anchor" href="#constraintStreamsTestingIsolatedConstraints"></a><a class="link" href="#constraintStreamsTestingIsolatedConstraints">6.6. Testing constraints in isolation</a></h3>
<div class="paragraph">
<p>Consider the following constraint stream:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    protected Constraint horizontalConflict(ConstraintFactory factory) {
        return factory
                .fromUniquePair(Queen.class, equal(Queen::getRowIndex))
                .penalize("Horizontal conflict", SimpleScore.ONE);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example uses the Constraint Verifier API to create a simple unit test for the preceding constraint stream:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    private ConstraintVerifier&lt;NQueensConstraintProvider, NQueens&gt; constraintVerifier
            = ConstraintVerifier.build(new NQueensConstraintProvider(), NQueens.class, Queen.class);

    @Test
    public void horizontalConflictWithTwoQueens() {
        Row row1 = new Row(0);
        Column column1 = new Column(0);
        Column column2 = new Column(1);
        Queen queen1 = new Queen(0, row1, column1);
        Queen queen2 = new Queen(1, row1, column2);
        constraintVerifier.verifyThat(NQueensConstraintProvider::horizontalConflict)
                .given(queen1, queen2)
                .penalizesBy(1);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>This test ensures that the horizontal conflict constraint assigns a penalty of <code>1</code> when there are two queens on the same
row.
The following line creates a shared <code>ConstraintVerifier</code> instance and initializes the instance with the
<code>NQueensConstraintProvider</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    private ConstraintVerifier&lt;NQueensConstraintProvider, NQueens&gt; constraintVerifier
            = ConstraintVerifier.build(new NQueensConstraintProvider(), NQueens.class, Queen.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Test</code> annotation indicates that the method is a unit test in a testing framework of your choice.
Constraint Verifier works with many testing frameworks including JUnit and AssertJ.</p>
</div>
<div class="paragraph">
<p>The first part of the test prepares the test data.
In this case, the test data includes two instances of the <code>Queen</code> planning entity and their dependencies
(<code>Row</code>, <code>Column</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">        Row row1 = new Row(0);
        Column column1 = new Column(0);
        Column column2 = new Column(1);
        Queen queen1 = new Queen(0, row1, column1);
        Queen queen2 = new Queen(1, row1, column2);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Further down, the following code test the constraint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    constraintVerifier.verifyThat(NQueensConstraintProvider::horizontalConflict)
            .given(queen1, queen2)
            .penalizesBy(1);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>verifyThat(&#8230;&#8203;)</code> call is used to specify a method on the <code>NQueensConstraintProvider</code> class which is under test.
This method must be visible to the test class, which the Java compiler will enforce.</p>
</div>
<div class="paragraph">
<p>The <code>given(&#8230;&#8203;)</code> call is used to enumerate all the facts that the constraint stream will operate on.
In this case, the <code>given(&#8230;&#8203;)</code> call takes the <code>queen1</code> and <code>queen2</code> instances previously created.
Alternatively, you can use a <code>givenSolution(&#8230;&#8203;)</code> method here and provide a planning solution instead.</p>
</div>
<div class="paragraph">
<p>Finally, the <code>penalizesBy(&#8230;&#8203;)</code> call completes the test, making sure that the horizontal conflict constraint, given
one <code>Queen</code>, results in a penalty of <code>1</code>.
This number is a product of multiplying the match weight, as defined in the constraint stream, by the number of matches.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can use a <code>rewardsWith(&#8230;&#8203;)</code> call to check for rewards instead of penalties.
The method to use here depends on whether the constraint stream in question is terminated with a <code>penalize</code> or a
<code>reward</code> building block.</p>
</div>
<div class="sect3">
<h4 id="constraintStreamsTestingAllConstraints"><a class="anchor" href="#constraintStreamsTestingAllConstraints"></a><a class="link" href="#constraintStreamsTestingAllConstraints">6.6.1. Testing all constraints together</a></h4>
<div class="paragraph">
<p>In addition to testing individual constraints, you can test the entire <code>ConstraintProvider</code> instance.
Consider the following test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @Test
    public void givenFactsMultipleConstraints() {
        Queen queen1 = new Queen(0, row1, column1);
        Queen queen2 = new Queen(1, row2, column2);
        Queen queen3 = new Queen(2, row3, column3);
        constraintVerifier.verifyThat()
                .given(queen1, queen2, queen3)
                .scores(SimpleScore.of(-3));
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are only two notable differences to the previous example.
First, the <code>verifyThat()</code> call takes no argument here, signifying that the entire <code>ConstraintProvider</code> instance is
being tested.
Second, instead of either a <code>penalizesBy()</code> or <code>rewardsWith()</code> call, the <code>scores(&#8230;&#8203;)</code> method is used.
This runs the <code>ConstraintProvider</code> on the given facts and returns a sum of `Score`s of all constraint matches resulting
from the given facts.</p>
</div>
<div class="paragraph">
<p>Using this method, you ensure that the constraint provider does not miss any constraints and that the scoring function
remains consistent as your code base evolves.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="constraintStreamsImplementations"><a class="anchor" href="#constraintStreamsImplementations"></a><a class="link" href="#constraintStreamsImplementations">6.7. Variant implementation types</a></h3>
<div class="paragraph">
<p>Constraint streams come in two flavors, a default implementation using Drools under the hood and a pure Java-based
implementation called <em>Bavet</em>.
The Drools-based implementation is more feature-complete.
Both of these variants implement the same <code>ConstraintProvider</code> API.
No Java code changes are necessary to switch between the two.</p>
</div>
<div class="paragraph">
<p>Bavet is an experimental implementation that focuses on raw speed and provides superior performance.
However, it lacks features and therefore many of the <a href="#examplesOverview">examples</a> are not supported.
To try it out, implement the <code>ConstraintProvider</code> interface and use the following in your solver config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;solver&gt;
      &lt;scoreDirectorFactory&gt;
        &lt;constraintStreamImplType&gt;BAVET&lt;/constraintStreamImplType&gt;
        &lt;constraintProviderClass&gt;com.example.MyConstraintProvider&lt;/constraintProviderClass&gt;
      &lt;/scoreDirectorFactory&gt;
      ...
    &lt;/solver&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="droolsScoreCalculation"><a class="anchor" href="#droolsScoreCalculation"></a><a class="link" href="#droolsScoreCalculation">7. Drools score calculation</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="droolsScoreCalculationOverview"><a class="anchor" href="#droolsScoreCalculationOverview"></a><a class="link" href="#droolsScoreCalculationOverview">7.1. Overview</a></h3>
<div class="paragraph">
<p>Implement your score calculation using the Drools rule engine.
Every score constraint is written as one or more score rules.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Advantages:</p>
<div class="ulist">
<ul>
<li>
<p>Incremental score calculation for free</p>
<div class="ulist">
<ul>
<li>
<p>Because most DRL syntax uses forward chaining, it does incremental calculation without any extra code</p>
</li>
</ul>
</div>
</li>
<li>
<p>Score constraints are isolated as separate rules</p>
<div class="ulist">
<ul>
<li>
<p>Easy to add or edit existing score rules</p>
</li>
</ul>
</div>
</li>
<li>
<p>Flexibility to augment your score constraints by</p>
<div class="ulist">
<ul>
<li>
<p>Defining them in decision tables</p>
<div class="ulist">
<ul>
<li>
<p>Excel (XLS) spreadsheet</p>
</li>
<li>
<p>KIE Workbench WebUI</p>
</li>
</ul>
</div>
</li>
<li>
<p>Translate them into natural language with DSL</p>
</li>
<li>
<p>Store and release in the KIE Workbench repository</p>
</li>
</ul>
</div>
</li>
<li>
<p>Performance optimizations in future versions for free</p>
<div class="ulist">
<ul>
<li>
<p>In every release, the Drools rule engine tends to become faster</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Disadvantages:</p>
<div class="ulist">
<ul>
<li>
<p>DRL learning curve</p>
</li>
<li>
<p>Usage of DRL</p>
<div class="ulist">
<ul>
<li>
<p>Polyglot fear can prohibit the use of a new language such as DRL in some organizations</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="droolsScoreRulesConfiguration"><a class="anchor" href="#droolsScoreRulesConfiguration"></a><a class="link" href="#droolsScoreRulesConfiguration">7.2. Drools score rules configuration</a></h3>
<div class="paragraph">
<p>There are several ways to define where your score rules live.</p>
</div>
<div class="sect3">
<h4 id="droolsScoreCalculationScoreDrl"><a class="anchor" href="#droolsScoreCalculationScoreDrl"></a><a class="link" href="#droolsScoreCalculationScoreDrl">7.2.1. A <code>scoreDrl</code> resource on the classpath</a></h4>
<div class="paragraph">
<p>This is the easy way.
The score rules live in a DRL file which is provided as a classpath resource.
Just add the score rules DRL file in the solver configuration as a <code>&lt;scoreDrl&gt;</code> element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDrl&gt;org/optaplanner/examples/nqueens/solver/nQueensConstraints.drl&lt;/scoreDrl&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a typical project (following the Maven directory structure), that DRL file would be located at <code>$PROJECT_DIR/src/main/resources/org/optaplanner/examples/nqueens/solver/nQueensConstraints.drl</code> (even for a war project).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>&lt;scoreDrl&gt;</code> element expects a classpath resource, as defined by <code>ClassLoader.getResource(String)</code>, it does not accept a <code>File</code>, nor a URL, nor a webapp resource.
See below to use a <code>File</code> instead.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add multiple <code>&lt;scoreDrl&gt;</code> elements if the score rules are split across multiple DRL files.</p>
</div>
<div class="paragraph">
<p>Optionally, you can also set drools configuration properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDrl&gt;org/optaplanner/examples/nqueens/solver/nQueensConstraints.drl&lt;/scoreDrl&gt;
    &lt;kieBaseConfigurationProperties&gt;
      &lt;drools.equalityBehavior&gt;...&lt;/drools.equalityBehavior&gt;
    &lt;/kieBaseConfigurationProperties&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable property reactive by default, without a <code>@propertyReactive</code> on the domain classes,
add <code>&lt;drools.propertySpecific&gt;ALWAYS&lt;/drools.propertySpecific&gt;</code> in there.
Otherwise OptaPlanner automatically changes the Drools default to <code>ALLOWED</code> so property reactive is not active by default.</p>
</div>
</div>
<div class="sect3">
<h4 id="droolsScoreCalculationScoreDrlFile"><a class="anchor" href="#droolsScoreCalculationScoreDrlFile"></a><a class="link" href="#droolsScoreCalculationScoreDrlFile">7.2.2. A <code>scoreDrlFile</code> element</a></h4>
<div class="paragraph">
<p>To use <code>File</code> on the local file system, instead of a classpath resource, add the score rules DRL file in the solver configuration as a <code>&lt;scoreDrlFile&gt;</code> element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDrlFile&gt;/home/ge0ffrey/tmp/nQueensConstraints.drl&lt;/scoreDrlFile&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For portability reasons, a classpath resource is recommended over a File.
An application build on one computer, but used on another computer, might not find the file on the same location.
Worse, if they use a different Operating System, it is hard to choose a portable file path.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add multiple <code>&lt;scoreDrlFile&gt;</code> elements if the score rules are split across multiple DRL files.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="implementingAScoreRule"><a class="anchor" href="#implementingAScoreRule"></a><a class="link" href="#implementingAScoreRule">7.3. Implementing a score rule</a></h3>
<div class="paragraph">
<p>Here is an example of a score constraint implemented as a score rule in a DRL file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">rule "Horizontal conflict"
    when
        Queen($id : id, row != null, $i : rowIndex)
        Queen(id &gt; $id, rowIndex == $i)
    then
        scoreHolder.addConstraintMatch(kcontext, -1);
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>This score rule will fire once for every two queens with the same <code>rowIndex</code>.
The <code>(id &gt; $id)</code> condition is needed to assure that for two queens A and B, it can only fire for (A, B) and not for (B, A), (A, A) or (B, B). Let us take a closer look at this score rule on this solution of four queens:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./DroolsScoreCalculation/unsolvedNQueens04.png" alt="unsolvedNQueens04">
</div>
</div>
<div class="paragraph">
<p>In this solution the <code>Horizontal conflict</code> score rule will fire for six queen couples: (A, B), (A, C), (A, D), (B, C), (B, D) and (C, D). Because none of the queens are on the same vertical or diagonal line, this solution will have a score of <code>-6</code>.
An optimal solution of four queens has a score of <code>0</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Notice that every score rule uses at least one planning entity class
(directly or indirectly through a logically inserted fact).</p>
</div>
<div class="paragraph">
<p>It is a waste of time to write a score rule that only relates to problem facts,
as the consequence will never change during planning, no matter what the possible solution.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A <code>ScoreHolder</code> instance is asserted into the <code>KieSession</code> as a global called <code>scoreHolder</code>.
The score rules need to (directly or indirectly) update that instance to influence the score of a solution state.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>kcontext</code> variable is a magic variable in Drools Expert.
The <code>scoreHolder</code>'s method uses it to do incremental score calculation correctly and to create a <code>ConstraintMatch</code> instance.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="weighingScoreRules"><a class="anchor" href="#weighingScoreRules"></a><a class="link" href="#weighingScoreRules">7.4. Weighing score rules</a></h3>
<div class="paragraph">
<p>If you&#8217;ve configured a <a href="#constraintConfiguration">constraint configuration</a>,
the score level and score weight of each constraint are beautifully decoupled from the constraint implementation,
so they can be changed by the business users more easily.</p>
</div>
<div class="paragraph">
<p>In that case, use the <code>reward()</code> and <code>penalize()</code> methods of the <code>ScoreHolder</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">package org.optaplanner.examples.nqueens.solver;
...
global SimpleScoreHolder scoreHolder;

rule "Horizontal conflict"
    when
        Queen($id : id, row != null, $i : rowIndex)
        Queen(id &gt; $id, rowIndex == $i)
    then
        scoreHolder.penalize(kcontext);
end

// Vertical conflict is impossible due the model

rule "Ascending diagonal conflict"
    when
        Queen($id : id, row != null, $i : ascendingDiagonalIndex)
        Queen(id &gt; $id, ascendingDiagonalIndex == $i)
    then
        scoreHolder.penalize(kcontext);
end

rule "Descending diagonal conflict"
    when
        Queen($id : id, row != null, $i : descendingDiagonalIndex)
        Queen(id &gt; $id, descendingDiagonalIndex == $i)
    then
        scoreHolder.penalize(kcontext);
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>They automatically impact the score for each constraint match
by the score weight defined in the <a href="#constraintConfiguration">constraint configuration</a>.</p>
</div>
<div class="paragraph">
<p>The drl file must define a <code>package</code> (otherwise Drools defaults to <code>defaultpkg</code>)
and it must match with the <a href="#constraintConfiguration">constraint configuration</a>'s <code>constraintPackage</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To learn more about the Drools rule language (DRL),
consult <a href="https://drools.org/learn/documentation.html">the Drools documentation</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The score weight of some constraints depends on the constraint match.
In these cases, provide a match weight to the <code>reward()</code> or <code>penalize()</code> methods.
The score impact is the constraint weight multiplied with the match weight.</p>
</div>
<div class="paragraph">
<p>For example in conference scheduling, the impact of a content conflict,
depends on the number of shared content tags between 2 overlapping talks:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">rule "Content conflict"
    when
        $talk1 : Talk(...)
        $talk2 : Talk(...)
    then
        scoreHolder.penalize(kcontext,
                $talk2.overlappingContentCount($talk1));
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Presume its constraint weight is set to <code>100soft</code>.
So when 2 overlapping talks share only 1 content tag, the score is impacted by <code>-100soft</code>.
But when 2 overlapping talks share 3 content tags, the match weight is <code>3</code>, so the score is impacted by <code>-300soft</code>.</p>
</div>
<div class="paragraph">
<p>If there is no <a href="#constraintConfiguration">constraint configuration</a>,
you&#8217;ll need to hard-code the weight in the constraint implementations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">global HardSoftScoreHolder scoreHolder;

// RoomCapacity: For each lecture, the number of students that attend the course must be less or equal
// than the number of seats of all the rooms that host its lectures.
rule "roomCapacity"
    when
        $room : Room($capacity : capacity)
        $lecture : Lecture(room == $room, studentSize &gt; $capacity, $studentSize : studentSize)
    then
        // Each student above the capacity counts as one point of penalty.
        scoreHolder.addSoftConstraintMatch(kcontext, ($capacity - $studentSize));
end

// CurriculumCompactness: Lectures belonging to a curriculum should be adjacent
// to each other (i.e., in consecutive periods).
// For a given curriculum we account for a violation every time there is one lecture not adjacent
// to any other lecture within the same day.
rule "curriculumCompactness"
    when
        ...
    then
        // Each isolated lecture in a curriculum counts as two points of penalty.
        scoreHolder.addSoftConstraintMatch(kcontext, -2);
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice how <code>addSoftConstraintMatch()</code> specifies that it&#8217;s a soft constraint,
and needs a negative number to penalize each match. Otherwise it would reward such matches.
The parameter <code>($capacity - $studentSize)</code> always results in a negative number because <code>studentSize &gt; $capacity</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="testingDroolsConstraints"><a class="anchor" href="#testingDroolsConstraints"></a><a class="link" href="#testingDroolsConstraints">7.5. Testing Drools-based constraints</a></h3>
<div class="paragraph">
<p>Drools-based constraints come with a unit testing harness.
To use it, first add a test scoped dependency to the <code>optaplanner-test</code> jar to take advantage of the JUnit integration
and use the <code>ScoreVerifier</code> classes to test score rules in DRL (or a constraint match aware incremental score calculator).
For example, suppose you want to test these score rules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">global HardSoftScoreHolder scoreHolder;

rule "requiredCpuPowerTotal"
    when
        ...
    then
        scoreHolder.addHardConstraintMatch(...);
end

...

rule "computerCost"
    when
        ...
    then
        scoreHolder.addSoftConstraintMatch(...);
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>For each score rule, create a separate <code>@Test</code> that only tests the effect of that score rule on the score:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class CloudBalancingScoreConstraintTest {

    private HardSoftScoreVerifier&lt;CloudBalance&gt; scoreVerifier = new HardSoftScoreVerifier&lt;&gt;(
            SolverFactory.createFromXmlResource(
                    "org/optaplanner/examples/cloudbalancing/solver/cloudBalancingSolverConfig.xml"));

    @Test
    public void requiredCpuPowerTotal() {
        CloudComputer c1 = new CloudComputer(1L, 1000, 1, 1, 1);
        CloudComputer c2 = new CloudComputer(2L, 200, 1, 1, 1);
        CloudProcess p1 = new CloudProcess(1L, 700, 0, 0);
        CloudProcess p2 = new CloudProcess(2L, 70, 0, 0);
        CloudBalance solution = new CloudBalance(0L,
                Arrays.asList(c1, c2),
                Arrays.asList(p1, p2));
        // Uninitialized
        scoreVerifier.assertHardWeight("requiredCpuPowerTotal", 0, solution);
        p1.setComputer(c1);
        p2.setComputer(c1);
        // Usage 700 + 70 is within capacity 1000 of c1
        scoreVerifier.assertHardWeight("requiredCpuPowerTotal", 0, solution);
        p1.setComputer(c2);
        p2.setComputer(c2);
        // Usage 700 + 70 is above capacity 200 of c2
        scoreVerifier.assertHardWeight("requiredCpuPowerTotal", -570, solution);
    }

    ...

    @Test
    public void computerCost() {
        CloudComputer c1 = new CloudComputer(1L, 1, 1, 1, 200);
        CloudComputer c2 = new CloudComputer(2L, 1, 1, 1, 30);
        CloudProcess p1 = new CloudProcess(1L, 0, 0, 0);
        CloudProcess p2 = new CloudProcess(2L, 0, 0, 0);
        CloudBalance solution = new CloudBalance(0L,
                Arrays.asList(c1, c2),
                Arrays.asList(p1, p2));
        // Uninitialized
        scoreVerifier.assertSoftWeight("computerCost", 0, solution);
        p1.setComputer(c1);
        p2.setComputer(c1);
        // Pay 200 for c1
        scoreVerifier.assertSoftWeight("computerCost", -200, solution);
        p2.setComputer(c2);
        // Pay 200 + 30 for c1 and c2
        scoreVerifier.assertSoftWeight("computerCost", -230, solution);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is a <code>ScoreVerifier</code> implementation for each <code>Score</code> implementation.
In the <code>assertHardWeight()</code> and <code>assertSoftWeight()</code> methods, the weight of the other score rules is ignored (even those of the same score level).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A ScoreVerifier does not work well to isolate score corruption,
use <a href="#invalidScoreDetection">an <code>assertionScoreDirectorFactory</code></a> instead.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="shadowVariable"><a class="anchor" href="#shadowVariable"></a><a class="link" href="#shadowVariable">8. Shadow variable</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="shadowVariableIntroduction"><a class="anchor" href="#shadowVariableIntroduction"></a><a class="link" href="#shadowVariableIntroduction">8.1. Introduction</a></h3>
<div class="paragraph">
<p>A shadow variable is a planning variable whose correct value can be deduced from the state of the <a href="#planningVariable">genuine planning variables</a>.
Even though such a variable violates the principle of normalization by definition, in some use cases it can be very practical to use a shadow variable, especially to express the constraints more naturally.
For example in vehicle routing with time windows: the arrival time at a customer for a vehicle can be calculated based on the previously visited customers of that vehicle (and the known travel times between two locations).</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ShadowVariable/planningVariableListener.png" alt="planningVariableListener">
</div>
</div>
<div class="paragraph">
<p>When the customers for a vehicle change, the arrival time for each customer is automatically adjusted.
For more information, see the <a href="#vehicleRoutingDomainModel">vehicle routing domain model</a>.</p>
</div>
<div class="paragraph">
<p>From a score calculation perspective, a shadow variable is like any other planning variable.
From an optimization perspective, OptaPlanner effectively only optimizes the genuine variables (and mostly ignores the shadow variables): it just assures that when a genuine variable changes, any dependent shadow variables are changed accordingly.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Any class that has at least one shadow variable, is a planning entity class (even if it has no genuine planning variables).
That class must be defined in the solver configuration and have a <code>@PlanningEntity</code> annotation.</strong></p>
</div>
<div class="paragraph">
<p>A genuine planning entity class has at least one genuine planning variable, but can have shadow variables too.
A shadow planning entity class has no genuine planning variables and at least one shadow planning variable.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are several built-in shadow variables:</p>
</div>
</div>
<div class="sect2">
<h3 id="bidirectionalVariable"><a class="anchor" href="#bidirectionalVariable"></a><a class="link" href="#bidirectionalVariable">8.2. Bi-directional variable (inverse relation shadow variable)</a></h3>
<div class="paragraph">
<p>Two variables are bi-directional if their instances always point to each other (unless one side points to <code>null</code> and the other side does not exist).
So if A references B, then B references A.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ShadowVariable/bidirectionalVariable.png" alt="bidirectionalVariable">
</div>
</div>
<div class="paragraph">
<p>For a non-chained planning variable, the bi-directional relationship must be a many to one relationship.
To map a bi-directional relationship between two planning variables, annotate the master side (which is the genuine side) as a normal planning variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningEntity
public class CloudProcess {

    @PlanningVariable(...)
    public CloudComputer getComputer() {
        return computer;
    }
    public void setComputer(CloudComputer computer) {...}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then annotate the other side (which is the shadow side) with a <code>@InverseRelationShadowVariable</code> annotation on a <code>Collection</code> (usually a <code>Set</code> or <code>List</code>) property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningEntity
public class CloudComputer {

    @InverseRelationShadowVariable(sourceVariableName = "computer")
    public List&lt;CloudProcess&gt; getProcessList() {
        return processList;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#shadowVariableIntroduction">Register this class as a planning entity</a>,
otherwise OptaPlanner won&#8217;t detect it and the shadow variable won&#8217;t update.
The <code>sourceVariableName</code> property is the name of the genuine planning variable on the return type of the getter
(so the name of the genuine planning variable on the <em>other</em> side).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The shadow property, which is <code>Collection</code> (usually <code>List</code>, <code>Set</code> or <code>SortedSet</code>), can never be <code>null</code>.
If no genuine variable references that shadow entity, then it is an empty collection.
Furthermore it must be a mutable <code>Collection</code> because once OptaPlanner starts initializing or changing genuine planning variables,
it will add and remove elements to the <code>Collection</code>s of those shadow variables accordingly.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For a chained planning variable, the bi-directional relationship is always a one to one relationship.
In that case, the genuine side looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningEntity
public class Customer ... {

    @PlanningVariable(graphType = PlanningVariableGraphType.CHAINED, ...)
    public Standstill getPreviousStandstill() {
        return previousStandstill;
    }
    public void setPreviousStandstill(Standstill previousStandstill) {...}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the shadow side looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningEntity
public class Standstill {

    @InverseRelationShadowVariable(sourceVariableName = "previousStandstill")
    public Customer getNextCustomer() {
         return nextCustomer;
    }
    public void setNextCustomer(Customer nextCustomer) {...}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#shadowVariableIntroduction">Register this class as a planning entity</a>,
otherwise OptaPlanner won&#8217;t detect it and the shadow variable won&#8217;t update.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The input planning problem of a <code>Solver</code> must not violate bi-directional relationships.
If A points to B, then B must point to A.
OptaPlanner will not violate that principle during planning, but the input must not violate it either.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="anchorShadowVariable"><a class="anchor" href="#anchorShadowVariable"></a><a class="link" href="#anchorShadowVariable">8.3. Anchor shadow variable</a></h3>
<div class="paragraph">
<p>An anchor shadow variable is the anchor of <a href="#chainedPlanningVariable">a chained variable</a>.</p>
</div>
<div class="paragraph">
<p>Annotate the anchor property as a <code>@AnchorShadowVariable</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningEntity
public class Customer {

    @AnchorShadowVariable(sourceVariableName = "previousStandstill")
    public Vehicle getVehicle() {...}
    public void setVehicle(Vehicle vehicle) {...}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#shadowVariableIntroduction">This class should already be registered as a planning entity.</a>
The <code>sourceVariableName</code> property is the name of the chained variable on the same entity class.</p>
</div>
</div>
<div class="sect2">
<h3 id="customVariableListener"><a class="anchor" href="#customVariableListener"></a><a class="link" href="#customVariableListener">8.4. Custom <code>VariableListener</code></a></h3>
<div class="paragraph">
<p>To update a shadow variable, OptaPlanner uses a <code>VariableListener</code>.
To define a custom shadow variable, write a custom <code>VariableListener</code>:
implement the interface and annotate it on the shadow variable that needs to change.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @PlanningVariable(...)
    public Standstill getPreviousStandstill() {
        return previousStandstill;
    }

    @CustomShadowVariable(variableListenerClass = VehicleUpdatingVariableListener.class,
            sources = {@PlanningVariableReference(variableName = "previousStandstill")})
    public Vehicle getVehicle() {
        return vehicle;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#shadowVariableIntroduction">Register this class as a planning entity</a> if it isn&#8217;t already.
Otherwise OptaPlanner won&#8217;t detect it and the shadow variable won&#8217;t update.</p>
</div>
<div class="paragraph">
<p>The source&#8217;s <code>variableName</code> is the (genuine or shadow) variable that triggers changes to this shadow variable.
If the source variable&#8217;s class is different than the shadow variable&#8217;s class,
also specify the <code>entityClass</code> in the <code>@PlanningVariableReference</code> annotation
and make sure the shadow variable&#8217;s class is <a href="#shadowVariableIntroduction">registered as a planning entity</a>.</p>
</div>
<div class="paragraph">
<p>Implement the <code>VariableListener</code> interface.
For example, the <code>VehicleUpdatingVariableListener</code> assures that every <code>Customer</code> in a chain has the same <code>Vehicle</code>, namely the chain&#8217;s anchor.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class VehicleUpdatingVariableListener implements VariableListener&lt;Customer&gt; {

    public void afterEntityAdded(ScoreDirector scoreDirector, Customer customer) {
        updateVehicle(scoreDirector, customer);
    }

    public void afterVariableChanged(ScoreDirector scoreDirector, Customer customer) {
        updateVehicle(scoreDirector, customer);
    }

    ...

    protected void updateVehicle(ScoreDirector scoreDirector, Customer sourceCustomer) {
        Standstill previousStandstill = sourceCustomer.getPreviousStandstill();
        Vehicle vehicle = previousStandstill == null ? null : previousStandstill.getVehicle();
        Customer shadowCustomer = sourceCustomer;
        while (shadowCustomer != null &amp;&amp; shadowCustomer.getVehicle() != vehicle) {
            scoreDirector.beforeVariableChanged(shadowCustomer, "vehicle");
            shadowCustomer.setVehicle(vehicle);
            scoreDirector.afterVariableChanged(shadowCustomer, "vehicle");
            shadowCustomer = shadowCustomer.getNextCustomer();
        }
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A <code>VariableListener</code> can only change shadow variables.
It must never change a genuine planning variable or a problem fact.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Any change of a shadow variable must be told to the <code>ScoreDirector</code> with <code>before*()</code> and <code>after*()</code> methods.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If one <code>VariableListener</code> changes two shadow variables (because having two separate <code>VariableListener</code>s would be inefficient), then annotate only the first shadow variable with the <code>variableListenerClass</code> and let the other shadow variable(s) reference the first shadow variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @PlanningVariable(...)
    public Standstill getPreviousStandstill() {
        return previousStandstill;
    }

    @CustomShadowVariable(variableListenerClass = TransportTimeAndCapacityUpdatingVariableListener.class,
            sources = {@PlanningVariableReference(variableName = "previousStandstill")})
    public Integer getTransportTime() {
        return transportTime;
    }

    @CustomShadowVariable(variableListenerRef = @PlanningVariableReference(variableName = "transportTime"))
    public Integer getCapacity() {
        return capacity;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>A shadow variable&#8217;s value (just like a genuine variable&#8217;s value)
isn&#8217;t <a href="#cloningASolution">planning cloned</a> by the default solution cloner,
unless it can easily prove that it must be planning cloned (for example the property type is a planning entity class).
Specifically shadow variables of type <code>List</code>, <code>Set</code>, <code>Collection</code> or <code>Map</code> usually need to be planning cloned
to avoid corrupting the best solution when the working solution changes.
To planning clone a shadow variable, add <code>@DeepPlanningClone</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @DeepPlanningClone
    @CustomShadowVariable(...)
    private Map&lt;LocalDateTime, Integer&gt; usedManHoursPerDayMap;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="variableListenerTriggeringOrder"><a class="anchor" href="#variableListenerTriggeringOrder"></a><a class="link" href="#variableListenerTriggeringOrder">8.5. VariableListener triggering order</a></h3>
<div class="paragraph">
<p>All shadow variables are triggered by a <code>VariableListener</code>, regardless if it&#8217;s a built-in or a custom shadow variable.
The genuine and shadow variables form a graph, that determines the order in which the <code>afterEntityAdded()</code>, <code>afterVariableChanged()</code> and <code>afterEntityRemoved()</code> methods are called:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ShadowVariable/shadowVariableOrder.png" alt="shadowVariableOrder">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In the example above, D could have also been ordered after E (or F) because there is no direct or indirect dependency between D and E (or F).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>OptaPlanner guarantees that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The first <code>VariableListener</code>'s <code>after*()</code> methods trigger <em>after</em> the last genuine variable has changed. Therefore the genuine variables (A and B in the example above) are guaranteed to be in a consistent state across all its instances (with values A1, A2 and B1 in the example above) because the entire <code>Move</code> has been applied.</p>
</li>
<li>
<p>The second <code>VariableListener</code>'s <code>after*()</code> methods trigger <em>after</em> the last first shadow variable has changed. Therefore the first shadow variable (C in the example above) are guaranteed to be in a consistent state across all its instances (with values C1 and C2 in the example above). And of course the genuine variables too.</p>
</li>
<li>
<p>And so forth.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>OptaPlanner does not guarantee the order in which the <code>after*()</code> methods are called for the <em>same</em><code>VariableListener</code> with different parameters (such as A1 and A2 in the example above), although they are likely to be in the order in which they were affected.</p>
</div>
<div class="paragraph">
<p>By default, OptaPlanner does not guarantee that the events are unique.
For example, if a shadow variable on an entity is changed twice in the same move (for example by two different genuine variables), then that will cause the same event twice on the <code>VariableListener</code>s that are listening to that original shadow variable.
To avoid dealing with that complexity, overwrite the method <code>requiresUniqueEntityEvents()</code> to receive unique events at the cost of a small performance penalty:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class StartTimeUpdatingVariableListener implements VariableListener&lt;Task&gt; {

    @Override
    public boolean requiresUniqueEntityEvents() {
        return true;
    }

    ...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="optimizationAlgorithms"><a class="anchor" href="#optimizationAlgorithms"></a><a class="link" href="#optimizationAlgorithms">9. Optimization algorithms</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="searchSpaceSize"><a class="anchor" href="#searchSpaceSize"></a><a class="link" href="#searchSpaceSize">9.1. Search space size in the real world</a></h3>
<div class="paragraph">
<p>The number of possible solutions for a planning problem can be mind blowing.
For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Four queens has <code>256</code> possible solutions (<code>4^4</code>) and two optimal solutions.</p>
</li>
<li>
<p>Five queens has <code>3125</code> possible solutions (<code>5^5</code>) and one optimal solution.</p>
</li>
<li>
<p>Eight queens has <code>16777216</code> possible solutions (<code>8^8</code>) and 92 optimal solutions.</p>
</li>
<li>
<p>64 queens has more than <code>10^115</code> possible solutions (<code>64^64</code>).</p>
</li>
<li>
<p>Most real-life planning problems have an incredible number of possible solutions and only one or a few optimal solutions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For comparison: the minimal number of atoms in the known universe (10^80). As a planning problem gets bigger, the search space tends to blow up really fast.
Adding only one extra planning entity or planning value can heavily multiply the running time of some algorithms.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./OptimizationAlgorithms/cloudBalanceSearchSpaceSize.png" alt="cloudBalanceSearchSpaceSize">
</div>
</div>
<div class="paragraph">
<p>Calculating the number of possible solutions depends on the design of the domain model:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./OptimizationAlgorithms/searchSpaceSizeCalculation.png" alt="searchSpaceSizeCalculation">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This search space size calculation includes infeasible solutions (if they can be represented by the model), because:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The optimal solution might be infeasible.</p>
</li>
<li>
<p>There are many types of hard constraints that cannot be incorporated in the formula practically. For example, in Cloud Balancing, try incorporating the CPU capacity constraint in the formula.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Even in cases where adding some of the hard constraints in the formula is practical (for example, Course Scheduling), the resulting search space is still huge.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An algorithm that checks every possible solution (even with pruning, such as in <a href="#branchAndBound">Branch And Bound</a>) can easily run for billions of years on a single real-life planning problem.
The aim is to find the best solution in the available timeframe.
Planning competitions (such as the International Timetabling Competition) show that Local Search variations
(<a href="#tabuSearch">Tabu Search</a>, <a href="#simulatedAnnealing">Simulated Annealing</a>, <a href="#lateAcceptance">Late Acceptance</a>, &#8230;&#8203;)
usually perform best for real-world problems given real-world time limitations.</p>
</div>
</div>
<div class="sect2">
<h3 id="doesPlannerFindTheOptimalSolution"><a class="anchor" href="#doesPlannerFindTheOptimalSolution"></a><a class="link" href="#doesPlannerFindTheOptimalSolution">9.2. Does OptaPlanner find the optimal solution?</a></h3>
<div class="paragraph">
<p>The business wants the optimal solution, but they also have other requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Scale out: Large production data sets must not crash and have also good results.</p>
</li>
<li>
<p>Optimize the right problem: The constraints must match the actual business needs.</p>
</li>
<li>
<p>Available time: The solution must be found in time, before it becomes useless to execute.</p>
</li>
<li>
<p>Reliability: Every data set must have at least a decent result (better than a human planner).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Given these requirements, and despite the promises of some salesmen, it is usually impossible for anyone or anything to find the optimal solution.
Therefore, OptaPlanner focuses on finding the best solution in available time.
In <a href="#examplesOverview">"realistic, independent competitions"</a>, it often comes out as the best <em>reusable</em> software.</p>
</div>
<div class="paragraph">
<p>The nature of NP-complete problems make scaling a prime concern.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The quality of a result from a small data set is no indication of the quality of a result from a large data set.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Scaling issues cannot be mitigated by hardware purchases later on.
Start testing with a production sized data set as soon as possible.
Do not assess quality on small data sets (unless production encounters only such data sets). Instead, solve a production sized data set and compare the results of longer executions, different algorithms and - if available - the human planner.</p>
</div>
</div>
<div class="sect2">
<h3 id="architectureOverview"><a class="anchor" href="#architectureOverview"></a><a class="link" href="#architectureOverview">9.3. Architecture overview</a></h3>
<div class="paragraph">
<p>OptaPlanner is the first framework to combine optimization algorithms (metaheuristics, &#8230;&#8203;) with score calculation by a rule engine (such as Drools Expert). This combination is very efficient, because:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A rule engine, such as Drools Expert, is <strong>great for calculating the score</strong> of a solution of a planning problem. It makes it easy and scalable to add additional soft or hard constraints such as, "a teacher should not teach more than seven hours a day". It does delta-based score calculation without any extra code. However it tends to be not suitable to actually find new solutions.</p>
</li>
<li>
<p>An optimization algorithm is <strong>great at finding new improving solutions</strong> for a planning problem, without necessarily brute-forcing every possibility. However, it needs to know the score of a solution and offers no support in calculating that score efficiently.</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./OptimizationAlgorithms/architectureOverview.png" alt="architectureOverview">
</div>
</div>
</div>
<div class="sect2">
<h3 id="optimizationAlgorithmsOverview"><a class="anchor" href="#optimizationAlgorithmsOverview"></a><a class="link" href="#optimizationAlgorithmsOverview">9.4. Optimization algorithms overview</a></h3>
<div class="paragraph">
<p>OptaPlanner supports three <em>families</em> of optimization algorithms: Exhaustive Search, Construction Heuristics and Metaheuristics.
In practice, Metaheuristics (in combination with Construction Heuristics to initialize) are the recommended choice:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./OptimizationAlgorithms/scalabilityOfOptimizationAlgorithms.png" alt="scalabilityOfOptimizationAlgorithms">
</div>
</div>
<div class="paragraph">
<p>Each of these algorithm families have multiple optimization algorithms:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Optimization Algorithms Overview</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Algorithm</th>
<th class="tableblock halign-left valign-top">Scalable?</th>
<th class="tableblock halign-left valign-top">Optimal?</th>
<th class="tableblock halign-left valign-top">Easy to use?</th>
<th class="tableblock halign-left valign-top">Tweakable?</th>
<th class="tableblock halign-left valign-top">Requires CH?</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" colspan="6"><p class="tableblock"><strong>Exhaustive Search (ES)</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">  <a href="#bruteForce">Brute Force</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">  <a href="#branchAndBound">Branch And Bound</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="6"><p class="tableblock"><strong>Construction heuristics (CH)</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">  <a href="#firstFit">First Fit</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">  <a href="#firstFitDecreasing">First Fit Decreasing</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">  <a href="#weakestFit">Weakest Fit</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">  <a href="#weakestFitDecreasing">Weakest Fit Decreasing</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">  <a href="#strongestFit">Strongest Fit</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">  <a href="#strongestFitDecreasing">Strongest Fit Decreasing</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">  <a href="#cheapestInsertion">Cheapest Insertion</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">  <a href="#regretInsertion">Regret Insertion</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="6"><p class="tableblock"><strong>Metaheuristics (MH)</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="6"><p class="tableblock">  Local Search (LS)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">    <a href="#hillClimbing">Hill Climbing</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">    <a href="#tabuSearch">Tabu Search</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">    <a href="#simulatedAnnealing">Simulated Annealing</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">    <a href="#lateAcceptance">Late Acceptance</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">    <a href="#greatDeluge">Great Deluge</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">    <a href="#stepCountingHillClimbing">Step Counting Hill Climbing</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">    <a href="#variableNeighborhoodDescent">Variable Neighborhood Descent</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="6"><p class="tableblock">  Evolutionary Algorithms (EA)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">    <a href="#evolutionaryStrategies">Evolutionary Strategies</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">    <a href="#geneticAlgorithms">Genetic Algorithms</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5/5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To learn more about metaheuristics, see  <a href="http://www.cs.gmu.edu/~sean/book/metaheuristics/">Essentials of Metaheuristics</a> or <a href="http://www.cleveralgorithms.com/">Clever Algorithms</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="whichOptimizationAlgorithmsShouldIUse"><a class="anchor" href="#whichOptimizationAlgorithmsShouldIUse"></a><a class="link" href="#whichOptimizationAlgorithmsShouldIUse">9.5. Which optimization algorithms should I use?</a></h3>
<div class="paragraph">
<p>The best optimization algorithms configuration to use depends heavily on your use case.
However, this basic procedure provides a good starting configuration that will produce better than average results.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start with a quick configuration that involves little or no configuration and optimization code:
See <a href="#firstFit">First Fit</a>.</p>
</li>
<li>
<p>Next, implement <a href="#planningEntityDifficulty">planning entity difficulty</a> comparison and turn it into <a href="#firstFitDecreasing">First Fit Decreasing</a>.</p>
</li>
<li>
<p>Next, add Late Acceptance behind it:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>First Fit Decreasing.</p>
</li>
<li>
<p><a href="#lateAcceptance">Late Acceptance</a>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>At this point, the return on invested time lowers and the result is likely to be sufficient.</p>
</div>
<div class="paragraph">
<p>However, this can be improved at a lower return on invested time.
Use the <a href="#benchmarker">Benchmarker</a> and try a couple of different Tabu Search, Simulated Annealing and Late Acceptance configurations, for example:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First Fit Decreasing: <a href="#tabuSearch">Tabu Search</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Use the <a href="#benchmarker">Benchmarker</a> to improve the values for the size parameters.</p>
</div>
<div class="paragraph">
<p>Other experiments can also be run. For example, the following multiple algorithms can be combined together:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First Fit Decreasing</p>
</li>
<li>
<p>Late Acceptance (relatively long time)</p>
</li>
<li>
<p>Tabu Search (relatively short time)</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="powerTweaking"><a class="anchor" href="#powerTweaking"></a><a class="link" href="#powerTweaking">9.6. Power tweaking or default parameter values</a></h3>
<div class="paragraph">
<p>Many optimization algorithms have parameters that affect results and scalability.
OptaPlanner applies <em>configuration by exception</em>, so all optimization algorithms have default parameter values.
This is very similar to the Garbage Collection parameters in a JVM: most users have no need to tweak them, but power users often do.</p>
</div>
<div class="paragraph">
<p>The default parameter values are sufficient for many cases (and especially for prototypes), but if development time allows, it may be beneficial to power tweak them with the <a href="#benchmarker">benchmarker</a> for better results and scalability on a specific use case.
The documentation for each optimization algorithm also declares the advanced configuration for power tweaking.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The default value of parameters will change between minor versions, to improve them for most users. The advanced configuration can be used to prevent unwanted changes, however, this is not recommended.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="solverPhase"><a class="anchor" href="#solverPhase"></a><a class="link" href="#solverPhase">9.7. Solver phase</a></h3>
<div class="paragraph">
<p>A <code>Solver</code> can use multiple optimization algorithms in sequence.
<strong>Each optimization algorithm is represented by one solver <code>Phase</code>.</strong>
There is never more than one <code>Phase</code> solving at the same time.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some <code>Phase</code> implementations can combine techniques from multiple optimization algorithms, but it is still just one <code>Phase</code>.
For example: a Local Search <code>Phase</code> can do Simulated Annealing with entity Tabu.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is a configuration that runs three phases in sequence:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;solver&gt;
  ...
  &lt;constructionHeuristic&gt;
    ... &lt;!-- First phase: First Fit Decreasing --&gt;
  &lt;/constructionHeuristic&gt;
  &lt;localSearch&gt;
    ... &lt;!-- Second phase: Late Acceptance --&gt;
  &lt;/localSearch&gt;
  &lt;localSearch&gt;
    ... &lt;!-- Third phase: Tabu Search --&gt;
  &lt;/localSearch&gt;
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The solver phases are run in the order defined by solver configuration.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When the first <code>Phase</code> terminates, the second <code>Phase</code> starts, and so on.</p>
</li>
<li>
<p>When the last <code>Phase</code> terminates, the <code>Solver</code> terminates.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Usually, a <code>Solver</code> will first run a construction heuristic and then run one or multiple metaheuristics:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./OptimizationAlgorithms/generalPhaseSequence.png" alt="generalPhaseSequence">
</div>
</div>
<div class="paragraph">
<p>If no phases are configured, OptaPlanner will default to a Construction Heuristic phase followed by a Local Search phase.</p>
</div>
<div class="paragraph">
<p>Some phases (especially construction heuristics) will terminate automatically.
Other phases (especially metaheuristics) will only terminate if the <code>Phase</code> is configured to terminate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;solver&gt;
  ...
  &lt;termination&gt;&lt;!-- Solver termination --&gt;
    &lt;secondsSpentLimit&gt;90&lt;/secondsSpentLimit&gt;
  &lt;/termination&gt;
  &lt;localSearch&gt;
    &lt;termination&gt;&lt;!-- Phase termination --&gt;
      &lt;secondsSpentLimit&gt;60&lt;/secondsSpentLimit&gt;&lt;!-- Give the next phase a chance to run too, before the Solver terminates --&gt;
    &lt;/termination&gt;
    ...
  &lt;/localSearch&gt;
  &lt;localSearch&gt;
    ...
  &lt;/localSearch&gt;
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>Solver</code> terminates (before the last <code>Phase</code> terminates itself),
the current phase is terminated and all subsequent phases will not run.</p>
</div>
</div>
<div class="sect2">
<h3 id="scopeOverview"><a class="anchor" href="#scopeOverview"></a><a class="link" href="#scopeOverview">9.8. Scope overview</a></h3>
<div class="paragraph">
<p>A solver will iteratively run phases. Each phase will usually iteratively run steps. Each step, in turn, usually iteratively runs moves.
These form four nested scopes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Solver</p>
</li>
<li>
<p>Phase</p>
</li>
<li>
<p>Step</p>
</li>
<li>
<p>Move</p>
</li>
</ol>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./OptimizationAlgorithms/scopeOverview.png" alt="scopeOverview">
</div>
</div>
<div class="paragraph">
<p>Configure <a href="#logging">logging</a> to display the log messages of each scope.</p>
</div>
</div>
<div class="sect2">
<h3 id="termination"><a class="anchor" href="#termination"></a><a class="link" href="#termination">9.9. Termination</a></h3>
<div class="paragraph">
<p>Not all phases terminate automatically and may take a significant amount of time.
A <code>Solver</code> can be terminated synchronously by up-front configuration, or asynchronously from another thread.</p>
</div>
<div class="paragraph">
<p>Metaheuristic phases in particular need to be instructed to stop solving.
This can be because of a number of reasons, for example, if the time is up, or the perfect score has been reached just before its solution is used.
Finding the optimal solution cannot be relied on (unless you know the optimal score), because a metaheuristic algorithm is generally unaware of the optimal solution.</p>
</div>
<div class="paragraph">
<p>This is not an issue for real-life problems, as finding the optimal solution may take more time than is available.
Finding the best solution in the available time is the most important outcome.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If no termination is configured (and a metaheuristic algorithm is used), the <code>Solver</code> will run forever, until <a href="#asynchronousTermination">terminateEarly()</a> is called from another thread.
This is especially common during <a href="#realTimePlanning">real-time planning</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For synchronous termination, configure a <code>Termination</code> on a <code>Solver</code> or a <code>Phase</code> when it needs to stop.
The built-in implementations of these should be sufficient,
but <a href="#customTerminationSelectorOrAcceptor">custom terminations</a> are supported too.
Every <code>Termination</code> can calculate a <em>time gradient</em> (needed for some optimization algorithms),
which is a ratio between the time already spent solving and the estimated entire solving time of the <code>Solver</code> or <code>Phase</code>.</p>
</div>
<div class="sect3">
<h4 id="timeMillisSpentTermination"><a class="anchor" href="#timeMillisSpentTermination"></a><a class="link" href="#timeMillisSpentTermination">9.9.1. Time spent termination</a></h4>
<div class="paragraph">
<p>Terminates when an amount of time has been used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;termination&gt;
    &lt;!-- 2 minutes and 30 seconds in ISO 8601 format P[n]Y[n]M[n]DT[n]H[n]M[n]S --&gt;
    &lt;spentLimit&gt;PT2M30S&lt;/spentLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively to a <code>java.util.Duration</code> in ISO 8601 format, you can also use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Milliseconds</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;termination&gt;
    &lt;millisecondsSpentLimit&gt;500&lt;/millisecondsSpentLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Seconds</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;termination&gt;
    &lt;secondsSpentLimit&gt;10&lt;/secondsSpentLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Minutes</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;termination&gt;
    &lt;minutesSpentLimit&gt;5&lt;/minutesSpentLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Hours</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;termination&gt;
    &lt;hoursSpentLimit&gt;1&lt;/hoursSpentLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Days</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;termination&gt;
    &lt;daysSpentLimit&gt;2&lt;/daysSpentLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Multiple time types can be used together, for example to configure 150 minutes, either configure it directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;termination&gt;
    &lt;minutesSpentLimit&gt;150&lt;/minutesSpentLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or use a combination that sums up to 150 minutes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;termination&gt;
    &lt;hoursSpentLimit&gt;2&lt;/hoursSpentLimit&gt;
    &lt;minutesSpentLimit&gt;30&lt;/minutesSpentLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This <code>Termination</code> will most likely sacrifice perfect reproducibility (even with <code>environmentMode</code> <code>REPRODUCIBLE</code>)
because the available CPU time differs frequently between runs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The available CPU time influences the number of steps that can be taken, which might be a few more or less.</p>
</li>
<li>
<p>The <code>Termination</code> might produce slightly different time gradient values,
which will send time gradient-based algorithms (such as Simulated Annealing) on a radically different path.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="unimprovedTimeMillisSpentTermination"><a class="anchor" href="#unimprovedTimeMillisSpentTermination"></a><a class="link" href="#unimprovedTimeMillisSpentTermination">9.9.2. Unimproved time spent termination</a></h4>
<div class="paragraph">
<p>Terminates when the best score has not improved in a specified amount of time.
Each time a new best solution is found, the timer basically resets.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    &lt;termination&gt;
      &lt;!-- 2 minutes and 30 seconds in ISO 8601 format P[n]Y[n]M[n]DT[n]H[n]M[n]S --&gt;
      &lt;unimprovedSpentLimit&gt;PT2M30S&lt;/unimprovedSpentLimit&gt;
    &lt;/termination&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively to a <code>java.util.Duration</code> in ISO 8601 format, you can also use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Milliseconds</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    &lt;termination&gt;
      &lt;unimprovedMillisecondsSpentLimit&gt;500&lt;/unimprovedMillisecondsSpentLimit&gt;
    &lt;/termination&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Seconds</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    &lt;termination&gt;
      &lt;unimprovedSecondsSpentLimit&gt;10&lt;/unimprovedSecondsSpentLimit&gt;
    &lt;/termination&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Minutes</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    &lt;termination&gt;
      &lt;unimprovedMinutesSpentLimit&gt;5&lt;/unimprovedMinutesSpentLimit&gt;
    &lt;/termination&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Hours</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    &lt;termination&gt;
      &lt;unimprovedHoursSpentLimit&gt;1&lt;/unimprovedHoursSpentLimit&gt;
    &lt;/termination&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Days</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    &lt;termination&gt;
      &lt;unimprovedDaysSpentLimit&gt;1&lt;/unimprovedDaysSpentLimit&gt;
    &lt;/termination&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Just like <a href="#timeMillisSpentTermination">time spent termination</a>, combinations are summed up.</p>
</div>
<div class="paragraph">
<p>This termination should not be applied to Construction Heuristics as they only update the best solution at the end.
Configuring it on a specific <code>Phase</code> (such as <code>&lt;localSearch&gt;</code>), instead of on the <code>Solver</code> itself is often a better option.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This <code>Termination</code> will most likely sacrifice perfect reproducibility (even with <code>environmentMode</code> <code>REPRODUCIBLE</code>)
as the available CPU time differs frequently between runs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The available CPU time influences the number of steps that can be taken, which might be a few more or less.</p>
</li>
<li>
<p>The <code>Termination</code> might produce slightly different time gradient values,
which will send time gradient based algorithms (such as Simulated Annealing) on a radically different path.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Optionally, configure a score difference threshold by which the best score must improve in the specified time.
For example, if the score doesn&#8217;t improve by at least <code>100</code> soft points every 30 seconds or less, it terminates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    &lt;termination&gt;
      &lt;unimprovedSecondsSpentLimit&gt;30&lt;/unimprovedSecondsSpentLimit&gt;
      &lt;unimprovedScoreDifferenceThreshold&gt;0hard/100soft&lt;/unimprovedScoreDifferenceThreshold&gt;
    &lt;/termination&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the score improves by 1 hard point and drops 900 soft points, it&#8217;s still meets the threshold,
because <code>1hard/-900soft</code> is larger than the threshold <code>0hard/100soft</code>.</p>
</div>
<div class="paragraph">
<p>On the other hand, a threshold of <code>1hard/0soft</code> is not met by any new best solution
that improves 1 hard point at the expense of 1 or more soft points,
because <code>1hard/-100soft</code> is smaller than the threshold <code>1hard/0soft</code>.</p>
</div>
<div class="paragraph">
<p>To require a feasibility improvement every 30 seconds while avoiding the pitfall above,
use a wildcard <code>*</code> for lower score levels that are allowed to deteriorate if a higher score level improves:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    &lt;termination&gt;
      &lt;unimprovedSecondsSpentLimit&gt;30&lt;/unimprovedSecondsSpentLimit&gt;
      &lt;unimprovedScoreDifferenceThreshold&gt;1hard/*soft&lt;/unimprovedScoreDifferenceThreshold&gt;
    &lt;/termination&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This effectively implies a threshold of <code>1hard/-2147483648soft</code>, because it relies on <code>Integer.MIN_VALUE</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="bestScoreTermination"><a class="anchor" href="#bestScoreTermination"></a><a class="link" href="#bestScoreTermination">9.9.3. <code>BestScoreTermination</code></a></h4>
<div class="paragraph">
<p><code>BestScoreTermination</code> terminates when a certain score has been reached.
Use this <code>Termination</code> where the perfect score is known, for example for four queens (which uses a <a href="#simpleScore">SimpleScore</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;termination&gt;
    &lt;bestScoreLimit&gt;0&lt;/bestScoreLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A planning problem with a <a href="#hardSoftScore">HardSoftScore</a> may look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;termination&gt;
    &lt;bestScoreLimit&gt;0hard/-5000soft&lt;/bestScoreLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A planning problem with a <a href="#bendableScore">BendableScore</a> with three hard levels and one soft level may look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;termination&gt;
    &lt;bestScoreLimit&gt;[0/0/0]hard/[-5000]soft&lt;/bestScoreLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this instance, <code>Termination</code> once a feasible solution has been reached is not practical because it requires a <code>bestScoreLimit</code> such as <code>0hard/-2147483648soft</code>. Use the next termination instead.</p>
</div>
</div>
<div class="sect3">
<h4 id="bestScoreFeasibleTermination"><a class="anchor" href="#bestScoreFeasibleTermination"></a><a class="link" href="#bestScoreFeasibleTermination">9.9.4. <code>BestScoreFeasibleTermination</code></a></h4>
<div class="paragraph">
<p>Terminates as soon as a feasible solution has been discovered.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;termination&gt;
    &lt;bestScoreFeasible&gt;true&lt;/bestScoreFeasible&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>Termination</code> is usually combined with other terminations.</p>
</div>
</div>
<div class="sect3">
<h4 id="stepCountTermination"><a class="anchor" href="#stepCountTermination"></a><a class="link" href="#stepCountTermination">9.9.5. <code>StepCountTermination</code></a></h4>
<div class="paragraph">
<p>Terminates when a number of steps has been reached.
This is useful for hardware performance independent runs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    &lt;termination&gt;
      &lt;stepCountLimit&gt;100&lt;/stepCountLimit&gt;
    &lt;/termination&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>Termination</code> can only be used for a <code>Phase</code> (such as <code>&lt;localSearch&gt;</code>), not for the <code>Solver</code> itself.</p>
</div>
</div>
<div class="sect3">
<h4 id="unimprovedStepCountTermination"><a class="anchor" href="#unimprovedStepCountTermination"></a><a class="link" href="#unimprovedStepCountTermination">9.9.6. <code>UnimprovedStepCountTermination</code></a></h4>
<div class="paragraph">
<p>Terminates when the best score has not improved in a number of steps.
This is useful for hardware performance independent runs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    &lt;termination&gt;
      &lt;unimprovedStepCountLimit&gt;100&lt;/unimprovedStepCountLimit&gt;
    &lt;/termination&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the score has not improved recently, it is unlikely to improve in a reasonable timeframe.
It has been observed that once a new best solution is found (even after a long time without improvement on the best solution), the next few steps tend to improve the best solution.</p>
</div>
<div class="paragraph">
<p>This <code>Termination</code> can only be used for a <code>Phase</code> (such as <code>&lt;localSearch&gt;</code>), not for the <code>Solver</code> itself.</p>
</div>
</div>
<div class="sect3">
<h4 id="scoreCalculationCountTermination"><a class="anchor" href="#scoreCalculationCountTermination"></a><a class="link" href="#scoreCalculationCountTermination">9.9.7. <code>ScoreCalculationCountTermination</code></a></h4>
<div class="paragraph">
<p><code>ScoreCalculationCountTermination</code> terminates when a number of score calculations have been reached.
This is often the sum of the number of moves and the number of steps.
This is useful for benchmarking.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;termination&gt;
    &lt;scoreCalculationCountLimit&gt;100000&lt;/scoreCalculationCountLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Switching <a href="#environmentMode">EnvironmentMode</a> can heavily impact when this termination ends.</p>
</div>
</div>
<div class="sect3">
<h4 id="combiningMultipleTerminations"><a class="anchor" href="#combiningMultipleTerminations"></a><a class="link" href="#combiningMultipleTerminations">9.9.8. Combining multiple terminations</a></h4>
<div class="paragraph">
<p>Terminations can be combined, for example: terminate after <code>100</code> steps or if a score of <code>0</code> has been reached:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;termination&gt;
    &lt;terminationCompositionStyle&gt;OR&lt;/terminationCompositionStyle&gt;
    &lt;stepCountLimit&gt;100&lt;/stepCountLimit&gt;
    &lt;bestScoreLimit&gt;0&lt;/bestScoreLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively you can use <code>AND</code>, for example: terminate after reaching a feasible score of at least <code>-100</code> and no improvements in <code>5</code> steps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;termination&gt;
    &lt;terminationCompositionStyle&gt;AND&lt;/terminationCompositionStyle&gt;
    &lt;unimprovedStepCountLimit&gt;5&lt;/unimprovedStepCountLimit&gt;
    &lt;bestScoreLimit&gt;-100&lt;/bestScoreLimit&gt;
  &lt;/termination&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example ensures it does not just terminate after finding a feasible solution, but also completes any obvious improvements on that solution before terminating.</p>
</div>
</div>
<div class="sect3">
<h4 id="asynchronousTermination"><a class="anchor" href="#asynchronousTermination"></a><a class="link" href="#asynchronousTermination">9.9.9. Asynchronous termination from another thread</a></h4>
<div class="paragraph">
<p>Asynchronous termination from another thread occurs when a <code>Solver</code> needs to be terminated early from another thread, for example, due to a user action or a server restart.
This cannot be configured by a <code>Termination</code> as it is impossible to predict when and if it will occur.
Therefore the <code>Solver</code> interface has the following thread-safe methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface Solver&lt;Solution_&gt; {
    ...

    boolean terminateEarly();
    boolean isTerminateEarly();

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When calling the <code>terminateEarly()</code> method from another thread, the <code>Solver</code> will terminate at its earliest convenience and the <code>solve(Solution)</code> method will return (in the original <code>Solver</code> thread).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Interrupting the Solver thread (which is the thread that called <code>Solver.solve(Solution)</code>) has the same effect as calling <code>terminateEarly()</code> except that it leaves that thread in the interrupted state.
This guarantees a graceful shutdown when an <code>ExecutorService</code> (such as a thread pool) is shutdown because that only interrupts all active threads in the pool.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="SolverEventListener"><a class="anchor" href="#SolverEventListener"></a><a class="link" href="#SolverEventListener">9.10. <code>SolverEventListener</code></a></h3>
<div class="paragraph">
<p>Each time a new best solution is found, a new <code>BestSolutionChangedEvent</code> is fired in the <code>Solver</code> thread.</p>
</div>
<div class="paragraph">
<p>To listen to such events, add a <code>SolverEventListener</code> to the <code>Solver</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface Solver&lt;Solution_&gt; {
    ...

    void addEventListener(SolverEventListener&lt;S&gt; eventListener);
    void removeEventListener(SolverEventListener&lt;S&gt; eventListener);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>BestSolutionChangedEvent</code>'s <code>newBestSolution</code> may not be initialized or feasible.
Use the <code>isFeasible()</code> method on <code>BestSolutionChangedEvent</code>'s new best <code>Score</code> to detect such cases:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    solver.addEventListener(new SolverEventListener&lt;CloudBalance&gt;() {
        public void bestSolutionChanged(BestSolutionChangedEvent&lt;CloudBalance&gt; event) {
            // Ignore infeasible (including uninitialized) solutions
            if (event.getNewBestSolution().getScore().isFeasible()) {
                ...
            }
        }
    });</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use <code>Score.isSolutionInitialized()</code> instead of <code>Score.isFeasible()</code> to only ignore uninitialized solutions, but also accept infeasible solutions.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>bestSolutionChanged()</code> method is called in the solver&#8217;s thread, as part of <code>Solver.solve()</code>.
So it should return quickly to avoid slowing down the solving.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="customSolverPhase"><a class="anchor" href="#customSolverPhase"></a><a class="link" href="#customSolverPhase">9.11. Custom solver phase</a></h3>
<div class="paragraph">
<p>Run a custom optimization algorithm between phases or before the first phase to initialize the solution, or to get a better score quickly.
You will still want to reuse the score calculation.
For example, to implement a custom Construction Heuristic without implementing an entire <code>Phase</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Most of the time, a custom solver phase is not worth the development time investment.
The supported <a href="#constructionHeuristics">Constructions Heuristics</a> are configurable (use the <a href="#benchmarker">Benchmarker</a> to tweak them),
<code>Termination</code> aware and support partially initialized solutions too.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>CustomPhaseCommand</code> interface appears as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface CustomPhaseCommand&lt;Solution_&gt; {
    ...

    void changeWorkingSolution(ScoreDirector&lt;Solution_&gt; scoreDirector);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, extend <code>AbstractCustomPhaseCommand</code> and implement the <code>changeWorkingSolution()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class ToOriginalMachineSolutionInitializer extends AbstractCustomPhaseCommand&lt;MachineReassignment&gt; {

    public void changeWorkingSolution(ScoreDirector&lt;MachineReassignment&gt; scoreDirector) {
        MachineReassignment machineReassignment = scoreDirector.getWorkingSolution();
        for (MrProcessAssignment processAssignment : machineReassignment.getProcessAssignmentList()) {
            scoreDirector.beforeVariableChanged(processAssignment, "machine");
            processAssignment.setMachine(processAssignment.getOriginalMachine());
            scoreDirector.afterVariableChanged(processAssignment, "machine");
            scoreDirector.triggerVariableListeners();
        }
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Any change on the planning entities in a <code>CustomPhaseCommand</code> must be notified to the <code>ScoreDirector</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not change any of the problem facts in a <code>CustomPhaseCommand</code>.
That will corrupt the <code>Solver</code> because any previous score or solution was for a different problem.
To do that, read about <a href="#repeatedPlanning">repeated planning</a> and do it with a <a href="#problemFactChange">ProblemFactChange</a> instead.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Configure the <code>CustomPhaseCommand</code> in the solver configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;solver&gt;
  ...
  &lt;customPhase&gt;
    &lt;customPhaseCommandClass&gt;org.optaplanner.examples.machinereassignment.solver.solution.initializer.ToOriginalMachineSolutionInitializer&lt;/customPhaseCommandClass&gt;
  &lt;/customPhase&gt;
  ... &lt;!-- Other phases --&gt;
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure multiple <code>customPhaseCommandClass</code> instances to run them in sequence.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the changes of a <code>CustomPhaseCommand</code> do not result in a better score, the best solution will not be changed
(so effectively nothing will have changed for the next <code>Phase</code> or <code>CustomPhaseCommand</code>).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the <code>Solver</code> or a <code>Phase</code> wants to terminate while a <code>CustomPhaseCommand</code> is still running,
it waits to terminate until the <code>CustomPhaseCommand</code> is complete.
This may take a significant amount of time.
The built-in solver phases do not have this issue.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To configure values of a <code>CustomPhaseCommand</code> dynamically in the solver configuration
(so the <a href="#benchmarker">Benchmarker</a> can tweak those parameters),
add the <code>customProperties</code> element and use <a href="#customPropertiesConfiguration">custom properties</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;customPhase&gt;
    &lt;customPhaseCommandClass&gt;...MyCustomPhase&lt;/customPhaseCommandClass&gt;
    &lt;customProperties&gt;
      &lt;mySelectionSize&gt;5&lt;/mySelectionSize&gt;
    &lt;/customProperties&gt;
  &lt;/customPhase&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="noChangeSolverPhase"><a class="anchor" href="#noChangeSolverPhase"></a><a class="link" href="#noChangeSolverPhase">9.12. No change solver phase</a></h3>
<div class="paragraph">
<p>In rare cases, it&#8217;s useful not to run any solver phases.
But by default, configuring no phase will trigger running the default phases.
To avoid those, configure a <code>NoChangePhase</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;solver&gt;
  ...
  &lt;noChangePhase/&gt;
&lt;/solver&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="multithreadedSolving"><a class="anchor" href="#multithreadedSolving"></a><a class="link" href="#multithreadedSolving">9.13. Multithreaded solving</a></h3>
<div class="paragraph">
<p>There are several ways of doing multithreaded solving:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Multitenancy</strong>: solve different datasets in parallel</p>
<div class="ulist">
<ul>
<li>
<p>The <code>SolverManager</code> will make it even easier to set this up, in a future version.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Multi bet solving</strong>: solve 1 dataset with multiple, isolated solvers and take the best result.</p>
<div class="ulist">
<ul>
<li>
<p>Not recommended: This is a marginal gain for a high cost of hardware resources.</p>
</li>
<li>
<p>Use the <a href="#benchmarker">Benchmarker</a> during development to determine the most appropriate algorithm, although that&#8217;s only on average.</p>
</li>
<li>
<p>Use multithreaded incremental solving instead.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Partitioned Search</strong>: Split 1 dataset in multiple parts and solve them independently.</p>
<div class="ulist">
<ul>
<li>
<p>Configure a <a href="#partitionedSearch">Partitioned Search</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Multithreaded incremental solving</strong>: solve 1 dataset with multiple threads without sacrificing <a href="#incrementalScoreCalculation">incremental score calculation</a>.</p>
<div class="ulist">
<ul>
<li>
<p>Donate a portion of your CPU cores to OptaPlanner to scale up the score calculation speed and get the same results in fraction of the time.</p>
</li>
<li>
<p>Configure <a href="#multithreadedIncrementalSolving">multithreaded incremental solving</a>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./OptimizationAlgorithms/multiThreadingStrategies.png" alt="multiThreadingStrategies">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A <a href="#logging">logging level</a> of <code>debug</code> or <code>trace</code> might cause congestion multithreaded solving
and slow down the <a href="#scoreCalculationSpeed">score calculation speed</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="planningId"><a class="anchor" href="#planningId"></a><a class="link" href="#planningId">9.13.1. <code>@PlanningId</code></a></h4>
<div class="paragraph">
<p>For some functionality (such as multithreaded solving and real-time planning),
OptaPlanner needs to map problem facts and planning entities to an ID.
OptaPlanner uses that ID to <em>rebase</em> a move from one thread&#8217;s solution state to another&#8217;s.</p>
</div>
<div class="paragraph">
<p>To enable such functionality, specify the <code>@PlanningId</code> annotation on the identification field or getter method,
for example on the database ID:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class CloudComputer {

    @PlanningId
    private Long id;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or alternatively, on another type of ID:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class User {

    @PlanningId
    private String username;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>@PlanningId</code> property must be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Unique for that specific class</p>
<div class="ulist">
<ul>
<li>
<p>It does not need to be unique across different problem fact classes
(unless in that rare case that those classes are mixed in the same value range or planning entity collection).</p>
</li>
</ul>
</div>
</li>
<li>
<p>An instance of a type that implements <code>Object.hashCode()</code> and <code>Object.equals()</code>.</p>
<div class="ulist">
<ul>
<li>
<p>It&#8217;s recommended to use the type <code>Integer</code>, <code>int</code>, <code>Long</code>, <code>long</code>, <code>String</code> or <code>UUID</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Never <code>null</code> by the time <code>Solver.solve()</code> is called.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="customThreadFactory"><a class="anchor" href="#customThreadFactory"></a><a class="link" href="#customThreadFactory">9.13.2. Custom thread factory (WildFly, Android, GAE, &#8230;&#8203;)</a></h4>
<div class="paragraph">
<p>The <code>threadFactoryClass</code> allows to plug in a custom <code>ThreadFactory</code> for environments
where arbitrary thread creation should be avoided,
such as most application servers (including WildFly), Android, or Google App Engine.</p>
</div>
<div class="paragraph">
<p>Configure the <code>ThreadFactory</code> on the solver to create the <a href="#multithreadedIncrementalSolving">move threads</a>
and the <a href="#partitionedSearch">Partition Search threads</a> with it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;solver&gt;
  &lt;threadFactoryClass&gt;...MyAppServerThreadFactory&lt;/threadFactoryClass&gt;
  ...
&lt;/solver&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="multithreadedIncrementalSolving"><a class="anchor" href="#multithreadedIncrementalSolving"></a><a class="link" href="#multithreadedIncrementalSolving">9.13.3. Multithreaded incremental solving</a></h4>
<div class="paragraph">
<p>Enable multithreaded incremental solving by <a href="#planningId">adding a @PlanningId annotation</a>
on every planning entity class and planning value class.
Then configure a <code>moveThreadCount</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;solver&gt;
  &lt;moveThreadCount&gt;AUTO&lt;/moveThreadCount&gt;
  ...
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>That one extra line heavily improves the score calculation speed,
presuming that your machine has enough free CPU cores.</p>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;solver&gt;
  &lt;moveThreadCount&gt;4&lt;/moveThreadCount&gt;
  &lt;moveThreadBufferSize&gt;10&lt;/moveThreadBufferSize&gt;
  &lt;threadFactoryClass&gt;...MyAppServerThreadFactory&lt;/threadFactoryClass&gt;
  ...
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>moveThreadCount</code> of <code>4</code> <a href="#sizingHardwareAndSoftware">saturates almost 5 CPU cores</a>:
the 4 move threads fill up 4 CPU cores completely
and the solver thread uses most of another CPU core.</p>
</div>
<div class="paragraph">
<p>The following <code>moveThreadCount</code>s are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>NONE</code> (default): Don&#8217;t run any move threads. Use the single threaded code.</p>
</li>
<li>
<p><code>AUTO</code>: Let OptaPlanner decide how many move threads to run in parallel.
On machines or containers with little or no CPUs, this falls back to the single threaded code.</p>
</li>
<li>
<p>Static number: The number of move threads to run in parallel.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;moveThreadCount&gt;4&lt;/moveThreadCount&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be <code>1</code> to enforce running the multithreaded code with only 1 move thread
(which is less efficient than <code>NONE</code>).</p>
</div>
</li>
<li>
<p>JavaScript formula: Formula for the number of move threads to run in parallel. It can use the variable <code>availableProcessorCount</code>. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;moveThreadCount&gt;(availableProcessorCount / 2) + 1&lt;/moveThreadCount&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is counter-effective to set a <code>moveThreadCount</code>
that is higher than the number of available CPU cores,
as that will slow down the score calculation speed.
One good reason to do it anyway, is to reproduce a bug of a high-end production machine.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Multithreaded solving is <em>still reproducible</em>, as long as the resolved <code>moveThreadCount</code> is stable.
A run of the same solver configuration on 2 machines with a different number of CPUs,
is still reproducible, unless the <code>moveThreadCount</code> is set to <code>AUTO</code> or a function of <code>availableProcessorCount</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>moveThreadBufferSize</code> power tweaks the number of moves that are selected but won&#8217;t be foraged.
Setting it too low reduces performance, but setting it too high too.
Unless you&#8217;re deeply familiar with the inner workings of multithreaded solving, don&#8217;t configure this parameter.</p>
</div>
<div class="paragraph">
<p>To run in an environment that doesn&#8217;t like arbitrary thread creation,
use <code>threadFactoryClass</code> to plug in a <a href="#customThreadFactory">custom thread factory</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="moveAndNeighborhoodSelection"><a class="anchor" href="#moveAndNeighborhoodSelection"></a><a class="link" href="#moveAndNeighborhoodSelection">10. Move and neighborhood selection</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="moveAndNeighborhoodSelectionIntroduction"><a class="anchor" href="#moveAndNeighborhoodSelectionIntroduction"></a><a class="link" href="#moveAndNeighborhoodSelectionIntroduction">10.1. Move and neighborhood introduction</a></h3>
<div class="sect3">
<h4 id="whatIsAMove"><a class="anchor" href="#whatIsAMove"></a><a class="link" href="#whatIsAMove">10.1.1. What is a <code>Move</code>?</a></h4>
<div class="paragraph">
<p>A <code>Move</code> is a change (or set of changes) from a solution A to a solution B.
For example, the move below changes queen <code>C</code> from row <code>0</code> to row <code>2</code>:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/singleMoveNQueens04.png" alt="singleMoveNQueens04">
</div>
</div>
<div class="paragraph">
<p>The new solution is called a <em>neighbor</em> of the original solution, because it can be reached in a single <code>Move</code>.
Although a single move can change multiple queens, the neighbors of a solution should always be a very small subset of all possible solutions.
For example, on that original solution, these are all possible <code>changeMove</code>s:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/possibleMovesNQueens04.png" alt="possibleMovesNQueens04">
</div>
</div>
<div class="paragraph">
<p>If we ignore the four <code>changeMove</code>s that have no impact and are therefore not doable, we can see that the number of moves is <code>n * (n - 1) = 12</code>.
This is far less than the number of possible solutions, which is <code>n ^ n = 256</code>.
As the problem scales out, the number of possible moves increases far less than the number of possible solutions.</p>
</div>
<div class="paragraph">
<p>Yet, in four <code>changeMove</code>s or less we can reach any solution.
For example we can reach a very different solution in three <code>changeMove</code>s:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/sequentialMovesNQueens04.png" alt="sequentialMovesNQueens04">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There are many other types of moves besides <code>changeMove</code>s.
Many move types are included out-of-the-box, but you can also implement custom moves.</p>
</div>
<div class="paragraph">
<p>A <code>Move</code> can affect multiple entities or even create/delete entities.
But it must not change the problem facts.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All optimization algorithms use <code>Move</code>s to transition from one solution to a neighbor solution.
Therefore, all the optimization algorithms are confronted with <code>Move</code> selection: the craft of creating and iterating moves efficiently and the art of finding the most promising subset of random moves to evaluate first.</p>
</div>
</div>
<div class="sect3">
<h4 id="whatIsAMoveSelector"><a class="anchor" href="#whatIsAMoveSelector"></a><a class="link" href="#whatIsAMoveSelector">10.1.2. What is a <code>MoveSelector</code>?</a></h4>
<div class="paragraph">
<p>A <code>MoveSelector</code>'s main function is to create <code>Iterator&lt;Move&gt;</code> when needed.
An optimization algorithm will iterate through a subset of those moves.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example how to configure a <code>changeMoveSelector</code> for the optimization algorithm Local Search:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    &lt;changeMoveSelector/&gt;
    ...
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Out of the box, this works and all properties of the <code>changeMoveSelector</code> are defaulted sensibly (unless that fails fast due to ambiguity). On the other hand, the configuration can be customized significantly for specific use cases.
For example: you might want to configure a <a href="#filteredSelection">filter</a> to discard pointless moves.</p>
</div>
</div>
<div class="sect3">
<h4 id="subselectingOfEntitiesValuesAndOtherMoves"><a class="anchor" href="#subselectingOfEntitiesValuesAndOtherMoves"></a><a class="link" href="#subselectingOfEntitiesValuesAndOtherMoves">10.1.3. Subselecting of entities, values, and other moves</a></h4>
<div class="paragraph">
<p>To create a <code>Move</code>, a <code>MoveSelector</code> needs to select one or more planning entities and/or planning values to move.
Just like <code>MoveSelector</code>s, <code>EntitySelector</code>s and <code>ValueSelector</code>s need to support a similar feature set (such as scalable just-in-time selection). Therefore, they all implement a common interface <code>Selector</code> and they are configured similarly.</p>
</div>
<div class="paragraph">
<p>A MoveSelector is often composed out of <code>EntitySelector</code>s, <code>ValueSelector</code>s or even other <code>MoveSelector</code>s, which can be configured individually if desired:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;unionMoveSelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;entitySelector&gt;
          ...
        &lt;/entitySelector&gt;
        &lt;valueSelector&gt;
          ...
        &lt;/valueSelector&gt;
        ...
      &lt;/changeMoveSelector&gt;
      &lt;swapMoveSelector&gt;
        ...
      &lt;/swapMoveSelector&gt;
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Together, this structure forms a <code>Selector</code> tree:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/selectorTree.png" alt="selectorTree">
</div>
</div>
<div class="paragraph">
<p>The root of this tree is a <code>MoveSelector</code> which is injected into the optimization algorithm implementation to be (partially) iterated in every step.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="genericMoveSelectors"><a class="anchor" href="#genericMoveSelectors"></a><a class="link" href="#genericMoveSelectors">10.2. Generic <code>MoveSelectors</code></a></h3>
<div class="sect3">
<h4 id="genericMoveSelectorsOverview"><a class="anchor" href="#genericMoveSelectorsOverview"></a><a class="link" href="#genericMoveSelectorsOverview">10.2.1. Generic <code>MoveSelectors</code> overview</a></h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top"><code>toString()</code> example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#changeMoveSelector">Change move</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Change 1 entity&#8217;s variable</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>Process-A {Computer-1 -&gt; Computer-2}</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#swapMoveSelector">Swap move</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Swap all variables of 2 entities</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>Process-A {Computer-1} &lt;-&gt; Process-B {Computer-2}</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#pillarChangeMoveSelector">Pillar change move</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Change a set of entities with the same value</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>[Process-A, Process-B, Process-C] {Computer-1 -&gt; Computer-2}</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#pillarSwapMoveSelector">Pillar swap move</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Swap 2 sets of entities with the same values</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>[Process-A, Process-B, Process-C] {Computer-1} &lt;-&gt; [Process-E, Process-F] {Computer-2}</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tailChainSwapMoveSelector">Tail chain swap move</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Swap 2 tails chains</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>Visit-A5 {Visit-A4} &lt;-tailChainSwap-&gt; Visit-B3 {Visit-B2}</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#subChainChangeMoveSelector">Sub chain change move</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Cut a subchain and paste it into another chain</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>[Visit-A5..Visit-A8] {Visit-A4 -&gt; Visit-B2}</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#subChainSwapMoveSelector">Sub chain swap move</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Swap 2 subchains</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>[Visit-A5..Visit-A8] {Visit-A4} &lt;-&gt; [Visit-B3..Visit-B9] {Visit-B2}</code></p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="changeMoveSelector"><a class="anchor" href="#changeMoveSelector"></a><a class="link" href="#changeMoveSelector">10.2.2. <code>ChangeMoveSelector</code></a></h4>
<div class="paragraph">
<p>For one planning variable, the <code>ChangeMove</code> selects one planning entity and one planning value and assigns the entity&#8217;s variable to that value.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/changeMove.png" alt="changeMove">
</div>
</div>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;changeMoveSelector/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If there are multiple entity classes or multiple planning variables for one entity class, a simple configuration will automatically unfold into a <a href="#unionMoveSelector">union</a> of <code>ChangeMove</code> selectors for every planning variable.</p>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;changeMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;entitySelector&gt;
        &lt;entityClass&gt;...Lecture&lt;/entityClass&gt;
        ...
      &lt;/entitySelector&gt;
      &lt;valueSelector variableName="room"&gt;
        ...
        &lt;nearbySelection&gt;...&lt;/nearbySelection&gt;
      &lt;/valueSelector&gt;
    &lt;/changeMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>ChangeMove</code> is the finest grained move.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Almost every <code>moveSelector</code> configuration injected into a metaheuristic algorithm should include a <code>changeMoveSelector</code>.
This guarantees that every possible solution can be reached in theory through applying a number of moves in sequence.
Of course, normally it is unioned with other, more coarse grained move selectors.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This move selector only supports <a href="#cacheType">phase or solver caching</a> if it doesn&#8217;t apply on a <a href="#chainedPlanningVariable">chained</a> variable.</p>
</div>
</div>
<div class="sect3">
<h4 id="swapMoveSelector"><a class="anchor" href="#swapMoveSelector"></a><a class="link" href="#swapMoveSelector">10.2.3. <code>SwapMoveSelector</code></a></h4>
<div class="paragraph">
<p>The <code>SwapMove</code> selects two different planning entities and swaps the planning values of all their planning variables.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/swapMove.png" alt="swapMove">
</div>
</div>
<div class="paragraph">
<p>Although a <code>SwapMove</code> on a single variable is essentially just two <code>ChangeMove</code>s,
it&#8217;s often the winning step in cases that the first of the two <code>ChangeMove</code>s would not win
because it leaves the solution in a state with broken hard constraints.
For example: swapping the room of two lectures doesn&#8217;t bring the solution in an intermediate state where both lectures are in the same room which breaks a hard constraint.</p>
</div>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;swapMoveSelector/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If there are multiple entity classes, a simple configuration will automatically unfold into a <a href="#unionMoveSelector">union</a> of <code>SwapMove</code> selectors for every entity class.</p>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;swapMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;entitySelector&gt;
        &lt;entityClass&gt;...Lecture&lt;/entityClass&gt;
        ...
      &lt;/entitySelector&gt;
      &lt;secondaryEntitySelector&gt;
        &lt;entityClass&gt;...Lecture&lt;/entityClass&gt;
        ...
        &lt;nearbySelection&gt;...&lt;/nearbySelection&gt;
      &lt;/secondaryEntitySelector&gt;
      &lt;variableNameInclude&gt;room&lt;/variableNameInclude&gt;
      &lt;variableNameInclude&gt;...&lt;/variableNameInclude&gt;
    &lt;/swapMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>secondaryEntitySelector</code> is rarely needed: if it is not specified, entities from the same <code>entitySelector</code> are swapped.</p>
</div>
<div class="paragraph">
<p>If one or more <code>variableNameInclude</code> properties are specified, not all planning variables will be swapped, but only those specified.
For example for course scheduling, specifying only <code>variableNameInclude</code> room will make it only swap room, not period.</p>
</div>
<div class="paragraph">
<p>This move selector only supports <a href="#cacheType">phase or solver caching</a> if it doesn&#8217;t apply on any <a href="#chainedPlanningVariable">chained</a> variables.</p>
</div>
</div>
<div class="sect3">
<h4 id="pillarMoveSelectors"><a class="anchor" href="#pillarMoveSelectors"></a><a class="link" href="#pillarMoveSelectors">10.2.4. Pillar-based move selectors</a></h4>
<div class="paragraph">
<p>A <em>pillar</em> is a set of planning entities which have the same planning value(s) for their planning variable(s).</p>
</div>
<div class="sect4">
<h5 id="pillarChangeMoveSelector"><a class="anchor" href="#pillarChangeMoveSelector"></a><a class="link" href="#pillarChangeMoveSelector">10.2.4.1. <code>PillarChangeMoveSelector</code></a></h5>
<div class="paragraph">
<p>The <code>PillarChangeMove</code> selects one entity pillar (or subset of those) and changes the value of one variable (which is the same for all entities) to another value.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/pillarChangeMove.png" alt="pillarChangeMove">
</div>
</div>
<div class="paragraph">
<p>In the example above, queen A and C have the same value (row 0) and are moved to row 2.
Also the yellow and blue process have the same value (computer Y) and are moved to computer X.</p>
</div>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;pillarChangeMoveSelector/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;pillarChangeMoveSelector&gt;
      &lt;subPillarType&gt;SEQUENCE&lt;/subPillarType&gt;
      &lt;subPillarSequenceComparatorClass&gt;org.optaplanner.examples.nurserostering.domain.ShiftAssignmentComparator&lt;/subPillarSequenceComparatorClass&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;pillarSelector&gt;
        &lt;entitySelector&gt;
          &lt;entityClass&gt;...ShiftAssignment&lt;/entityClass&gt;
          ...
        &lt;/entitySelector&gt;
        &lt;minimumSubPillarSize&gt;1&lt;/minimumSubPillarSize&gt;
        &lt;maximumSubPillarSize&gt;1000&lt;/maximumSubPillarSize&gt;
      &lt;/pillarSelector&gt;
      &lt;valueSelector variableName="room"&gt;
        ...
      &lt;/valueSelector&gt;
    &lt;/pillarChangeMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a description of <code>subPillarType</code> and related properties, please refer to <a href="#subPillars">Subpillars</a>.</p>
</div>
<div class="paragraph">
<p>The other properties are explained in <a href="#changeMoveSelector">changeMoveSelector</a>.
This move selector does not support <a href="#cacheType">phase or solver caching</a>
and step caching scales badly memory wise.</p>
</div>
</div>
<div class="sect4">
<h5 id="pillarSwapMoveSelector"><a class="anchor" href="#pillarSwapMoveSelector"></a><a class="link" href="#pillarSwapMoveSelector">10.2.4.2. <code>PillarSwapMoveSelector</code></a></h5>
<div class="paragraph">
<p>The <code>PillarSwapMove</code> selects two different entity pillars and swaps the values of all their variables for all their entities.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/pillarSwapMove.png" alt="pillarSwapMove">
</div>
</div>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;pillarSwapMoveSelector/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;pillarSwapMoveSelector&gt;
      &lt;subPillarType&gt;SEQUENCE&lt;/subPillarType&gt;
      &lt;subPillarSequenceComparatorClass&gt;org.optaplanner.examples.nurserostering.domain.ShiftAssignmentComparator&lt;/subPillarSequenceComparatorClass&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;pillarSelector&gt;
        &lt;entitySelector&gt;
          &lt;entityClass&gt;...ShiftAssignment&lt;/entityClass&gt;
          ...
        &lt;/entitySelector&gt;
        &lt;minimumSubPillarSize&gt;1&lt;/minimumSubPillarSize&gt;
        &lt;maximumSubPillarSize&gt;1000&lt;/maximumSubPillarSize&gt;
      &lt;/pillarSelector&gt;
      &lt;secondaryPillarSelector&gt;
        &lt;entitySelector&gt;
          ...
        &lt;/entitySelector&gt;
        ...
      &lt;/secondaryPillarSelector&gt;
      &lt;variableNameInclude&gt;employee&lt;/variableNameInclude&gt;
      &lt;variableNameInclude&gt;...&lt;/variableNameInclude&gt;
    &lt;/pillarSwapMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a description of <code>subPillarType</code> and related properties, please refer to <a href="#subPillars">sub pillars</a>.</p>
</div>
<div class="paragraph">
<p>The <code>secondaryPillarSelector</code> is rarely needed: if it is not specified, entities from the same <code>pillarSelector</code> are swapped.</p>
</div>
<div class="paragraph">
<p>The other properties are explained in <a href="#swapMoveSelector">swapMoveSelector</a> and <a href="#pillarChangeMoveSelector">pillarChangeMoveSelector</a>.
This move selector does not support <a href="#cacheType">phase or solver caching</a>
and step caching scales badly memory wise.</p>
</div>
</div>
<div class="sect4">
<h5 id="subPillars"><a class="anchor" href="#subPillars"></a><a class="link" href="#subPillars">10.2.4.3. Sub pillars</a></h5>
<div class="paragraph">
<p>A sub pillar is a subset of entities that share the same value(s) for their variable(s). For example if queen A, B, C and D are all located on row 0, they are a pillar and <code>[A, D]</code> is one of the many sub pillars.</p>
</div>
<div class="paragraph">
<p>There are several ways how sub pillars can be selected by the <code>subPillarType</code> property:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ALL</code> (default) selects all possible sub pillars.</p>
</li>
<li>
<p><code>SEQUENCE</code> limits selection of sub pillars to <a href="#sequentialSubPillars">Sequential sub pillars</a>.</p>
</li>
<li>
<p><code>NONE</code> never selects any sub pillars.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If sub pillars are enabled, the pillar itself is also included and the properties <code>minimumSubPillarSize</code> (defaults to <code>1</code>) and <code>maximumSubPillarSize</code> (defaults to <code>infinity</code>) limit the size of the selected (sub) pillar.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The number of sub pillars of a pillar is exponential to the size of the pillar.
For example a pillar of size 32 has <code>(2^32 - 1)</code> subpillars.
Therefore a <code>pillarSelector</code> only supports <a href="#justInTimeRandomSelection">JIT random selection</a> (which is the default).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="sequentialSubPillars"><a class="anchor" href="#sequentialSubPillars"></a><a class="link" href="#sequentialSubPillars">10.2.4.3.1. Sequential sub pillars</a></h6>
<div class="paragraph">
<p>Sub pillars can be sorted with a <code>Comparator</code>. A sequential sub pillar is a continuous subset of its sorted base pillar.</p>
</div>
<div class="paragraph">
<p>For example if a nurse has shifts on Monday (<code>M</code>), Tuesday (<code>T</code>), and Wednesday (<code>W</code>), they are a pillar and only the following are its sequential sub pillars: <code>[M], [T], [W], [M, T], [T, W], [M, T, W]</code>.
But <code>[M, W]</code> is not a sub pillar in this case, as there is a gap on Tuesday.</p>
</div>
<div class="paragraph">
<p>Sequential sub pillars apply to both <a href="#pillarChangeMoveSelector">Pillar change move</a> and
<a href="#pillarSwapMoveSelector">Pillar swap move</a>. A minimal configuration looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;pillar...MoveSelector&gt;
      &lt;subPillarType&gt;SEQUENCE&lt;/subPillarType&gt;
    &lt;/pillar...MoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the entity being operated on must implement the <code>Comparable</code> interface. The size of sub pillars will not be limited in any way.</p>
</div>
<div class="paragraph">
<p>An advanced configuration looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;pillar...MoveSelector&gt;
      ...
      &lt;subPillarType&gt;SEQUENCE&lt;/subPillarType&gt;
      &lt;subPillarSequenceComparatorClass&gt;org.optaplanner.examples.nurserostering.domain.ShiftAssignmentComparator&lt;/subPillarSequenceComparatorClass&gt;
      &lt;pillarSelector&gt;
        ...
        &lt;minimumSubPillarSize&gt;1&lt;/minimumSubPillarSize&gt;
        &lt;maximumSubPillarSize&gt;1000&lt;/maximumSubPillarSize&gt;
      &lt;/pillarSelector&gt;
      ...
    &lt;/pillar...MoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the entity being operated on need not be <code>Comparable</code>. The given <code>subPillarSequenceComparatorClass</code> is used to establish the sequence instead. Also, the size of the sub pillars is limited in length of up to 1000 entities.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="chainMoveSelectors"><a class="anchor" href="#chainMoveSelectors"></a><a class="link" href="#chainMoveSelectors">10.2.5. Move selectors for chained variables</a></h4>
<div class="sect4">
<h5 id="tailChainSwapMoveSelector"><a class="anchor" href="#tailChainSwapMoveSelector"></a><a class="link" href="#tailChainSwapMoveSelector">10.2.5.1. <code>TailChainSwapMoveSelector</code> or 2-opt</a></h5>
<div class="paragraph">
<p>A <em>tailChain</em> is a set of planning entities with a chained planning variable which form the last part of a chain.
The <code>tailChainSwapMove</code> selects a tail chain and swaps it with the tail chain of another planning value (in a different or the same anchor chain). If the targeted planning value, doesn&#8217;t have a tail chain, it swaps with nothing (resulting in a change like move). If it occurs within the same anchor chain, a partial chain reverse occurs.
In academic papers, this is often called a 2-opt move.</p>
</div>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;tailChainSwapMoveSelector/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;tailChainSwapMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;entitySelector&gt;
        &lt;entityClass&gt;...Customer&lt;/entityClass&gt;
        ...
      &lt;/entitySelector&gt;
      &lt;valueSelector variableName="previousStandstill"&gt;
        ...
        &lt;nearbySelection&gt;...&lt;/nearbySelection&gt;
      &lt;/valueSelector&gt;
    &lt;/tailChainSwapMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>entitySelector</code> selects the start of the tail chain that is being moved.
The <code>valueSelector</code> selects to where that tail chain is moved.
If it has a tail chain itself, that is moved to the location of the original tail chain.
It uses a <code>valueSelector</code> instead of a <code>secondaryEntitySelector</code> to be able to include all possible 2opt moves (such as moving to the end of a tail) and to work correctly with <a href="#nearbySelection">nearby selection</a> (because of asymmetric distances and also swapped entity distance gives an incorrect selection probability).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Although <code>subChainChangeMoveSelector</code> and <code>subChainSwapMoveSelector</code> include almost every possible <code>tailChainSwapMove</code>, experiments have shown that focusing on <code>tailChainSwapMove</code>s increases efficiency.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This move selector does not support <a href="#cacheType">phase or solver caching</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="subChainChangeMoveSelector"><a class="anchor" href="#subChainChangeMoveSelector"></a><a class="link" href="#subChainChangeMoveSelector">10.2.5.2. <code>SubChainChangeMoveSelector</code></a></h5>
<div class="paragraph">
<p>A <em>subChain</em> is a set of planning entities with a chained planning variable which form part of a chain.
The <code>subChainChangeMoveSelector</code> selects a subChain and moves it to another place (in a different or the same anchor chain).</p>
</div>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;subChainChangeMoveSelector/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;subChainChangeMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;entityClass&gt;...Customer&lt;/entityClass&gt;
      &lt;subChainSelector&gt;
        &lt;valueSelector variableName="previousStandstill"&gt;
          ...
        &lt;/valueSelector&gt;
        &lt;minimumSubChainSize&gt;2&lt;/minimumSubChainSize&gt;
        &lt;maximumSubChainSize&gt;40&lt;/maximumSubChainSize&gt;
      &lt;/subChainSelector&gt;
      &lt;valueSelector variableName="previousStandstill"&gt;
        ...
      &lt;/valueSelector&gt;
      &lt;selectReversingMoveToo&gt;true&lt;/selectReversingMoveToo&gt;
    &lt;/subChainChangeMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>subChainSelector</code> selects a number of entities, no less than <code>minimumSubChainSize</code> (defaults to <code>1</code>) and no more than <code>maximumSubChainSize</code> (defaults to <code>infinity</code>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If <code>minimumSubChainSize</code> is <code>1</code> (which is the default), this selector might select the same move as a <code>ChangeMoveSelector</code>, at a far lower selection probability (because each move <em>type</em> has the same selection chance by default (not every move instance) and there are far more <code>SubChainChangeMove</code> instances than <code>ChangeMove</code> instances). However, don&#8217;t just remove the <code>ChangeMoveSelector</code>, because experiments show that it&#8217;s good to focus on <code>ChangeMove</code>s.</p>
</div>
<div class="paragraph">
<p>Furthermore, in a <code>SubChainSwapMoveSelector</code>, setting <code>minimumSubChainSize</code> prevents swapping a subchain of size <code>1</code> with a subchain of size <code>2</code> or more.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>selectReversingMoveToo</code> property (defaults to true) enables selecting the reverse of every subchain too.</p>
</div>
<div class="paragraph">
<p>This move selector does not support <a href="#cacheType">phase or solver caching</a>
and step caching scales badly memory wise.</p>
</div>
</div>
<div class="sect4">
<h5 id="subChainSwapMoveSelector"><a class="anchor" href="#subChainSwapMoveSelector"></a><a class="link" href="#subChainSwapMoveSelector">10.2.5.3. <code>SubChainSwapMoveSelector</code></a></h5>
<div class="paragraph">
<p>The <code>subChainSwapMoveSelector</code> selects two different subChains and moves them to another place in a different or the same anchor chain.</p>
</div>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;subChainSwapMoveSelector/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;subChainSwapMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;entityClass&gt;...Customer&lt;/entityClass&gt;
      &lt;subChainSelector&gt;
        &lt;valueSelector variableName="previousStandstill"&gt;
          ...
        &lt;/valueSelector&gt;
        &lt;minimumSubChainSize&gt;2&lt;/minimumSubChainSize&gt;
        &lt;maximumSubChainSize&gt;40&lt;/maximumSubChainSize&gt;
      &lt;/subChainSelector&gt;
      &lt;secondarySubChainSelector&gt;
        &lt;valueSelector variableName="previousStandstill"&gt;
          ...
        &lt;/valueSelector&gt;
        &lt;minimumSubChainSize&gt;2&lt;/minimumSubChainSize&gt;
        &lt;maximumSubChainSize&gt;40&lt;/maximumSubChainSize&gt;
      &lt;/secondarySubChainSelector&gt;
      &lt;selectReversingMoveToo&gt;true&lt;/selectReversingMoveToo&gt;
    &lt;/subChainSwapMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>secondarySubChainSelector</code> is rarely needed: if it is not specified, entities from the same <code>subChainSelector</code> are swapped.</p>
</div>
<div class="paragraph">
<p>The other properties are explained in <a href="#subChainChangeMoveSelector">subChainChangeMoveSelector</a>.
This move selector does not support <a href="#cacheType">phase or solver caching</a>
and step caching scales badly memory wise.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="combiningMultipleMoveSelectors"><a class="anchor" href="#combiningMultipleMoveSelectors"></a><a class="link" href="#combiningMultipleMoveSelectors">10.3. Combining multiple <code>MoveSelector</code>s</a></h3>
<div class="sect3">
<h4 id="unionMoveSelector"><a class="anchor" href="#unionMoveSelector"></a><a class="link" href="#unionMoveSelector">10.3.1. <code>unionMoveSelector</code></a></h4>
<div class="paragraph">
<p>A <code>unionMoveSelector</code> selects a <code>Move</code> by selecting one of its <code>MoveSelector</code> children to supply the next <code>Move</code>.</p>
</div>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;unionMoveSelector&gt;
      &lt;...MoveSelector/&gt;
      &lt;...MoveSelector/&gt;
      &lt;...MoveSelector/&gt;
      ...
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;unionMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;selectorProbabilityWeightFactoryClass&gt;...ProbabilityWeightFactory&lt;/selectorProbabilityWeightFactoryClass&gt;
      &lt;changeMoveSelector&gt;
        &lt;fixedProbabilityWeight&gt;...&lt;/fixedProbabilityWeight&gt;
        ...
      &lt;/changeMoveSelector&gt;
      &lt;swapMoveSelector&gt;
        &lt;fixedProbabilityWeight&gt;...&lt;/fixedProbabilityWeight&gt;
        ...
      &lt;/swapMoveSelector&gt;
      &lt;...MoveSelector&gt;
        &lt;fixedProbabilityWeight&gt;...&lt;/fixedProbabilityWeight&gt;
        ...
      &lt;/...MoveSelector&gt;
      ...
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>selectorProbabilityWeightFactory</code> determines in <code>selectionOrder</code> <code>RANDOM</code> how often a <code>MoveSelector</code> child is selected to supply the next Move.
By default, each <code>MoveSelector</code> child has the same chance of being selected.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/selectorProbabilityInUnion.png" alt="selectorProbabilityInUnion">
</div>
</div>
<div class="paragraph">
<p>Change the <code>fixedProbabilityWeight</code> of such a child to select it more often.
For example, the <code>unionMoveSelector</code> can return a <code>SwapMove</code> twice as often as a <code>ChangeMove</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;unionMoveSelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;fixedProbabilityWeight&gt;1.0&lt;/fixedProbabilityWeight&gt;
        ...
      &lt;/changeMoveSelector&gt;
      &lt;swapMoveSelector&gt;
        &lt;fixedProbabilityWeight&gt;2.0&lt;/fixedProbabilityWeight&gt;
        ...
      &lt;/swapMoveSelector&gt;
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The number of possible <code>ChangeMove</code>s is very different from the number of possible <code>SwapMove</code>s and furthermore it&#8217;s problem dependent.
To give each individual <code>Move</code> the same selection chance (as opposed to each <code>MoveSelector</code>), use the <code>FairSelectorProbabilityWeightFactory</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;unionMoveSelector&gt;
      &lt;selectorProbabilityWeightFactoryClass&gt;org.optaplanner.core.impl.heuristic.selector.common.decorator.FairSelectorProbabilityWeightFactory&lt;/selectorProbabilityWeightFactoryClass&gt;
      &lt;changeMoveSelector/&gt;
      &lt;swapMoveSelector/&gt;
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cartesianProductMoveSelector"><a class="anchor" href="#cartesianProductMoveSelector"></a><a class="link" href="#cartesianProductMoveSelector">10.3.2. <code>cartesianProductMoveSelector</code></a></h4>
<div class="paragraph">
<p>A <code>cartesianProductMoveSelector</code> selects a new <code>CompositeMove</code>.
It builds that <code>CompositeMove</code> by selecting one <code>Move</code> per <code>MoveSelector</code> child and adding it to the <code>CompositeMove</code>.</p>
</div>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;cartesianProductMoveSelector&gt;
      &lt;...MoveSelector/&gt;
      &lt;...MoveSelector/&gt;
      &lt;...MoveSelector/&gt;
      ...
    &lt;/cartesianProductMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;cartesianProductMoveSelector&gt;
      ... &lt;!-- Normal selector properties --&gt;
      &lt;ignoreEmptyChildIterators&gt;true&lt;/ignoreEmptyChildIterators&gt;
      &lt;changeMoveSelector&gt;
        ...
      &lt;/changeMoveSelector&gt;
      &lt;swapMoveSelector&gt;
        ...
      &lt;/swapMoveSelector&gt;
      &lt;...MoveSelector&gt;
        ...
      &lt;/...MoveSelector&gt;
      ...
    &lt;/cartesianProductMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ignoreEmptyChildIterators</code> property (true by default) will ignore every empty <code>childMoveSelector</code> to avoid returning no moves.
For example: a cartesian product of <code>changeMoveSelector</code> A and B, for which B is empty (because all it&#8217;s entities are pinned) returns no move if <code>ignoreEmptyChildIterators</code> is <code>false</code> and the moves of A if <code>ignoreEmptyChildIterators</code> is <code>true</code>.</p>
</div>
<div class="paragraph">
<p>To enforce that two child selectors use the same entity or value efficiently, use <a href="#mimicSelection">mimic selection</a>, not move filtering.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="entitySelector"><a class="anchor" href="#entitySelector"></a><a class="link" href="#entitySelector">10.4. <code>EntitySelector</code></a></h3>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">      &lt;entitySelector/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">      &lt;entitySelector&gt;
        ... &lt;!-- Normal selector properties --&gt;
        &lt;entityClass&gt;org.optaplanner.examples.curriculumcourse.domain.Lecture&lt;/entityClass&gt;
      &lt;/entitySelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>entityClass</code> property is only required if it cannot be deduced automatically because there are multiple entity classes.</p>
</div>
</div>
<div class="sect2">
<h3 id="valueSelector"><a class="anchor" href="#valueSelector"></a><a class="link" href="#valueSelector">10.5. <code>ValueSelector</code></a></h3>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">      &lt;valueSelector/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">      &lt;valueSelector variableName="room"&gt;
        ... &lt;!-- Normal selector properties --&gt;
      &lt;/valueSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>variableName</code> property is only required if it cannot be deduced automatically because there are multiple variables (for the related entity class).</p>
</div>
<div class="paragraph">
<p>In exotic Construction Heuristic configurations, the <code>entityClass</code> from the <code>EntitySelector</code> sometimes needs to be downcasted, which can be done with the property <code>downcastEntityClass</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">      &lt;valueSelector variableName="period"&gt;
        &lt;downcastEntityClass&gt;...LeadingExam&lt;/downcastEntityClass&gt;
      &lt;/valueSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a selected entity cannot be downcasted, the <code>ValueSelector</code> is empty for that entity.</p>
</div>
</div>
<div class="sect2">
<h3 id="generalSelectorFeatures"><a class="anchor" href="#generalSelectorFeatures"></a><a class="link" href="#generalSelectorFeatures">10.6. General <code>Selector</code> features</a></h3>
<div class="sect3">
<h4 id="cacheType"><a class="anchor" href="#cacheType"></a><a class="link" href="#cacheType">10.6.1. <code>CacheType</code>: create moves ahead of time or just in time</a></h4>
<div class="paragraph">
<p>A <code>Selector</code>'s <code>cacheType</code> determines when a selection (such as a <code>Move</code>, an entity, a value, &#8230;&#8203;)
is created and how long it lives.</p>
</div>
<div class="paragraph">
<p>Almost every <code>Selector</code> supports setting a <code>cacheType</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;changeMoveSelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      ...
    &lt;/changeMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following <code>cacheType</code>s are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>JUST_IN_TIME</code> (default, recommended): Not cached. Construct each selection (<code>Move</code>, &#8230;&#8203;) just before it&#8217;s used.
This scales up well in memory footprint.</p>
</li>
<li>
<p><code>STEP</code>: Cached. Create each selection (<code>Move</code>, &#8230;&#8203;) at the beginning of a step and cache them in a list for the remainder of the step.
This scales up badly in memory footprint.</p>
</li>
<li>
<p><code>PHASE</code>: Cached. Create each selection (<code>Move</code>, &#8230;&#8203;) at the beginning of a solver phase and cache them in a list for the remainder of the phase. Some selections cannot be phase cached because the list changes every step.
This scales up badly in memory footprint, but has a slight performance gain.</p>
</li>
<li>
<p><code>SOLVER</code>: Cached. Create each selection (<code>Move</code>, &#8230;&#8203;) at the beginning of a <code>Solver</code> and cache them in a list for the remainder of the <code>Solver</code>. Some selections cannot be solver cached because the list changes every step.
This scales up badly in memory footprint, but has a slight performance gain.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A <code>cacheType</code> can be set on composite selectors too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;unionMoveSelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;changeMoveSelector/&gt;
      &lt;swapMoveSelector/&gt;
      ...
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nested selectors of a cached selector cannot be configured to be cached themselves, unless it&#8217;s a higher <code>cacheType</code>.
For example: a <code>STEP</code> cached <code>unionMoveSelector</code> can contain a <code>PHASE</code> cached <code>changeMoveSelector</code>,
but it cannot contain a <code>STEP</code> cached <code>changeMoveSelector</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="selectionOrder"><a class="anchor" href="#selectionOrder"></a><a class="link" href="#selectionOrder">10.6.2. <code>SelectionOrder</code>: original, sorted, random, shuffled, or probabilistic</a></h4>
<div class="paragraph">
<p>A <code>Selector</code>'s <code>selectionOrder</code> determines the order in which the selections (such as <code>Move</code>s, entities, values, &#8230;&#8203;) are iterated.
An optimization algorithm will usually only iterate through a subset of its <code>MoveSelector</code>'s selections, starting from the start, so the <code>selectionOrder</code> is critical to decide which <code>Move</code>s are actually evaluated.</p>
</div>
<div class="paragraph">
<p>Almost every <code>Selector</code> supports setting a <code>selectionOrder</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;changeMoveSelector&gt;
      ...
      &lt;selectionOrder&gt;RANDOM&lt;/selectionOrder&gt;
      ...
    &lt;/changeMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following <code>selectionOrder</code>s are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ORIGINAL</code>: Select the selections (<code>Move</code>s, entities, values, &#8230;&#8203;) in default order. Each selection will be selected only once.</p>
<div class="ulist">
<ul>
<li>
<p>For example: A0, A1, A2, A3, &#8230;&#8203;, B0, B1, B2, B3, &#8230;&#8203;, C0, C1, C2, C3, &#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
<li>
<p>SORTED: Select the selections (<code>Move</code>s, entities, values, &#8230;&#8203;) in sorted order. Each selection will be selected only once. Requires <code>cacheType &gt;= STEP</code>. Mostly used on an <code>entitySelector</code> or <code>valueSelector</code> for construction heuristics. See <a href="#sortedSelection">sorted selection</a>.</p>
<div class="ulist">
<ul>
<li>
<p>For example: A0, B0, C0, &#8230;&#8203;, A2, B2, C2, &#8230;&#8203;, A1, B1, C1, &#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
<li>
<p>RANDOM (default): Select the selections (<code>Move</code>s, entities, values, &#8230;&#8203;) in non-shuffled random order. A selection might be selected multiple times. This scales up well in performance because it does not require caching.</p>
<div class="ulist">
<ul>
<li>
<p>For example: C2, A3, B1, C2, A0, C0, &#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
<li>
<p>SHUFFLED: Select the selections (<code>Move</code>s, entities, values, &#8230;&#8203;) in shuffled random order. Each selection will be selected only once. Requires <code>cacheType &gt;= STEP</code>. This scales up badly in performance, not just because it requires caching, but also because a random number is generated for each element, even if it&#8217;s not selected (which is the grand majority when scaling up).</p>
<div class="ulist">
<ul>
<li>
<p>For example: C2, A3, B1, A0, C0, &#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
<li>
<p>PROBABILISTIC: Select the selections (<code>Move</code>s, entities, values, &#8230;&#8203;) in random order, based on the selection probability of each element. A selection with a higher probability has a higher chance to be selected than elements with a lower probability. A selection might be selected multiple times. Requires <code>cacheType &gt;= STEP</code>. Mostly used on an <code>entitySelector</code> or <code>valueSelector</code>. See <a href="#probabilisticSelection">probabilistic selection</a>.</p>
<div class="ulist">
<ul>
<li>
<p>For example: B1, B1, A1, B2, B1, C2, B1, B1, &#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>A <code>selectionOrder</code> can be set on composite selectors too.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When a <code>Selector</code> is cached, all of its nested <code>Selector</code>s will naturally default to <code>selectionOrder</code> <code>ORIGINAL</code>.
Avoid overwriting the <code>selectionOrder</code> of those nested <code>Selector</code>s.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="recommendedCombinationsOfCacheTypeAndSelectionOrder"><a class="anchor" href="#recommendedCombinationsOfCacheTypeAndSelectionOrder"></a><a class="link" href="#recommendedCombinationsOfCacheTypeAndSelectionOrder">10.6.3. Recommended combinations of <code>CacheType</code> and <code>SelectionOrder</code></a></h4>
<div class="sect4">
<h5 id="justInTimeRandomSelection"><a class="anchor" href="#justInTimeRandomSelection"></a><a class="link" href="#justInTimeRandomSelection">10.6.3.1. Just in time random selection (default)</a></h5>
<div class="paragraph">
<p>This combination is great for big use cases (10 000 entities or more), as it scales up well in memory footprint and performance.
Other combinations are often not even viable on such sizes.
It works for smaller use cases too, so it&#8217;s a good way to start out.
It&#8217;s the default, so this explicit configuration of <code>cacheType</code> and <code>selectionOrder</code> is actually obsolete:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;unionMoveSelector&gt;
      &lt;cacheType&gt;JUST_IN_TIME&lt;/cacheType&gt;
      &lt;selectionOrder&gt;RANDOM&lt;/selectionOrder&gt;

      &lt;changeMoveSelector/&gt;
      &lt;swapMoveSelector/&gt;
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s how it works.
When <code>Iterator&lt;Move&gt;.next()</code> is called, a child <code>MoveSelector</code> is randomly selected (1), which creates a random <code>Move</code> (2, 3, 4) and is then returned (5):</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/jitRandomSelection.png" alt="jitRandomSelection">
</div>
</div>
<div class="paragraph">
<p>Notice that <strong>it never creates a list of <code><strong>Move</strong></code>s</strong> and it generates random numbers only for <code>Move</code>s that are actually selected.</p>
</div>
</div>
<div class="sect4">
<h5 id="cachedShuffledSelection"><a class="anchor" href="#cachedShuffledSelection"></a><a class="link" href="#cachedShuffledSelection">10.6.3.2. Cached shuffled selection</a></h5>
<div class="paragraph">
<p>This combination often wins for small use cases (1000 entities or less).
Beyond that size, it scales up badly in memory footprint and performance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;unionMoveSelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SHUFFLED&lt;/selectionOrder&gt;

      &lt;changeMoveSelector/&gt;
      &lt;swapMoveSelector/&gt;
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s how it works: At the start of the phase (or step depending on the <code>cacheType</code>), all moves are created (1) and cached (2). When <code>MoveSelector.iterator()</code> is called, the moves are shuffled (3). When <code>Iterator&lt;Move&gt;.next()</code> is called, the next element in the shuffled list is returned (4):</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/cachedShuffledSelection.png" alt="cachedShuffledSelection">
</div>
</div>
<div class="paragraph">
<p>Notice that <strong>each <code></strong>Move<strong></code> will only be selected once</strong>, even though they are selected in random order.</p>
</div>
<div class="paragraph">
<p>Use cacheType PHASE if none of the (possibly nested) Selectors require <code>STEP</code>.
Otherwise, do something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;unionMoveSelector&gt;
      &lt;cacheType&gt;STEP&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SHUFFLED&lt;/selectionOrder&gt;

      &lt;changeMoveSelector&gt;
        &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;/changeMoveSelector&gt;
      &lt;swapMoveSelector/&gt;
        &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;/swapMoveSelector&gt;
      &lt;pillarSwapMoveSelector/&gt;&lt;!-- Does not support cacheType PHASE --&gt;
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="cachedRandomSelection"><a class="anchor" href="#cachedRandomSelection"></a><a class="link" href="#cachedRandomSelection">10.6.3.3. Cached random selection</a></h5>
<div class="paragraph">
<p>This combination is often a worthy competitor for medium use cases, especially with fast stepping optimization algorithms (such as Simulated Annealing). Unlike cached shuffled selection, it doesn&#8217;t waste time shuffling the moves list at the beginning of every step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;unionMoveSelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;RANDOM&lt;/selectionOrder&gt;

      &lt;changeMoveSelector/&gt;
      &lt;swapMoveSelector/&gt;
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="filteredSelection"><a class="anchor" href="#filteredSelection"></a><a class="link" href="#filteredSelection">10.6.4. Filtered selection</a></h4>
<div class="paragraph">
<p>There can be certain moves that you don&#8217;t want to select, because:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The move is pointless and would only waste CPU time.
For example, swapping two lectures of the same course will result in the same score and the same schedule because all lectures of one course are interchangeable (same teacher, same students, same topic).</p>
</li>
<li>
<p>Doing the move would break <a href="#buildInHardConstraint">a built-in hard constraint</a>,
so the solution would be infeasible but the score function doesn&#8217;t check built-in hard constraints for performance reasons.
For example, don&#8217;t change a gym lecture to a room which is not a gym room.
It&#8217;s usually better to not use move filtering for such cases,
because it allows the metaheuristics to temporarily break hard constraints to escape local optima.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Any built-in hard constraint must probably be filtered on every move type of every solver phase.
For example if it filters the change move of Local Search, it must also filter the swap move that swaps the room of a gym lecture with another lecture for which the other lecture&#8217;s original room isn&#8217;t a gym room.
Furthermore, it must also filter the change moves of the Construction Heuristics (which requires an advanced configuration).</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>If a move is unaccepted by the filter, it&#8217;s not executed and the score isn&#8217;t calculated.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/filteredSelection.png" alt="filteredSelection">
</div>
</div>
<div class="paragraph">
<p>Filtering uses the interface <code>SelectionFilter</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface SelectionFilter&lt;Solution_, T&gt; {

    boolean accept(ScoreDirector&lt;Solution_&gt; scoreDirector, T selection);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Implement the <code>accept</code> method to return <code>false</code> on a discarded <code>selection</code> (see below).
Filtered selection can happen on any Selector in the selector tree, including any <code>MoveSelector</code>, <code>EntitySelector</code>
or <code>ValueSelector</code>.
It works with any <code>cacheType</code> and <code>selectionOrder</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Apply the filter on the lowest level possible.
In most cases, you&#8217;ll need to know both the entity and the value involved so you&#8217;ll have to apply it on the move selector.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="filteredMoveSelection"><a class="anchor" href="#filteredMoveSelection"></a><a class="link" href="#filteredMoveSelection">10.6.4.1. Filtered move selection</a></h5>
<div class="paragraph">
<p>Unaccepted moves will not be selected and will therefore never have their <code>doMove()</code> method called:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class DifferentCourseSwapMoveFilter implements SelectionFilter&lt;CourseSchedule, SwapMove&gt; {

    @Override
    public boolean accept(ScoreDirector&lt;CourseSchedule&gt; scoreDirector, SwapMove move) {
        Lecture leftLecture = (Lecture) move.getLeftEntity();
        Lecture rightLecture = (Lecture) move.getRightEntity();
        return !leftLecture.getCourse().equals(rightLecture.getCourse());
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure the <code>filterClass</code> on every targeted <code>moveSelector</code> (potentially both in the Local Search and the Construction Heuristics if it filters <code>ChangeMove</code>s):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;swapMoveSelector&gt;
      &lt;filterClass&gt;org.optaplanner.examples.curriculumcourse.solver.move.DifferentCourseSwapMoveFilter&lt;/filterClass&gt;
    &lt;/swapMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can configure multiple <code>filterClass</code> elements on a single move selector.</p>
</div>
</div>
<div class="sect4">
<h5 id="filteredEntitySelection"><a class="anchor" href="#filteredEntitySelection"></a><a class="link" href="#filteredEntitySelection">10.6.4.2. Filtered entity selection</a></h5>
<div class="paragraph">
<p>Unaccepted entities will not be selected and will therefore never be used to create a move.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class LongLectureSelectionFilter implements SelectionFilter&lt;CourseSchedule, Lecture&gt; {

    @Override
    public boolean accept(ScoreDirector&lt;CourseSchedule&gt; scoreDirector, Lecture lecture) {
        return lecture.isLong();
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure the <code>filterClass</code> on every targeted <code>entitySelector</code> (potentially both in the Local Search and the Construction Heuristics):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;changeMoveSelector&gt;
      &lt;entitySelector&gt;
        &lt;filterClass&gt;org.optaplanner.examples.curriculumcourse.solver.move.LongLectureSelectionFilter&lt;/filterClass&gt;
      &lt;/entitySelector&gt;
    &lt;/changeMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If that filter should apply on all entities, configure it as a <a href="#pinnedPlanningEntities">global pinningFilter</a> instead.</p>
</div>
<div class="paragraph">
<p>You can configure multiple <code>filterClass</code> elements on a single entity selector.</p>
</div>
</div>
<div class="sect4">
<h5 id="filteredValueSelection"><a class="anchor" href="#filteredValueSelection"></a><a class="link" href="#filteredValueSelection">10.6.4.3. Filtered value selection</a></h5>
<div class="paragraph">
<p>Unaccepted values will not be selected and will therefore never be used to create a move.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class LongPeriodSelectionFilter implements SelectionFilter&lt;CourseSchedule, Period&gt; {

    @Override
    public boolean accept(ScoreDirector&lt;CourseSchedule&gt; scoreDirector, Period period) {
        return period();
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure the <code>filterClass</code> on every targeted <code>valueSelector</code> (potentially both in the Local Search and the Construction Heuristics):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;changeMoveSelector&gt;
      &lt;valueSelector&gt;
        &lt;filterClass&gt;org.optaplanner.examples.curriculumcourse.solver.move.LongPeriodSelectionFilter&lt;/filterClass&gt;
      &lt;/valueSelector&gt;
    &lt;/changeMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can configure multiple <code>filterClass</code> elements on a single value selector.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sortedSelection"><a class="anchor" href="#sortedSelection"></a><a class="link" href="#sortedSelection">10.6.5. Sorted selection</a></h4>
<div class="paragraph">
<p>Sorted selection can happen on any Selector in the selector tree, including any <code>MoveSelector</code>, <code>EntitySelector</code> or <code>ValueSelector</code>.
It does not work with <code>cacheType</code> <code>JUST_IN_TIME</code> and it only works with <code>selectionOrder</code> <code>SORTED</code>.</p>
</div>
<div class="paragraph">
<p>It&#8217;s mostly used in construction heuristics.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the chosen construction heuristic implies sorting, for example <code>FIRST_FIT_DECREASING</code> implies that the <code>EntitySelector</code> is sorted, there is no need to explicitly configure a <code>Selector</code> with sorting.
If you do explicitly configure the <code>Selector</code>, it overwrites the default settings of that construction heuristic.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="sortedSelectionBySorterManner"><a class="anchor" href="#sortedSelectionBySorterManner"></a><a class="link" href="#sortedSelectionBySorterManner">10.6.5.1. Sorted selection by <code>SorterManner</code></a></h5>
<div class="paragraph">
<p>Some <code>Selector</code> types implement a <code>SorterManner</code> out of the box:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>EntitySelector</code> supports:</p>
<div class="ulist">
<ul>
<li>
<p><code>DECREASING_DIFFICULTY</code>: Sorts the planning entities according to decreasing <a href="#planningEntityDifficulty">planning entity difficulty</a>. Requires that planning entity difficulty is annotated on the domain model.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;entitySelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
      &lt;sorterManner&gt;DECREASING_DIFFICULTY&lt;/sorterManner&gt;
    &lt;/entitySelector&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><code>ValueSelector</code> supports:</p>
<div class="ulist">
<ul>
<li>
<p><code>INCREASING_STRENGTH</code>: Sorts the planning values according to increasing <a href="#planningValueStrength">planning value strength</a>. Requires that planning value strength is annotated on the domain model.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;valueSelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
      &lt;sorterManner&gt;INCREASING_STRENGTH&lt;/sorterManner&gt;
    &lt;/valueSelector&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="sortedSelectionByComparator"><a class="anchor" href="#sortedSelectionByComparator"></a><a class="link" href="#sortedSelectionByComparator">10.6.5.2. Sorted selection by <code>Comparator</code></a></h5>
<div class="paragraph">
<p>An easy way to sort a <code>Selector</code> is with a plain old <code>Comparator</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class CloudProcessDifficultyComparator implements Comparator&lt;CloudProcess&gt; {

    public int compare(CloudProcess a, CloudProcess b) {
        return new CompareToBuilder()
                .append(a.getRequiredMultiplicand(), b.getRequiredMultiplicand())
                .append(a.getId(), b.getId())
                .toComparison();
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll also need to configure it (unless it&#8217;s annotated on the domain model and automatically applied by the optimization algorithm):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;entitySelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
      &lt;sorterComparatorClass&gt;...CloudProcessDifficultyComparator&lt;/sorterComparatorClass&gt;
      &lt;sorterOrder&gt;DESCENDING&lt;/sorterOrder&gt;
    &lt;/entitySelector&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sortedSelectionBySelectionSorterWeightFactory"><a class="anchor" href="#sortedSelectionBySelectionSorterWeightFactory"></a><a class="link" href="#sortedSelectionBySelectionSorterWeightFactory">10.6.5.3. Sorted selection by <code>SelectionSorterWeightFactory</code></a></h5>
<div class="paragraph">
<p>If you need the entire solution to sort a <code>Selector</code>, use a <code>SelectionSorterWeightFactory</code> instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface SelectionSorterWeightFactory&lt;Solution_, T&gt; {

    Comparable createSorterWeight(Solution_ solution, T selection);

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class QueenDifficultyWeightFactory implements SelectionSorterWeightFactory&lt;NQueens, Queen&gt; {

    public QueenDifficultyWeight createSorterWeight(NQueens nQueens, Queen queen) {
        int distanceFromMiddle = calculateDistanceFromMiddle(nQueens.getN(), queen.getColumnIndex());
        return new QueenDifficultyWeight(queen, distanceFromMiddle);
    }

    ...

    public static class QueenDifficultyWeight implements Comparable&lt;QueenDifficultyWeight&gt; {

        private final Queen queen;
        private final int distanceFromMiddle;

        public QueenDifficultyWeight(Queen queen, int distanceFromMiddle) {
            this.queen = queen;
            this.distanceFromMiddle = distanceFromMiddle;
        }

        public int compareTo(QueenDifficultyWeight other) {
            return new CompareToBuilder()
                    // The more difficult queens have a lower distance to the middle
                    .append(other.distanceFromMiddle, distanceFromMiddle) // Decreasing
                    // Tie breaker
                    .append(queen.getColumnIndex(), other.queen.getColumnIndex())
                    .toComparison();
        }

    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll also need to configure it (unless it&#8217;s annotated on the domain model and automatically applied by the optimization algorithm):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;entitySelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
      &lt;sorterWeightFactoryClass&gt;...QueenDifficultyWeightFactory&lt;/sorterWeightFactoryClass&gt;
      &lt;sorterOrder&gt;DESCENDING&lt;/sorterOrder&gt;
    &lt;/entitySelector&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sortedSelectionBySelectionSorter"><a class="anchor" href="#sortedSelectionBySelectionSorter"></a><a class="link" href="#sortedSelectionBySelectionSorter">10.6.5.4. Sorted selection by <code>SelectionSorter</code></a></h5>
<div class="paragraph">
<p>Alternatively, you can also use the interface <code>SelectionSorter</code> directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface SelectionSorter&lt;Solution_, T&gt; {

    void sort(ScoreDirector&lt;Solution_&gt; scoreDirector, List&lt;T&gt; selectionList);

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;entitySelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
      &lt;sorterClass&gt;...MyEntitySorter&lt;/sorterClass&gt;
    &lt;/entitySelector&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="probabilisticSelection"><a class="anchor" href="#probabilisticSelection"></a><a class="link" href="#probabilisticSelection">10.6.6. Probabilistic selection</a></h4>
<div class="paragraph">
<p>Probabilistic selection can happen on any Selector in the selector tree, including any <code>MoveSelector</code>, <code>EntitySelector</code> or <code>ValueSelector</code>.
It does not work with <code>cacheType</code> <code>JUST_IN_TIME</code> and it only works with <code>selectionOrder</code> <code>PROBABILISTIC</code>.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/probabilisticSelection.png" alt="probabilisticSelection">
</div>
</div>
<div class="paragraph">
<p>Each selection has a <code>probabilityWeight</code>, which determines the chance that selection will be selected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface SelectionProbabilityWeightFactory&lt;Solution_, T&gt; {

    double createProbabilityWeight(ScoreDirector&lt;Solution_&gt; scoreDirector, T selection);

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;entitySelector&gt;
      &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
      &lt;selectionOrder&gt;PROBABILISTIC&lt;/selectionOrder&gt;
      &lt;probabilityWeightFactoryClass&gt;...MyEntityProbabilityWeightFactoryClass&lt;/probabilityWeightFactoryClass&gt;
    &lt;/entitySelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, if there are three entities: process A (probabilityWeight 2.0), process B (probabilityWeight 0.5) and process C (probabilityWeight 0.5), then process A will be selected four times more than B and C.</p>
</div>
</div>
<div class="sect3">
<h4 id="limitedSelection"><a class="anchor" href="#limitedSelection"></a><a class="link" href="#limitedSelection">10.6.7. Limited selection</a></h4>
<div class="paragraph">
<p>Selecting all possible moves sometimes does not scale well enough, especially for construction heuristics (which don&#8217;t support <a href="#acceptedCountLimit">acceptedCountLimit</a>).</p>
</div>
<div class="paragraph">
<p>To limit the number of selected selection per step, apply a <code>selectedCountLimit</code> on the selector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;changeMoveSelector&gt;
      &lt;selectedCountLimit&gt;100&lt;/selectedCountLimit&gt;
    &lt;/changeMoveSelector&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To scale Local Search, setting <a href="#acceptedCountLimit">acceptedCountLimit</a> is usually better than using <code>selectedCountLimit</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mimicSelection"><a class="anchor" href="#mimicSelection"></a><a class="link" href="#mimicSelection">10.6.8. Mimic selection (record/replay)</a></h4>
<div class="paragraph">
<p>During mimic selection, one normal selector records its selection and one or multiple other special selectors replay that selection.
The recording selector acts as a normal selector and supports all other configuration properties.
A replaying selector mimics the recording selection and supports no other configuration properties.</p>
</div>
<div class="paragraph">
<p>The recording selector needs an <code>id</code>.
A replaying selector must reference a recorder&#8217;s id with a <code>mimicSelectorRef</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">      &lt;cartesianProductMoveSelector&gt;
        &lt;changeMoveSelector&gt;
          &lt;entitySelector id="entitySelector"/&gt;
          &lt;valueSelector variableName="period"/&gt;
        &lt;/changeMoveSelector&gt;
        &lt;changeMoveSelector&gt;
          &lt;entitySelector mimicSelectorRef="entitySelector"/&gt;
          &lt;valueSelector variableName="room"/&gt;
        &lt;/changeMoveSelector&gt;
      &lt;/cartesianProductMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Mimic selection is useful to create <a href="#cartesianProductMoveSelector">a composite move</a> from two moves that affect the same entity.</p>
</div>
</div>
<div class="sect3">
<h4 id="nearbySelection"><a class="anchor" href="#nearbySelection"></a><a class="link" href="#nearbySelection">10.6.9. Nearby selection</a></h4>
<div class="paragraph">
<p>In some use cases (such as TSP and VRP, but also in non-chained variable cases), changing entities to nearby values or swapping nearby entities can <strong>heavily increase scalability</strong> and improve solution quality.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/nearbySelectionMotivation.png" alt="nearbySelectionMotivation">
</div>
</div>
<div class="paragraph">
<p>Nearby selection increases the probability of selecting an entity or value which is nearby to the first entity being moved in that move.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./MoveAndNeighborhoodSelection/nearbySelectionRandomDistribution.png" alt="nearbySelectionRandomDistribution">
</div>
</div>
<div class="paragraph">
<p>The distance between two entities or values is domain specific.
Therefore, implement the <code>NearbyDistanceMeter</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface NearbyDistanceMeter&lt;O, D&gt; {

    double getNearbyDistance(O origin, D destination);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It returns a <code>double</code> which represents the distance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class CustomerNearbyDistanceMeter implements NearbyDistanceMeter&lt;Customer, Standstill&gt; {

    public double getNearbyDistance(Customer origin, Standstill destination) {
        return origin.getDistanceTo(destination);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To configure nearby selection, add a <code>nearbySelection</code> element in the <code>entitySelector</code> or <code>valueSelector</code>
and use <a href="#mimicSelection">mimic selection</a> to specify which entity should be near by the selection.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;unionMoveSelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;entitySelector id="entitySelector1"/&gt;
        &lt;valueSelector&gt;
          &lt;nearbySelection&gt;
            &lt;originEntitySelector mimicSelectorRef="entitySelector1"/&gt;
            &lt;nearbyDistanceMeterClass&gt;...CustomerNearbyDistanceMeter&lt;/nearbyDistanceMeterClass&gt;
            &lt;parabolicDistributionSizeMaximum&gt;40&lt;/parabolicDistributionSizeMaximum&gt;
          &lt;/nearbySelection&gt;
        &lt;/valueSelector&gt;
      &lt;/changeMoveSelector&gt;
      &lt;swapMoveSelector&gt;
        &lt;entitySelector id="entitySelector2"/&gt;
        &lt;secondaryEntitySelector&gt;
          &lt;nearbySelection&gt;
            &lt;originEntitySelector mimicSelectorRef="entitySelector2"/&gt;
            &lt;nearbyDistanceMeterClass&gt;...CustomerNearbyDistanceMeter&lt;/nearbyDistanceMeterClass&gt;
            &lt;parabolicDistributionSizeMaximum&gt;40&lt;/parabolicDistributionSizeMaximum&gt;
          &lt;/nearbySelection&gt;
        &lt;/secondaryEntitySelector&gt;
      &lt;/swapMoveSelector&gt;
      &lt;tailChainSwapMoveSelector&gt;
        &lt;entitySelector id="entitySelector3"/&gt;
        &lt;valueSelector&gt;
          &lt;nearbySelection&gt;
            &lt;originEntitySelector mimicSelectorRef="entitySelector3"/&gt;
            &lt;nearbyDistanceMeterClass&gt;...CustomerNearbyDistanceMeter&lt;/nearbyDistanceMeterClass&gt;
            &lt;parabolicDistributionSizeMaximum&gt;40&lt;/parabolicDistributionSizeMaximum&gt;
          &lt;/nearbySelection&gt;
        &lt;/valueSelector&gt;
      &lt;/tailChainSwapMoveSelector&gt;
    &lt;/unionMoveSelector&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>distributionSizeMaximum</code> parameter should not be 1 because if the nearest is already the planning value of the current entity, then the only move that is selectable is not doable.</p>
</div>
<div class="paragraph">
<p>To allow every element to be selected, regardless of the number of entities, only set the distribution type (so without a <code>distributionSizeMaximum</code> parameter):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;nearbySelection&gt;
    &lt;nearbySelectionDistributionType&gt;PARABOLIC_DISTRIBUTION&lt;/nearbySelectionDistributionType&gt;
  &lt;/nearbySelection&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following <code>NearbySelectionDistributionType</code>s are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BLOCK_DISTRIBUTION</code>: Only the n nearest are selected, with an equal probability. For example, select the 20 nearest:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;nearbySelection&gt;
    &lt;blockDistributionSizeMaximum&gt;20&lt;/blockDistributionSizeMaximum&gt;
  &lt;/nearbySelection&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><code>LINEAR_DISTRIBUTION</code>: Nearest elements are selected with a higher probability. The probability decreases linearly.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;nearbySelection&gt;
    &lt;linearDistributionSizeMaximum&gt;40&lt;/linearDistributionSizeMaximum&gt;
  &lt;/nearbySelection&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><code>PARABOLIC_DISTRIBUTION</code> (recommended): Nearest elements are selected with a higher probability.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;nearbySelection&gt;
    &lt;parabolicDistributionSizeMaximum&gt;80&lt;/parabolicDistributionSizeMaximum&gt;
  &lt;/nearbySelection&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><code>BETA_DISTRIBUTION</code>: Selection according to a beta distribution. Slows down the solver significantly.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;nearbySelection&gt;
    &lt;betaDistributionAlpha&gt;1&lt;/betaDistributionAlpha&gt;
    &lt;betaDistributionBeta&gt;5&lt;/betaDistributionBeta&gt;
  &lt;/nearbySelection&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>As always, use the <a href="#benchmarker">Benchmarker</a> to tweak values if desired.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="customMoves"><a class="anchor" href="#customMoves"></a><a class="link" href="#customMoves">10.7. Custom moves</a></h3>
<div class="sect3">
<h4 id="whichMoveTypesMightBeMissing"><a class="anchor" href="#whichMoveTypesMightBeMissing"></a><a class="link" href="#whichMoveTypesMightBeMissing">10.7.1. Which move types might be missing in my implementation?</a></h4>
<div class="paragraph">
<p>To determine which move types might be missing in your implementation,
run a <a href="#benchmarker">Benchmarker</a> <em>for a short amount of time</em>
and <a href="#writeTheOutputSolutionOfBenchmarkRuns">configure it to write the best solutions to disk</a>.
Take a look at such a best solution: it will likely be a local optima.
Try to figure out if there&#8217;s a move that could get out of that local optima faster.</p>
</div>
<div class="paragraph">
<p>If you find one, implement that coarse-grained move, mix it with the existing moves
and benchmark it against the previous configurations to see if you want to keep it.</p>
</div>
</div>
<div class="sect3">
<h4 id="customMovesIntroduction"><a class="anchor" href="#customMovesIntroduction"></a><a class="link" href="#customMovesIntroduction">10.7.2. Custom moves introduction</a></h4>
<div class="paragraph">
<p>Instead of using the generic <code>Move</code>s (such as <code>ChangeMove</code>) you can also implement your own <code>Move</code>.
Generic and custom <code>MoveSelector</code>s can be <a href="#combiningMultipleMoveSelectors">combined</a> as desired.</p>
</div>
<div class="paragraph">
<p>A custom <code>Move</code> can be tailored to work to the advantage of your constraints.
For example in examination scheduling, changing the period of an exam A
would also change the period of all the other exams that need to coincide with exam A.</p>
</div>
<div class="paragraph">
<p>A custom <code>Move</code> is far more work to implement and much harder to avoid bugs than a generic <code>Move</code>.
After implementing a custom <code>Move</code>, turn on <code>environmentMode</code> <code>FULL_ASSERT</code> to check for score corruptions.</p>
</div>
</div>
<div class="sect3">
<h4 id="theInterfaceMove"><a class="anchor" href="#theInterfaceMove"></a><a class="link" href="#theInterfaceMove">10.7.3. The <code>Move</code> interface</a></h4>
<div class="paragraph">
<p>All moves implement the <code>Move</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface Move&lt;Solution_&gt; {

    boolean isMoveDoable(ScoreDirector&lt;Solution_&gt; scoreDirector);

    Move&lt;Solution_&gt; doMove(ScoreDirector&lt;Solution_&gt; scoreDirector);

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To implement a custom move, it&#8217;s recommended to extend <code>AbstractMove</code> instead implementing <code>Move</code> directly.
OptaPlanner calls <code>AbstractMove.doMove(ScoreDirector)</code>, which calls <code>doMoveOnGenuineVariables(ScoreDirector)</code>.
For example in cloud balancing, this move changes one process to another computer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class CloudComputerChangeMove extends AbstractMove&lt;CloudBalance&gt; {

    private CloudProcess cloudProcess;
    private CloudComputer toCloudComputer;

    public CloudComputerChangeMove(CloudProcess cloudProcess, CloudComputer toCloudComputer) {
        this.cloudProcess = cloudProcess;
        this.toCloudComputer = toCloudComputer;
    }

    @Override
    protected void doMoveOnGenuineVariables(ScoreDirector&lt;CloudBalance&gt; scoreDirector) {
        scoreDirector.beforeVariableChanged(cloudProcess, "computer");
        cloudProcess.setComputer(toCloudComputer);
        scoreDirector.afterVariableChanged(cloudProcess, "computer");
    }

    // ...

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation must notify the <code>ScoreDirector</code> of any changes it makes to planning entity&#8217;s variables:
Call the <code>scoreDirector.beforeVariableChanged(Object, String)</code> and <code>scoreDirector.afterVariableChanged(Object, String)</code>
methods directly before and after modifying an entity&#8217;s planning variable.</p>
</div>
<div class="paragraph">
<p>The example move above is a fine-grained move because it changes only one planning variable.
On the other hand, a coarse-grained move changes multiple entities or multiple planning variables
in a single move, usually to avoid breaking hard constraints by making multiple related changes at once.
For example, a swap move is really just two change moves, but it keeps those two changes together.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A <code>Move</code> can only change/add/remove planning entities,
it must not change any of the problem facts as that will cause score corruption.
Use <a href="#realTimePlanning">real-time planning</a> to change problem facts while solving.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>OptaPlanner automatically filters out <em>non doable moves</em> by calling the <code>isMoveDoable(ScoreDirector)</code> method on each selected move.
A <em>non doable move</em> is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A move that changes nothing on the current solution.
For example, moving process <code>P1</code> on computer <code>X</code> to computer <code>X</code> is not doable, because it is already there.</p>
</li>
<li>
<p>A move that is impossible to do on the current solution.
For example, moving process <code>P1</code> to computer <code>Q</code>  (when <code>Q</code> isn&#8217;t in the list of computers) is not doable
because it would assign a planning value that&#8217;s not inside the planning variable&#8217;s value range.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the cloud balancing example, a move which assigns a process to the computer it&#8217;s already assigned to is not doable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @Override
    public boolean isMoveDoable(ScoreDirector&lt;CloudBalance&gt; scoreDirector) {
        return !Objects.equals(cloudProcess.getComputer(), toCloudComputer);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>We don&#8217;t need to check if <code>toCloudComputer</code> is in the value range,
because we only generate moves for which that is the case.
A move that is currently not doable can become doable when the working solution changes in a later step,
otherwise we probably shouldn&#8217;t have created it in the first place.</p>
</div>
<div class="paragraph">
<p>Each move has an <em>undo move</em>: a move (normally of the same type) which does the exact opposite.
In the cloud balancing example the undo move of <code>P1 {X &#8594; Y}</code> is the move <code>P1 {Y &#8594; X}</code>.
The undo move of a move is created when the <code>Move</code> is being done on the current solution,
before the genuine variables change:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @Override
    public CloudComputerChangeMove createUndoMove(ScoreDirector&lt;CloudBalance&gt; scoreDirector) {
        return new CloudComputerChangeMove(cloudProcess, cloudProcess.getComputer());
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that if <code>P1</code> would have already been moved to <code>Y</code>, the undo move would create the move <code>P1 {Y &#8594; Y}</code>,
instead of the move <code>P1 {Y &#8594; X}</code>.</p>
</div>
<div class="paragraph">
<p>A solver phase might do and undo the same <code>Move</code> more than once.
In fact, many solver phases will iteratively do and undo a number of moves to evaluate them,
before selecting one of those and doing that move again (without undoing it the last time).</p>
</div>
<div class="paragraph">
<p>Always implement the <code>toString()</code> method to keep OptaPlanner&#8217;s logs readable.
Keep it non-verbose and make it consistent with <a href="#genericMoveSelectorsOverview">the generic moves</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    public String toString() {
        return cloudProcess + " {" + cloudProcess.getComputer() + " -&gt; " + toCloudComputer + "}";
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Optionally, implement the <code>getSimpleMoveTypeDescription()</code> method to support
<a href="#benchmarkReportPickedMoveTypeBestScoreDiffOverTimeStatistic">picked move statistics</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @Override
    public String getSimpleMoveTypeDescription() {
        return "CloudComputerChangeMove(CloudProcess.computer)";
    }</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_custom_move_rebase"><a class="anchor" href="#_custom_move_rebase"></a><a class="link" href="#_custom_move_rebase">10.7.3.1. Custom move: <code>rebase()</code></a></h5>
<div class="paragraph">
<p>For <a href="#multithreadedIncrementalSolving">multithreaded incremental solving</a>,
the custom move must implement the <code>rebase()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @Override
    public CloudComputerChangeMove rebase(ScoreDirector&lt;CloudBalance&gt; destinationScoreDirector) {
        return new CloudComputerChangeMove(destinationScoreDirector.lookUpWorkingObject(cloudProcess),
                destinationScoreDirector.lookUpWorkingObject(toCloudComputer));
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rebasing a move takes a move generated of one working solution and creates a new move
that does the same change as the original move,
but rewired as if was generated off of the destination working solution.
This allows multithreaded solving to migrate moves from one thread to another.</p>
</div>
<div class="paragraph">
<p>The <code>lookUpWorkingObject()</code> method translates a planning entity instance or problem fact instance
from one working solution to that of the destination&#8217;s working solution.
Internally it often uses a mapping technique based on the <a href="#planningId">planning ID</a>.</p>
</div>
<div class="paragraph">
<p>To rebase lists or arrays in bulk, use <code>rebaseList()</code> and <code>rebaseArray()</code> on <code>AbstractMove</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="customMoveGetPlanningEntitiesAndGetPlanningValues"><a class="anchor" href="#customMoveGetPlanningEntitiesAndGetPlanningValues"></a><a class="link" href="#customMoveGetPlanningEntitiesAndGetPlanningValues">10.7.3.2. Custom move: <code>getPlanningEntities()</code> and <code>getPlanningValues()</code></a></h5>
<div class="paragraph">
<p>A custom move should also implement the <code>getPlanningEntities()</code> and <code>getPlanningValues()</code> methods.
Those are used by <a href="#tabuSearch">entity tabu and value tabu</a> respectively.
They are called after the <code>Move</code> has already been done.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @Override
    public Collection&lt;? extends Object&gt; getPlanningEntities() {
        return Collections.singletonList(cloudProcess);
    }

    @Override
    public Collection&lt;? extends Object&gt; getPlanningValues() {
        return Collections.singletonList(toCloudComputer);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>Move</code> changes multiple planning entities, such as in a swap move,
return all of them in <code>getPlanningEntities()</code>
and return all their values (to which they are changing) in <code>getPlanningValues()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @Override
    public Collection&lt;? extends Object&gt; getPlanningEntities() {
        return Arrays.asList(leftCloudProcess, rightCloudProcess);
    }

    @Override
    public Collection&lt;? extends Object&gt; getPlanningValues() {
        return Arrays.asList(leftCloudProcess.getComputer(), rightCloudProcess.getComputer());
    }</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="customMoveEqualsAndHashCode"><a class="anchor" href="#customMoveEqualsAndHashCode"></a><a class="link" href="#customMoveEqualsAndHashCode">10.7.3.3. Custom move: <code>equals()</code> and <code>hashCode()</code></a></h5>
<div class="paragraph">
<p>A <code>Move</code> must implement the <code>equals()</code> and <code>hashCode()</code> methods for <a href="#tabuSearch">move tabu</a>.
Two moves which make the same change on a solution, should be equal ideally.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    @Override
    public boolean equals(Object o) {
        if (this == o) {
            return true;
        } else if (o instanceof CloudComputerChangeMove) {
            CloudComputerChangeMove other = (CloudComputerChangeMove) o;
            return new EqualsBuilder()
                    .append(cloudProcess, other.cloudProcess)
                    .append(toCloudComputer, other.toCloudComputer)
                    .isEquals();
        } else {
            return false;
        }
    }

    @Override
    public int hashCode() {
        return new HashCodeBuilder()
                .append(cloudProcess)
                .append(toCloudComputer)
                .toHashCode();
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that it checks if the other move is an instance of the same move type.
This <code>instanceof</code> check is important because a move are compared to a move of another move type.
For example a <code>ChangeMove</code> and <code>SwapMove</code> are compared.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="generatingCustomMoves"><a class="anchor" href="#generatingCustomMoves"></a><a class="link" href="#generatingCustomMoves">10.7.4. Generating custom moves</a></h4>
<div class="paragraph">
<p>Now, let&#8217;s generate instances of this custom <code>Move</code> class.
There are 2 ways:</p>
</div>
<div class="sect4">
<h5 id="moveListFactory"><a class="anchor" href="#moveListFactory"></a><a class="link" href="#moveListFactory">10.7.4.1. <code>MoveListFactory</code>: the easy way to generate custom moves</a></h5>
<div class="paragraph">
<p>The easiest way to generate custom moves is by implementing the interface <code>MoveListFactory</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface MoveListFactory&lt;Solution_&gt; {

    List&lt;Move&gt; createMoveList(Solution_ solution);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class CloudComputerChangeMoveFactory implements MoveListFactory&lt;CloudBalance&gt; {

    @Override
    public List&lt;CloudComputerChangeMove&gt; createMoveList(CloudBalance cloudBalance) {
        List&lt;CloudComputerChangeMove&gt; moveList = new ArrayList&lt;&gt;();
        List&lt;CloudComputer&gt; cloudComputerList = cloudBalance.getComputerList();
        for (CloudProcess cloudProcess : cloudBalance.getProcessList()) {
            for (CloudComputer cloudComputer : cloudComputerList) {
                moveList.add(new CloudComputerChangeMove(cloudProcess, cloudComputer));
            }
        }
        return moveList;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Simple configuration (which can be nested in a <code>unionMoveSelector</code> just like any other <code>MoveSelector</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;moveListFactory&gt;
      &lt;moveListFactoryClass&gt;org.optaplanner.examples.cloudbalancing.optional.move.CloudComputerChangeMoveFactory&lt;/moveListFactoryClass&gt;
    &lt;/moveListFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;moveListFactory&gt;
      ... &lt;!-- Normal moveSelector properties --&gt;
      &lt;moveListFactoryClass&gt;org.optaplanner.examples.cloudbalancing.optional.move.CloudComputerChangeMoveFactory&lt;/moveListFactoryClass&gt;
      &lt;moveListFactoryCustomProperties&gt;
        ...&lt;!-- Custom properties --&gt;
      &lt;/moveListFactoryCustomProperties&gt;
    &lt;/moveListFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the <code>MoveListFactory</code> generates all moves at once in a <code>List&lt;Move&gt;</code>,
it does not support <code>cacheType</code> <code>JUST_IN_TIME</code>.
Therefore, <code>moveListFactory</code> uses <code>cacheType</code> <code>STEP</code> by default and it scales badly.</p>
</div>
<div class="paragraph">
<p>To configure values of a <code>MoveListFactory</code> dynamically in the solver configuration
(so the <a href="#benchmarker">Benchmarker</a> can tweak those parameters),
add the <code>moveListFactoryCustomProperties</code> element and use <a href="#customPropertiesConfiguration">custom properties</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A custom <code>MoveListFactory</code> implementation must ensure that it does not move <a href="#pinnedPlanningEntities">pinned entities</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="moveIteratorFactory"><a class="anchor" href="#moveIteratorFactory"></a><a class="link" href="#moveIteratorFactory">10.7.4.2. <code>MoveIteratorFactory</code>: generate Custom moves just in time</a></h5>
<div class="paragraph">
<p>Use this advanced form to generate custom moves Just In Time
by implementing the <code>MoveIteratorFactory</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface MoveIteratorFactory&lt;Solution_&gt; {

    long getSize(ScoreDirector&lt;Solution_&gt; scoreDirector);

    Iterator&lt;Move&gt; createOriginalMoveIterator(ScoreDirector&lt;Solution_&gt; scoreDirector);

    Iterator&lt;Move&gt; createRandomMoveIterator(ScoreDirector&lt;Solution_&gt; scoreDirector, Random workingRandom);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>getSize()</code> method must return an estimation of the size.
It doesn&#8217;t need to be correct, but it&#8217;s better too big than too small.
The <code>createOriginalMoveIterator</code> method is called if the <code>selectionOrder</code> is <code>ORIGINAL</code> or if it is cached.
The <code>createRandomMoveIterator</code> method is called for <code>selectionOrder</code> <code>RANDOM</code> combined with cacheType <code>JUST_IN_TIME</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Don&#8217;t create a collection (array, list, set or map) of <code>Move</code>s when creating the <code>Iterator&lt;Move&gt;</code>:
the whole purpose of <code>MoveIteratorFactory</code> over <code>MoveListFactory</code> is to create a <code>Move</code> just in time
in a custom <code>Iterator.next()</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Simple configuration (which can be nested in a <code>unionMoveSelector</code> just like any other <code>MoveSelector</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;moveIteratorFactory&gt;
      &lt;moveIteratorFactoryClass&gt;...&lt;/moveIteratorFactoryClass&gt;
    &lt;/moveIteratorFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;moveIteratorFactory&gt;
      ... &lt;!-- Normal moveSelector properties --&gt;
      &lt;moveIteratorFactoryClass&gt;...&lt;/moveIteratorFactoryClass&gt;
      &lt;moveIteratorFactoryCustomProperties&gt;
        ...&lt;!-- Custom properties --&gt;
      &lt;/moveIteratorFactoryCustomProperties&gt;
    &lt;/moveIteratorFactory&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To configure values of a <code>MoveIteratorFactory</code> dynamically in the solver configuration
(so the <a href="#benchmarker">Benchmarker</a> can tweak those parameters),
add the <code>moveIteratorFactoryCustomProperties</code> element and use <a href="#customPropertiesConfiguration">custom properties</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A custom <code>MoveIteratorFactory</code> implementation must ensure that it does not move <a href="#pinnedPlanningEntities">pinned entities</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="exhaustiveSearch"><a class="anchor" href="#exhaustiveSearch"></a><a class="link" href="#exhaustiveSearch">11. Exhaustive search</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="exhaustiveSearchOverview"><a class="anchor" href="#exhaustiveSearchOverview"></a><a class="link" href="#exhaustiveSearchOverview">11.1. Overview</a></h3>
<div class="paragraph">
<p>Exhaustive Search will always find the global optimum and recognize it too.
That being said, it doesn&#8217;t scale (not even beyond toy data sets) and is therefore mostly useless.</p>
</div>
</div>
<div class="sect2">
<h3 id="bruteForce"><a class="anchor" href="#bruteForce"></a><a class="link" href="#bruteForce">11.2. Brute force</a></h3>
<div class="sect3">
<h4 id="bruteForceAlgorithm"><a class="anchor" href="#bruteForceAlgorithm"></a><a class="link" href="#bruteForceAlgorithm">11.2.1. Algorithm description</a></h4>
<div class="paragraph">
<p>The Brute Force algorithm creates and evaluates every possible solution.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ExhaustiveSearch/bruteForceNQueens04.png" alt="bruteForceNQueens04">
</div>
</div>
<div class="paragraph">
<p>Notice that it creates a search tree that explodes exponentially as the problem size increases, so it hits a scalability wall.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Brute Force is mostly unusable for a real-world problem due to time limitations</strong>,
as shown in <a href="#scalabilityOfExhaustiveSearch">scalability of Exhaustive  Search</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="bruteForceConfiguration"><a class="anchor" href="#bruteForceConfiguration"></a><a class="link" href="#bruteForceConfiguration">11.2.2. Configuration</a></h4>
<div class="paragraph">
<p>Simplest configuration of Brute Force:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;solver&gt;
  ...
  &lt;exhaustiveSearch&gt;
    &lt;exhaustiveSearchType&gt;BRUTE_FORCE&lt;/exhaustiveSearchType&gt;
  &lt;/exhaustiveSearch&gt;
&lt;/solver&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="branchAndBound"><a class="anchor" href="#branchAndBound"></a><a class="link" href="#branchAndBound">11.3. Branch and bound</a></h3>
<div class="sect3">
<h4 id="branchAndBoundAlgorithm"><a class="anchor" href="#branchAndBoundAlgorithm"></a><a class="link" href="#branchAndBoundAlgorithm">11.3.1. Algorithm description</a></h4>
<div class="paragraph">
<p>Branch And Bound also explores nodes in an exponential search tree, but it investigates more promising nodes first and prunes away worthless nodes.</p>
</div>
<div class="paragraph">
<p>For each node, Branch And Bound calculates the optimistic bound: the best possible score to which that node can lead to.
If the optimistic bound of a node is lower or equal to the global pessimistic bound, then it prunes away that node (including the entire branch of all its subnodes).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Academic papers use the term lower bound instead of optimistic bound (and the term upper bound instead of pessimistic bound), because they minimize the score.</p>
</div>
<div class="paragraph">
<p>OptaPlanner maximizes the score (because it supports combining negative and positive constraints). Therefore, for clarity, it uses different terms, as it would be confusing to use the term lower bound for a bound which is always higher.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example: at index 14, it sets the global pessimistic bound to <code>-2</code>.
Because all solutions reachable from the node visited at index 11 will have a score lower or equal to <code>-2</code> (the node&#8217;s optimistic bound), they can be pruned away.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ExhaustiveSearch/depthFirstBranchAndBoundNQueens04.png" alt="depthFirstBranchAndBoundNQueens04">
</div>
</div>
<div class="paragraph">
<p>Notice that Branch And Bound (much like <a href="#bruteForce">Brute Force</a>) creates a search tree that explodes exponentially as the problem size increases.
So it hits the same scalability wall, only a little bit later.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Branch And Bound is mostly unusable for a real-world problem due to time limitations</strong>,
as shown in <a href="#scalabilityOfExhaustiveSearch">scalability of Exhaustive Search</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="branchAndBoundConfiguration"><a class="anchor" href="#branchAndBoundConfiguration"></a><a class="link" href="#branchAndBoundConfiguration">11.3.2. Configuration</a></h4>
<div class="paragraph">
<p>Simplest configuration of Branch And Bound:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;solver&gt;
  ...
  &lt;exhaustiveSearch&gt;
    &lt;exhaustiveSearchType&gt;BRANCH_AND_BOUND&lt;/exhaustiveSearchType&gt;
  &lt;/exhaustiveSearch&gt;
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For the pruning to work with the default <code>ScoreBounder</code>, the <a href="#initializingScoreTrend">InitializingScoreTrend</a> should be set.
Especially an <a href="#initializingScoreTrend">InitializingScoreTrend</a> of <code>ONLY_DOWN</code> (or at least has <code>ONLY_DOWN</code> in the leading score levels) prunes a lot.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;exhaustiveSearch&gt;
    &lt;exhaustiveSearchType&gt;BRANCH_AND_BOUND&lt;/exhaustiveSearchType&gt;
    &lt;nodeExplorationType&gt;DEPTH_FIRST&lt;/nodeExplorationType&gt;
    &lt;entitySorterManner&gt;DECREASING_DIFFICULTY_IF_AVAILABLE&lt;/entitySorterManner&gt;
    &lt;valueSorterManner&gt;INCREASING_STRENGTH_IF_AVAILABLE&lt;/valueSorterManner&gt;
  &lt;/exhaustiveSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>nodeExplorationType</code> options are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DEPTH_FIRST</code> (default): Explore deeper nodes first (and then a better score and then a better optimistic bound). Deeper nodes (especially leaf nodes) often improve the pessimistic bound. A better pessimistic bound allows pruning more nodes to reduce the search space.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;exhaustiveSearch&gt;
    &lt;exhaustiveSearchType&gt;BRANCH_AND_BOUND&lt;/exhaustiveSearchType&gt;
    &lt;nodeExplorationType&gt;DEPTH_FIRST&lt;/nodeExplorationType&gt;
  &lt;/exhaustiveSearch&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><code>BREADTH_FIRST</code> (not recommended): Explore nodes layer by layer (and then a better score and then a better optimistic bound). Scales terribly in memory (and usually in performance too).</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;exhaustiveSearch&gt;
    &lt;exhaustiveSearchType&gt;BRANCH_AND_BOUND&lt;/exhaustiveSearchType&gt;
    &lt;nodeExplorationType&gt;BREADTH_FIRST&lt;/nodeExplorationType&gt;
  &lt;/exhaustiveSearch&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><code>SCORE_FIRST</code>: Explore nodes with a better score first (and then a better optimistic bound and then deeper nodes first). Might scale as terribly as <code>BREADTH_FIRST</code> in some cases.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;exhaustiveSearch&gt;
    &lt;exhaustiveSearchType&gt;BRANCH_AND_BOUND&lt;/exhaustiveSearchType&gt;
    &lt;nodeExplorationType&gt;SCORE_FIRST&lt;/nodeExplorationType&gt;
  &lt;/exhaustiveSearch&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><code>OPTIMISTIC_BOUND_FIRST</code>: Explore nodes with a better optimistic bound first (and then a better score and then deeper nodes first). Might scale as terribly as <code>BREADTH_FIRST</code> in some cases.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;exhaustiveSearch&gt;
    &lt;exhaustiveSearchType&gt;BRANCH_AND_BOUND&lt;/exhaustiveSearchType&gt;
    &lt;nodeExplorationType&gt;OPTIMISTIC_BOUND_FIRST&lt;/nodeExplorationType&gt;
  &lt;/exhaustiveSearch&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>entitySorterManner</code> options are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DECREASING_DIFFICULTY</code>: Initialize the more difficult planning entities first. This usually increases pruning (and therefore improves scalability).
Requires the model to support <a href="#planningEntityDifficulty">planning entity difficulty comparison</a>.</p>
</li>
<li>
<p><code>DECREASING_DIFFICULTY_IF_AVAILABLE</code> (default): If the model supports <a href="#planningEntityDifficulty">planning entity difficulty comparison</a>, behave like <code>DECREASING_DIFFICULTY</code>, else like <code>NONE</code>.</p>
</li>
<li>
<p><code>NONE</code>: Initialize the planning entities in original order.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>valueSorterManner</code> options are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>INCREASING_STRENGTH</code>: Evaluate the planning values in increasing strength. Requires the model to support <a href="#planningValueStrength">planning value strength comparison</a>.</p>
</li>
<li>
<p><code>INCREASING_STRENGTH_IF_AVAILABLE</code> (default): If the model supports <a href="#planningValueStrength">planning value strength comparison</a>, behave like <code>INCREASING_STRENGTH</code>, else like <code>NONE</code>.</p>
</li>
<li>
<p><code>DECREASING_STRENGTH</code>: Evaluate the planning values in decreasing strength. Requires the model to support <a href="#planningValueStrength">planning value strength comparison</a>.</p>
</li>
<li>
<p><code>DECREASING_STRENGTH_IF_AVAILABLE</code>: If the model supports <a href="#planningValueStrength">planning value strength comparison</a>, behave like <code>DECREASING_STRENGTH</code>, else like <code>NONE</code>.</p>
</li>
<li>
<p><code>NONE</code>: Try the planning values in original order.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scalabilityOfExhaustiveSearch"><a class="anchor" href="#scalabilityOfExhaustiveSearch"></a><a class="link" href="#scalabilityOfExhaustiveSearch">11.4. Scalability of exhaustive search</a></h3>
<div class="paragraph">
<p>Exhaustive Search variants suffer from two big scalability issues:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>They scale terribly memory wise.</p>
</li>
<li>
<p>They scale horribly performance wise.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As shown in these time spent graphs from the <a href="#benchmarker">Benchmarker</a>, Brute Force and Branch And Bound both hit a performance scalability wall.
For example, on N queens it hits wall at a few dozen queens:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ExhaustiveSearch/exhaustiveSearchScalabilityNQueens.png" alt="exhaustiveSearchScalabilityNQueens">
</div>
</div>
<div class="paragraph">
<p>In most use cases, such as Cloud Balancing, the wall appears out of thin air:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ExhaustiveSearch/exhaustiveSearchScalabilityCloudBalance.png" alt="exhaustiveSearchScalabilityCloudBalance">
</div>
</div>
<div class="paragraph">
<p><strong>Exhaustive Search hits this wall on small datasets already, so in production these optimizations algorithms are mostly useless.</strong> Use Construction Heuristics with Local Search instead: those can handle thousands of queens/computers easily.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Throwing hardware at these scalability issues has no noticeable impact.
Newer and more hardware are just a drop in the ocean.
Moore&#8217;s law cannot win against the onslaught of a few more planning entities in the dataset.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="constructionHeuristics"><a class="anchor" href="#constructionHeuristics"></a><a class="link" href="#constructionHeuristics">12. Construction heuristics</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="constructionHeuristicsOverview"><a class="anchor" href="#constructionHeuristicsOverview"></a><a class="link" href="#constructionHeuristicsOverview">12.1. Overview</a></h3>
<div class="paragraph">
<p>A construction heuristic builds a pretty good initial solution in a finite length of time.
Its solution isn&#8217;t always feasible, but it finds it fast so metaheuristics can finish the job.</p>
</div>
<div class="paragraph">
<p>Construction heuristics terminate automatically, so there&#8217;s usually no need to configure a <code>Termination</code> on the construction heuristic phase specifically.</p>
</div>
</div>
<div class="sect2">
<h3 id="firstFit"><a class="anchor" href="#firstFit"></a><a class="link" href="#firstFit">12.2. First fit</a></h3>
<div class="sect3">
<h4 id="firstFitAlgorithm"><a class="anchor" href="#firstFitAlgorithm"></a><a class="link" href="#firstFitAlgorithm">12.2.1. Algorithm description</a></h4>
<div class="paragraph">
<p>The First Fit algorithm cycles through all the planning entities (in default order), initializing one planning entity at a time.
It assigns the planning entity to the best available planning value, taking the already initialized planning entities into account.
It terminates when all planning entities have been initialized.
It never changes a planning entity after it has been assigned.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ConstructionHeuristics/firstFitNQueens04.png" alt="firstFitNQueens04">
</div>
</div>
<div class="paragraph">
<p>Notice that it starts with putting <code>Queen</code> A into row 0 (and never moving it later), which makes it impossible to reach the optimal solution.
Suffixing this construction heuristic with metaheuristics can remedy that.</p>
</div>
</div>
<div class="sect3">
<h4 id="firstFitConfiguration"><a class="anchor" href="#firstFitConfiguration"></a><a class="link" href="#firstFitConfiguration">12.2.2. Configuration</a></h4>
<div class="paragraph">
<p>Simple configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;FIRST_FIT&lt;/constructionHeuristicType&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;FIRST_FIT&lt;/constructionHeuristicType&gt;
    &lt;...MoveSelector/&gt;
    &lt;...MoveSelector/&gt;
    ...
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For scaling out, see <a href="#scalingConstructionHeuristics">scaling construction heuristics</a>.
For a very advanced configuration, see <a href="#allocateEntityFromQueue">Allocate Entity From Queue</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="firstFitDecreasing"><a class="anchor" href="#firstFitDecreasing"></a><a class="link" href="#firstFitDecreasing">12.3. First fit decreasing</a></h3>
<div class="sect3">
<h4 id="firstFitDecreasingAlgorithm"><a class="anchor" href="#firstFitDecreasingAlgorithm"></a><a class="link" href="#firstFitDecreasingAlgorithm">12.3.1. Algorithm description</a></h4>
<div class="paragraph">
<p>Like <a href="#firstFit">First Fit</a>, but assigns the more difficult planning entities first, because they are less likely to fit in the leftovers.
So it sorts the planning entities on decreasing difficulty.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ConstructionHeuristics/firstFitDecreasingNQueens04.png" alt="firstFitDecreasingNQueens04">
</div>
</div>
<div class="paragraph">
<p>Requires the model to support <a href="#planningEntityDifficulty">planning entity difficulty comparison</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>One would expect that this algorithm has better results than First Fit.
That&#8217;s usually the case, but not always.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="firstFitDecreasingConfiguration"><a class="anchor" href="#firstFitDecreasingConfiguration"></a><a class="link" href="#firstFitDecreasingConfiguration">12.3.2. Configuration</a></h4>
<div class="paragraph">
<p>Simple configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;FIRST_FIT_DECREASING&lt;/constructionHeuristicType&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;FIRST_FIT_DECREASING&lt;/constructionHeuristicType&gt;
    &lt;...MoveSelector/&gt;
    &lt;...MoveSelector/&gt;
    ...
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For scaling out, see <a href="#scalingConstructionHeuristics">scaling construction heuristics</a>.
For a very advanced configuration, see <a href="#allocateEntityFromQueue">Allocate Entity From Queue</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="weakestFit"><a class="anchor" href="#weakestFit"></a><a class="link" href="#weakestFit">12.4. Weakest fit</a></h3>
<div class="sect3">
<h4 id="weakestFitAlgorithm"><a class="anchor" href="#weakestFitAlgorithm"></a><a class="link" href="#weakestFitAlgorithm">12.4.1. Algorithm description</a></h4>
<div class="paragraph">
<p>Like First Fit, but uses the weaker planning values first, because the strong planning values are more likely to be able to accommodate later planning entities.
So it sorts the planning values on increasing strength.</p>
</div>
<div class="paragraph">
<p>Requires the model to support <a href="#planningValueStrength">planning value strength comparison</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not presume that this algorithm has better results than First Fit.
That&#8217;s often not the case.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="weakestFitConfiguration"><a class="anchor" href="#weakestFitConfiguration"></a><a class="link" href="#weakestFitConfiguration">12.4.2. Configuration</a></h4>
<div class="paragraph">
<p>Simple configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;WEAKEST_FIT&lt;/constructionHeuristicType&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;WEAKEST_FIT&lt;/constructionHeuristicType&gt;
    &lt;...MoveSelector/&gt;
    &lt;...MoveSelector/&gt;
    ...
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For scaling out, see <a href="#scalingConstructionHeuristics">scaling construction heuristics</a>.
For a very advanced configuration, see <a href="#allocateEntityFromQueue">Allocate Entity From Queue</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="weakestFitDecreasing"><a class="anchor" href="#weakestFitDecreasing"></a><a class="link" href="#weakestFitDecreasing">12.5. Weakest fit decreasing</a></h3>
<div class="sect3">
<h4 id="weakestFitDecreasingAlgorithm"><a class="anchor" href="#weakestFitDecreasingAlgorithm"></a><a class="link" href="#weakestFitDecreasingAlgorithm">12.5.1. Algorithm description</a></h4>
<div class="paragraph">
<p>Combines First Fit Decreasing and Weakest Fit.
So it sorts the planning entities on decreasing difficulty and the planning values on increasing strength.</p>
</div>
<div class="paragraph">
<p>Requires the model to support <a href="#planningEntityDifficulty">planning entity difficulty comparison</a>
and <a href="#planningValueStrength">planning value strength comparison</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not presume that this algorithm has better results than First Fit Decreasing.
That&#8217;s often not the case.
However, it is usually better than Weakest Fit.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="weakestFitDecreasingConfiguration"><a class="anchor" href="#weakestFitDecreasingConfiguration"></a><a class="link" href="#weakestFitDecreasingConfiguration">12.5.2. Configuration</a></h4>
<div class="paragraph">
<p>Simple configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;WEAKEST_FIT_DECREASING&lt;/constructionHeuristicType&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;WEAKEST_FIT_DECREASING&lt;/constructionHeuristicType&gt;
    &lt;...MoveSelector/&gt;
    &lt;...MoveSelector/&gt;
    ...
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For scaling out, see <a href="#scalingConstructionHeuristics">scaling construction heuristics</a>.
For a very advanced configuration, see <a href="#allocateEntityFromQueue">Allocate Entity From Queue</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="strongestFit"><a class="anchor" href="#strongestFit"></a><a class="link" href="#strongestFit">12.6. Strongest fit</a></h3>
<div class="sect3">
<h4 id="strongestFitAlgorithm"><a class="anchor" href="#strongestFitAlgorithm"></a><a class="link" href="#strongestFitAlgorithm">12.6.1. Algorithm description</a></h4>
<div class="paragraph">
<p>Like First Fit, but uses the strong planning values first, because the strong planning values are more likely to have a lower soft cost to use.
So it sorts the planning values on decreasing strength.</p>
</div>
<div class="paragraph">
<p>Requires the model to support <a href="#planningValueStrength">planning value strength comparison</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not presume that this algorithm has better results than First Fit or Weakest Fit.
That&#8217;s often not the case.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="strongestFitConfiguration"><a class="anchor" href="#strongestFitConfiguration"></a><a class="link" href="#strongestFitConfiguration">12.6.2. Configuration</a></h4>
<div class="paragraph">
<p>Simple configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;STRONGEST_FIT&lt;/constructionHeuristicType&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;STRONGEST_FIT&lt;/constructionHeuristicType&gt;
    &lt;...MoveSelector/&gt;
    &lt;...MoveSelector/&gt;
    ...
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For scaling out, see <a href="#scalingConstructionHeuristics">scaling construction heuristics</a>.
For a very advanced configuration, see <a href="#allocateEntityFromQueue">Allocate Entity From Queue</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="strongestFitDecreasing"><a class="anchor" href="#strongestFitDecreasing"></a><a class="link" href="#strongestFitDecreasing">12.7. Strongest fit decreasing</a></h3>
<div class="sect3">
<h4 id="strongestFitDecreasingAlgorithm"><a class="anchor" href="#strongestFitDecreasingAlgorithm"></a><a class="link" href="#strongestFitDecreasingAlgorithm">12.7.1. Algorithm description</a></h4>
<div class="paragraph">
<p>Combines First Fit Decreasing and Strongest Fit.
So it sorts the planning entities on decreasing difficulty and the planning values on decreasing strength.</p>
</div>
<div class="paragraph">
<p>Requires the model to support <a href="#planningEntityDifficulty">planning entity difficulty comparison</a>
and <a href="#planningValueStrength">planning value strength comparison</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not presume that this algorithm has better results than First Fit Decreasing or Weakest Fit Decreasing.
That&#8217;s often not the case.
However, it is usually better than Strongest Fit.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="strongestFitDecreasingConfiguration"><a class="anchor" href="#strongestFitDecreasingConfiguration"></a><a class="link" href="#strongestFitDecreasingConfiguration">12.7.2. Configuration</a></h4>
<div class="paragraph">
<p>Simple configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;STRONGEST_FIT_DECREASING&lt;/constructionHeuristicType&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;STRONGEST_FIT_DECREASING&lt;/constructionHeuristicType&gt;
    &lt;...MoveSelector/&gt;
    &lt;...MoveSelector/&gt;
    ...
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For scaling out, see <a href="#scalingConstructionHeuristics">scaling construction heuristics</a>.
For a very advanced configuration, see <a href="#allocateEntityFromQueue">Allocate Entity From Queue</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="allocateEntityFromQueue"><a class="anchor" href="#allocateEntityFromQueue"></a><a class="link" href="#allocateEntityFromQueue">12.8. Allocate entity from queue</a></h3>
<div class="sect3">
<h4 id="allocateEntityFromQueueAlgorithm"><a class="anchor" href="#allocateEntityFromQueueAlgorithm"></a><a class="link" href="#allocateEntityFromQueueAlgorithm">12.8.1. Algorithm description</a></h4>
<div class="paragraph">
<p>Allocate Entity From Queue is a versatile, generic form of <a href="#firstFit">First Fit</a>, <a href="#firstFitDecreasing">First Fit Decreasing</a>,
<a href="#weakestFit">Weakest Fit</a>, <a href="#weakestFitDecreasing">Weakest Fit Decreasing</a>,
<a href="#strongestFit">Strongest Fit</a> and <a href="#strongestFitDecreasing">Strongest Fit Decreasing</a>.
It works like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Put all entities in a queue.</p>
</li>
<li>
<p>Assign the first entity (from that queue) to the best value.</p>
</li>
<li>
<p>Repeat until all entities are assigned.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="allocateEntityFromQueueConfiguration"><a class="anchor" href="#allocateEntityFromQueueConfiguration"></a><a class="link" href="#allocateEntityFromQueueConfiguration">12.8.2. Configuration</a></h4>
<div class="paragraph">
<p>Simple configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;ALLOCATE_ENTITY_FROM_QUEUE&lt;/constructionHeuristicType&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verbose simple configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;ALLOCATE_ENTITY_FROM_QUEUE&lt;/constructionHeuristicType&gt;
    &lt;entitySorterManner&gt;DECREASING_DIFFICULTY_IF_AVAILABLE&lt;/entitySorterManner&gt;
    &lt;valueSorterManner&gt;INCREASING_STRENGTH_IF_AVAILABLE&lt;/valueSorterManner&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>entitySorterManner</code> options are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DECREASING_DIFFICULTY</code>: Initialize the more difficult planning entities first.
This usually increases pruning (and therefore improves scalability).
Requires the model to support <a href="#planningEntityDifficulty">planning entity difficulty comparison</a>.</p>
</li>
<li>
<p><code>DECREASING_DIFFICULTY_IF_AVAILABLE</code> (default): If the model supports <a href="#planningEntityDifficulty">planning entity difficulty comparison</a>, behave like <code>DECREASING_DIFFICULTY</code>, else like <code>NONE</code>.</p>
</li>
<li>
<p><code>NONE</code>: Initialize the planning entities in original order.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>valueSorterManner</code> options are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>INCREASING_STRENGTH</code>: Evaluate the planning values in increasing strength.
Requires the model to support <a href="#planningValueStrength">planning value strength comparison</a>.</p>
</li>
<li>
<p><code>INCREASING_STRENGTH_IF_AVAILABLE</code> (default): If the model supports <a href="#planningValueStrength">planning value strength comparison</a>, behave like <code>INCREASING_STRENGTH</code>, else like <code>NONE</code>.</p>
</li>
<li>
<p><code>DECREASING_STRENGTH</code>: Evaluate the planning values in decreasing strength.
Requires the model to support <a href="#planningValueStrength">planning value strength comparison</a>.</p>
</li>
<li>
<p><code>DECREASING_STRENGTH_IF_AVAILABLE</code>: If the model supports <a href="#planningValueStrength">planning value strength comparison</a>, behave like <code>DECREASING_STRENGTH</code>, else like <code>NONE</code>.</p>
</li>
<li>
<p><code>NONE</code>: Try the planning values in original order.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Advanced configuration with <a href="#weakestFitDecreasing">Weakest Fit Decreasing</a> for a single entity class with one variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;queuedEntityPlacer&gt;
      &lt;entitySelector id="placerEntitySelector"&gt;
        &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
        &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
        &lt;sorterManner&gt;DECREASING_DIFFICULTY&lt;/sorterManner&gt;
      &lt;/entitySelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;entitySelector mimicSelectorRef="placerEntitySelector"/&gt;
        &lt;valueSelector&gt;
          &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
          &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
          &lt;sorterManner&gt;INCREASING_STRENGTH&lt;/sorterManner&gt;
        &lt;/valueSelector&gt;
      &lt;/changeMoveSelector&gt;
    &lt;/queuedEntityPlacer&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Per step, the <code>QueuedEntityPlacer</code> selects one uninitialized entity from the <code>EntitySelector</code>
and applies the winning <code>Move</code> (out of all the moves for that entity generated by the <code>MoveSelector</code>).
The <a href="#mimicSelection">mimic selection</a> ensures that the winning <code>Move</code> changes only the selected entity.</p>
</div>
<div class="paragraph">
<p>To customize the entity or value sorting, see <a href="#sortedSelection">sorted selection</a>.
For scaling out, see <a href="#scalingConstructionHeuristics">scaling construction heuristics</a>.</p>
</div>
<div class="paragraph">
<p>If there are multiple planning variables, there&#8217;s one <code>ChangeMoveSelector</code> per planning variable,
which are either in a cartesian product or in sequential steps,
similar to <a href="#scalingMultiplePlanningVariablesInConstructionHeuristics">the less verbose configuration</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="allocateEntityFromQueueMultipleEntityClasses"><a class="anchor" href="#allocateEntityFromQueueMultipleEntityClasses"></a><a class="link" href="#allocateEntityFromQueueMultipleEntityClasses">12.8.3. Multiple entity classes</a></h4>
<div class="paragraph">
<p>The easiest way to deal with multiple entity classes is to run a separate Construction Heuristic for each entity class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;queuedEntityPlacer&gt;
      &lt;entitySelector id="placerEntitySelector"&gt;
        &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
        &lt;entityClass&gt;...DogEntity&lt;/entityClass&gt;
      &lt;/entitySelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;entitySelector mimicSelectorRef="placerEntitySelector"/&gt;
      &lt;/changeMoveSelector&gt;
    &lt;/queuedEntityPlacer&gt;
    ...
  &lt;/constructionHeuristic&gt;
  &lt;constructionHeuristic&gt;
    &lt;queuedEntityPlacer&gt;
      &lt;entitySelector id="placerEntitySelector"&gt;
        &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
        &lt;entityClass&gt;...CatEntity&lt;/entityClass&gt;
      &lt;/entitySelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;entitySelector mimicSelectorRef="placerEntitySelector"/&gt;
      &lt;/changeMoveSelector&gt;
    &lt;/queuedEntityPlacer&gt;
    ...
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="constructionHeuristicsPickEarlyType"><a class="anchor" href="#constructionHeuristicsPickEarlyType"></a><a class="link" href="#constructionHeuristicsPickEarlyType">12.8.4. Pick early type</a></h4>
<div class="paragraph">
<p>There are several pick early types for Construction Heuristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>NEVER</code>: Evaluate all the selected moves to initialize the variable(s).
This is the default if the <a href="#initializingScoreTrend">InitializingScoreTrend</a> is not <code>ONLY_DOWN</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    ...
    &lt;forager&gt;
      &lt;pickEarlyType&gt;NEVER&lt;/pickEarlyType&gt;
    &lt;/forager&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><code>FIRST_NON_DETERIORATING_SCORE</code>: Initialize the variable(s) with the first move that doesn&#8217;t deteriorate the score, ignore the remaining selected moves.
This is the default if the <a href="#initializingScoreTrend">InitializingScoreTrend</a> is <code>ONLY_DOWN</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    ...
    &lt;forager&gt;
      &lt;pickEarlyType&gt;FIRST_NON_DETERIORATING_SCORE&lt;/pickEarlyType&gt;
    &lt;/forager&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If there are only negative constraints, but the <a href="#initializingScoreTrend">InitializingScoreTrend</a> is strictly not <code>ONLY_DOWN</code>,
it can sometimes make sense to apply FIRST_NON_DETERIORATING_SCORE.
Use the <a href="#benchmarker">Benchmarker</a> to decide if the score quality loss is worth the time gain.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p><code>FIRST_FEASIBLE_SCORE</code>: Initialize the variable(s) with the first move that has a feasible score.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    ...
    &lt;forager&gt;
      &lt;pickEarlyType&gt;FIRST_FEASIBLE_SCORE&lt;/pickEarlyType&gt;
    &lt;/forager&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <a href="#initializingScoreTrend">InitializingScoreTrend</a> is <code>ONLY_DOWN</code>, use <code>FIRST_FEASIBLE_SCORE_OR_NON_DETERIORATING_HARD</code> instead, because that&#8217;s faster without any disadvantages.</p>
</div>
</li>
<li>
<p><code>FIRST_FEASIBLE_SCORE_OR_NON_DETERIORATING_HARD</code>: Initialize the variable(s) with the first move that doesn&#8217;t deteriorate the feasibility of the score any further.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    ...
    &lt;forager&gt;
      &lt;pickEarlyType&gt;FIRST_FEASIBLE_SCORE_OR_NON_DETERIORATING_HARD&lt;/pickEarlyType&gt;
    &lt;/forager&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="allocateToValueFromQueue"><a class="anchor" href="#allocateToValueFromQueue"></a><a class="link" href="#allocateToValueFromQueue">12.9. Allocate to value from queue</a></h3>
<div class="sect3">
<h4 id="allocateToValueFromQueueAlgorithm"><a class="anchor" href="#allocateToValueFromQueueAlgorithm"></a><a class="link" href="#allocateToValueFromQueueAlgorithm">12.9.1. Algorithm description</a></h4>
<div class="paragraph">
<p>Allocate To Value From Queue works like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Put all values in a round-robin queue.</p>
</li>
<li>
<p>Assign the best entity to the first value (from that queue).</p>
</li>
<li>
<p>Repeat until all entities are assigned.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="allocateToValueFromQueueConfiguration"><a class="anchor" href="#allocateToValueFromQueueConfiguration"></a><a class="link" href="#allocateToValueFromQueueConfiguration">12.9.2. Configuration</a></h4>
<div class="paragraph">
<p>Simple configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;ALLOCATE_TO_VALUE_FROM_QUEUE&lt;/constructionHeuristicType&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verbose simple configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;ALLOCATE_TO_VALUE_FROM_QUEUE&lt;/constructionHeuristicType&gt;
    &lt;entitySorterManner&gt;DECREASING_DIFFICULTY_IF_AVAILABLE&lt;/entitySorterManner&gt;
    &lt;valueSorterManner&gt;INCREASING_STRENGTH_IF_AVAILABLE&lt;/valueSorterManner&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration for a single entity class with a single variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;queuedValuePlacer&gt;
      &lt;valueSelector id="placerValueSelector"&gt;
        &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
        &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
        &lt;sorterManner&gt;INCREASING_STRENGTH&lt;/sorterManner&gt;
      &lt;/valueSelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;entitySelector&gt;
          &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
          &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
          &lt;sorterManner&gt;DECREASING_DIFFICULTY&lt;/sorterManner&gt;
        &lt;/entitySelector&gt;
        &lt;valueSelector mimicSelectorRef="placerValueSelector"/&gt;
      &lt;/changeMoveSelector&gt;
    &lt;/queuedValuePlacer&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For scaling out, see <a href="#scalingConstructionHeuristics">scaling construction heuristics</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cheapestInsertion"><a class="anchor" href="#cheapestInsertion"></a><a class="link" href="#cheapestInsertion">12.10. Cheapest insertion</a></h3>
<div class="sect3">
<h4 id="cheapestInsertionAlgorithm"><a class="anchor" href="#cheapestInsertionAlgorithm"></a><a class="link" href="#cheapestInsertionAlgorithm">12.10.1. Algorithm description</a></h4>
<div class="paragraph">
<p>The Cheapest Insertion algorithm cycles through all the planning values for all the planning entities, initializing one planning entity at a time.
It assigns a planning entity to the best available planning value (out of all the planning entities and values), taking the already initialized planning entities into account.
It terminates when all planning entities have been initialized.
It never changes a planning entity after it has been assigned.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ConstructionHeuristics/cheapestInsertionNQueens04.png" alt="cheapestInsertionNQueens04">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Cheapest Insertion scales considerably worse than First Fit, etc.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="cheapestInsertionConfiguration"><a class="anchor" href="#cheapestInsertionConfiguration"></a><a class="link" href="#cheapestInsertionConfiguration">12.10.2. Configuration</a></h4>
<div class="paragraph">
<p>Simple configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;CHEAPEST_INSERTION&lt;/constructionHeuristicType&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;CHEAPEST_INSERTION&lt;/constructionHeuristicType&gt;
    &lt;...MoveSelector/&gt;
    &lt;...MoveSelector/&gt;
    ...
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For scaling out, see <a href="#scalingConstructionHeuristics">scaling construction heuristics</a>.
For a very advanced configuration, see <a href="#allocateFromPool">Allocate from pool</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="regretInsertion"><a class="anchor" href="#regretInsertion"></a><a class="link" href="#regretInsertion">12.11. Regret insertion</a></h3>
<div class="sect3">
<h4 id="regretInsertionAlgorithm"><a class="anchor" href="#regretInsertionAlgorithm"></a><a class="link" href="#regretInsertionAlgorithm">12.11.1. Algorithm description</a></h4>
<div class="paragraph">
<p>The Regret Insertion algorithm behaves like the Cheapest Insertion algorithm.
It also cycles through all the planning values for all the planning entities, initializing one planning entity at a time.
But instead of picking the entity-value combination with the best score, it picks the entity which has the largest score loss between its best and second best value assignment.
It then assigns that entity to its best value, to avoid regretting not having done that.</p>
</div>
</div>
<div class="sect3">
<h4 id="regretInsertionConfiguration"><a class="anchor" href="#regretInsertionConfiguration"></a><a class="link" href="#regretInsertionConfiguration">12.11.2. Configuration</a></h4>
<div class="paragraph">
<p>This algorithm has not been implemented yet.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="allocateFromPool"><a class="anchor" href="#allocateFromPool"></a><a class="link" href="#allocateFromPool">12.12. Allocate from pool</a></h3>
<div class="sect3">
<h4 id="allocateFromPoolAlgorithm"><a class="anchor" href="#allocateFromPoolAlgorithm"></a><a class="link" href="#allocateFromPoolAlgorithm">12.12.1. Algorithm description</a></h4>
<div class="paragraph">
<p>Allocate From Pool is a versatile, generic form of <a href="#cheapestInsertion">Cheapest Insertion</a> and <a href="#regretInsertion">Regret Insertion</a>.
It works like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Put all entity-value combinations in a pool.</p>
</li>
<li>
<p>Assign the best entity to best value.</p>
</li>
<li>
<p>Repeat until all entities are assigned.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="allocateFromPoolConfiguration"><a class="anchor" href="#allocateFromPoolConfiguration"></a><a class="link" href="#allocateFromPoolConfiguration">12.12.2. Configuration</a></h4>
<div class="paragraph">
<p>Simple configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;ALLOCATE_FROM_POOL&lt;/constructionHeuristicType&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verbose simple configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;ALLOCATE_FROM_POOL&lt;/constructionHeuristicType&gt;
    &lt;entitySorterManner&gt;DECREASING_DIFFICULTY_IF_AVAILABLE&lt;/entitySorterManner&gt;
    &lt;valueSorterManner&gt;INCREASING_STRENGTH_IF_AVAILABLE&lt;/valueSorterManner&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>entitySorterManner</code> and <code>valueSorterManner</code> options are described in <a href="#allocateEntityFromQueue">Allocate Entity From Queue</a>.</p>
</div>
<div class="paragraph">
<p>Advanced configuration with <a href="#cheapestInsertion">Cheapest Insertion</a> for a single entity class with a single variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;pooledEntityPlacer&gt;
      &lt;changeMoveSelector&gt;
        &lt;entitySelector id="placerEntitySelector"&gt;
          &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
          &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
          &lt;sorterManner&gt;DECREASING_DIFFICULTY&lt;/sorterManner&gt;
        &lt;/entitySelector&gt;
        &lt;valueSelector&gt;
          &lt;cacheType&gt;PHASE&lt;/cacheType&gt;
          &lt;selectionOrder&gt;SORTED&lt;/selectionOrder&gt;
          &lt;sorterManner&gt;INCREASING_STRENGTH&lt;/sorterManner&gt;
        &lt;/valueSelector&gt;
      &lt;/changeMoveSelector&gt;
    &lt;/pooledEntityPlacer&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Per step, the <code>PooledEntityPlacer</code> applies the winning <code>Move</code> (out of all the moves for that entity generated by the <code>MoveSelector</code>).</p>
</div>
<div class="paragraph">
<p>To customize the entity or value sorting, see <a href="#sortedSelection">sorted selection</a>.
Other <code>Selector</code> customization (such as <a href="#filteredSelection">filtering</a> and <a href="#limitedSelection">limiting</a>) is supported too.</p>
</div>
<div class="paragraph">
<p>For scaling out, see <a href="#scalingConstructionHeuristics">scaling construction heuristics</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scalingConstructionHeuristics"><a class="anchor" href="#scalingConstructionHeuristics"></a><a class="link" href="#scalingConstructionHeuristics">12.13. Scaling construction heuristics</a></h3>
<div class="paragraph">
<p>If the Construction Heuristic takes a long time to solve and create an initial solution,
there is too little time left for <a href="#localSearch">Local Search</a> to reach a near optimal solution.</p>
</div>
<div class="paragraph">
<p>Ideally, a Construction Heuristic should take less than 20 seconds from scratch
and less than 50 milliseconds in <a href="#realTimePlanning">real-time planning</a>,
so there is plenty of time left for <a href="#localSearch">Local Search</a>.
If the <a href="#benchmarker">Benchmarker</a> proves that this is not the case, there&#8217;s a number of improvements that can be done:</p>
</div>
<div class="sect3">
<h4 id="initializingScoreTrendShortcuts"><a class="anchor" href="#initializingScoreTrendShortcuts"></a><a class="link" href="#initializingScoreTrendShortcuts">12.13.1. InitializingScoreTrend shortcuts</a></h4>
<div class="paragraph">
<p>If the <a href="#initializingScoreTrend">InitializingScoreTrend</a> is <code>ONLY_DOWN</code>, a Construction Heuristic algorithm (such as First Fit) is faster:
for an entity, it picks the first move for which the score does not deteriorate the last step score, ignoring all subsequent moves in that step.</p>
</div>
<div class="paragraph">
<p>It can take that shortcut without reducing solution quality,
because a down trend guarantees that initializing any additional planning variable can only make the score the same or worse.
So if a move has the same score as before the planning variable was initialized, then no other move can have a better score.</p>
</div>
</div>
<div class="sect3">
<h4 id="scalingMultiplePlanningVariablesInConstructionHeuristics"><a class="anchor" href="#scalingMultiplePlanningVariablesInConstructionHeuristics"></a><a class="link" href="#scalingMultiplePlanningVariablesInConstructionHeuristics">12.13.2. Scaling multiple planning variables in construction heuristics</a></h4>
<div class="paragraph">
<p>There are two ways to deal with multiple planning variables,
depending on how their <code>ChangeMove</code>s are combined:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Cartesian product</strong> (default): All variables of the selected entity are assigned together.
This usually results in a better solution quality, but it scales poorly because it tries every combination of variables. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;FIRST_FIT_DECREASING&lt;/constructionHeuristicType&gt;
    &lt;cartesianProductMoveSelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;valueSelector variableName="period"/&gt;
      &lt;/changeMoveSelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;valueSelector variableName="room"/&gt;
      &lt;/changeMoveSelector&gt;
    &lt;/cartesianProductMoveSelector&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Sequential</strong>: One variable is assigned at a time.
Scales better, at the cost of solution quality. The order of the planning variables matters. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;FIRST_FIT_DECREASING&lt;/constructionHeuristicType&gt;
    &lt;changeMoveSelector&gt;
      &lt;valueSelector variableName="period"/&gt;
    &lt;/changeMoveSelector&gt;
    &lt;changeMoveSelector&gt;
      &lt;valueSelector variableName="room"/&gt;
    &lt;/changeMoveSelector&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The second way scales better, so it can be worth to switch to it.
For example, in a course scheduling example with 200 rooms and 40 periods,
a cartesian product selects 8&#160;000 moves per entity (1 step per entity).
On the other hand, a sequential approach only selects 240 moves per entity (2 steps per entity),
ending the Construction Heuristic 3 times faster.
Especially for three or more planning variables, the scaling difference is huge.
For example, with three variables of 1&#160;000 values each,
a cartesian product selects 1&#160;000&#160;000&#160;000 moves per entity (1 step per entity).
A sequential approach only selects 3&#160;000 moves per entity (3 steps per entity),
ending the Construction Heuristic 300&#160;000 times faster.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./ConstructionHeuristics/multiVariableConstructionHeuristics.png" alt="multiVariableConstructionHeuristics">
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The order of the variables is important, especially in the sequential technique.
In the sequential example above, it&#8217;s better to select the <code>period</code> first and the <code>room</code> second (instead of the other way around),
because there are more hard constraints that do not involve the room, such as <em>no teacher should teach two lectures at the same time</em>.</p>
</div>
<div class="paragraph">
<p>Let the <a href="#benchmarker">Benchmarker</a> guide you.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With three or more variables, it&#8217;s possible to combine the cartesian product and sequential techniques:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;constructionHeuristic&gt;
    &lt;constructionHeuristicType&gt;FIRST_FIT_DECREASING&lt;/constructionHeuristicType&gt;
    &lt;cartesianProductMoveSelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;valueSelector variableName="period"/&gt;
      &lt;/changeMoveSelector&gt;
      &lt;changeMoveSelector&gt;
        &lt;valueSelector variableName="room"/&gt;
      &lt;/changeMoveSelector&gt;
    &lt;/cartesianProductMoveSelector&gt;
    &lt;changeMoveSelector&gt;
      &lt;valueSelector variableName="teacher"/&gt;
    &lt;/changeMoveSelector&gt;
  &lt;/constructionHeuristic&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="otherScalingTechniquesInConstructionHeuristics"><a class="anchor" href="#otherScalingTechniquesInConstructionHeuristics"></a><a class="link" href="#otherScalingTechniquesInConstructionHeuristics">12.13.3. Other scaling techniques in construction heuristics</a></h4>
<div class="paragraph">
<p><a href="#partitionedSearch">Partitioned Search</a> reduces the number of moves per step.
On top of that, it runs the Construction Heuristic on the partitions in parallel.
It is supported to only partition the Construction Heuristic phase.</p>
</div>
<div class="paragraph">
<p>Other <code>Selector</code> customizations can also reduce the number of moves generated by step:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#filteredSelection">Filtered selection</a></p>
</li>
<li>
<p><a href="#limitedSelection">Limited selection</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="localSearch"><a class="anchor" href="#localSearch"></a><a class="link" href="#localSearch">13. Local search</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="localSearchOverview"><a class="anchor" href="#localSearchOverview"></a><a class="link" href="#localSearchOverview">13.1. Overview</a></h3>
<div class="paragraph">
<p>Local Search starts from an initial solution and evolves that single solution into a mostly better and better solution.
It uses a single search path of solutions, not a search tree.
At each solution in this path it evaluates a number of moves on the solution and applies the most suitable move to take the step to the next solution.
It does that for a high number of iterations until it&#8217;s terminated (usually because its time has run out).</p>
</div>
<div class="paragraph">
<p>Local Search acts a lot like a human planner: it uses a single search path and moves facts around to find a good feasible solution.
Therefore it&#8217;s pretty natural to implement.</p>
</div>
<div class="paragraph">
<p><strong>Local Search needs to start from an initialized solution</strong>, therefore it&#8217;s usually required to configure a Construction Heuristic phase before it.</p>
</div>
</div>
<div class="sect2">
<h3 id="localSearchConcepts"><a class="anchor" href="#localSearchConcepts"></a><a class="link" href="#localSearchConcepts">13.2. Local search concepts</a></h3>
<div class="sect3">
<h4 id="localSearchStepByStep"><a class="anchor" href="#localSearchStepByStep"></a><a class="link" href="#localSearchStepByStep">13.2.1. Step by step</a></h4>
<div class="paragraph">
<p>A step is the winning <code>Move</code>.
Local Search tries a number of moves on the current solution and picks the best accepted move as the step:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./LocalSearch/decideNextStepNQueens04.png" alt="decideNextStepNQueens04">
</div>
<div class="title">Figure 6. Decide the next step at step 0 (four queens example)</div>
</div>
<div class="paragraph">
<p>Because the move <em>B0 to B3</em> has the highest score (<code>-3</code>), it is picked as the next step.
If multiple moves have the same highest score, one is picked randomly, in this case <em>B0 to B3</em>.
Note that <em>C0 to C3</em> (not shown) could also have been picked because it also has the score <code>-3</code>.</p>
</div>
<div class="paragraph">
<p>The step is applied on the solution.
From that new solution, Local Search tries every move again, to decide the next step after that.
It continually does this in a loop, and we get something like this:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./LocalSearch/allStepsNQueens04.png" alt="allStepsNQueens04">
</div>
<div class="title">Figure 7. All steps (four queens example)</div>
</div>
<div class="paragraph">
<p>Notice that Local Search doesn&#8217;t use a search tree, but a search path.
The search path is highlighted by the green arrows.
At each step it tries all selected moves, but unless it&#8217;s the step, it doesn&#8217;t investigate that solution further.
This is one of the reasons why Local Search is very scalable.</p>
</div>
<div class="paragraph">
<p>As shown above, Local Search solves the four queens problem by starting with the starting solution and make the following steps sequentially:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>B0 to B3</em></p>
</li>
<li>
<p><em>D0 to B2</em></p>
</li>
<li>
<p><em>A0 to B1</em></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Turn on <code>debug</code> logging for the category <code>org.optaplanner</code> to show those steps in the log:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">INFO  Solving started: time spent (0), best score (-6), environment mode (REPRODUCIBLE), random (JDK with seed 0).
DEBUG     LS step (0), time spent (20), score (-3), new best score (-3), accepted/selected move count (12/12), picked move (Queen-1 {Row-0 -&gt; Row-3}).
DEBUG     LS step (1), time spent (31), score (-1), new best score (-1), accepted/selected move count (12/12), picked move (Queen-3 {Row-0 -&gt; Row-2}).
DEBUG     LS step (2), time spent (40), score (0), new best score (0), accepted/selected move count (12/12), picked move (Queen-0 {Row-0 -&gt; Row-1}).
INFO  Local Search phase (0) ended: time spent (41), best score (0), score calculation speed (5000/sec), step total (3).
INFO  Solving ended: time spent (41), best score (0), score calculation speed (5000/sec), phase total (1), environment mode (REPRODUCIBLE).</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that a log message includes the <code>toString()</code> method of the <code>Move</code> implementation which returns for example "<code>Queen-1 {Row-0 &#8594; Row-3}</code>".</p>
</div>
<div class="paragraph">
<p>A naive Local Search configuration solves the four queens problem in three steps, by evaluating only 37 possible solutions (three steps with 12 moves each + one starting solution), which is only a fraction of all 256 possible solutions.
It solves 16 queens in 31 steps, by evaluating only 7441 out of 18446744073709551616 possible solutions.
By using a <a href="#constructionHeuristics">Construction Heuristics</a> phase first, it&#8217;s even a lot more efficient.</p>
</div>
</div>
<div class="sect3">
<h4 id="localSearchConceptsDecideTheNextStep"><a class="anchor" href="#localSearchConceptsDecideTheNextStep"></a><a class="link" href="#localSearchConceptsDecideTheNextStep">13.2.2. Decide the next step</a></h4>
<div class="paragraph">
<p>Local Search decides the next step with the aid of three configurable components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>MoveSelector</code> which selects the possible moves of the current solution. See the chapter <a href="#moveAndNeighborhoodSelection">move and neighborhood selection</a>.</p>
</li>
<li>
<p>An <code>Acceptor</code> which filters out unacceptable moves.</p>
</li>
<li>
<p>A <code>Forager</code> which gathers accepted moves and picks the next step from them.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The solver phase configuration looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    &lt;unionMoveSelector&gt;
      ...
    &lt;/unionMoveSelector&gt;
    &lt;acceptor&gt;
      ...
    &lt;/acceptor&gt;
    &lt;forager&gt;
      ...
    &lt;/forager&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example below, the <code>MoveSelector</code> generated the moves shown with the blue lines, the <code>Acceptor</code> accepted all of them and the <code>Forager</code> picked the move <em>B0 to B3</em>.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./LocalSearch/decideNextStepNQueens04.png" alt="decideNextStepNQueens04">
</div>
</div>
<div class="paragraph">
<p><a href="#logging">Turn on <code>trace</code> logging</a> to show the decision making in the log:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">INFO  Solver started: time spent (0), score (-6), new best score (-6), random (JDK with seed 0).
TRACE         Move index (0) not doable, ignoring move (Queen-0 {Row-0 -&gt; Row-0}).
TRACE         Move index (1), score (-4), accepted (true), move (Queen-0 {Row-0 -&gt; Row-1}).
TRACE         Move index (2), score (-4), accepted (true), move (Queen-0 {Row-0 -&gt; Row-2}).
TRACE         Move index (3), score (-4), accepted (true), move (Queen-0 {Row-0 -&gt; Row-3}).
...
TRACE         Move index (6), score (-3), accepted (true), move (Queen-1 {Row-0 -&gt; Row-3}).
...
TRACE         Move index (9), score (-3), accepted (true), move (Queen-2 {Row-0 -&gt; Row-3}).
...
TRACE         Move index (12), score (-4), accepted (true), move (Queen-3 {Row-0 -&gt; Row-3}).
DEBUG     LS step (0), time spent (6), score (-3), new best score (-3), accepted/selected move count (12/12), picked move (Queen-1 {Row-0 -&gt; Row-3}).
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the last solution can degrade (for example in Tabu Search), the <code>Solver</code> remembers the best solution it has encountered through the entire search path.
Each time the current solution is better than the last best solution, the current solution is <a href="#cloningASolution">cloned</a> and referenced as the new best solution.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./LocalSearch/localSearchScoreOverTime.png" alt="localSearchScoreOverTime">
</div>
</div>
</div>
<div class="sect3">
<h4 id="localSearchAcceptor"><a class="anchor" href="#localSearchAcceptor"></a><a class="link" href="#localSearchAcceptor">13.2.3. Acceptor</a></h4>
<div class="paragraph">
<p>An <code>Acceptor</code> is used (together with a <code>Forager</code>) to active Tabu Search, Simulated Annealing, Late Acceptance, &#8230;&#8203; For each move it checks whether it is accepted or not.</p>
</div>
<div class="paragraph">
<p>By changing a few lines of configuration, you can easily switch from Tabu Search to Simulated Annealing or Late Acceptance and back.</p>
</div>
<div class="paragraph">
<p>You can implement your own <code>Acceptor</code>, but the built-in acceptors should suffice for most needs.
You can also combine multiple acceptors.</p>
</div>
</div>
<div class="sect3">
<h4 id="localSearchForager"><a class="anchor" href="#localSearchForager"></a><a class="link" href="#localSearchForager">13.2.4. Forager</a></h4>
<div class="paragraph">
<p>A <code>Forager</code> gathers all accepted moves and picks the move which is the next step.
Normally it picks the accepted move with the highest score.
If several accepted moves have the highest score, one is picked randomly to break the tie.
Breaking ties randomly leads to better results.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is possible to disable breaking ties randomly by explicitly setting <code>breakTieRandomly</code> to <code>false</code>, but that&#8217;s almost never a good idea:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If an earlier move is better than a later move with the same score, the score calculator should add an extra softer <a href="#scoreLevel">score level</a> to score the first move as slightly better. Don&#8217;t rely on move selection order to enforce that.</p>
</li>
<li>
<p>Random tie breaking does not affect <a href="#environmentMode">reproducibility</a>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="acceptedCountLimit"><a class="anchor" href="#acceptedCountLimit"></a><a class="link" href="#acceptedCountLimit">13.2.4.1. Accepted count limit</a></h5>
<div class="paragraph">
<p>When there are many possible moves, it becomes inefficient to evaluate all of them at every step.
To evaluate only a random subset of all the moves, use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An <code>acceptedCountLimit</code> integer, which specifies how many accepted moves should be evaluated during each step. By default, all accepted moves are evaluated at every step.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;forager&gt;
    &lt;acceptedCountLimit&gt;1000&lt;/acceptedCountLimit&gt;
  &lt;/forager&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Unlike the n queens problem, real world problems require the use of <code>acceptedCountLimit</code>.
Start from an <code>acceptedCountLimit</code> that takes a step in less than two seconds. <a href="#logging">Turn on INFO logging</a> to see the step times.
Use the <a href="#benchmarker">Benchmarker</a> to tweak the value.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>With a low <code>acceptedCountLimit</code> (so a fast stepping algorithm), it is recommended to avoid using <code>selectionOrder</code> SHUFFLED because the shuffling generates a random number for every element in the selector, taking up a lot of time, but only a few elements are actually selected.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="localSearchPickEarlyType"><a class="anchor" href="#localSearchPickEarlyType"></a><a class="link" href="#localSearchPickEarlyType">13.2.4.2. Pick early type</a></h5>
<div class="paragraph">
<p>A forager can pick a move early during a step, ignoring subsequent selected moves.
There are three pick early types for Local Search:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>NEVER</code>: A move is never picked early: all accepted moves are evaluated that the selection allows. This is the default.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;forager&gt;
      &lt;pickEarlyType&gt;NEVER&lt;/pickEarlyType&gt;
    &lt;/forager&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><code>FIRST_BEST_SCORE_IMPROVING</code>: Pick the first accepted move that improves the best score. If none improve the best score, it behaves exactly like the pickEarlyType NEVER.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;forager&gt;
      &lt;pickEarlyType&gt;FIRST_BEST_SCORE_IMPROVING&lt;/pickEarlyType&gt;
    &lt;/forager&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><code>FIRST_LAST_STEP_SCORE_IMPROVING</code>: Pick the first accepted move that improves the last step score. If none improve the last step score, it behaves exactly like the pickEarlyType NEVER.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;forager&gt;
      &lt;pickEarlyType&gt;FIRST_LAST_STEP_SCORE_IMPROVING&lt;/pickEarlyType&gt;
    &lt;/forager&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="hillClimbing"><a class="anchor" href="#hillClimbing"></a><a class="link" href="#hillClimbing">13.3. Hill climbing (simple local search)</a></h3>
<div class="sect3">
<h4 id="hillClimbingAlgorithm"><a class="anchor" href="#hillClimbingAlgorithm"></a><a class="link" href="#hillClimbingAlgorithm">13.3.1. Algorithm description</a></h4>
<div class="paragraph">
<p>Hill Climbing tries all selected moves and then takes the best move, which is the move which leads to the solution with the highest score.
That best move is called the step move.
From that new solution, it again tries all selected moves and takes the best move and continues like that iteratively.
If multiple selected moves tie for the best move, one of them is randomly chosen as the best move.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./LocalSearch/hillClimbingNQueens04.png" alt="hillClimbingNQueens04">
</div>
</div>
<div class="paragraph">
<p>Notice that once a queen has moved, it can be moved again later.
This is a good thing, because in an NP-complete problem it&#8217;s impossible to predict what will be the optimal final value for a planning variable.</p>
</div>
</div>
<div class="sect3">
<h4 id="hillClimbingStuckInLocalOptima"><a class="anchor" href="#hillClimbingStuckInLocalOptima"></a><a class="link" href="#hillClimbingStuckInLocalOptima">13.3.2. Stuck in local optima</a></h4>
<div class="paragraph">
<p>Hill climbing always takes improving moves.
This may seem like a good thing, but it&#8217;s not: <strong>Hill Climbing can easily get stuck in a local optimum.</strong> This happens when it reaches a solution for which all the moves deteriorate the score.
Even if it picks one of those moves, the next step might go back to the original solution and which case chasing its own tail:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./LocalSearch/hillClimbingGetsStuckInLocalOptimaNQueens04.png" alt="hillClimbingGetsStuckInLocalOptimaNQueens04">
</div>
</div>
<div class="paragraph">
<p>Improvements upon Hill Climbing (such as Tabu Search, Simulated Annealing and Late Acceptance) address the problem of being stuck in local optima.
Therefore, it&#8217;s recommended to never use Hill Climbing, unless you&#8217;re absolutely sure there are no local optima in your planning problem.</p>
</div>
</div>
<div class="sect3">
<h4 id="hillClimbingConfigure"><a class="anchor" href="#hillClimbingConfigure"></a><a class="link" href="#hillClimbingConfigure">13.3.3. Configuration</a></h4>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    &lt;localSearchType&gt;HILL_CLIMBING&lt;/localSearchType&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    ...
    &lt;acceptor&gt;
      &lt;acceptorType&gt;HILL_CLIMBING&lt;/acceptorType&gt;
    &lt;/acceptor&gt;
    &lt;forager&gt;
      &lt;acceptedCountLimit&gt;1&lt;/acceptedCountLimit&gt;
    &lt;/forager&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tabuSearch"><a class="anchor" href="#tabuSearch"></a><a class="link" href="#tabuSearch">13.4. Tabu search</a></h3>
<div class="sect3">
<h4 id="tabuSearchAlgorithm"><a class="anchor" href="#tabuSearchAlgorithm"></a><a class="link" href="#tabuSearchAlgorithm">13.4.1. Algorithm description</a></h4>
<div class="paragraph">
<p>Tabu Search is a Local Search that maintains a tabu list to avoid getting stuck in local optima.
The tabu list holds recently used objects that are <em>taboo</em> to use for now.
Moves that involve an object in the tabu list, are not accepted.
The tabu list objects can be anything related to the move, such as the planning entity, planning value, move, solution, &#8230;&#8203;
Here&#8217;s an example with entity tabu for four queens, so the queens are put in the tabu list:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./LocalSearch/entityTabuSearch.png" alt="entityTabuSearch">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It&#8217;s called Tabu Search, not Taboo Search.
There is no spelling error.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Scientific paper: <em>Tabu Search - Part 1 and Part 2</em> by Fred Glover (1989 - 1990)</p>
</div>
</div>
<div class="sect3">
<h4 id="tabuSearchConfiguration"><a class="anchor" href="#tabuSearchConfiguration"></a><a class="link" href="#tabuSearchConfiguration">13.4.2. Configuration</a></h4>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    &lt;localSearchType&gt;TABU_SEARCH&lt;/localSearchType&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When Tabu Search takes steps it creates one or more tabus.
For a number of steps, it does not accept a move if that move breaks tabu.
That number of steps is the tabu size.
Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    ...
    &lt;acceptor&gt;
      &lt;entityTabuSize&gt;7&lt;/entityTabuSize&gt;
    &lt;/acceptor&gt;
    &lt;forager&gt;
      &lt;acceptedCountLimit&gt;1000&lt;/acceptedCountLimit&gt;
    &lt;/forager&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A Tabu Search acceptor should be combined with a high <code>acceptedCountLimit</code>, such as <code>1000</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>OptaPlanner implements several tabu types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Planning entity tabu</em> (recommended) makes the planning entities of recent steps tabu. For example, for N queens it makes the recently moved queens tabu. It&#8217;s recommended to start with this tabu type.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;acceptor&gt;
      &lt;entityTabuSize&gt;7&lt;/entityTabuSize&gt;
    &lt;/acceptor&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To avoid hard coding the tabu size, configure a tabu ratio, relative to the number of entities, for example 2%:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;acceptor&gt;
      &lt;entityTabuRatio&gt;0.02&lt;/entityTabuRatio&gt;
    &lt;/acceptor&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><em>Planning value tabu</em> makes the planning values of recent steps tabu. For example, for N queens it makes the recently moved to rows tabu.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;acceptor&gt;
      &lt;valueTabuSize&gt;7&lt;/valueTabuSize&gt;
    &lt;/acceptor&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To avoid hard coding the tabu size, configure a tabu ratio, relative to the number of values, for example 2%:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;acceptor&gt;
      &lt;valueTabuRatio&gt;0.02&lt;/valueTabuRatio&gt;
    &lt;/acceptor&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><em>Move tabu</em> makes recent steps tabu. It does not accept a move equal to one of those steps.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;acceptor&gt;
      &lt;moveTabuSize&gt;7&lt;/moveTabuSize&gt;
    &lt;/acceptor&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><em>Undo move tabu </em>makes the undo move of recent steps tabu.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;acceptor&gt;
      &lt;undoMoveTabuSize&gt;7&lt;/undoMoveTabuSize&gt;
    &lt;/acceptor&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When using move tabu and undo move tabu with <a href="#customMoves">custom moves</a>,
make sure that the planning entities do not include planning variables in their <code>hashCode</code> methods.
Failure to do so results in runtime exceptions being thrown due to the <code>hashCode</code> not being constant,
as the entities have their values changed by the local search algorithm.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Sometimes it&#8217;s useful to combine tabu types:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;acceptor&gt;
      &lt;entityTabuSize&gt;7&lt;/entityTabuSize&gt;
      &lt;valueTabuSize&gt;3&lt;/valueTabuSize&gt;
    &lt;/acceptor&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the tabu size is too small, the solver can still get stuck in a local optimum.
On the other hand, if the tabu size is too large, the solver can be inefficient by bouncing off the walls.
Use the <a href="#benchmarker">Benchmarker</a> to fine tweak your configuration.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="simulatedAnnealing"><a class="anchor" href="#simulatedAnnealing"></a><a class="link" href="#simulatedAnnealing">13.5. Simulated annealing</a></h3>
<div class="sect3">
<h4 id="simulatedAnnealingAlgorithm"><a class="anchor" href="#simulatedAnnealingAlgorithm"></a><a class="link" href="#simulatedAnnealingAlgorithm">13.5.1. Algorithm description</a></h4>
<div class="paragraph">
<p>Simulated Annealing evaluates only a few moves per step, so it steps quickly.
In the classic implementation, the first accepted move is the winning step.
A move is accepted if it doesn&#8217;t decrease the score or - in case it does decrease the score - it passes a random check.
The chance that a decreasing move passes the random check decreases relative to the size of the score decrement and the time the phase has been running (which is represented as the temperature).</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./LocalSearch/simulatedAnnealing.png" alt="simulatedAnnealing">
</div>
</div>
<div class="paragraph">
<p>Simulated Annealing does not always pick the move with the highest score, neither does it evaluate many moves per step.
At least at first.
Instead, it gives non improving moves also a chance to be picked, depending on its score and the time gradient of the <code>Termination</code>.
In the end, it gradually turns into Hill Climbing, only accepting improving moves.</p>
</div>
</div>
<div class="sect3">
<h4 id="simulatedAnnealingConfiguration"><a class="anchor" href="#simulatedAnnealingConfiguration"></a><a class="link" href="#simulatedAnnealingConfiguration">13.5.2. Configuration</a></h4>
<div class="paragraph">
<p>Start with a <code>simulatedAnnealingStartingTemperature</code> set to the maximum score delta a single move can cause.
Use the <a href="#benchmarker">Benchmarker</a> to tweak the value.
Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    ...
    &lt;acceptor&gt;
      &lt;simulatedAnnealingStartingTemperature&gt;2hard/100soft&lt;/simulatedAnnealingStartingTemperature&gt;
    &lt;/acceptor&gt;
    &lt;forager&gt;
      &lt;acceptedCountLimit&gt;1&lt;/acceptedCountLimit&gt;
    &lt;/forager&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Simulated Annealing should use a low <code>acceptedCountLimit</code>.
The classic algorithm uses an <code>acceptedCountLimit</code> of <code>1</code>, but often <code>4</code> performs better.</p>
</div>
<div class="paragraph">
<p>Simulated Annealing can be combined with a tabu acceptor at the same time.
That gives Simulated Annealing salted with a bit of Tabu.
Use a lower tabu size than in a pure Tabu Search configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    ...
    &lt;acceptor&gt;
      &lt;simulatedAnnealingStartingTemperature&gt;2hard/100soft&lt;/simulatedAnnealingStartingTemperature&gt;
      &lt;entityTabuSize&gt;5&lt;/entityTabuSize&gt;
    &lt;/acceptor&gt;
    &lt;forager&gt;
      &lt;acceptedCountLimit&gt;1&lt;/acceptedCountLimit&gt;
    &lt;/forager&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="lateAcceptance"><a class="anchor" href="#lateAcceptance"></a><a class="link" href="#lateAcceptance">13.6. Late acceptance</a></h3>
<div class="sect3">
<h4 id="lateAcceptanceAlgorithm"><a class="anchor" href="#lateAcceptanceAlgorithm"></a><a class="link" href="#lateAcceptanceAlgorithm">13.6.1. Algorithm description</a></h4>
<div class="paragraph">
<p>Late Acceptance (also known as Late Acceptance Hill Climbing) also evaluates only a few moves per step.
A move is accepted if it does not decrease the score, or if it leads to a score that is at least the late score (which is the winning score of a fixed number of steps ago).</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./LocalSearch/lateAcceptance.png" alt="lateAcceptance">
</div>
</div>
<div class="paragraph">
<p>Scientific paper: <a href="http://www.cs.stir.ac.uk/~kjt/techreps/pdf/TR192.pdf">The Late Acceptance Hill-Climbing Heuristic by Edmund K. Burke, Yuri Bykov (2012)</a></p>
</div>
</div>
<div class="sect3">
<h4 id="lateAcceptanceConfiguration"><a class="anchor" href="#lateAcceptanceConfiguration"></a><a class="link" href="#lateAcceptanceConfiguration">13.6.2. Configuration</a></h4>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    &lt;localSearchType&gt;LATE_ACCEPTANCE&lt;/localSearchType&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Late Acceptance accepts any move that has a score which is higher than the best score of a number of steps ago.
That number of steps is the <code>lateAcceptanceSize</code>.
Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    ...
    &lt;acceptor&gt;
      &lt;lateAcceptanceSize&gt;400&lt;/lateAcceptanceSize&gt;
    &lt;/acceptor&gt;
    &lt;forager&gt;
      &lt;acceptedCountLimit&gt;1&lt;/acceptedCountLimit&gt;
    &lt;/forager&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Late Acceptance should use a low <code>acceptedCountLimit</code>.</p>
</div>
<div class="paragraph">
<p>Late Acceptance can be combined with a tabu acceptor at the same time.
That gives Late Acceptance salted with a bit of Tabu.
Use a lower tabu size than in a pure Tabu Search configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    ...
    &lt;acceptor&gt;
      &lt;lateAcceptanceSize&gt;400&lt;/lateAcceptanceSize&gt;
      &lt;entityTabuSize&gt;5&lt;/entityTabuSize&gt;
    &lt;/acceptor&gt;
    &lt;forager&gt;
      &lt;acceptedCountLimit&gt;1&lt;/acceptedCountLimit&gt;
    &lt;/forager&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="greatDeluge"><a class="anchor" href="#greatDeluge"></a><a class="link" href="#greatDeluge">13.7. Great Deluge</a></h3>
<div class="sect3">
<h4 id="greatDelugeAlgorithm"><a class="anchor" href="#greatDelugeAlgorithm"></a><a class="link" href="#greatDelugeAlgorithm">13.7.1. Algorithm Description</a></h4>
<div class="paragraph">
<p>Great Deluge algorithm is similar to the  <a href="#simulatedAnnealing">Simulated Annealing</a> algorithm, it evaluates only a few moves per steps,
so it steps quickly. The first accepted move is the winning step. A move is accepted only if it is not lower than
the score value (water level) that we are working with. It means Great Deluge is deterministic and opposite
of Simulated Annealing has no randomization in it. The water level is increased after every step either about the fixed value
or by percentual value.
A gradual increase in water level gives Great Deluge more time to escape from local maxima.</p>
</div>
</div>
<div class="sect3">
<h4 id="greatDelugeConfiguration"><a class="anchor" href="#greatDelugeConfiguration"></a><a class="link" href="#greatDelugeConfiguration">13.7.2. Configuration</a></h4>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    &lt;localSearchType&gt;GREAT_DELUGE&lt;/localSearchType&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Great Deluge takes as starting water level best score from construction heuristic and uses default rain speed ratio. Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    ...
    &lt;acceptor&gt;
      &lt;greatDelugeInitialWaterLevel&gt;20hard/100soft&lt;/greatDelugeInitialWaterLevel&gt;
      &lt;greatDelugeWaterLevelIncrementRatio&gt;0.00000005&lt;/greatDelugeWaterLevelIncrementRatio&gt;
    &lt;/acceptor&gt;
    &lt;forager&gt;
      &lt;acceptedCountLimit&gt;1&lt;/acceptedCountLimit&gt;
    &lt;/forager&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>OptaPlanner implements two water level increment options:</p>
</div>
<div class="paragraph">
<p>If <code>greatDelugeWaterLevelIncrementScore</code> is set, the water level is increased by a constant value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;acceptor&gt;
  &lt;greatDelugeWaterLevelIncrementScore&gt;10&lt;/greatDelugeWaterLevelIncrementScore&gt;
&lt;/acceptor&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To avoid hard coding the water level increment, configure a <code>greatDelugeWaterLevelIncrementRatio</code> (recommended) when the water level is increased by percentual value, so there is no need to know the size of the problem or value of a scoring function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;acceptor&gt;
  &lt;greatDelugeWaterLevelIncrementRatio&gt;0.00000005&lt;/greatDelugeWaterLevelIncrementRatio&gt;
&lt;/acceptor&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also <code>greatDelugeInitialWaterLevel</code> can be set as a starting water level but is recommended not to do it,
so the algorithm takes as starting value the best score from the construction heuristic.
Use the Benchmarker to fine-tune tweak your configuration.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="stepCountingHillClimbing"><a class="anchor" href="#stepCountingHillClimbing"></a><a class="link" href="#stepCountingHillClimbing">13.8. Step counting hill climbing</a></h3>
<div class="sect3">
<h4 id="stepCountingHillClimbingAlgorithm"><a class="anchor" href="#stepCountingHillClimbingAlgorithm"></a><a class="link" href="#stepCountingHillClimbingAlgorithm">13.8.1. Algorithm description</a></h4>
<div class="paragraph">
<p>Step Counting Hill Climbing also evaluates only a few moves per step.
For a number of steps, it keeps the step score as a threshold.
A move is accepted if it does not decrease the score, or if it leads to a score that is at least the threshold score.</p>
</div>
<div class="paragraph">
<p>Scientific paper: <a href="https://www.researchgate.net/profile/Sanja_Petrovic2/publication/299593956_A_Step_Counting_Hill_Climbing_Algorithm_applied_to_University_Examination_Timetabling/links/5729d02a08aef7c7e2c4103a/A-Step-Counting-Hill-Climbing-Algorithm-applied-to-University-Examination-Timetabling.pdf">An initial study of a novel Step Counting Hill Climbing heuristic applied to timetabling problems by Yuri Bykov, Sanja Petrovic (2013)</a></p>
</div>
</div>
<div class="sect3">
<h4 id="stepCountingHillClimbingConfiguration"><a class="anchor" href="#stepCountingHillClimbingConfiguration"></a><a class="link" href="#stepCountingHillClimbingConfiguration">13.8.2. Configuration</a></h4>
<div class="paragraph">
<p>Step Counting Hill Climbing accepts any move that has a score which is higher than a threshold score.
Every number of steps (specified by <code>stepCountingHillClimbingSize</code>), the threshold score is set to the step score.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    ...
    &lt;acceptor&gt;
      &lt;stepCountingHillClimbingSize&gt;400&lt;/stepCountingHillClimbingSize&gt;
    &lt;/acceptor&gt;
    &lt;forager&gt;
      &lt;acceptedCountLimit&gt;1&lt;/acceptedCountLimit&gt;
    &lt;/forager&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Step Counting Hill Climbing should use a low <code>acceptedCountLimit</code>.</p>
</div>
<div class="paragraph">
<p>Step Counting Hill Climbing can be combined with a tabu acceptor at the same time, similar as shown in <a href="#lateAcceptance">the Late Acceptance section</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="strategicOscillation"><a class="anchor" href="#strategicOscillation"></a><a class="link" href="#strategicOscillation">13.9. Strategic oscillation</a></h3>
<div class="sect3">
<h4 id="strategicOscillationAlgorithm"><a class="anchor" href="#strategicOscillationAlgorithm"></a><a class="link" href="#strategicOscillationAlgorithm">13.9.1. Algorithm description</a></h4>
<div class="paragraph">
<p>Strategic Oscillation is an add-on, which works especially well with <a href="#tabuSearch">Tabu Search</a>.
Instead of picking the accepted move with the highest score, it employs a different mechanism: If there&#8217;s an improving move, it picks it.
If there&#8217;s no improving move however, it prefers moves which improve a softer score level, over moves which break a harder score level less.</p>
</div>
</div>
<div class="sect3">
<h4 id="strategicOscillationConfiguration"><a class="anchor" href="#strategicOscillationConfiguration"></a><a class="link" href="#strategicOscillationConfiguration">13.9.2. Configuration</a></h4>
<div class="paragraph">
<p>Configure a <code>finalistPodiumType</code>, for example in a Tabu Search configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    ...
    &lt;acceptor&gt;
      &lt;entityTabuSize&gt;7&lt;/entityTabuSize&gt;
    &lt;/acceptor&gt;
    &lt;forager&gt;
      &lt;acceptedCountLimit&gt;1000&lt;/acceptedCountLimit&gt;
      &lt;finalistPodiumType&gt;STRATEGIC_OSCILLATION&lt;/finalistPodiumType&gt;
    &lt;/forager&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following <code>finalistPodiumType</code>s are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>HIGHEST_SCORE</code> (default): Pick the accepted move with the highest score.</p>
</li>
<li>
<p><code>STRATEGIC_OSCILLATION</code>: Alias for the default strategic oscillation variant.</p>
</li>
<li>
<p><code>STRATEGIC_OSCILLATION_BY_LEVEL</code>: If there is an accepted improving move, pick it. If no such move exists, prefer an accepted move which improves a softer score level over one that doesn&#8217;t (even if it has a better harder score level). A move is improving if it&#8217;s better than the last completed step score.</p>
</li>
<li>
<p><code>STRATEGIC_OSCILLATION_BY_LEVEL_ON_BEST_SCORE</code>: Like <code>STRATEGIC_OSCILLATION_BY_LEVEL</code>, but define improving as better than the best score (instead of the last completed step score).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="variableNeighborhoodDescent"><a class="anchor" href="#variableNeighborhoodDescent"></a><a class="link" href="#variableNeighborhoodDescent">13.10. Variable neighborhood descent</a></h3>
<div class="sect3">
<h4 id="variableNeighborhoodDescentAlgorithm"><a class="anchor" href="#variableNeighborhoodDescentAlgorithm"></a><a class="link" href="#variableNeighborhoodDescentAlgorithm">13.10.1. Algorithm description</a></h4>
<div class="paragraph">
<p>Variable Neighborhood Descent iteratively tries multiple move selectors
in original order (depleting each selector entirely before trying the next one),
picking the first improving move (which also resets the iterator back to the first move selector).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Despite that VND has a name that ends with <em>descent</em> (from the research papers),
the implementation will ascend to a higher score (which is a better score).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="variableNeighborhoodDescentConfiguration"><a class="anchor" href="#variableNeighborhoodDescentConfiguration"></a><a class="link" href="#variableNeighborhoodDescentConfiguration">13.10.2. Configuration</a></h4>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    &lt;localSearchType&gt;VARIABLE_NEIGHBORHOOD_DESCENT&lt;/localSearchType&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;localSearch&gt;
    &lt;unionMoveSelector&gt;
      &lt;selectionOrder&gt;ORIGINAL&lt;/selectionOrder&gt;
      &lt;changeMoveSelector/&gt;
      &lt;swapMoveSelector/&gt;
      ...
    &lt;/unionMoveSelector&gt;
    &lt;acceptor&gt;
      &lt;acceptorType&gt;HILL_CLIMBING&lt;/acceptorType&gt;
    &lt;/acceptor&gt;
    &lt;forager&gt;
      &lt;pickEarlyType&gt;FIRST_LAST_STEP_SCORE_IMPROVING&lt;/pickEarlyType&gt;
    &lt;/forager&gt;
  &lt;/localSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Variable Neighborhood Descent doesn&#8217;t scale well,
but it is useful in some use cases with a very erratic score landscape.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="customTerminationSelectorOrAcceptor"><a class="anchor" href="#customTerminationSelectorOrAcceptor"></a><a class="link" href="#customTerminationSelectorOrAcceptor">13.11. Using a custom <code>Termination</code>, <code>MoveSelector</code>, <code>EntitySelector</code>, <code>ValueSelector</code>, or <code>Acceptor</code></a></h3>
<div class="paragraph">
<p>Plug in a custom <code>Termination</code>, <code>MoveSelector</code>, <code>EntitySelector</code>, <code>ValueSelector</code> or <code>Acceptor</code> by extending the abstract class and also the related <code>\*Config</code> class.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Extending <code>Config</code> classes is not covered by the backwards compatibility guarantee.
Whenever possible, it&#8217;s better to just use <a href="#customPropertiesConfiguration">custom properties</a> instead.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, to use a custom <code>Termination</code>, extend the <code>AbstractTermination</code> class,
extend the <code>TerminationConfig</code> class and configure it in the solver configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;solver&gt;
  &lt;termination class="...MyTerminationConfig"&gt;
    &lt;myProperty&gt;myValue&lt;/myProperty&gt;
  &lt;/termination&gt;
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It&#8217;s not possible to inject a <code>Termination</code>, &#8230;&#8203; instance directly (to avoid extending a <code>Config</code> class too) because:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>SolverFactory</code> can build multiple <code>Solver</code> instances, which each require a distinct <code>Termination</code>, &#8230;&#8203; instance.</p>
</li>
<li>
<p>A solver configuration needs to be serializable from and to XML.
This makes benchmarking with <code>PlannerBenchmark</code> particularly easy because you can configure different <code>Solver</code> variants in XML.</p>
</li>
<li>
<p>A <code>Config</code> class is often easier and clearer to configure.
For example: <code>TerminationConfig</code> translates <code>minutesSpentLimit</code> and <code>secondsSpentLimit</code> into <code>timeMillisSpentLimit</code>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you write a custom implementation of any of those classes,
let us know <em>why</em> on <a href="https://groups.google.com/forum/#!forum/optaplanner-dev">our forum</a>.
If it&#8217;s not domain specific, you might want to consider contributing it back as a pull request on github:
we&#8217;ll optimize it and take it along in future refactorings.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="evolutionaryAlgorithms"><a class="anchor" href="#evolutionaryAlgorithms"></a><a class="link" href="#evolutionaryAlgorithms">14. Evolutionary algorithms</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="evolutionaryAlgorithmsOverview"><a class="anchor" href="#evolutionaryAlgorithmsOverview"></a><a class="link" href="#evolutionaryAlgorithmsOverview">14.1. Overview</a></h3>
<div class="paragraph">
<p>Evolutionary Algorithms work on a population of solutions and evolve that population.</p>
</div>
</div>
<div class="sect2">
<h3 id="evolutionaryStrategies"><a class="anchor" href="#evolutionaryStrategies"></a><a class="link" href="#evolutionaryStrategies">14.2. Evolutionary strategies</a></h3>
<div class="paragraph">
<p>This algorithm has not been implemented yet.</p>
</div>
</div>
<div class="sect2">
<h3 id="geneticAlgorithms"><a class="anchor" href="#geneticAlgorithms"></a><a class="link" href="#geneticAlgorithms">14.3. Genetic algorithms</a></h3>
<div class="paragraph">
<p>This algorithm has not been implemented yet.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A good Genetic Algorithms prototype in OptaPlanner was written some time ago, but it wasn&#8217;t practical to merge and support it at the time.
The results of Genetic Algorithms were consistently and seriously inferior to all the <a href="#localSearch">Local Search</a> variants (except Hill Climbing) on all use cases tried.
Nevertheless, a future version of OptaPlanner will add support for Genetic Algorithms, so you can easily benchmark Genetic Algorithms on your use case too.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="hyperheuristics"><a class="anchor" href="#hyperheuristics"></a><a class="link" href="#hyperheuristics">15. Hyperheuristics</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="hyperheuristicsOverview"><a class="anchor" href="#hyperheuristicsOverview"></a><a class="link" href="#hyperheuristicsOverview">15.1. Overview</a></h3>
<div class="paragraph">
<p>A hyperheuristic automates the decision which heuristic(s) to use on a specific data set.</p>
</div>
<div class="paragraph">
<p>A future version of OptaPlanner will have native support for hyperheuristics.
Meanwhile, it&#8217;s possible to implement it yourself: Based on the size or difficulty of a data set (which is a criterion), use a different <code>Solver</code> configuration (or adjust the default configuration using the Solver configuration API). The <a href="#benchmarker">Benchmarker</a> can help to identify such criteria.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="partitionedSearch"><a class="anchor" href="#partitionedSearch"></a><a class="link" href="#partitionedSearch">16. Partitioned search</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="partitionedSearchAlgorithm"><a class="anchor" href="#partitionedSearchAlgorithm"></a><a class="link" href="#partitionedSearchAlgorithm">16.1. Algorithm description</a></h3>
<div class="paragraph">
<p>It is often more efficient to partition large data sets (usually above 5000 planning entities)
into smaller pieces and solve them separately.
Partition Search is <a href="#multithreadedSolving">multithreaded</a>, so it provides a performance boost on multi-core machines
due to higher CPU utilization.
Additionally, even when only using one CPU, it finds an initial solution faster,
because the search space sum of a partitioned Construction Heuristic is far less than its non-partitioned variant.</p>
</div>
<div class="paragraph">
<p>However, <strong>partitioning does lead to suboptimal results</strong>, even if the pieces are solved optimally, as shown below:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./PartitionedSearch/mapReduceIsTerribleForTsp.png" alt="mapReduceIsTerribleForTsp">
</div>
</div>
<div class="paragraph">
<p>It effectively trades a short term gain in solution quality for long term loss.
One way to compensate for this loss,
is to run a non-partitioned Local Search after the Partitioned Search phase.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Not all use cases can be partitioned.
Partitioning only works for use cases where the planning entities and value ranges can be split into n partitions,
without any of the constraints crossing boundaries between partitions.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="partitionedSearchConfiguration"><a class="anchor" href="#partitionedSearchConfiguration"></a><a class="link" href="#partitionedSearchConfiguration">16.2. Configuration</a></h3>
<div class="paragraph">
<p>Simplest configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;partitionedSearch&gt;
    &lt;solutionPartitionerClass&gt;org.optaplanner.examples.cloudbalancing.optional.partitioner.CloudBalancePartitioner&lt;/solutionPartitionerClass&gt;
  &lt;/partitionedSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also <a href="#planningId">add a @PlanningId annotations</a> on every planning entity class and planning value class.
There are several ways to <a href="#partitioningASolution">partition a solution</a>.</p>
</div>
<div class="paragraph">
<p>Advanced configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;partitionedSearch&gt;
    ...
    &lt;solutionPartitionerClass&gt;org.optaplanner.examples.cloudbalancing.optional.partitioner.CloudBalancePartitioner&lt;/solutionPartitionerClass&gt;
    &lt;runnablePartThreadLimit&gt;4&lt;/runnablePartThreadLimit&gt;

    &lt;constructionHeuristic&gt;...&lt;/constructionHeuristic&gt;
    &lt;localSearch&gt;...&lt;/localSearch&gt;
  &lt;/partitionedSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>runnablePartThreadLimit</code> allows limiting CPU usage to avoid hanging your machine, see below.</p>
</div>
<div class="paragraph">
<p>To run in an environment that doesn&#8217;t like arbitrary thread creation,
plug in a <a href="#customThreadFactory">custom thread factory</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A <a href="#logging">logging level</a> of <code>debug</code> or <code>trace</code> causes congestion in multithreaded Partitioned Search
and slows down the <a href="#scoreCalculationSpeed">score calculation speed</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Just like a <code>&lt;solver&gt;</code> element, the <code>&lt;partitionedSearch&gt;</code> element can contain one or more <a href="#solverPhase">phases</a>.
Each of those phases will be run on each partition.</p>
</div>
<div class="paragraph">
<p>A common configuration is to first run a Partitioned Search phase
(which includes a Construction Heuristic and a Local Search)
followed by a non-partitioned Local Search phase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;partitionedSearch&gt;
    &lt;solutionPartitionerClass&gt;...CloudBalancePartitioner&lt;/solutionPartitionerClass&gt;

    &lt;constructionHeuristic/&gt;
    &lt;localSearch&gt;
      &lt;termination&gt;
        &lt;secondsSpentLimit&gt;60&lt;/secondsSpentLimit&gt;
      &lt;/termination&gt;
    &lt;/localSearch&gt;
  &lt;/partitionedSearch&gt;
  &lt;localSearch/&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="partitioningASolution"><a class="anchor" href="#partitioningASolution"></a><a class="link" href="#partitioningASolution">16.3. Partitioning a solution</a></h3>
<div class="sect3">
<h4 id="customSolutionPartitioner"><a class="anchor" href="#customSolutionPartitioner"></a><a class="link" href="#customSolutionPartitioner">16.3.1. Custom <code>SolutionPartitioner</code></a></h4>
<div class="paragraph">
<p>To use a custom <code>SolutionPartitioner</code>, configure one on the Partitioned Search phase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;partitionedSearch&gt;
    &lt;solutionPartitionerClass&gt;org.optaplanner.examples.cloudbalancing.optional.partitioner.CloudBalancePartitioner&lt;/solutionPartitionerClass&gt;
  &lt;/partitionedSearch&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Implement the <code>SolutionPartitioner</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface SolutionPartitioner&lt;Solution_&gt; {

    List&lt;Solution_&gt; splitWorkingSolution(ScoreDirector&lt;Solution_&gt; scoreDirector, Integer runnablePartThreadLimit);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>size()</code> of the returned <code>List</code> is the <code>partCount</code> (the number of partitions).
This can be decided dynamically, for example, based on the size of the non-partitioned solution.
The <code>partCount</code> is unrelated to the <code>runnablePartThreadLimit</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class CloudBalancePartitioner implements SolutionPartitioner&lt;CloudBalance&gt; {

    private int partCount = 4;
    private int minimumProcessListSize = 75;

    @Override
    public List&lt;CloudBalance&gt; splitWorkingSolution(ScoreDirector&lt;CloudBalance&gt; scoreDirector, Integer runnablePartThreadLimit) {
        CloudBalance originalSolution = scoreDirector.getWorkingSolution();
        List&lt;CloudComputer&gt; originalComputerList = originalSolution.getComputerList();
        List&lt;CloudProcess&gt; originalProcessList = originalSolution.getProcessList();
        int partCount = this.partCount;
        if (originalProcessList.size() / partCount &lt; minimumProcessListSize) {
            partCount = originalProcessList.size() / minimumProcessListSize;
        }
        List&lt;CloudBalance&gt; partList = new ArrayList&lt;&gt;(partCount);
        for (int i = 0; i &lt; partCount; i++) {
            CloudBalance partSolution = new CloudBalance(originalSolution.getId(),
                    new ArrayList&lt;&gt;(originalComputerList.size() / partCount + 1),
                    new ArrayList&lt;&gt;(originalProcessList.size() / partCount + 1));
            partList.add(partSolution);
        }

        int partIndex = 0;
        Map&lt;Long, Pair&lt;Integer, CloudComputer&gt;&gt; idToPartIndexAndComputerMap = new HashMap&lt;&gt;(originalComputerList.size());
        for (CloudComputer originalComputer : originalComputerList) {
            CloudBalance part = partList.get(partIndex);
            CloudComputer computer = new CloudComputer(
                    originalComputer.getId(),
                    originalComputer.getCpuPower(), originalComputer.getMemory(),
                    originalComputer.getNetworkBandwidth(), originalComputer.getCost());
            part.getComputerList().add(computer);
            idToPartIndexAndComputerMap.put(computer.getId(), Pair.of(partIndex, computer));
            partIndex = (partIndex + 1) % partList.size();
        }

        partIndex = 0;
        for (CloudProcess originalProcess : originalProcessList) {
            CloudBalance part = partList.get(partIndex);
            CloudProcess process = new CloudProcess(
                    originalProcess.getId(),
                    originalProcess.getRequiredCpuPower(), originalProcess.getRequiredMemory(),
                    originalProcess.getRequiredNetworkBandwidth());
            part.getProcessList().add(process);
            if (originalProcess.getComputer() != null) {
                Pair&lt;Integer, CloudComputer&gt; partIndexAndComputer = idToPartIndexAndComputerMap.get(
                        originalProcess.getComputer().getId());
                if (partIndexAndComputer == null) {
                    throw new IllegalStateException("The initialized process (" + originalProcess
                            + ") has a computer (" + originalProcess.getComputer()
                            + ") which doesn't exist in the originalSolution (" + originalSolution + ").");
                }
                if (partIndex != partIndexAndComputer.getLeft().intValue()) {
                    throw new IllegalStateException("The initialized process (" + originalProcess
                            + ") with partIndex (" + partIndex
                            + ") has a computer (" + originalProcess.getComputer()
                            + ") which belongs to another partIndex (" + partIndexAndComputer.getLeft() + ").");
                }
                process.setComputer(partIndexAndComputer.getRight());
            }
            partIndex = (partIndex + 1) % partList.size();
        }
        return partList;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To configure values of a <code>SolutionPartitioner</code> dynamically in the solver configuration
(so the <a href="#benchmarker">Benchmarker</a> can tweak those parameters),
add the <code>solutionPartitionerCustomProperties</code> element and use <a href="#customPropertiesConfiguration">custom properties</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;partitionedSearch&gt;
    &lt;solutionPartitionerClass&gt;...CloudBalancePartitioner&lt;/solutionPartitionerClass&gt;
    &lt;solutionPartitionerCustomProperties&gt;
      &lt;myPartCount&gt;8&lt;/myPartCount&gt;
      &lt;myMinimumProcessListSize&gt;100&lt;/myMinimumProcessListSize&gt;
    &lt;/solutionPartitionerCustomProperties&gt;
  &lt;/partitionedSearch&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="runnablePartThreadLimit"><a class="anchor" href="#runnablePartThreadLimit"></a><a class="link" href="#runnablePartThreadLimit">16.4. Runnable part thread limit</a></h3>
<div class="paragraph">
<p>When running a multithreaded solver, such as Partitioned Search, CPU power can quickly become a scarce resource,
which can cause other processes or threads to hang or freeze.
However, OptaPlanner has a system to prevent CPU starving of
other processes (such as an SSH connection in production or your IDE in development)
or other threads (such as the servlet threads that handle REST requests).</p>
</div>
<div class="paragraph">
<p>As explained in <a href="#sizingHardwareAndSoftware">sizing hardware and software</a>,
each solver (including each child solver) does no IO during <code>solve()</code> and therefore saturates one CPU core completely.
In Partitioned Search, every partition always has its own thread, called a part thread.
It is impossible for two partitions to share a thread,
because of <a href="#asynchronousTermination">asynchronous termination</a>: the second thread would never run.
Every part thread will try to consume one CPU core entirely, so if there are more partitions than CPU cores,
this will probably hang the system.
<code>Thread.setPriority()</code> is often too weak to solve this hogging problem, so another approach is used.</p>
</div>
<div class="paragraph">
<p>The <code>runnablePartThreadLimit</code> parameter specifies how many part threads are runnable at the same time.
The other part threads will temporarily block and therefore will not consume any CPU power.
<strong>This parameter basically specifies how many CPU cores are donated to OptaPlanner.</strong>
All part threads share the CPU cores in a round-robin manner
to consume (more or less) the same number of CPU cycles:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./PartitionedSearch/partitionedSearchThreading.png" alt="partitionedSearchThreading">
</div>
</div>
<div class="paragraph">
<p>The following <code>runnablePartThreadLimit</code> options are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>UNLIMITED</code>: Allow OptaPlanner to occupy all CPU cores, do not avoid hogging.
Useful if a no hogging CPU policy is configured on the OS level.</p>
</li>
<li>
<p><code>AUTO</code> (default): Let OptaPlanner decide how many CPU cores to occupy. This formula is based on experience.
It does not hog all CPU cores on a multi-core machine.</p>
</li>
<li>
<p>Static number: The number of CPU cores to consume. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;runnablePartThreadLimit&gt;2&lt;/runnablePartThreadLimit&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>JavaScript formula: Formula for the number of CPU cores to occupy.
It can use the variable <code>availableProcessorCount</code>. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;runnablePartThreadLimit&gt;availableProcessorCount - 2&lt;/runnablePartThreadLimit&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the <code>runnablePartThreadLimit</code> is equal to or higher than the number of available processors,
the host is likely to hang or freeze,
unless there is an OS specific policy in place to avoid OptaPlanner from hogging all the CPU processors.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="benchmarker"><a class="anchor" href="#benchmarker"></a><a class="link" href="#benchmarker">17. Benchmarking and tweaking</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="findTheBestSolverConfiguration"><a class="anchor" href="#findTheBestSolverConfiguration"></a><a class="link" href="#findTheBestSolverConfiguration">17.1. Find the best solver configuration</a></h3>
<div class="paragraph">
<p>OptaPlanner supports several optimization algorithms, so you&#8217;re probably wondering which is the best one?
Although some optimization algorithms generally perform better than others, it really depends on your problem domain.
Most solver phases have parameters which can be tweaked.
Those parameters can influence the results a lot, even though most solver phases work pretty well out-of-the-box.</p>
</div>
<div class="paragraph">
<p>Luckily, OptaPlanner includes a benchmarker, which allows you to play out different solver phases with different settings
against each other in development, so you can use the best configuration for your planning problem in production.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./BenchmarkingAndTweaking/benchmarkOverview.png" alt="benchmarkOverview">
</div>
</div>
</div>
<div class="sect2">
<h3 id="benchmarkConfiguration"><a class="anchor" href="#benchmarkConfiguration"></a><a class="link" href="#benchmarkConfiguration">17.2. Benchmark configuration</a></h3>
<div class="sect3">
<h4 id="addADependencyOnBenchmarkJar"><a class="anchor" href="#addADependencyOnBenchmarkJar"></a><a class="link" href="#addADependencyOnBenchmarkJar">17.2.1. Add a dependency on <code>optaplanner-benchmark</code></a></h4>
<div class="paragraph">
<p>The benchmarker is in a separate artifact called <code>optaplanner-benchmark</code>.</p>
</div>
<div class="paragraph">
<p>If you use Maven, add a dependency in your <code>pom.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;dependency&gt;
      &lt;groupId&gt;org.optaplanner&lt;/groupId&gt;
      &lt;artifactId&gt;optaplanner-benchmark&lt;/artifactId&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is similar for Gradle, Ivy and Buildr.
The version must be exactly the same as the <code>optaplanner-core</code> version used (which is automatically the case if you import <code>optaplanner-bom</code>).</p>
</div>
<div class="paragraph">
<p>If you use ANT, you&#8217;ve probably already copied the required jars from the download zip&#8217;s <em class="path">binaries</em>
 directory.</p>
</div>
</div>
<div class="sect3">
<h4 id="runASimpleBenchmark"><a class="anchor" href="#runASimpleBenchmark"></a><a class="link" href="#runASimpleBenchmark">17.2.2. Run a simple benchmark</a></h4>
<div class="paragraph">
<p>To quickly setup a benchmark, create a <code>PlannerBenchmarkFactory</code> from your solver configuration XML,
load a few datasets and benchmark them. For example, with 3 datasets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">PlannerBenchmarkFactory benchmarkFactory = PlannerBenchmarkFactory.createFromSolverConfigXmlResource(
        "org/optaplanner/examples/cloudbalancing/solver/cloudBalancingSolverConfig.xml");

CloudBalance dataset1 = ...;
CloudBalance dataset2 = ...;
CloudBalance dataset3 = ...;
PlannerBenchmark benchmark = benchmarkFactory.buildPlannerBenchmark(
        dataset1, dataset2, dataset3);
benchmark.benchmarkAndShowReportInBrowser();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This generates a benchmark report in <code>local/benchmarkReport</code> and shows it in your browser when it&#8217;s finished.
The <code>SolverFactory</code>'s solver configuration needs a termination to limit how long each dataset runs.
To configure a different benchmark directory, pass a <code>File</code> parameter to <code>createFromSolverConfigXmlResource()</code>.</p>
</div>
<div class="paragraph">
<p>The generated benchmark report already contains interesting information,
but it doesn&#8217;t compare solver configurations to find the best algorithm.
To do that, set up an explicit benchmark configuration:</p>
</div>
</div>
<div class="sect3">
<h4 id="buildAndRunAPlannerBenchmark"><a class="anchor" href="#buildAndRunAPlannerBenchmark"></a><a class="link" href="#buildAndRunAPlannerBenchmark">17.2.3. Configure and run an advanced benchmark</a></h4>
<div class="paragraph">
<p>Build a <code>PlannerBenchmark</code> instance with a <code>PlannerBenchmarkFactory</code>.
Configure it with a benchmark configuration XML file, provided as a classpath resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">PlannerBenchmarkFactory benchmarkFactory = PlannerBenchmarkFactory.createFromXmlResource(
        "org/optaplanner/examples/cloudbalancing/benchmark/cloudBalancingBenchmarkConfig.xml");
PlannerBenchmark benchmark = benchmarkFactory.buildPlannerBenchmark();
benchmark.benchmarkAndShowReportInBrowser();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, create a <code>PlannerBenchmarkFactory</code> programmatically from a <code>PlannerBenchmarkConfig</code>.</p>
</div>
<div class="paragraph">
<p>A benchmark configuration XML file looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;plannerBenchmark&gt;
  &lt;benchmarkDirectory&gt;local/data/nqueens&lt;/benchmarkDirectory&gt;

  &lt;inheritedSolverBenchmark&gt;
    &lt;problemBenchmarks&gt;
      ...
      &lt;inputSolutionFile&gt;data/cloudbalancing/unsolved/100computers-300processes.xml&lt;/inputSolutionFile&gt;
      &lt;inputSolutionFile&gt;data/cloudbalancing/unsolved/200computers-600processes.xml&lt;/inputSolutionFile&gt;
    &lt;/problemBenchmarks&gt;
    &lt;solver&gt;
      ...&lt;!-- Common solver configuration --&gt;
    &lt;/solver&gt;
  &lt;/inheritedSolverBenchmark&gt;

  &lt;solverBenchmark&gt;
    &lt;name&gt;Tabu Search&lt;/name&gt;
    &lt;solver&gt;
      ...&lt;!-- Tabu Search specific solver configuration --&gt;
    &lt;/solver&gt;
  &lt;/solverBenchmark&gt;
  &lt;solverBenchmark&gt;
    &lt;name&gt;Simulated Annealing&lt;/name&gt;
    &lt;solver&gt;
      ...&lt;!-- Simulated Annealing specific solver configuration --&gt;
    &lt;/solver&gt;
  &lt;/solverBenchmark&gt;
  &lt;solverBenchmark&gt;
    &lt;name&gt;Late Acceptance&lt;/name&gt;
    &lt;solver&gt;
      ...&lt;!-- Late Acceptance specific solver configuration --&gt;
    &lt;/solver&gt;
  &lt;/solverBenchmark&gt;
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>PlannerBenchmark</code> tries three configurations (Tabu Search, Simulated Annealing and Late Acceptance)
on two data sets (<code>100computers-300processes</code> and <code>200computers-600processes</code>), so it runs six solvers.</p>
</div>
<div class="paragraph">
<p>Every <code>&lt;solverBenchmark&gt;</code> element contains a solver configuration and one or more <code>&lt;inputSolutionFile&gt;</code> elements.
It runs the solver configuration on each of those unsolved solution files.
The element <code>name</code> is optional, because it is generated if absent.
The <code>inputSolutionFile</code> is read by a <a href="#solutionFileIO">SolutionFileIO</a>, relative to the working directory.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use a forward slash (<code>/</code>) as the file separator (for example in the element <code>&lt;inputSolutionFile&gt;</code>). That will work on any platform (including Windows).</p>
</div>
<div class="paragraph">
<p>Do not use backslash (<code>\</code>) as the file separator: that breaks portability because it does not work on Linux and Mac.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The benchmark report is written in the directory specified by the <code>&lt;benchmarkDirectory&gt;</code> element (relative to the working directory).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It&#8217;s recommended that the <code>benchmarkDirectory</code> is a directory that is ignored for source control and not cleaned by your build system.
This way the generated files are not bloating your source control and they aren&#8217;t lost when doing a clean build.
For example in git, it should be added to <code>.gitignore</code>. Usually that directory is called <code>local</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If an <code>Exception</code> or <code>Error</code> occurs in a single benchmark, the entire Benchmarker does not fail-fast (unlike everything else in OptaPlanner).
Instead, the Benchmarker continues to run all other benchmarks, write the benchmark report and then fail (if there is at least one failing single benchmark).
The failing benchmarks are clearly marked as such in the benchmark report.</p>
</div>
<div class="sect4">
<h5 id="inheritedSolverBenchmark"><a class="anchor" href="#inheritedSolverBenchmark"></a><a class="link" href="#inheritedSolverBenchmark">17.2.3.1. Inherited solver benchmark</a></h5>
<div class="paragraph">
<p>To lower verbosity, the common parts of multiple <code>&lt;solverBenchmark&gt;</code> elements are extracted to the <code>&lt;inheritedSolverBenchmark&gt;</code> element.
Every property can still be overwritten per <code>&lt;solverBenchmark&gt;</code> element.
Note that inherited solver phases such as <code>&lt;constructionHeuristic&gt;</code> or <code>&lt;localSearch&gt;</code> are not overwritten
but instead are added to the tail of the solver phases list.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="solutionFileIO"><a class="anchor" href="#solutionFileIO"></a><a class="link" href="#solutionFileIO">17.2.4. <code>SolutionFileIO</code>: input and output of solution files</a></h4>
<div class="sect4">
<h5 id="solutionFileIOInterface"><a class="anchor" href="#solutionFileIOInterface"></a><a class="link" href="#solutionFileIOInterface">17.2.4.1. <code>SolutionFileIO</code> interface</a></h5>
<div class="paragraph">
<p>The benchmarker needs to be able to read the input files to load a problem.
Also, it optionally writes the best solution of each benchmark to an output file.
It does that through the <code>SolutionFileIO</code> interface which has a read and write method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface SolutionFileIO&lt;Solution_&gt; {
    ...

    Solution_ read(File inputSolutionFile);
    void write(Solution_ solution, File outputSolutionFile);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>SolutionFileIO</code> interface is in the <code>optaplanner-persistence-common</code> jar (which is a dependency of the <code>optaplanner-benchmark</code> jar).
There are several ways to serialize a solution:</p>
</div>
</div>
<div class="sect4">
<h5 id="xStreamSolutionFileIO"><a class="anchor" href="#xStreamSolutionFileIO"></a><a class="link" href="#xStreamSolutionFileIO">17.2.4.2. <code>XStreamSolutionFileIO</code>: serialize to and from an XML format</a></h5>
<div class="paragraph">
<p>To use the <code>XStreamSolutionFileIO</code> instance to read and write solutions,
configure your <code>@PlanningSolution</code> class as an <code>xStreamAnnotatedClass</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;problemBenchmarks&gt;
      &lt;xStreamAnnotatedClass&gt;org.optaplanner.examples.nqueens.domain.NQueens&lt;/xStreamAnnotatedClass&gt;
      &lt;inputSolutionFile&gt;data/nqueens/unsolved/32queens.xml&lt;/inputSolutionFile&gt;
      ...
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Those input files need to have been written with a <code>XStreamSolutionFileIO</code> instance, not just any <code>XStream</code> instance,
because the <code>XStreamSolutionFileIO</code> uses a customized <code>XStream</code> instance.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>inputSolutionFile</code> needs to come from a trusted source:
if it contains malicious data, it can be exploited.
The <code>XStreamSolutionFileIO</code> disables the <code>XStream</code> security framework, so it just works out of the box.</p>
</div>
<div class="paragraph">
<p>If you expose benchmarking in production, use <code>XStreamSolutionFileIO.getXStream()</code>
to enable the security framework and explicitly whitelist all marshalled classes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add XStream annotations (such as <code>@XStreamAlias</code>) on your domain classes to use a less verbose XML format.
Regardless, XML is still a very verbose format.
Reading or writing large datasets in this format can cause an <code>OutOfMemoryError</code>, <code>StackOverflowError</code>
or large performance degradation.</p>
</div>
</div>
<div class="sect4">
<h5 id="customSolutionFileIO"><a class="anchor" href="#customSolutionFileIO"></a><a class="link" href="#customSolutionFileIO">17.2.4.3. Custom <code>SolutionFileIO</code>: serialize to and from a custom format</a></h5>
<div class="paragraph">
<p>Implement your own <code>SolutionFileIO</code> implementation and configure it with the <code>solutionFileIOClass</code> element to write to a custom format (such as a txt or a binary format):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;problemBenchmarks&gt;
      &lt;solutionFileIOClass&gt;org.optaplanner.examples.machinereassignment.persistence.MachineReassignmentFileIO&lt;/solutionFileIOClass&gt;
      &lt;inputSolutionFile&gt;data/machinereassignment/import/model_a1_1.txt&lt;/inputSolutionFile&gt;
      ...
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s recommended that output files can be read as input files,
which implies that <code>getInputFileExtension()</code> and <code>getOutputFileExtension()</code> return the same value.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A <code>SolutionFileIO</code> implementation must be thread-safe.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="readingAnInputSolutionFromADatabase"><a class="anchor" href="#readingAnInputSolutionFromADatabase"></a><a class="link" href="#readingAnInputSolutionFromADatabase">17.2.4.4. Reading an input solution from a database or other storage</a></h5>
<div class="paragraph">
<p>There are two options if your dataset is in a relational database or another type of repository:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Extract the datasets from the database and serialize them to a local file (for example as XML with <code>XStreamSolutionFileIO</code> if XML isn&#8217;t too verbose).
Then use those files in <code>&lt;inputSolutionFile&gt;</code> elements.</p>
<div class="ulist">
<ul>
<li>
<p>The benchmarks are now more reliable because they run offline.</p>
</li>
<li>
<p>Each dataset is only loaded just in time.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Load all the datasets in advance and pass them to the <code>buildPlannerBenchmark()</code> method:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">        PlannerBenchmark plannerBenchmark = benchmarkFactory.buildPlannerBenchmark(dataset1, dataset2, dataset3);</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="warmingUpTheHotSpotCompiler"><a class="anchor" href="#warmingUpTheHotSpotCompiler"></a><a class="link" href="#warmingUpTheHotSpotCompiler">17.2.5. Warming up the HotSpot compiler</a></h4>
<div class="paragraph">
<p>Without a warm up, the results of the first (or first few) benchmarks are not reliable because they lose CPU time on HotSpot JIT compilation (and possibly DRL compilation too).</p>
</div>
<div class="paragraph">
<p>To avoid that distortion, the benchmarker runs some of the benchmarks for 30 seconds, before running the real benchmarks. That default warm up of 30 seconds usually suffices. Change it, for example to give it 60 seconds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;plannerBenchmark&gt;
  ...
  &lt;warmUpSecondsSpentLimit&gt;60&lt;/warmUpSecondsSpentLimit&gt;
  ...
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Turn off the warm up phase altogether by setting it to zero:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;plannerBenchmark&gt;
  ...
  &lt;warmUpSecondsSpentLimit&gt;0&lt;/warmUpSecondsSpentLimit&gt;
  ...
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The warm up time budget does not include the time it takes to load the datasets.
With large datasets, this can cause the warm up to run considerably longer than specified in the configuration.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkBlueprint"><a class="anchor" href="#benchmarkBlueprint"></a><a class="link" href="#benchmarkBlueprint">17.2.6. Benchmark blueprint: a predefined configuration</a></h4>
<div class="paragraph">
<p>To quickly configure and run a benchmark for typical solver configs, use a <code>solverBenchmarkBluePrint</code> instead of <code>solverBenchmark</code>s:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;plannerBenchmark&gt;
  &lt;benchmarkDirectory&gt;local/data/nqueens&lt;/benchmarkDirectory&gt;

  &lt;inheritedSolverBenchmark&gt;
    &lt;problemBenchmarks&gt;
      &lt;xStreamAnnotatedClass&gt;org.optaplanner.examples.nqueens.domain.NQueens&lt;/xStreamAnnotatedClass&gt;
      &lt;inputSolutionFile&gt;data/nqueens/unsolved/32queens.xml&lt;/inputSolutionFile&gt;
      &lt;inputSolutionFile&gt;data/nqueens/unsolved/64queens.xml&lt;/inputSolutionFile&gt;
    &lt;/problemBenchmarks&gt;
    &lt;solver&gt;
      &lt;solutionClass&gt;org.optaplanner.examples.nqueens.domain.NQueens&lt;/solutionClass&gt;
      &lt;entityClass&gt;org.optaplanner.examples.nqueens.domain.Queen&lt;/entityClass&gt;
      &lt;scoreDirectorFactory&gt;
        &lt;scoreDrl&gt;org/optaplanner/examples/nqueens/solver/nQueensConstraints.drl&lt;/scoreDrl&gt;
        &lt;initializingScoreTrend&gt;ONLY_DOWN&lt;/initializingScoreTrend&gt;
      &lt;/scoreDirectorFactory&gt;
      &lt;termination&gt;
        &lt;minutesSpentLimit&gt;1&lt;/minutesSpentLimit&gt;
      &lt;/termination&gt;
    &lt;/solver&gt;
  &lt;/inheritedSolverBenchmark&gt;

  &lt;solverBenchmarkBluePrint&gt;
    &lt;solverBenchmarkBluePrintType&gt;EVERY_CONSTRUCTION_HEURISTIC_TYPE_WITH_EVERY_LOCAL_SEARCH_TYPE&lt;/solverBenchmarkBluePrintType&gt;
  &lt;/solverBenchmarkBluePrint&gt;
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following <code>SolverBenchmarkBluePrintType</code>s are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CONSTRUCTION_HEURISTIC_WITH_AND_WITHOUT_LOCAL_SEARCH</code>: Run the default Construction Heuristic type with and without the default Local Search type.</p>
</li>
<li>
<p><code>EVERY_CONSTRUCTION_HEURISTIC_TYPE</code>: Run every Construction Heuristic type (First Fit, First Fit Decreasing, Cheapest Insertion, &#8230;&#8203;).</p>
</li>
<li>
<p><code>EVERY_LOCAL_SEARCH_TYPE</code>: Run every Local Search type (Tabu Search, Late Acceptance, &#8230;&#8203;) with the default Construction Heuristic.</p>
</li>
<li>
<p><code>EVERY_CONSTRUCTION_HEURISTIC_TYPE_WITH_EVERY_LOCAL_SEARCH_TYPE</code>: Run every Construction Heuristic type with every Local Search type.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="writeTheOutputSolutionOfBenchmarkRuns"><a class="anchor" href="#writeTheOutputSolutionOfBenchmarkRuns"></a><a class="link" href="#writeTheOutputSolutionOfBenchmarkRuns">17.2.7. Write the output solution of benchmark runs</a></h4>
<div class="paragraph">
<p>The best solution of each benchmark run can be written in the <code>benchmarkDirectory</code>.
By default, this is disabled, because the files are rarely used and considered bloat.
Also, on large datasets, writing the best solution of each single benchmark can take quite some time and memory (causing an <code>OutOfMemoryError</code>), especially in a verbose format like XStream XML.</p>
</div>
<div class="paragraph">
<p>To write those solutions in the <code>benchmarkDirectory</code>, enable <code>writeOutputSolutionEnabled</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;problemBenchmarks&gt;
      ...
      &lt;writeOutputSolutionEnabled&gt;true&lt;/writeOutputSolutionEnabled&gt;
      ...
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkLogging"><a class="anchor" href="#benchmarkLogging"></a><a class="link" href="#benchmarkLogging">17.2.8. Benchmark logging</a></h4>
<div class="paragraph">
<p>Benchmark logging is configured like <a href="#logging">solver logging</a>.</p>
</div>
<div class="paragraph">
<p>To separate the log messages of each single benchmark run into a separate file, use the <a href="http://logback.qos.ch/manual/mdc.html">MDC</a> with key <code>singleBenchmark.name</code> in a sifting appender.
For example with Logback in <code>logback.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;appender name="fileAppender" class="ch.qos.logback.classic.sift.SiftingAppender"&gt;
    &lt;discriminator&gt;
      &lt;key&gt;singleBenchmark.name&lt;/key&gt;
      &lt;defaultValue&gt;app&lt;/defaultValue&gt;
    &lt;/discriminator&gt;
    &lt;sift&gt;
      &lt;appender name="fileAppender.${singleBenchmark.name}" class="...FileAppender"&gt;
        &lt;file&gt;local/log/optaplannerBenchmark-${singleBenchmark.name}.log&lt;/file&gt;
        ...
      &lt;/appender&gt;
    &lt;/sift&gt;
  &lt;/appender&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="benchmarkReport"><a class="anchor" href="#benchmarkReport"></a><a class="link" href="#benchmarkReport">17.3. Benchmark report</a></h3>
<div class="sect3">
<h4 id="benchmarkHtmlReport"><a class="anchor" href="#benchmarkHtmlReport"></a><a class="link" href="#benchmarkHtmlReport">17.3.1. HTML report</a></h4>
<div class="paragraph">
<p>After running a benchmark, an HTML report will be written in the <code>benchmarkDirectory</code> with the <code>index.html</code> filename.
Open it in your browser.
It has a nice overview of your benchmark including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Summary statistics: graphs and tables</p>
</li>
<li>
<p>Problem statistics per <code>inputSolutionFile</code>: graphs and CSV</p>
</li>
<li>
<p>Each solver configuration (ranked): Handy to copy and paste</p>
</li>
<li>
<p>Benchmark information: settings, hardware, &#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Graphs are generated by the excellent <a href="http://www.jfree.org/jfreechart/">JFreeChart</a> library.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The HTML report will use your default locale to format numbers.
If you share the benchmark report with people from another country, consider overwriting the <code>locale</code> accordingly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;plannerBenchmark&gt;
  ...
  &lt;benchmarkReport&gt;
    &lt;locale&gt;en_US&lt;/locale&gt;
  &lt;/benchmarkReport&gt;
  ...
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="rankingTheSolvers"><a class="anchor" href="#rankingTheSolvers"></a><a class="link" href="#rankingTheSolvers">17.3.2. Ranking the solvers</a></h4>
<div class="paragraph">
<p>The benchmark report automatically ranks the solvers.
The <code>Solver</code> with rank <code>0</code> is called the favorite <code>Solver</code>: it performs best overall, but it might not be the best on every problem.
It&#8217;s recommended to use that favorite <code>Solver</code> in production.</p>
</div>
<div class="paragraph">
<p>However, there are different ways of ranking the solvers.
Configure it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;plannerBenchmark&gt;
  ...
  &lt;benchmarkReport&gt;
    &lt;solverRankingType&gt;TOTAL_SCORE&lt;/solverRankingType&gt;
  &lt;/benchmarkReport&gt;
  ...
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following <code>solverRankingType</code>s are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>TOTAL_SCORE</code> (default): Maximize the overall score, so minimize the overall cost if all solutions would be executed.</p>
</li>
<li>
<p><code>WORST_SCORE</code>: Minimize the worst case scenario.</p>
</li>
<li>
<p><code>TOTAL_RANKING</code>: Maximize the overall ranking. Use this if your datasets differ greatly in size or difficulty, producing a difference in <code>Score</code> magnitude.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>Solver</code>s with at least one failed single benchmark do not get a ranking.
<code>Solver</code>s with not fully initialized solutions are ranked worse.</p>
</div>
<div class="paragraph">
<p>To use a custom ranking, implement a <code>Comparator</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;benchmarkReport&gt;
    &lt;solverRankingComparatorClass&gt;...TotalScoreSolverRankingComparator&lt;/solverRankingComparatorClass&gt;
  &lt;/benchmarkReport&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or by implementing a weight factory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">  &lt;benchmarkReport&gt;
    &lt;solverRankingWeightFactoryClass&gt;...TotalRankSolverRankingWeightFactory&lt;/solverRankingWeightFactoryClass&gt;
  &lt;/benchmarkReport&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="benchmarkReportSummaryStatistics"><a class="anchor" href="#benchmarkReportSummaryStatistics"></a><a class="link" href="#benchmarkReportSummaryStatistics">17.4. Summary statistics</a></h3>
<div class="sect3">
<h4 id="benchmarkReportBestScoreSummary"><a class="anchor" href="#benchmarkReportBestScoreSummary"></a><a class="link" href="#benchmarkReportBestScoreSummary">17.4.1. Best score summary (graph and table)</a></h4>
<div class="paragraph">
<p>Shows the best score per <code>inputSolutionFile</code> for each solver configuration.</p>
</div>
<div class="paragraph">
<p>Useful for visualizing the best solver configuration.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./BenchmarkingAndTweaking/bestScoreSummary.png" alt="bestScoreSummary">
</div>
<div class="title">Figure 8. Best score summary statistic</div>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportBestScoreScalabilitySummary"><a class="anchor" href="#benchmarkReportBestScoreScalabilitySummary"></a><a class="link" href="#benchmarkReportBestScoreScalabilitySummary">17.4.2. Best score scalability summary (graph)</a></h4>
<div class="paragraph">
<p>Shows the best score per problem scale for each solver configuration.</p>
</div>
<div class="paragraph">
<p>Useful for visualizing the scalability of each solver configuration.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The problem scale will report <code>0</code> if any <code>@ValueRangeProvider</code> method signature returns ValueRange (instead of <code>CountableValueRange</code> or <code>Collection</code>).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportBestScoreDistributionSummary"><a class="anchor" href="#benchmarkReportBestScoreDistributionSummary"></a><a class="link" href="#benchmarkReportBestScoreDistributionSummary">17.4.3. Best score distribution summary (graph)</a></h4>
<div class="paragraph">
<p>Shows the best score distribution per <code>inputSolutionFile</code> for each solver configuration.</p>
</div>
<div class="paragraph">
<p>Useful for visualizing the reliability of each solver configuration.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./BenchmarkingAndTweaking/bestScoreDistributionSummary.png" alt="bestScoreDistributionSummary">
</div>
<div class="title">Figure 9. Best Score Distribution Summary Statistic</div>
</div>
<div class="paragraph">
<p>Enable <a href="#statisticalBenchmarking">statistical benchmarking</a> to use this summary.</p>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportWinningScoreDifferenceSummary"><a class="anchor" href="#benchmarkReportWinningScoreDifferenceSummary"></a><a class="link" href="#benchmarkReportWinningScoreDifferenceSummary">17.4.4. Winning score difference summary (graph And table)</a></h4>
<div class="paragraph">
<p>Shows the winning score difference per <code>inputSolutionFile</code> for each solver configuration.
The winning score difference is the score difference with the score of the winning solver configuration for that particular <code>inputSolutionFile</code>.</p>
</div>
<div class="paragraph">
<p>Useful for zooming in on the results of the best score summary.</p>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportWorstScoreDifferencePercentageSummary"><a class="anchor" href="#benchmarkReportWorstScoreDifferencePercentageSummary"></a><a class="link" href="#benchmarkReportWorstScoreDifferencePercentageSummary">17.4.5. Worst score difference percentage (ROI) summary (graph And table)</a></h4>
<div class="paragraph">
<p>Shows the return on investment (ROI) per <code>inputSolutionFile</code> for each solver configuration if you&#8217;d upgrade from the worst solver configuration for that particular <code>inputSolutionFile</code>.</p>
</div>
<div class="paragraph">
<p>Useful for visualizing the return on investment (ROI) to decision makers.</p>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportScoreCalculationSpeedSummary"><a class="anchor" href="#benchmarkReportScoreCalculationSpeedSummary"></a><a class="link" href="#benchmarkReportScoreCalculationSpeedSummary">17.4.6. Score calculation speed summary (graph And table)</a></h4>
<div class="paragraph">
<p>Shows the score calculation speed: a count per second per problem scale for each solver configuration.</p>
</div>
<div class="paragraph">
<p>Useful for comparing different score calculators and/or constraint implementations
(presuming that the solver configurations do not differ otherwise).
Also useful to measure the scalability cost of an extra constraint.</p>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportTimeSpentSummary"><a class="anchor" href="#benchmarkReportTimeSpentSummary"></a><a class="link" href="#benchmarkReportTimeSpentSummary">17.4.7. Time spent summary (graph And table)</a></h4>
<div class="paragraph">
<p>Shows the time spent per <code>inputSolutionFile</code> for each solver configuration.
This is pointless if it&#8217;s benchmarking against a fixed time limit.</p>
</div>
<div class="paragraph">
<p>Useful for visualizing the performance of construction heuristics (presuming that no other solver phases are configured).</p>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportTimeSpentScalabilitySummary"><a class="anchor" href="#benchmarkReportTimeSpentScalabilitySummary"></a><a class="link" href="#benchmarkReportTimeSpentScalabilitySummary">17.4.8. Time spent scalability summary (graph)</a></h4>
<div class="paragraph">
<p>Shows the time spent per problem scale for each solver configuration.
This is pointless if it&#8217;s benchmarking against a fixed time limit.</p>
</div>
<div class="paragraph">
<p>Useful for extrapolating the scalability of construction heuristics (presuming that no other solver phases are configured).</p>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportBestScorePerTimeSpentSummary"><a class="anchor" href="#benchmarkReportBestScorePerTimeSpentSummary"></a><a class="link" href="#benchmarkReportBestScorePerTimeSpentSummary">17.4.9. Best score per time spent summary (graph)</a></h4>
<div class="paragraph">
<p>Shows the best score per time spent for each solver configuration.
This is pointless if it&#8217;s benchmarking against a fixed time limit.</p>
</div>
<div class="paragraph">
<p>Useful for visualizing trade-off between the best score versus the time spent for construction heuristics (presuming that no other solver phases are configured).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="benchmarkReportStatisticPerDataset"><a class="anchor" href="#benchmarkReportStatisticPerDataset"></a><a class="link" href="#benchmarkReportStatisticPerDataset">17.5. Statistic per dataset (graph and CSV)</a></h3>
<div class="sect3">
<h4 id="enableAProblemStatistic"><a class="anchor" href="#enableAProblemStatistic"></a><a class="link" href="#enableAProblemStatistic">17.5.1. Enable a problem statistic</a></h4>
<div class="paragraph">
<p>The benchmarker supports outputting problem statistics as graphs and CSV (comma separated values) files to the <code>benchmarkDirectory</code>.
To configure one or more, add a <code>problemStatisticType</code> line for each one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;plannerBenchmark&gt;
  &lt;benchmarkDirectory&gt;local/data/nqueens/solved&lt;/benchmarkDirectory&gt;
  &lt;inheritedSolverBenchmark&gt;
    &lt;problemBenchmarks&gt;
      ...
      &lt;problemStatisticType&gt;BEST_SCORE&lt;/problemStatisticType&gt;
      &lt;problemStatisticType&gt;SCORE_CALCULATION_SPEED&lt;/problemStatisticType&gt;
    &lt;/problemBenchmarks&gt;
    ...
  &lt;/inheritedSolverBenchmark&gt;
  ...
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These problem statistics can slow down the solvers noticeably, which affects the benchmark results.
That&#8217;s why they are optional and only <code>BEST_SCORE</code> is enabled by default.
To disable that one too, use <code>problemStatisticEnabled</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;problemBenchmarks&gt;
      ...
      &lt;problemStatisticEnabled&gt;false&lt;/problemStatisticEnabled&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The summary statistics do not slow down the solver and are always generated.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following types are supported:</p>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportBestScoreOverTimeStatistic"><a class="anchor" href="#benchmarkReportBestScoreOverTimeStatistic"></a><a class="link" href="#benchmarkReportBestScoreOverTimeStatistic">17.5.2. Best score over time statistic (graph and CSV)</a></h4>
<div class="paragraph">
<p>Shows how the best score evolves over time. It is run by default.
To run it when other statistics are configured, also add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;problemBenchmarks&gt;
      ...
      &lt;problemStatisticType&gt;BEST_SCORE&lt;/problemStatisticType&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./BenchmarkingAndTweaking/bestScoreStatistic.png" alt="bestScoreStatistic">
</div>
<div class="title">Figure 10. Best Score Over Time Statistic</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A time gradient based algorithm (such as Simulated Annealing) will have a different statistic if it&#8217;s run with a different time limit configuration.
That&#8217;s because this Simulated Annealing implementation automatically determines its velocity based on the amount of time that can be spent.
On the other hand, for the Tabu Search and Late Acceptance, what you see is what you&#8217;d get.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>The best score over time statistic is very useful to detect abnormalities, such as a
potential <a href="#scoreTrap">score trap</a> which gets the solver temporarily stuck in a local optima.</strong></p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./BenchmarkingAndTweaking/letTheBestScoreStatisticGuideYou.png" alt="letTheBestScoreStatisticGuideYou">
</div>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportStepScoreOverTimeStatistic"><a class="anchor" href="#benchmarkReportStepScoreOverTimeStatistic"></a><a class="link" href="#benchmarkReportStepScoreOverTimeStatistic">17.5.3. Step score over time statistic (graph and CSV)</a></h4>
<div class="paragraph">
<p>To see how the step score evolves over time, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;problemBenchmarks&gt;
      ...
      &lt;problemStatisticType&gt;STEP_SCORE&lt;/problemStatisticType&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./BenchmarkingAndTweaking/stepScoreStatistic.png" alt="stepScoreStatistic">
</div>
<div class="title">Figure 11. Step Score Over Time Statistic</div>
</div>
<div class="paragraph">
<p>Compare the step score statistic with the best score statistic (especially on parts for which the best score flatlines). If it hits a local optima, the solver should take deteriorating steps to escape it.
But it shouldn&#8217;t deteriorate too much either.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The step score statistic has been seen to slow down the solver noticeably due to GC stress,
especially for fast stepping algorithms
(such as <a href="#simulatedAnnealing">Simulated Annealing</a> and <a href="#lateAcceptance">Late Acceptance</a>).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportScoreCalculationSpeedOverTimeStatistic"><a class="anchor" href="#benchmarkReportScoreCalculationSpeedOverTimeStatistic"></a><a class="link" href="#benchmarkReportScoreCalculationSpeedOverTimeStatistic">17.5.4. Score calculation speed over time statistic (graph and CSV)</a></h4>
<div class="paragraph">
<p>To see how fast the scores are calculated, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;problemBenchmarks&gt;
      ...
      &lt;problemStatisticType&gt;SCORE_CALCULATION_SPEED&lt;/problemStatisticType&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./BenchmarkingAndTweaking/scoreCalculationSpeedStatistic.png" alt="scoreCalculationSpeedStatistic">
</div>
<div class="title">Figure 12. Score Calculation Speed Statistic</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The initial high calculation speed is typical during solution initialization: it&#8217;s far easier to calculate the score of a solution if only a handful planning entities have been initialized, than when all the planning entities are initialized.</p>
</div>
<div class="paragraph">
<p>After those few seconds of initialization, the calculation speed is relatively stable, apart from an occasional stop-the-world garbage collector disruption.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportBestSolutionMutationOverTimeStatistic"><a class="anchor" href="#benchmarkReportBestSolutionMutationOverTimeStatistic"></a><a class="link" href="#benchmarkReportBestSolutionMutationOverTimeStatistic">17.5.5. Best solution mutation over time statistic (graph and CSV)</a></h4>
<div class="paragraph">
<p>To see how much each new best solution differs from the <em>previous best solution</em>, by counting the number of planning variables which have a different value (not including the variables that have changed multiple times but still end up with the same value), add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;problemBenchmarks&gt;
      ...
      &lt;problemStatisticType&gt;BEST_SOLUTION_MUTATION&lt;/problemStatisticType&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./BenchmarkingAndTweaking/bestSolutionMutationStatistic.png" alt="bestSolutionMutationStatistic">
</div>
<div class="title">Figure 13. Best Solution Mutation Over Time Statistic</div>
</div>
<div class="paragraph">
<p>Use Tabu Search - an algorithm that behaves like a human - to get an estimation on how difficult it would be for a human to improve the previous best solution to that new best solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportMoveCountPerStepStatistic"><a class="anchor" href="#benchmarkReportMoveCountPerStepStatistic"></a><a class="link" href="#benchmarkReportMoveCountPerStepStatistic">17.5.6. Move count per step statistic (graph and CSV)</a></h4>
<div class="paragraph">
<p>To see how the selected and accepted move count per step evolves over time, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;problemBenchmarks&gt;
      ...
      &lt;problemStatisticType&gt;MOVE_COUNT_PER_STEP&lt;/problemStatisticType&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./BenchmarkingAndTweaking/moveCountPerStepStatistic.png" alt="moveCountPerStepStatistic">
</div>
<div class="title">Figure 14. Move Count Per Step Statistic</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This statistic has been seen to slow down the solver noticeably due to GC stress, especially for fast stepping algorithms (such as Simulated Annealing and Late Acceptance).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportMemoryUseStatistic"><a class="anchor" href="#benchmarkReportMemoryUseStatistic"></a><a class="link" href="#benchmarkReportMemoryUseStatistic">17.5.7. Memory use statistic (graph and CSV)</a></h4>
<div class="paragraph">
<p>To see how much memory is used, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;problemBenchmarks&gt;
      ...
      &lt;problemStatisticType&gt;MEMORY_USE&lt;/problemStatisticType&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./BenchmarkingAndTweaking/memoryUseStatistic.png" alt="memoryUseStatistic">
</div>
<div class="title">Figure 15. Memory Use Statistic</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
==
The memory use statistic has been seen to affect the solver noticeably.
==
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="benchmarkReportStatisticPerSingleBenchmark"><a class="anchor" href="#benchmarkReportStatisticPerSingleBenchmark"></a><a class="link" href="#benchmarkReportStatisticPerSingleBenchmark">17.6. Statistic per single benchmark (graph and CSV)</a></h3>
<div class="sect3">
<h4 id="enableASingleStatistic"><a class="anchor" href="#enableASingleStatistic"></a><a class="link" href="#enableASingleStatistic">17.6.1. Enable a single statistic</a></h4>
<div class="paragraph">
<p>A single statistic is static for one dataset for one solver configuration.
Unlike a problem statistic, it does not aggregate over solver configurations.</p>
</div>
<div class="paragraph">
<p>The benchmarker supports outputting single statistics as graphs and CSV (comma separated values) files to the <code>benchmarkDirectory</code>.
To configure one, add a <code>singleStatisticType</code> line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;plannerBenchmark&gt;
  &lt;benchmarkDirectory&gt;local/data/nqueens/solved&lt;/benchmarkDirectory&gt;
  &lt;inheritedSolverBenchmark&gt;
    &lt;problemBenchmarks&gt;
      ...
      &lt;problemStatisticType&gt;...&lt;/problemStatisticType&gt;
      &lt;singleStatisticType&gt;PICKED_MOVE_TYPE_BEST_SCORE_DIFF&lt;/singleStatisticType&gt;
    &lt;/problemBenchmarks&gt;
    ...
  &lt;/inheritedSolverBenchmark&gt;
  ...
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multiple <code>singleStatisticType</code> elements are allowed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These statistic per single benchmark can slow down the solver noticeably, which affects the benchmark results.
That&#8217;s why they are optional and not enabled by default.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following types are supported:</p>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportConstraintMatchTotalBestScoreOverTimeStatistic"><a class="anchor" href="#benchmarkReportConstraintMatchTotalBestScoreOverTimeStatistic"></a><a class="link" href="#benchmarkReportConstraintMatchTotalBestScoreOverTimeStatistic">17.6.2. Constraint match total best score over time statistic (graph and CSV)</a></h4>
<div class="paragraph">
<p>To see which constraints are matched in the best score (and how much) over time, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;problemBenchmarks&gt;
      ...
      &lt;singleStatisticType&gt;CONSTRAINT_MATCH_TOTAL_BEST_SCORE&lt;/singleStatisticType&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./BenchmarkingAndTweaking/constraintMatchTotalBestScoreStatistic.png" alt="constraintMatchTotalBestScoreStatistic">
</div>
<div class="title">Figure 16. Constraint Match Total Best Score Diff Over Time Statistic</div>
</div>
<div class="paragraph">
<p>Requires the score calculation to support <a href="#explainingTheScore">constraint matches</a>.
<a href="#droolsScoreCalculation">Drools score calculation</a> supports constraint matches automatically,
but <a href="#incrementalJavaScoreCalculation">incremental Java score calculation</a> requires more work.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The constraint match total statistics affect the solver noticeably.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportConstraintMatchTotalStepScoreOverTimeStatistic"><a class="anchor" href="#benchmarkReportConstraintMatchTotalStepScoreOverTimeStatistic"></a><a class="link" href="#benchmarkReportConstraintMatchTotalStepScoreOverTimeStatistic">17.6.3. Constraint match total step score over time statistic (graph and CSV)</a></h4>
<div class="paragraph">
<p>To see which constraints are matched in the step score (and how much) over time, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;problemBenchmarks&gt;
      ...
      &lt;singleStatisticType&gt;CONSTRAINT_MATCH_TOTAL_STEP_SCORE&lt;/singleStatisticType&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./BenchmarkingAndTweaking/constraintMatchTotalStepScoreStatistic.png" alt="constraintMatchTotalStepScoreStatistic">
</div>
<div class="title">Figure 17. Constraint Match Total Step Score Diff Over Time Statistic</div>
</div>
<div class="paragraph">
<p>Also requires the score calculation to support <a href="#explainingTheScore">constraint matches</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The constraint match total statistics affect the solver noticeably.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportPickedMoveTypeBestScoreDiffOverTimeStatistic"><a class="anchor" href="#benchmarkReportPickedMoveTypeBestScoreDiffOverTimeStatistic"></a><a class="link" href="#benchmarkReportPickedMoveTypeBestScoreDiffOverTimeStatistic">17.6.4. Picked move type best score diff over time statistic (graph and CSV)</a></h4>
<div class="paragraph">
<p>To see which move types improve the best score (and how much) over time, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;problemBenchmarks&gt;
      ...
      &lt;singleStatisticType&gt;PICKED_MOVE_TYPE_BEST_SCORE_DIFF&lt;/singleStatisticType&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./BenchmarkingAndTweaking/pickedMoveTypeBestScoreDiffStatistic.png" alt="pickedMoveTypeBestScoreDiffStatistic">
</div>
<div class="title">Figure 18. Picked Move Type Best Score Diff Over Time Statistic</div>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportPickedMoveTypeStepScoreDiffOverTimeStatistic"><a class="anchor" href="#benchmarkReportPickedMoveTypeStepScoreDiffOverTimeStatistic"></a><a class="link" href="#benchmarkReportPickedMoveTypeStepScoreDiffOverTimeStatistic">17.6.5. Picked move type step score diff over time statistic (graph and CSV)</a></h4>
<div class="paragraph">
<p>To see how much each winning step affects the step score over time, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">    &lt;problemBenchmarks&gt;
      ...
      &lt;singleStatisticType&gt;PICKED_MOVE_TYPE_STEP_SCORE_DIFF&lt;/singleStatisticType&gt;
    &lt;/problemBenchmarks&gt;</code></pre>
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./BenchmarkingAndTweaking/pickedMoveTypeStepScoreDiffStatistic.png" alt="pickedMoveTypeStepScoreDiffStatistic">
</div>
<div class="title">Figure 19. Picked Move Type Step Score Diff Over Time Statistic</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="advancedBenchmarking"><a class="anchor" href="#advancedBenchmarking"></a><a class="link" href="#advancedBenchmarking">17.7. Advanced benchmarking</a></h3>
<div class="sect3">
<h4 id="benchmarkingPerformanceTricks"><a class="anchor" href="#benchmarkingPerformanceTricks"></a><a class="link" href="#benchmarkingPerformanceTricks">17.7.1. Benchmarking performance tricks</a></h4>
<div class="sect4">
<h5 id="parallelBenchmarkingOnMultipleThreads"><a class="anchor" href="#parallelBenchmarkingOnMultipleThreads"></a><a class="link" href="#parallelBenchmarkingOnMultipleThreads">17.7.1.1. Parallel benchmarking on multiple threads</a></h5>
<div class="paragraph">
<p>If you have multiple processors available on your computer, you can run multiple benchmarks in parallel on multiple threads to get your benchmarks results faster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;plannerBenchmark&gt;
  ...
  &lt;parallelBenchmarkCount&gt;AUTO&lt;/parallelBenchmarkCount&gt;
  ...
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Running too many benchmarks in parallel will affect the results of benchmarks negatively.
Leave some processors unused for garbage collection and other processes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following <code>parallelBenchmarkCount</code>s are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>1</code> (default): Run all benchmarks sequentially.</p>
</li>
<li>
<p><code>AUTO</code>: Let OptaPlanner decide how many benchmarks to run in parallel. This formula is based on experience. It&#8217;s recommended to prefer this over the other parallel enabling options.</p>
</li>
<li>
<p>Static number: The number of benchmarks to run in parallel.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;parallelBenchmarkCount&gt;2&lt;/parallelBenchmarkCount&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>JavaScript formula: Formula for the number of benchmarks to run in parallel. It can use the variable <code>availableProcessorCount</code>. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;parallelBenchmarkCount&gt;(availableProcessorCount / 2) + 1&lt;/parallelBenchmarkCount&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>parallelBenchmarkCount</code> is always limited to the number of available processors.
If it&#8217;s higher, it will be automatically decreased.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you have a computer with slow or unreliable cooling, increasing the <code>parallelBenchmarkCount</code> above one (even on <code>AUTO</code>) may overheat your CPU.</p>
</div>
<div class="paragraph">
<p>The <code>sensors</code> command can help you detect if this is the case.
It is available in the package <code>lm_sensors</code> or <code>lm-sensors</code> in most Linux distributions.
There are several freeware tools available for Windows too.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The benchmarker uses a thread pool internally, but you can optionally plug in a custom <code>ThreadFactory</code>,
for example when running benchmarks on an application server or a cloud platform:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;plannerBenchmark&gt;
  ...
  &lt;threadFactoryClass&gt;...MyCustomThreadFactory&lt;/threadFactoryClass&gt;
  ...
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In the future, we will also support multi-JVM benchmarking.
This feature is independent of <a href="#multithreadedSolving">multithreaded solving</a> or multi-JVM solving.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="statisticalBenchmarking"><a class="anchor" href="#statisticalBenchmarking"></a><a class="link" href="#statisticalBenchmarking">17.7.2. Statistical benchmarking</a></h4>
<div class="paragraph">
<p>To minimize the influence of your environment and the Random Number Generator on the benchmark results, configure the number of times each single benchmark run is repeated.
The results of those runs are statistically aggregated.
Each individual result is also visible in the report, as well as plotted in <a href="#benchmarkReportBestScoreDistributionSummary">the best score distribution summary</a>.</p>
</div>
<div class="paragraph">
<p>Just add a <code>&lt;subSingleCount&gt;</code> element to an <a href="#inheritedSolverBenchmark"><code>&lt;inheritedSolverBenchmark&gt;</code></a> element or in a <code>&lt;solverBenchmark&gt;</code> element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;plannerBenchmark&gt;
  ...
  &lt;inheritedSolverBenchmark&gt;
    ...
    &lt;solver&gt;
      ...
    &lt;/solver&gt;
    &lt;subSingleCount&gt;10&lt;/subSingleCount&gt;
  &lt;/inheritedSolverBenchmark&gt;
  ...
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>subSingleCount</code> defaults to <code>1</code> (so no statistical benchmarking).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If <code>subSingleCount</code> is higher than <code>1</code>, the benchmarker will automatically use a <em>different</em><a href="#randomNumberGenerator"><code>Random</code> seed</a> for every sub single run, without losing reproducibility (for each sub single index) in <a href="#environmentMode">EnvironmentMode</a><code>REPRODUCIBLE</code> and lower.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="templateBasedBenchmarking"><a class="anchor" href="#templateBasedBenchmarking"></a><a class="link" href="#templateBasedBenchmarking">17.7.3. Template-based benchmarking and matrix benchmarking</a></h4>
<div class="paragraph">
<p>Matrix benchmarking is benchmarking a combination of value sets.
For example: benchmark four <code>entityTabuSize</code> values (<code>5</code>, <code>7</code>, <code>11</code> and <code>13</code>) combined with three <code>acceptedCountLimit</code> values (<code>500</code>, <code>1000</code> and <code>2000</code>), resulting in 12 solver configurations.</p>
</div>
<div class="paragraph">
<p>To reduce the verbosity of such a benchmark configuration, you can use a <a href="http://freemarker.org/">Freemarker</a> template for the benchmark configuration instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;plannerBenchmark&gt;
  ...
  &lt;inheritedSolverBenchmark&gt;
    ...
  &lt;/inheritedSolverBenchmark&gt;

&lt;#list [5, 7, 11, 13] as entityTabuSize&gt;
&lt;#list [500, 1000, 2000] as acceptedCountLimit&gt;
  &lt;solverBenchmark&gt;
    &lt;name&gt;Tabu Search entityTabuSize ${entityTabuSize} acceptedCountLimit ${acceptedCountLimit}&lt;/name&gt;
    &lt;solver&gt;
      &lt;localSearch&gt;
        &lt;unionMoveSelector&gt;
          &lt;changeMoveSelector/&gt;
          &lt;swapMoveSelector/&gt;
        &lt;/unionMoveSelector&gt;
        &lt;acceptor&gt;
          &lt;entityTabuSize&gt;${entityTabuSize}&lt;/entityTabuSize&gt;
        &lt;/acceptor&gt;
        &lt;forager&gt;
          &lt;acceptedCountLimit&gt;${acceptedCountLimit}&lt;/acceptedCountLimit&gt;
        &lt;/forager&gt;
      &lt;/localSearch&gt;
    &lt;/solver&gt;
  &lt;/solverBenchmark&gt;
&lt;/#list&gt;
&lt;/#list&gt;
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To configure Matrix Benchmarking for Simulated Annealing (or any other configuration that involves a <code>Score</code> template variable), use the <code>replace()</code> method in the solver benchmark name element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;plannerBenchmark&gt;
  ...
  &lt;inheritedSolverBenchmark&gt;
    ...
  &lt;/inheritedSolverBenchmark&gt;

&lt;#list ["1hard/10soft", "1hard/20soft", "1hard/50soft", "1hard/70soft"] as startingTemperature&gt;
  &lt;solverBenchmark&gt;
    &lt;name&gt;Simulated Annealing startingTemperature ${startingTemperature?replace("/", "_")}&lt;/name&gt;
    &lt;solver&gt;
      &lt;localSearch&gt;
        &lt;acceptor&gt;
          &lt;simulatedAnnealingStartingTemperature&gt;${startingTemperature}&lt;/simulatedAnnealingStartingTemperature&gt;
        &lt;/acceptor&gt;
      &lt;/localSearch&gt;
    &lt;/solver&gt;
  &lt;/solverBenchmark&gt;
&lt;/#list&gt;
&lt;/plannerBenchmark&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A solver benchmark name doesn&#8217;t allow some characters (such a <code>/</code>) because the name is also used a file name.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And build it with the class <code>PlannerBenchmarkFactory</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">        PlannerBenchmarkFactory benchmarkFactory = PlannerBenchmarkFactory.createFromFreemarkerXmlResource(
                "org/optaplanner/examples/cloudbalancing/optional/benchmark/cloudBalancingBenchmarkConfigTemplate.xml.ftl");
        PlannerBenchmark benchmark = benchmarkFactory.buildPlannerBenchmark();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="benchmarkReportAggregation"><a class="anchor" href="#benchmarkReportAggregation"></a><a class="link" href="#benchmarkReportAggregation">17.7.4. Benchmark report aggregation</a></h4>
<div class="paragraph">
<p>The <code>BenchmarkAggregator</code> takes one or more existing benchmarks and merges them into new benchmark report, without actually running the benchmarks again.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./BenchmarkingAndTweaking/benchmarkAggregator.png" alt="benchmarkAggregator">
</div>
</div>
<div class="paragraph">
<p>This is useful to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Report on the impact of code changes</strong>: Run the same benchmark configuration before and after the code changes, then aggregate a report.</p>
</li>
<li>
<p><strong>Report on the impact of dependency upgrades</strong>: Run the same benchmark configuration before and after upgrading the dependency, then aggregate a report.</p>
</li>
<li>
<p><strong>Summarize a too verbose report</strong>: Select only the interesting solver benchmarks from the existing report. This especially useful on template reports to make the graphs readable.</p>
</li>
<li>
<p><strong>Partially rerun a benchmark</strong>: Rerun part of an existing report (for example only the failed or invalid solvers), then recreate the original intended report with the new values.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Compose the aggregated report in the Benchmark aggregator UI:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./BenchmarkingAndTweaking/benchmarkAggregatorScreenshot.png" alt="benchmarkAggregatorScreenshot">
</div>
</div>
<div class="paragraph">
<p>To display that UI, provide a benchmark config to the <code>BenchmarkAggregatorFrame</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    public static void main(String[] args) {
        BenchmarkAggregatorFrame.createAndDisplayFromXmlResource(
                "org/optaplanner/examples/cloudbalancing/benchmark/cloudBalancingBenchmarkConfig.xml");
    }</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Despite that it uses a benchmark configuration as input, it ignores all elements of that configuration,
except for the elements <code>&lt;benchmarkDirectory&gt;</code> and <code>&lt;benchmarkReport&gt;</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the GUI, select the interesting benchmarks and click the button to generate the aggregated report.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>All the input reports which are being merged should have been generated with the same OptaPlanner version (excluding hotfix differences) as the <code>BenchmarkAggregator</code>.
Using reports from different OptaPlanner major or minor versions are not guaranteed to succeed and deliver correct information,
because the benchmark report data structure often changes.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="repeatedPlanning"><a class="anchor" href="#repeatedPlanning"></a><a class="link" href="#repeatedPlanning">18. Repeated planning</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="introductionToRepeatedPlanning"><a class="anchor" href="#introductionToRepeatedPlanning"></a><a class="link" href="#introductionToRepeatedPlanning">18.1. Introduction to repeated planning</a></h3>
<div class="paragraph">
<p>The problem facts used to create a solution may change before or during the execution of that solution. Delaying planning in order to lower the risk of problem facts changing is not ideal, as an incomplete plan is preferable to no plan.</p>
</div>
<div class="paragraph">
<p>The following examples demonstrate situations where planning solutions need to be altered due to unpredictable changes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Unforeseen fact changes</em></p>
<div class="ulist">
<ul>
<li>
<p>An employee assigned to a shift calls in sick.</p>
</li>
<li>
<p>An airplane scheduled to take off has a technical delay.</p>
</li>
<li>
<p>One of the machines or vehicles break down.</p>
<div class="paragraph">
<p>Unforeseen fact changes benefit from using <em>backup planning</em>.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><em>Cannot assign all entities immediately</em></p>
<div class="paragraph">
<p>Leave some unassigned. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>There are 10 shifts at the same time to assign but only nine employees to handle shifts.</p>
<div class="paragraph">
<p>For this type of planning, use <a href="#overconstrainedPlanning"><em>overconstrained planning</em></a>.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><em>Unknown long term future facts</em></p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Hospital admissions for the next two weeks are reliable, but those for week three and four are less reliable, and for week five and beyond are not worth planning yet.</p>
<div class="paragraph">
<p>This problem benefits from <a href="#continuousPlanning"><em>continuous planning</em></a>.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><em>Constantly changing problem facts</em></p>
<div class="paragraph">
<p>Use <a href="#realTimePlanning"><em>real-time planning</em></a>.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>More CPU time results in a better planning solution.</p>
</div>
<div class="paragraph">
<p>OptaPlanner allows you to start planning earlier, despite unforeseen changes, as the optimization algorithms support planning a solution that has already been partially planned. This is known as repeated planning.</p>
</div>
</div>
<div class="sect2">
<h3 id="backupPlanning"><a class="anchor" href="#backupPlanning"></a><a class="link" href="#backupPlanning">18.2. Backup planning</a></h3>
<div class="paragraph">
<p>Backup planning adds extra score constraints to create space in the planning for when things go wrong. That creates a backup plan within the plan itself.</p>
</div>
<div class="paragraph">
<p>An example of backup planning is as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create an extra score constraint. For example:</p>
<div class="ulist">
<ul>
<li>
<p>Assign an employee as the spare employee (one for every 10 shifts at the same time).</p>
</li>
<li>
<p>Keep one hospital bed open in each department.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Change the planning problem when an unforeseen event occurs.</p>
<div class="paragraph">
<p>For example, if an employee calls in sick:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Delete the sick employee and leave their shifts unassigned.</p>
</li>
<li>
<p>Restart the planning, starting from that solution, which now has a different score.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The construction heuristics fills in the newly created gaps (probably with the spare employee) and the metaheuristics will improve it even further.</p>
</div>
</div>
<div class="sect2">
<h3 id="overconstrainedPlanning"><a class="anchor" href="#overconstrainedPlanning"></a><a class="link" href="#overconstrainedPlanning">18.3. Overconstrained planning</a></h3>
<div class="paragraph">
<p>When there is no feasible solution to assign all planning entities, it is preferable to assign as many entities as possible without breaking hard constraints.
This is called overconstrained planning.</p>
</div>
<div class="paragraph">
<p>By default, OptaPlanner assigns all planning entities, overloads the planning values, and therefore breaks hard constraints.
There are two ways to avoid this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use <a href="#nullablePlanningVariable">nullable</a> planning variables, so that some entities are unassigned.</p>
</li>
<li>
<p>Add virtual values to catch the unassigned entities.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="overconstrainedPlanningWithNullableVariables"><a class="anchor" href="#overconstrainedPlanningWithNullableVariables"></a><a class="link" href="#overconstrainedPlanningWithNullableVariables">18.3.1. Overconstrained planning with nullable variables</a></h4>
<div class="paragraph">
<p>If we handle overconstrained planning with nullable variables, the overload entities will be left unassigned:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./RepeatedPlanning/overconstrainedPlanning.png" alt="overconstrainedPlanning">
</div>
</div>
<div class="paragraph">
<p>To implement this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add an additional score level (usually a medium level between the hard and soft level) by switching <a href="#scoreType"><code>Score</code> type</a>.</p>
</li>
<li>
<p>Make the planning variable <a href="#nullablePlanningVariable">nullable</a>.</p>
</li>
<li>
<p>Add a score constraint on the new level (usually a medium constraint) to penalize the number of unassigned entities (or a weighted sum of them).</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="overconstrainedPlanningWithVirutalValues"><a class="anchor" href="#overconstrainedPlanningWithVirutalValues"></a><a class="link" href="#overconstrainedPlanningWithVirutalValues">18.3.2. Overconstrained planning with virtual values</a></h4>
<div class="paragraph">
<p>In overconstrained planning it is often useful to know which resources are lacking.
In overconstrained planning with virtual values, the solution indicates which resources to buy.</p>
</div>
<div class="paragraph">
<p>To implement this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add an additional score level (usually a medium level between the hard and soft level) by switching <a href="#scoreType"><code>Score</code> type</a>.</p>
</li>
<li>
<p>Add a number of virtual values. It can be difficult to determine a good formula to calculate that number:</p>
<div class="ulist">
<ul>
<li>
<p>Do not add too many, as that will decrease solver efficiency.</p>
</li>
<li>
<p>Importantly, do not add too few as that will lead to an infeasible solution.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Add a score constraint on the new level (usually a medium constraint) to penalize the number of virtual assigned entities (or a weighted sum of them).</p>
</li>
<li>
<p>Optionally, change all soft constraints to ignore virtual assigned entities.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="continuousPlanning"><a class="anchor" href="#continuousPlanning"></a><a class="link" href="#continuousPlanning">18.4. Continuous planning (windowed planning)</a></h3>
<div class="paragraph">
<p>Continuous planning is the technique of planning one or more upcoming planning periods at the same time
and repeating that process monthly, weekly, daily, hourly, or even more frequently.
However, as time is infinite, planning all future time periods is impossible.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./RepeatedPlanning/continuousPlanningEmployeeRostering.png" alt="continuousPlanningEmployeeRostering">
</div>
</div>
<div class="paragraph">
<p>In the employee rostering example above, we re-plan every four days.
Each time, we actually plan a window of 12 days, but we only publish the first four days,
which is stable enough to share with the employees, so they can plan their social life accordingly.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./RepeatedPlanning/continuousPlanningPatientAdmissionSchedule.png" alt="continuousPlanningPatientAdmissionSchedule">
</div>
</div>
<div class="paragraph">
<p>In the hospital bed planning example above, notice the difference between the original planning of November 1st and the new planning of November 5th:
some problem facts (F, H, I, J, K) changed in the meantime, which results in unrelated planning entities (G) changing too.</p>
</div>
<div class="paragraph">
<p>The planning window can be split up in several stages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>History</em></p>
<div class="paragraph">
<p>Immutable past time periods.
It contains only pinned entities.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Recent historic entities can also affect score constraints that apply to movable entities.
For example, in nurse rostering, a nurse that has worked the last three historic weekends in a row should not be assigned to three more weekends in a row, because she requires a one free weekend per month.</p>
</li>
<li>
<p>Do not load all historic entities in memory:
even though pinned entities do not affect solving performance, they can cause out of memory problems when the data grows to years.
Only load those that might still affect the current constraints with a good safety margin.</p>
</li>
</ul>
</div>
</li>
<li>
<p><em>Published</em></p>
<div class="paragraph">
<p>Upcoming time periods that have been published.
They contain only <a href="#pinnedPlanningEntities">pinned</a> and/or <a href="#nonvolatileReplanning">semi-movable</a> planning entities.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The published schedule has been shared with the business.
For example, in nurse rostering, the nurses will use this schedule to plan their personal lives, so they require a publish notice of for example 3 weeks in advance.
Normal planning will not change that part of schedule.</p>
<div class="paragraph">
<p>Changing that schedule later is disruptive, but were exceptions force us to do them anyway (for example someone calls in sick), do change this part of the planning while minimizing disruption with <a href="#nonvolatileReplanning">non-disruptive replanning</a>.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><em>Draft</em></p>
<div class="paragraph">
<p>Upcoming time periods after the published time periods that can change freely.
They contain movable planning entities, except for any that are pinned for other reasons (such as being <a href="#pinDownPlanningEntities">pinned by a user</a>).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The first part of the draft, called <em>the final draft</em>, will be published, so these planning entities can change one last time.
The publishing frequency, for example once per week, determines the number of time periods that change from <em>draft</em> to <em>published</em>.</p>
</li>
<li>
<p>The latter time periods of the <em>draft</em> are likely change again in later planning efforts, especially if some of the problem facts change by then (for example nurse Ann doesn&#8217;t want to work on one of those days).</p>
<div class="paragraph">
<p>Despite that these latter planning entities might still change a lot, we can&#8217;t leave them out for later, because we would risk <em>painting ourselves into a corner</em>.
For example, in employee rostering we could have all our rare skilled employees working the last 5 days of the week that gets published,
which won&#8217;t reduce the score of that week, but will make it impossible for us to deliver a feasible schedule the next week.
So the draft length needs to be longer than the part that will be published first.</p>
</div>
</li>
<li>
<p>That draft part is usually not shared with the business yet, because it is too volatile and it would only raise false expectations.
However, it is stored in the database and used as a starting point for the next solver.</p>
</li>
</ul>
</div>
</li>
<li>
<p><em>Unplanned</em> (out of scope)</p>
<div class="paragraph">
<p>Planning entities that are not in the current planning window.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the planning window is too small to plan all entities, you&#8217;re dealing with <a href="#overconstrainedPlanning">overconstrained planning</a>.</p>
</li>
<li>
<p>If <a href="#assigningTimeToPlanningEntities">time is a planning variable</a>, the size of the planning window is determined dynamically,
in which case the <em>unplanned</em> stage is not applicable.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./RepeatedPlanning/continuousPublishingWithRotation.png" alt="continuousPublishingWithRotation">
</div>
</div>
<div class="sect3">
<h4 id="pinnedPlanningEntities"><a class="anchor" href="#pinnedPlanningEntities"></a><a class="link" href="#pinnedPlanningEntities">18.4.1. Pinned planning entities</a></h4>
<div class="paragraph">
<p>A pinned planning entity doesn&#8217;t change during solving.
This is commonly used by users to pin down one or more specific assignments and force OptaPlanner to schedule around those fixed assignments.</p>
</div>
<div class="sect4">
<h5 id="pinDownPlanningEntities"><a class="anchor" href="#pinDownPlanningEntities"></a><a class="link" href="#pinDownPlanningEntities">18.4.1.1. Pin down planning entities with <code>@PlanningPin</code></a></h5>
<div class="paragraph">
<p>To pin some planning entities down, add an <code>@PlanningPin</code> annotation on a boolean getter or field of the planning entity class.
That boolean is <code>true</code> if the entity is pinned down to its current planning values and <code>false</code> otherwise.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the <code>@PlanningPin</code> annotation on a <code>boolean</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningEntity
public class Lecture {

    private boolean pinned;
    ...

    @PlanningPin
    public boolean isPinned() {
        return pinned;
    }

    ...
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>In the example above, if <code>pinned</code> is <code>true</code>, the lecture will not be assigned to another period or room (even if the current period and rooms fields are <code>null</code>).</p>
</div>
</div>
<div class="sect4">
<h5 id="configureAPinningFilter"><a class="anchor" href="#configureAPinningFilter"></a><a class="link" href="#configureAPinningFilter">18.4.1.2. Configure a <code>PinningFilter</code></a></h5>
<div class="paragraph">
<p>Alternatively, to pin some planning entities down, add a <code>PinningFilter</code> that returns <code>true</code> if an entity is movable, and <code>false</code> if it is pinned.
This is more flexible and more verbose than the <code>@PlanningPin</code> approach.</p>
</div>
<div class="paragraph">
<p>For example on the nurse rostering example:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the <code>PinningFilter</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public class ShiftAssignmentPinningFilter implements PinningFilter&lt;NurseRoster, ShiftAssignment&gt; {

    @Override
    public boolean accept(NurseRoster nurseRoster, ShiftAssignment shiftAssignment) {
        ShiftDate shiftDate = shiftAssignment.getShift().getShiftDate();
        return nurseRoster.getNurseRosterInfo().isInPlanningWindow(shiftDate);
    }

}</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the <code>PinningFilter</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningEntity(pinningFilter = ShiftAssignmentPinningFilter.class)
public class ShiftAssignment {
    ...
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="nonvolatileReplanning"><a class="anchor" href="#nonvolatileReplanning"></a><a class="link" href="#nonvolatileReplanning">18.4.2. Nonvolatile replanning to minimize disruption (semi-movable planning entities)</a></h4>
<div class="paragraph">
<p>Replanning an existing plan can be very disruptive.
If the plan affects humans (such as employees, drivers, &#8230;&#8203;), very disruptive changes are often undesirable.
In such cases, nonvolatile replanning helps by restricting planning freedom: the gain of changing a plan must be higher than the disruption it causes.
This is usually implemented by taxing all planning entities that change.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./RepeatedPlanning/nonDisruptiveReplanning.png" alt="nonDisruptiveReplanning">
</div>
</div>
<div class="paragraph">
<p>In the machine reassignment example, the entity has both the planning variable <code>machine</code> and its original value <code>originalMachine</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningEntity(...)
public class ProcessAssignment {

    private MrProcess process;
    private Machine originalMachine;
    private Machine machine;

    public Machine getOriginalMachine() {...}

    @PlanningVariable(...)
    public Machine getMachine() {...}

    public boolean isMoved() {
        return originalMachine != null &amp;&amp; originalMachine != machine;
    }

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>During planning, the planning variable <code>machine</code> changes.
By comparing it with the originalMachine, a change in plan can be penalized:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">rule "processMoved"
    when
        ProcessAssignment(moved == true)
    then
        scoreHolder.addSoftConstraintMatch(kcontext, -1000);
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>The soft penalty of <code>-1000</code> means that a better solution is only accepted if it improves the soft score for at least <code>1000</code> points per variable changed (or if it improves the hard score).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="realTimePlanning"><a class="anchor" href="#realTimePlanning"></a><a class="link" href="#realTimePlanning">18.5. Real-time planning</a></h3>
<div class="paragraph">
<p>To do real-time planning, combine the following planning techniques:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#backupPlanning">Backup planning</a> - adding extra score constraints to allow for unforeseen changes.</p>
</li>
<li>
<p><a href="#continuousPlanning">Continuous planning</a> - planning for one or more future planning periods.</p>
</li>
<li>
<p>Short planning windows.</p>
<div class="paragraph">
<p>This lowers the burden of real-time planning.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>As time passes, the problem itself changes.
Consider the vehicle routing use case:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./RepeatedPlanning/realTimePlanningVehicleRouting.png" alt="realTimePlanningVehicleRouting">
</div>
</div>
<div class="paragraph">
<p>In the example above, three customers are added at different times (<code>07:56</code>, <code>08:02</code> and <code>08:45</code>), after the original customer set finished solving at <code>07:55</code>, and in some cases, after the vehicles have already left.</p>
</div>
<div class="paragraph">
<p>OptaPlanner can handle such scenarios with <code>ProblemFactChange</code> (in combination with <a href="#pinnedPlanningEntities">pinned planning entities</a>).</p>
</div>
<div class="sect3">
<h4 id="problemFactChange"><a class="anchor" href="#problemFactChange"></a><a class="link" href="#problemFactChange">18.5.1. <code>ProblemFactChange</code></a></h4>
<div class="paragraph">
<p>While the <code>Solver</code> is solving, one of the problem facts may be changed by an outside event.
For example, an airplane is delayed and needs the runway at a later time.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not change the problem fact instances used by the <code>Solver</code> while it is solving (from another thread or even in the same thread), as that will corrupt it.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add a <code>ProblemFactChange</code> to the <code>Solver</code>, which it executes in the solver thread as soon as possible.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface Solver&lt;Solution_&gt; {

    ...

    boolean addProblemFactChange(ProblemFactChange&lt;Solution_&gt; problemFactChange);

    boolean isEveryProblemFactChangeProcessed();

    ...

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">public interface ProblemFactChange&lt;Solution_&gt; {

    void doChange(ScoreDirector&lt;Solution_&gt; scoreDirector);

}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>ScoreDirector</code> must be updated with any change on the problem facts of planning entities in a <code>ProblemFactChange</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To write a <code>ProblemFactChange</code> correctly, it is important to understand the behavior of <a href="#cloningASolution">a planning clone</a>.</p>
</div>
<div class="paragraph">
<p>A planning clone of a solution must fulfill these requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The clone must represent the same planning problem.
Usually it reuses the same instances of the problem facts and problem fact collections as the original.</p>
</li>
<li>
<p>The clone must use different, cloned instances of the entities and entity collections.
Changes to an original Solution entity’s variables must not affect its clone.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="problemFactChangeExample"><a class="anchor" href="#problemFactChangeExample"></a><a class="link" href="#problemFactChangeExample">18.5.1.1. Cloud balancing <code>ProblemFactChange</code> example</a></h5>
<div class="paragraph">
<p>Consider the following example of a <code>ProblemFactChange</code> implementation in the cloud balancing use case:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    public void deleteComputer(final CloudComputer computer) {
        solver.addProblemFactChange(scoreDirector -&gt; {
            CloudBalance cloudBalance = scoreDirector.getWorkingSolution();
            CloudComputer workingComputer = scoreDirector.lookUpWorkingObject(computer);
            // First remove the problem fact from all planning entities that use it
            for (CloudProcess process : cloudBalance.getProcessList()) {
                if (process.getComputer() == workingComputer) {
                    scoreDirector.beforeVariableChanged(process, "computer");
                    process.setComputer(null);
                    scoreDirector.afterVariableChanged(process, "computer");
                }
            }
            // A SolutionCloner does not clone problem fact lists (such as computerList)
            // Shallow clone the computerList so only workingSolution is affected, not bestSolution or guiSolution
            ArrayList&lt;CloudComputer&gt; computerList = new ArrayList&lt;&gt;(cloudBalance.getComputerList());
            cloudBalance.setComputerList(computerList);
            // Remove the problem fact itself
            scoreDirector.beforeProblemFactRemoved(workingComputer);
            computerList.remove(workingComputer);
            scoreDirector.afterProblemFactRemoved(workingComputer);
            scoreDirector.triggerVariableListeners();
        });
    }</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Any change in a <code>ProblemFactChange</code> must be done on the <code>@PlanningSolution</code> instance of <code>scoreDirector.getWorkingSolution()</code>.</p>
</li>
<li>
<p>The <code>workingSolution</code> is <a href="#cloningASolution">a planning clone</a> of the <code>BestSolutionChangedEvent</code>'s <code>bestSolution</code>.</p>
<div class="ulist">
<ul>
<li>
<p>The <code>workingSolution</code> in the <code>Solver</code> is never the same solution instance as in the rest of your application: it is a planning clone.</p>
</li>
<li>
<p>A planning clone also clones the planning entities and planning entity collections.</p>
<div class="paragraph">
<p>So any change on the planning entities must happen on the instances held by <code>scoreDirector.getWorkingSolution()</code>.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Use the method <code>ScoreDirector.lookUpWorkingObject()</code> to translate and retrieve the working solution&#8217;s instance of an object.
This requires <a href="#planningId">annotating a property of that class as the @PlanningId</a>.</p>
</li>
<li>
<p>A planning clone does not clone the problem facts, nor the problem fact collections.
<em>Therefore the <code><em>workingSolution</em></code> and the <code><em>bestSolution</em></code> share the same problem fact instances and the same problem fact list instances.</em></p>
<div class="paragraph">
<p>Any problem fact or problem fact list changed by a <code>ProblemFactChange</code> must be problem cloned first (which can imply rerouting references in other problem facts and planning entities).
Otherwise, if the <code>workingSolution</code> and <code>bestSolution</code> are used in different threads (for example a solver thread and a GUI event thread), a race condition can occur.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="cloningSolutionsToAvoidRaceConditions"><a class="anchor" href="#cloningSolutionsToAvoidRaceConditions"></a><a class="link" href="#cloningSolutionsToAvoidRaceConditions">18.5.1.2. Cloning solutions to avoid race conditions in real-time planning</a></h5>
<div class="paragraph">
<p>Many types of changes can leave a planning entity uninitialized, resulting in a partially initialized solution. This is acceptable, provided the first solver phase can handle it.</p>
</div>
<div class="paragraph">
<p>All construction heuristics solver phases can handle a partially initialized solution, so it is recommended to configure such a solver phase as the first phase.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./RepeatedPlanning/realTimePlanningConcurrencySequenceDiagram.png" alt="realTimePlanningConcurrencySequenceDiagram">
</div>
</div>
<div class="paragraph">
<p>The process occurs as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>Solver</code> stops.</p>
</li>
<li>
<p>Runs the <code>ProblemFactChange</code>.</p>
</li>
<li>
<p><strong>restarts</strong>.</p>
<div class="paragraph">
<p>This is a <em>warm start</em> because its initial solution is the adjusted best solution of the previous run.</p>
</div>
</li>
<li>
<p>Each solver phase runs again.</p>
<div class="paragraph">
<p>This implies the construction heuristic runs again, but because little or no planning variables are uninitialized (unless you have a <a href="#nullablePlanningVariable">nullable planning variable</a>), it finishes much quicker than in a cold start.</p>
</div>
</li>
<li>
<p>Each configured <code>Termination</code> resets (both in solver and phase configuration), but a previous call to <code>terminateEarly()</code> is not undone.</p>
<div class="paragraph">
<p><code>Termination</code> is not usually configured (except in daemon mode); instead, <code>Solver.terminateEarly()</code> is called when the results are needed. Alternatively, configure a <code>Termination</code> and use the daemon mode in combination with <code><a href="#SolverEventListener">BestSolutionChangedEvent</a></code> as described in the following section.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="daemon"><a class="anchor" href="#daemon"></a><a class="link" href="#daemon">18.5.2. Daemon: <code>solve()</code> does not return</a></h4>
<div class="paragraph">
<p>In real-time planning, it is often useful to have a solver thread wait when it runs out of work, and immediately resume solving a problem once new problem fact changes are added.
Putting the <code>Solver</code> in daemon mode has the following effects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the <code>Solver</code>'s <code>Termination</code> terminates, it does not return from <code>solve()</code>, but blocks its thread instead (which frees up CPU power).</p>
<div class="ulist">
<ul>
<li>
<p>Except for <code>terminateEarly()</code>, which does make it return from <code>solve()</code>, freeing up system resources and allowing an application to shutdown gracefully.</p>
</li>
<li>
<p>If a <code>Solver</code> starts with an empty planning entity collection, it waits in the blocked state immediately.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If a <code>ProblemFactChange</code> is added, it goes into the running state, applies the <code>ProblemFactChange</code> and runs the <code>Solver</code> again.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To use the <code>Solver</code> in daemon mode:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Enable <code>daemon</code> mode on the <code>Solver</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;solver&gt;
  &lt;daemon&gt;true&lt;/daemon&gt;
  ...
&lt;/solver&gt;</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not forget to call <code>Solver.terminateEarly()</code> when your application needs to shutdown to avoid killing the solver thread unnaturally.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Subscribe to the <code><a href="#SolverEventListener">BestSolutionChangedEvent</a></code> to process new best solutions found by the solver thread.</p>
<div class="paragraph">
<p>A <code>BestSolutionChangedEvent</code> does not guarantee that every <code>ProblemFactChange</code> has been processed already, nor that the solution is initialized and feasible.</p>
</div>
</li>
<li>
<p>To ignore <code>BestSolutionChangedEvent</code>s with such invalid solutions, do the following:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">    public void bestSolutionChanged(BestSolutionChangedEvent&lt;CloudBalance&gt; event) {
        if (event.isEveryProblemFactChangeProcessed()
                // Ignore infeasible (including uninitialized) solutions
                &amp;&amp; event.getNewBestSolution().getScore().isFeasible()) {
            ...
        }
    }</code></pre>
</div>
</div>
</li>
<li>
<p>Use <code>Score.isSolutionInitialized()</code> instead of <code>Score.isFeasible()</code> to only ignore uninitialized solutions, but do accept infeasible solutions too.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="integration"><a class="anchor" href="#integration"></a><a class="link" href="#integration">19. Integration</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="integrationOverview"><a class="anchor" href="#integrationOverview"></a><a class="link" href="#integrationOverview">19.1. Overview</a></h3>
<div class="paragraph">
<p>OptaPlanner&#8217;s input and output data (the planning problem and the best solution) are plain old JavaBeans (POJOs), so integration with other Java technologies is straightforward.
For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To read a planning problem from the database (and store the best solution in it), annotate the domain POJOs with JPA annotations.</p>
</li>
<li>
<p>To read a planning problem from an XML file (and store the best solution in it), annotate the domain POJOs with XStream or JAXB annotations.</p>
</li>
<li>
<p>To expose the Solver as a REST Service that reads the planning problem and responds with the best solution, annotate the domain POJOs with XStream, JAXB or Jackson annotations and hook the <code>Solver</code> in Camel or RESTEasy.</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./Integration/integrationOverview.png" alt="integrationOverview">
</div>
</div>
</div>
<div class="sect2">
<h3 id="integrationWithPersistentStorage"><a class="anchor" href="#integrationWithPersistentStorage"></a><a class="link" href="#integrationWithPersistentStorage">19.2. Persistent storage</a></h3>
<div class="sect3">
<h4 id="integrationWithJpaAndHibernate"><a class="anchor" href="#integrationWithJpaAndHibernate"></a><a class="link" href="#integrationWithJpaAndHibernate">19.2.1. Database: JPA and Hibernate</a></h4>
<div class="paragraph">
<p>Enrich domain POJOs (solution, entities and problem facts) with JPA annotations
to store them in a database by calling <code>EntityManager.persist()</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not confuse JPA&#8217;s <code>@Entity</code> annotation with OptaPlanner&#8217;s <code>@PlanningEntity</code> annotation.
They can appear both on the same class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningEntity // OptaPlanner annotation
@Entity // JPA annotation
public class Talk {...}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add a dependency to the <code>optaplanner-persistence-jpa</code> jar to take advantage of these extra integration features:</p>
</div>
<div class="sect4">
<h5 id="jpaAndHibernatePersistingAScore"><a class="anchor" href="#jpaAndHibernatePersistingAScore"></a><a class="link" href="#jpaAndHibernatePersistingAScore">19.2.1.1. JPA and Hibernate: persisting a <code>Score</code></a></h5>
<div class="paragraph">
<p>When a <code>Score</code> is persisted into a relational database, JPA and Hibernate will default to Java serializing it to a <code>BLOB</code> column.
This has several disadvantages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Java serialization format of <code>Score</code> classes is currently not backwards compatible. Upgrading to a newer OptaPlanner version can break reading an existing database.</p>
</li>
<li>
<p>The score is not easily readable for a query executed in the database console. This is annoying during development.</p>
</li>
<li>
<p>The score cannot be used in a SQL or JPA-QL query to efficiently filter the results: for example to query all infeasible schedules.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To avoid these issues, configure it to instead use INTEGER (or other) columns, by using the appropriate <code>*ScoreHibernateType</code> for your <code>Score</code> type, for example for a <code>HardSoftScore</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
@Entity
@TypeDef(defaultForType = HardSoftScore.class, typeClass = HardSoftScoreHibernateType.class)
public class CloudBalance {

    @PlanningScore
    @Columns(columns = {@Column(name = "initScore"), @Column(name = "hardScore"), @Column(name = "softScore")})
    protected HardSoftScore score;

    ...
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Configure the same number of <code>@Column</code> annotations as the number of score levels in the score plus one (for the <code>initScore</code>), otherwise Hibernate will fail fast because a property mapping has the wrong number of columns.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this case, the DDL will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="sql" class="language-sql hljs">CREATE TABLE CloudBalance(
    ...
    initScore INTEGER,
    hardScore INTEGER,
    softScore INTEGER
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using a <code>BigDecimal</code> based <code>Score</code>, specify the precision and scale of the columns to avoid silent rounding:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
@Entity
@TypeDef(defaultForType = HardSoftBigDecimalScore.class, typeClass = HardSoftBigDecimalScoreHibernateType.class)
public class CloudBalance{

    @PlanningScore
    @Columns(columns = {
            @Column(name = "initScore")
            @Column(name = "hardScore", precision = 10, scale = 5),
            @Column(name = "softScore", precision = 10, scale = 5)})
    protected HardSoftBigDecimalScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the DDL will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="sql" class="language-sql hljs">CREATE TABLE CloudBalance(
    ...
    initScore INTEGER,
    hardScore DECIMAL(10, 5),
    softScore DECIMAL(10, 5)
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using any type of bendable <code>Score</code>, specify the hard and soft level sizes as parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
@Entity
@TypeDef(defaultForType = BendableScore.class, typeClass = BendableScoreHibernateType.class, parameters = {
        @Parameter(name = "hardLevelsSize", value = "3"),
        @Parameter(name = "softLevelsSize", value = "2")})
public class Schedule {

    @PlanningScore
    @Columns(columns = {
            @Column(name = "initScore")
            @Column(name = "hard0Score"),
            @Column(name = "hard1Score"),
            @Column(name = "hard2Score"),
            @Column(name = "soft0Score"),
            @Column(name = "soft1Score")})
    protected BendableScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All this support is Hibernate specific because currently JPA 2.1&#8217;s converters do not support converting to multiple columns.</p>
</div>
</div>
<div class="sect4">
<h5 id="jpaAndHibernatePlanningCloning"><a class="anchor" href="#jpaAndHibernatePlanningCloning"></a><a class="link" href="#jpaAndHibernatePlanningCloning">19.2.1.2. JPA and Hibernate: planning cloning</a></h5>
<div class="paragraph">
<p>In JPA and Hibernate, there is usually a <code>@ManyToOne</code> relationship from most problem fact classes to the planning solution class.
Therefore, the problem fact classes reference the planning solution class, which implies that when the solution is <a href="#cloningASolution">planning cloned</a>, they need to be cloned too.
Use an <code>@DeepPlanningClone</code> on each such problem fact class to enforce that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution // OptaPlanner annotation
@Entity // JPA annotation
public class Conference {

    @OneToMany(mappedBy="conference")
    private List&lt;Room&gt; roomList;

    ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@DeepPlanningClone // OptaPlanner annotation: Force the default planning cloner to planning clone this class too
@Entity // JPA annotation
public class Room {

    @ManyToOne
    private Conference conference; // Because of this reference, this problem fact needs to be planning cloned too

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Neglecting to do this can lead to persisting duplicate solutions, JPA exceptions or other side effects.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="integrationWithXStream"><a class="anchor" href="#integrationWithXStream"></a><a class="link" href="#integrationWithXStream">19.2.2. XML or JSON: XStream</a></h4>
<div class="paragraph">
<p>Enrich domain POJOs (solution, entities and problem facts) with XStream annotations to serialize them to/from XML or JSON.</p>
</div>
<div class="paragraph">
<p>Add a dependency to the <code>optaplanner-persistence-xstream</code> jar to take advantage of these extra integration features:</p>
</div>
<div class="sect4">
<h5 id="xStreamMarshallingAScore"><a class="anchor" href="#xStreamMarshallingAScore"></a><a class="link" href="#xStreamMarshallingAScore">19.2.2.1. XStream: marshalling a <code>Score</code></a></h5>
<div class="paragraph">
<p>When a <code>Score</code> is marshalled to XML or JSON by the default XStream configuration, it&#8217;s verbose and ugly.
To fix that, configure the appropriate <code>ScoreXStreamConverter</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
@XStreamAlias("CloudBalance")
public class CloudBalance {

    @PlanningScore
    @XStreamConverter(HardSoftScoreXStreamConverter.class)
    private HardSoftScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, this generates pretty XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;CloudBalance&gt;
   ...
   &lt;score&gt;0hard/-200soft&lt;/score&gt;
&lt;/CloudBalance&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same applies for a bendable score:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
@XStreamAlias("Schedule")
public class Schedule {

    @PlanningScore
    @XStreamConverter(BendableScoreXStreamConverter.class)
    private BendableScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, this generates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;Schedule&gt;
   ...
   &lt;score&gt;[0/0]hard/[-100/-20/-3]soft&lt;/score&gt;
&lt;/Schedule&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When reading a bendable score from an XML element, the implied <code>hardLevelsSize</code> and <code>softLevelsSize</code>
must always be in sync with those in the solver.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="integrationWithJaxb"><a class="anchor" href="#integrationWithJaxb"></a><a class="link" href="#integrationWithJaxb">19.2.3. XML or JSON: JAXB</a></h4>
<div class="paragraph">
<p>Enrich domain POJOs (solution, entities and problem facts) with JAXB annotations to serialize them to/from XML or JSON.</p>
</div>
<div class="paragraph">
<p>Add a dependency to the <code>optaplanner-persistence-jaxb</code> jar to take advantage of these extra integration features:</p>
</div>
<div class="sect4">
<h5 id="jaxbMarshallingAScore"><a class="anchor" href="#jaxbMarshallingAScore"></a><a class="link" href="#jaxbMarshallingAScore">19.2.3.1. JAXB: marshalling a <code>Score</code></a></h5>
<div class="paragraph">
<p>When a <code>Score</code> is marshalled to XML or JSON by the default JAXB configuration, it&#8217;s corrupted.
To fix that, configure the appropriate <code>ScoreJaxbXmlAdapter</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
@XmlRootElement @XmlAccessorType(XmlAccessType.FIELD)
public class CloudBalance {

    @PlanningScore
    @XmlJavaTypeAdapter(HardSoftScoreJaxbXmlAdapter.class)
    private HardSoftScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, this generates pretty XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;cloudBalance&gt;
   ...
   &lt;score&gt;0hard/-200soft&lt;/score&gt;
&lt;/cloudBalance&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same applies for a bendable score:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
@XmlRootElement @XmlAccessorType(XmlAccessType.FIELD)
public class Schedule {

    @PlanningScore
    @XmlJavaTypeAdapter(BendableScoreJaxbXmlAdapter.class)
    private BendableScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, with a <code>hardLevelsSize</code> of <code>2</code> and a <code>softLevelsSize</code> of <code>3</code>, that will generate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;schedule&gt;
   ...
   &lt;score&gt;[0/0]hard/[-100/-20/-3]soft&lt;/score&gt;
&lt;/schedule&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>hardLevelsSize</code> and <code>softLevelsSize</code> implied, when reading a bendable score from an XML element, must always be in sync with those in the solver.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="integrationWithJackson"><a class="anchor" href="#integrationWithJackson"></a><a class="link" href="#integrationWithJackson">19.2.4. JSON: Jackson</a></h4>
<div class="paragraph">
<p>Enrich domain POJOs (solution, entities and problem facts) with Jackson annotations to serialize them to/from JSON.</p>
</div>
<div class="paragraph">
<p>Add a dependency to the <code>optaplanner-persistence-jackson</code> jar and register <code>OptaPlannerJacksonModule</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">ObjectMapper objectMapper = new ObjectMapper();
objectMapper.registerModule(OptaPlannerJacksonModule.createModule());</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="jacksonMarshallingAScore"><a class="anchor" href="#jacksonMarshallingAScore"></a><a class="link" href="#jacksonMarshallingAScore">19.2.4.1. Jackson: marshalling a <code>Score</code></a></h5>
<div class="paragraph">
<p>When a <code>Score</code> is marshalled to/from JSON by the default Jackson configuration, it fails.
The <code>OptaPlannerJacksonModule</code> fixes that, by using <code>HardSoftScoreJacksonJsonSerializer</code>,
<code>HardSoftScoreJacksonJsonDeserializer</code>, etc.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
public class CloudBalance {

    @PlanningScore
    private HardSoftScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, this generates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
   "score":"0hard/-200soft"
   ...
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When reading a <code>BendableScore</code>, the <code>hardLevelsSize</code> and <code>softLevelsSize</code> implied in the JSON element,
must always be in sync with those defined in the <code>@PlanningScore</code> annotation in the solution class. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
   "score":"[0/0]hard/[-100/-20/-3]soft"
   ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This JSON implies the <code>hardLevelsSize</code> is 2 and the <code>softLevelsSize</code> is 3,
which must be in sync with the <code>@PlanningScore</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
public class Schedule {

    @PlanningScore(bendableHardLevelsSize = 2, bendableSoftLevelsSize = 3)
    private BendableScore score;

    ...
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When a field is the <code>Score</code> supertype (instead of a specific type such as <code>HardSoftScore</code>),
it uses <code>PolymorphicScoreJacksonJsonSerializer</code> and <code>PolymorphicScoreJacksonJsonDeserializer</code>
to record the score type in JSON too, otherwise it would be impossible to deserialize it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
public class CloudBalance {

    @PlanningScore
    private Score score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, this generates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
   "score":{"HardSoftScore":"0hard/-200soft"}
   ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="integrationWithJsonb"><a class="anchor" href="#integrationWithJsonb"></a><a class="link" href="#integrationWithJsonb">19.2.5. JSON: JSON-B</a></h4>
<div class="paragraph">
<p>Enrich domain POJOs (solution, entities and problem facts) with JSON-B annotations to serialize them to/from JSON.</p>
</div>
<div class="paragraph">
<p>Add a dependency to the <code>optaplanner-persistence-jsonb</code> jar and use <code>OptaPlannerJsonbConfig</code> to create a <code>Jsonb</code> instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">JsonbConfig config = OptaPlannerJsonbConfig.createConfig();
Jsonb jsonb = JsonbBuilder.create(config);</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="jsonbMarshallingAScore"><a class="anchor" href="#jsonbMarshallingAScore"></a><a class="link" href="#jsonbMarshallingAScore">19.2.5.1. JSON-B: marshalling a <code>Score</code></a></h5>
<div class="paragraph">
<p>When a <code>Score</code> is marshalled to/from JSON by the default JSON-B configuration, it fails.
The <code>OptaPlannerJsonbConfig</code> fixes that, by using adapters including <code>BendableScoreJsonbAdapter</code>, <code>HardSoftScoreJsonbAdapter</code>, etc.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
public class CloudBalance {

    @PlanningScore
    private HardSoftScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, this generates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{"hardSoftScore":"0hard/-200soft"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same applies for a bendable score:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">@PlanningSolution
public class CloudBalance {

    @PlanningScore
    private BendableScore score;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This generates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{"bendableScore":"[0/0]hard/[-200/-20/0]soft"}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integrationWithQuarkus"><a class="anchor" href="#integrationWithQuarkus"></a><a class="link" href="#integrationWithQuarkus">19.3. Quarkus</a></h3>
<div class="paragraph">
<p>The Quarkus extension for OptaPlanner and its guide is coming soon.</p>
</div>
</div>
<div class="sect2">
<h3 id="integrationWithSpringBoot"><a class="anchor" href="#integrationWithSpringBoot"></a><a class="link" href="#integrationWithSpringBoot">19.4. Spring Boot</a></h3>
<div class="paragraph">
<p>To use OptaPlanner on Spring Boot, add the <code>optaplanner-spring-boot-starter</code> dependency
and read the Spring guide <em>Constraint solving AI with OptaPlanner</em>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>DRL score calculation is currently incompatible with the dependency <code>spring-boot-devtools</code>:
none of the DRL rules will fire, due to ClassLoader issues.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>These properties are supported in Spring&#8217;s <code>application.properties</code>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">optaplanner.solver-manager.parallel-solver-count</dt>
<dd>
<p>The number of solvers that run in parallel.
This directly influences CPU consumption.
Defaults to <code>AUTO</code>.</p>
</dd>
<dt class="hdlist1">optaplanner.solver-config-xml</dt>
<dd>
<p>A classpath resource to read the solver configuration XML.
Defaults to <code>solverConfig.xml</code>.
If this property isn&#8217;t specified, that file is optional.</p>
</dd>
<dt class="hdlist1">optaplanner.solver.environment-mode</dt>
<dd>
<p>Enable runtime assertions to detect common bugs in your implementation during development.</p>
</dd>
<dt class="hdlist1">optaplanner.solver.daemon</dt>
<dd>
<p>Enable <a href="#daemon">daemon mode</a>.
In daemon mode, non-early termination pauses the solver instead of stopping it, until the next problem fact change arrives.
This is often useful for <a href="#realTimePlanning">real-time planning</a>.
Defaults to <code>false</code>.</p>
</dd>
<dt class="hdlist1">optaplanner.solver.move-thread-count</dt>
<dd>
<p>Enable multithreaded solving for a single problem, which increases CPU consumption.
Defaults to <code>NONE</code>.
See <a href="#multithreadedIncrementalSolving">multithreaded incremental solving</a>.</p>
</dd>
<dt class="hdlist1">optaplanner.solver.termination.spent-limit</dt>
<dd>
<p>How long the solver can run.
For example: <code>30s</code> is 30 seconds. <code>5m</code> is 5 minutes. <code>2h</code> is 2 hours. <code>1d</code> is 1 day.</p>
</dd>
<dt class="hdlist1">optaplanner.solver.termination.unimproved-spent-limit</dt>
<dd>
<p>How long the solver can run without finding a new best solution after finding a new best solution.
For example: <code>30s</code> is 30 seconds. <code>5m</code> is 5 minutes. <code>2h</code> is 2 hours. <code>1d</code> is 1 day.</p>
</dd>
<dt class="hdlist1">optaplanner.solver.termination.best-score-limit</dt>
<dd>
<p>Terminates the solver when a specific or higher score has been reached.
For example: <code>0hard/-1000soft</code> terminates when the best score changes from <code>0hard/-1200soft</code> to <code>0hard/-900soft</code>.
Wildcards are supported to replace numbers.
For example: <code>0hard/*soft</code> to terminate when any feasible score is reached.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="integrationWithSoaAndEsb"><a class="anchor" href="#integrationWithSoaAndEsb"></a><a class="link" href="#integrationWithSoaAndEsb">19.5. SOA and ESB</a></h3>
<div class="sect3">
<h4 id="integrationWithCamel"><a class="anchor" href="#integrationWithCamel"></a><a class="link" href="#integrationWithCamel">19.5.1. Camel and Karaf</a></h4>
<div class="paragraph">
<p><a href="http://camel.apache.org/">Camel</a> is an enterprise integration framework which includes support for OptaPlanner (starting from Camel 2.13). It can expose a use case as a REST service, a SOAP service, a JMS service, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p><a href="http://camel.apache.org/optaplanner.html">Read the documentation for the camel-optaplanner component.</a>
That component works in Karaf too.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integrationWithOtherEnvironments"><a class="anchor" href="#integrationWithOtherEnvironments"></a><a class="link" href="#integrationWithOtherEnvironments">19.6. Other environments</a></h3>
<div class="sect3">
<h4 id="integrationWithJBossModules"><a class="anchor" href="#integrationWithJBossModules"></a><a class="link" href="#integrationWithJBossModules">19.6.1. JBoss Modules, WildFly, and JBoss EAP</a></h4>
<div class="paragraph">
<p>Because of JBoss Modules' <code>ClassLoader</code> magic, provide the <code>ClassLoader</code> of your classes <a href="#solverConfigurationByXML">during the SolverFactory creation</a>,
so it can find the classpath resources (such as the solver config, score DRLs and domain classes) in your jars.</p>
</div>
<div class="paragraph">
<p>It&#8217;s also recommended <a href="#customThreadFactory">to plug in WildFly&#8217;s thread factory</a>,
especially with <a href="#multithreadedSolving">multithreaded solving</a>.</p>
</div>
<div class="sect4">
<h5 id="loggingOnWildFlyAndJBossEAP"><a class="anchor" href="#loggingOnWildFlyAndJBossEAP"></a><a class="link" href="#loggingOnWildFlyAndJBossEAP">19.6.1.1. Logging on WildFly and JBoss EAP</a></h5>
<div class="paragraph">
<p>To get decent <a href="#logging">logging of the solver(s)</a>, create a file <code>src/main/resources/jboss-log4j.xml</code>
(so it ends up in the <code>war</code> as <code>WEB-INF/classes/jboss-log4j.xml</code>) with this content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;log4j:configuration xmlns:log4j="http://jakarta.apache.org/log4j/" debug="false"&gt;

  &lt;appender name="consoleAppender" class="org.apache.log4j.ConsoleAppender"&gt;
    &lt;layout class="org.apache.log4j.PatternLayout"&gt;
      &lt;param name="ConversionPattern" value="%d{HH:mm:ss.SSS} %-5p [%t] %m%n"/&gt;
    &lt;/layout&gt;
  &lt;/appender&gt;

  &lt;logger name="org.optaplanner"&gt;
    &lt;level value="debug"/&gt;
  &lt;/logger&gt;

  &lt;root&gt;
    &lt;level value="warn" /&gt;
    &lt;appender-ref ref="consoleAppender"/&gt;
  &lt;/root&gt;

&lt;/log4j:configuration&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="skinnyWarOnWildFlyAndJBossEAP"><a class="anchor" href="#skinnyWarOnWildFlyAndJBossEAP"></a><a class="link" href="#skinnyWarOnWildFlyAndJBossEAP">19.6.1.2. Skinny WAR on WildFly and JBoss EAP</a></h5>
<div class="paragraph">
<p>To deploy an OptaPlanner web application on WildFly, simply include the optaplanner dependency jars in the <code>war</code> file&#8217;s <code>WEB-INF/lib</code> directory
(just like any other dependency).
However, in this approach the war file can easily grow to several MB in size, which is fine for a one-time deployment,
but too heavyweight for frequent redeployments (especially over a slow network connection).</p>
</div>
<div class="paragraph">
<p>The remedy is to use deliver the optaplanner jars in a JBoss module to WildFly and create a skinny war.
Let&#8217;s create a module called <em>org.optaplanner</em>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to the directory <code>${WILDFLY_HOME}/modules/system/layers/base/</code>. This directory contains the JBoss modules of WildFly. Create directory structure <code>org/optaplanner/main</code> for our new module.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Copy <code>optaplanner-core-${version}.jar</code> and all its direct and transitive dependency jars into that new directory. Use "mvn dependency:tree" on each optaplanner artifact to discover all dependencies.</p>
</li>
<li>
<p>Create the file <code>module.xml</code> in that new directory. Give it this content:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;module xmlns="urn:jboss:module:1.3" name="org.optaplanner"&gt;
  &lt;resources&gt;
    ...
    &lt;resource-root path="kie-api-${version}.jar"/&gt;
    ...
    &lt;resource-root path="optaplanner-core-${version}.jar"/&gt;
    ...
    &lt;resource-root path="."/&gt;
  &lt;/resources&gt;
  &lt;dependencies&gt;
    &lt;module name="javaee.api"/&gt;
  &lt;/dependencies&gt;
&lt;/module&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Navigate to the deployed <code>war</code> file.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Remove <code>optaplanner-core-${version}.jar</code> and all its direct and transitive dependency jars from the <code>WEB-INF/lib</code> directory in the <code>war</code> file.</p>
</li>
<li>
<p>Create the file <code>jboss-deployment-structure.xml</code> in the <code>WEB-INF/lib</code> directory. Give it this content:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;jboss-deployment-structure&gt;
   &lt;deployment&gt;
      &lt;dependencies&gt;
         &lt;module name="org.optaplanner" export="true"/&gt;
      &lt;/dependencies&gt;
   &lt;/deployment&gt;
&lt;/jboss-deployment-structure&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="integrationWithJPMS"><a class="anchor" href="#integrationWithJPMS"></a><a class="link" href="#integrationWithJPMS">19.6.2. Java platform module system (Jigsaw)</a></h4>
<div class="paragraph">
<p>When using OptaPlanner from code on the modulepath (Java 9 and higher),
<em>open</em> your packages that contain your domain objects, DRL files and solver configuration
<em>to all modules</em> in your <code>module-info.java</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">module org.optaplanner.cloudbalancing {
    requires org.optaplanner.core;
    ...

    opens org.optaplanner.examples.cloudbalancing.domain; // Domain classes
    opens org.optaplanner.examples.cloudbalancing.solver; // DRL file and solver configuration
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Otherwise OptaPlanner can&#8217;t reach those classes or files, even if they are exported.</p>
</div>
<div class="paragraph">
<p>The package <code>org.xmlpull.v1</code> is split between dependencies of XStream.
A workaround is to patch the <code>xmlpull</code> module with the <code>xpp3_min-1.1.4c.jar</code> artifact.</p>
</div>
<div class="paragraph">
<p>Since OptaPlanner has no <code>module-info.java</code>, it is required to add its <code>java.scripting</code> dependency manually to the modulepath with this JVM argument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="bash" class="language-bash hljs">--add-modules java.scripting</code></pre>
</div>
</div>
<div class="paragraph">
<p>Drools and XStream require illegal reflective access to some internal Java packages. This can be achieved with the following JVM arguments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="bash" class="language-bash hljs">--add-opens java.base/java.lang=org.drools.core \
--add-opens java.base/java.util=xstream \
--add-opens java.base/java.lang.reflect=xstream \
--add-opens java.base/java.text=xstream \
--add-opens java.desktop/java.awt.font=xstream</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="integrationWithOSGi"><a class="anchor" href="#integrationWithOSGi"></a><a class="link" href="#integrationWithOSGi">19.6.3. OSGi</a></h4>
<div class="paragraph">
<p>The <code>optaplanner-core</code> jar includes OSGi metadata in its <code>MANIFEST.MF</code> file to function properly in an OSGi environment too.
Furthermore, the maven artifact <code>kie-karaf-features</code> contains a <code>features.xml</code> file that supports the OSGi-feature <code>optaplanner-engine</code>.</p>
</div>
<div class="paragraph">
<p>Because of the OSGi&#8217;s <code>ClassLoader</code> magic, provide the <code>ClassLoader</code> of your classes <a href="#solverConfigurationByXML">during the SolverFactory creation</a>,
so it can find the classpath resources (such as the solver config, score DRLs and domain classes) in your jars.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>OptaPlanner does <em>not</em> require OSGi.
It works perfectly fine in a normal Java environment too.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="integrationWithAndroid"><a class="anchor" href="#integrationWithAndroid"></a><a class="link" href="#integrationWithAndroid">19.6.4. Android</a></h4>
<div class="paragraph">
<p>Android is not a complete JVM (because some JDK libraries are missing), but OptaPlanner works on Android with <a href="#easyJavaScoreCalculation">easy Java</a> or <a href="#incrementalJavaScoreCalculation">incremental Java</a> score calculation.
The Drools rule engine does not work on Android yet, so Drools score calculation doesn&#8217;t work on Android and its dependencies need to be excluded.</p>
</div>
<div class="paragraph">
<p><strong>Workaround to use OptaPlanner on Android:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add a dependency to the <code>build.gradle</code> file in your Android project to exclude <code>org.drools</code> and <code>xmlpull</code> dependencies:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="gradle" class="language-gradle hljs">dependencies {
    ...
    compile('org.optaplanner:optaplanner-core:...') {
        exclude group: 'xmlpull'
        exclude group: 'org.drools'
    }
    ...
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integrationWithHumanPlanners"><a class="anchor" href="#integrationWithHumanPlanners"></a><a class="link" href="#integrationWithHumanPlanners">19.7. Integration with human planners (politics)</a></h3>
<div class="paragraph">
<p>A good OptaPlanner implementation beats any good human planner for non-trivial datasets.
Many human planners fail to accept this, often because they feel threatened by an automated system.</p>
</div>
<div class="paragraph">
<p>But despite that, both can benefit if the human planner becomes the supervisor of OptaPlanner:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>The human planner defines, validates and tweaks the score function.</strong></p>
<div class="ulist">
<ul>
<li>
<p>The human planner tweaks the constraint weights of the <a href="#constraintConfiguration">constraint configuration</a> in a UI, as the business priorities change over time.</p>
</li>
<li>
<p>When the business changes, the score function often needs to change too.
The human planner can notify the developers to add, change or remove score constraints.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>The human planner is always in control of OptaPlanner.</strong></p>
<div class="ulist">
<ul>
<li>
<p>As shown in the course scheduling example, the human planner can pin down one or more planning variables to a specific planning value.
Because they are <a href="#pinnedPlanningEntities">pinned</a>, OptaPlanner does not change them: it optimizes the planning around the enforcements made by the human.
If the human planner pins down all planning variables, he/she sidelines OptaPlanner completely.</p>
</li>
<li>
<p>In a prototype implementation, the human planner occasionally uses pinning to intervene, but as the implementation matures, this should become obsolete.
The feature should be kept available as a reassurance for the humans, and in the event that the business changes dramatically before the score constraints are adjusted accordingly.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For this reason, it is recommended that the human planner is actively involved in your project.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./Integration/keepTheUserInControl.png" alt="keepTheUserInControl">
</div>
</div>
</div>
<div class="sect2">
<h3 id="sizingHardwareAndSoftware"><a class="anchor" href="#sizingHardwareAndSoftware"></a><a class="link" href="#sizingHardwareAndSoftware">19.8. Sizing hardware and software</a></h3>
<div class="paragraph">
<p>Before sizing a OptaPlanner service, first understand the typical behaviour of a <code>Solver.solve()</code> call:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./Integration/sizingHardware.png" alt="sizingHardware">
</div>
</div>
<div class="paragraph">
<p>Understand these guidelines to decide the hardware for a OptaPlanner service:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>RAM memory</strong>: Provision plenty, but no need to provide more.</p>
<div class="ulist">
<ul>
<li>
<p>The problem dataset, loaded before OptaPlanner is called, often consumes the most memory. It depends on the problem scale.</p>
<div class="ulist">
<ul>
<li>
<p>For example, in the Machine Reassignment example some datasets use over 1GB in memory. But in most examples, they use just a few MB.</p>
</li>
<li>
<p>If this is a problem, review the domain class structure: remove classes or fields that OptaPlanner doesn&#8217;t need during solving.</p>
</li>
<li>
<p>OptaPlanner usually has up to three solution instances: the internal working solution, the best solution and the old best solution (when it&#8217;s being replaced). However, these are all a <a href="#cloningASolution">planning clone</a> of each other, so many problem fact instances are shared between those solution instances.</p>
</li>
</ul>
</div>
</li>
<li>
<p>During solving, the memory is very volatile, because solving creates many short-lived objects. The Garbage Collector deletes these in bulk and therefore needs some heap space as a buffer.</p>
</li>
<li>
<p>The maximum size of the JVM heap space can be in three states:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Insufficient</strong>: An <code>OutOfMemoryException</code> is thrown (often because the Garbage Collector is using more than 98% of the CPU time).</p>
</li>
<li>
<p><strong>Narrow</strong>: The heap buffer for those short-lived instances is too small, therefore the Garbage Collector needs to run more than it would like to, which causes a performance loss.</p>
<div class="ulist">
<ul>
<li>
<p>Profiling shows that in the heap chart, the used heap space frequently touches the max heap space during solving. It also shows that the Garbage Collector has a significant CPU usage impact.</p>
</li>
<li>
<p>Adding more heap space increases the <a href="#scoreCalculationSpeed">score calculation speed</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Plenty</strong>: There is enough heap space. The Garbage Collector is active, but its CPU usage is low.</p>
<div class="ulist">
<ul>
<li>
<p>Adding more heap space does <em>not</em> increase performance.</p>
</li>
<li>
<p>Usually, this is around 300 to 500MB above the dataset size, <em>regardless of the problem scale</em> (except with <a href="#nearbySelection">nearby selection</a> and caching move selector, neither are used by default).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>CPU power</strong>: More is better.</p>
<div class="ulist">
<ul>
<li>
<p>Improving CPU speed directly increases the <a href="#scoreCalculationSpeed">score calculation speed</a>.</p>
<div class="ulist">
<ul>
<li>
<p>If the CPU power is twice as fast, it takes half the time to find the same result. However, this does not guarantee that it finds a better result in the same time, nor that it finds a similar result for a problem twice as big in the same time.</p>
</li>
<li>
<p>Increasing CPU power usually does not resolve scaling issues, because planning problems scale exponentially. Power tweaking the solver configuration has far better results for scaling issues than throwing hardware at it.</p>
</li>
</ul>
</div>
</li>
<li>
<p>During the <code>solve()</code> method, the CPU power will max out until it returns (except in <a href="#daemon">daemon mode</a> or if your <a href="#SolverEventListener">SolverEventListener</a> writes the best solution to disk or the network).</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Number of CPU cores</strong>: one CPU core per active Solver, plus at least one one for the operating system.</p>
<div class="ulist">
<ul>
<li>
<p>So in a multitenant application, which has one Solver per tenant, this means one CPU core per tenant, unless the number of solver threads is limited, as that limits the number of tenants being solved in parallel.</p>
</li>
<li>
<p>With Partitioned Search, presume one CPU core per partition (per active tenant), unless the number of partition threads is limited.</p>
<div class="ulist">
<ul>
<li>
<p>To reduce the number of used cores, it can be better to reduce the partition threads (so solve some partitions sequentially) than to reduce the number of partitions.</p>
</li>
</ul>
</div>
</li>
<li>
<p>In use cases with many tenants (such as scheduling Software as a Service) or many partitions, it might not be affordable to provision that many CPUs.</p>
<div class="ulist">
<ul>
<li>
<p>Reduce the number of active Solvers at a time. For example: give each tenant only one minute of machine time and use a <code>ExecutorService</code> with a fixed thread pool to queue requests.</p>
</li>
<li>
<p>Distribute the Solver runs across the day (or night). This is especially an opportunity in SaaS that&#8217;s used across the globe, due to timezones: UK and India can use the same CPU core when scheduling at night.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The SolverManager will take care of the orchestration, especially in those underfunded environments in which solvers (and partitions) are forced to share CPU cores or wait in line.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>I/O (network, disk, &#8230;&#8203;)</strong>: Not used during solving.</p>
<div class="ulist">
<ul>
<li>
<p>OptaPlanner is not a web server: a solver thread does not block (unlike a servlet thread), each one fully drains a CPU.</p>
<div class="ulist">
<ul>
<li>
<p>A web server can handle 24 active servlets threads with eight cores without performance loss, because most servlets threads are blocking on I/O.</p>
</li>
<li>
<p>However, 24 active solver threads with eight cores will cause each solver&#8217;s <a href="#scoreCalculationSpeed">score calculation speed</a> to be three times slower, causing a big performance loss.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Note that calling any I/O during solving, for example a remote service in your score calculation, causes a huge performance loss because it&#8217;s called thousands of times per second, so it should complete in microseconds. So no good implementation does that.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Keep these guidelines in mind when selecting and configuring the software.
See <a href="https://www.optaplanner.org/blog/archive.html">our blog archive</a> for the details of our experiments, which use our diverse set of examples.
Your mileage may vary.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Operating System</p>
<div class="ulist">
<ul>
<li>
<p>No experimentally proven advice yet (but prefer Linux anyway).</p>
</li>
</ul>
</div>
</li>
<li>
<p>JDK</p>
<div class="ulist">
<ul>
<li>
<p>Version: Java 7 can be between 10% and 25% faster than Java 6. But Java 8 however is usually not significantly faster than Java 7.</p>
</li>
<li>
<p>Garbage Collector: ParallelGC (the default in Java 8) can be potentially between 5% and 35% faster than G1GC (the default in Java 9). Unlike web servers, OptaPlanner needs a GC focused on throughput, not latency. Use <code>-XX:+UseParallelGC</code> to turn on ParallelGC.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Logging can have a severe impact on performance.</p>
<div class="ulist">
<ul>
<li>
<p>Debug logging <code>org.drools</code> can reduce performance by a factor of 7.</p>
</li>
<li>
<p>Debug logging <code>org.optaplanner</code> can be between 0% and 15% slower than info logging. Trace logging can be between 5% and 70% slower than info logging.</p>
</li>
<li>
<p>Synchronous logging to a file has an additional significant impact for debug and trace logging (but not for info logging).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Avoid a cloud environment in which you share your CPU core(s) with other virtual machines or containers. Performance (and therefore solution quality) can be unreliable when the available CPU power varies greatly.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Keep in mind that the perfect hardware/software environment will probably <em>not</em> solve scaling issues (even Moore&#8217;s law is too slow).
There is no need to follow these guidelines to the letter.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="designPatterns"><a class="anchor" href="#designPatterns"></a><a class="link" href="#designPatterns">20. Design patterns</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="designPatternsIntroduction"><a class="anchor" href="#designPatternsIntroduction"></a><a class="link" href="#designPatternsIntroduction">20.1. Design patterns introduction</a></h3>
<div class="paragraph">
<p>OptaPlanner design patterns are generic reusable solutions to common challenges in the model or architecture of projects that perform constraint solving. The design patterns in this section list and solve common design challenges.</p>
</div>
</div>
<div class="sect2">
<h3 id="domainModelingGuide"><a class="anchor" href="#domainModelingGuide"></a><a class="link" href="#domainModelingGuide">20.2. Domain Modeling Guidelines</a></h3>
<div class="paragraph">
<p>Follow the guidelines listed in this section to create a well thought-out model that can contribute significantly to the success of your planning.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Draw a class diagram of your domain model.</strong></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Make sure there are no duplications in your data model and that relationships between objects are clearly defined.</p>
</li>
<li>
<p>Create sample instances for each class. For example, in the employee rostering <code>Employee</code> class, create <code>Ann</code>, <code>Bert</code>, and <code>Carl</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Determine which relationships (or fields) change during planning and color them orange.</strong> One side of these relationships will become a planning variable later on. For example, in employee rostering, the <code>Shift</code> to <code>Employee</code> relationship changes during planning, so it is orange. However, other relationships, such as from <code>Employee</code> to <code>Skill</code>, are immutable during planning
because Optaplanner cannot assign an extra skill to an employee.</p>
</li>
<li>
<p><strong>If there are multiple relationships (or fields), check for <a href="#shadowVariable">shadow variables</a></strong>.
A shadow variable changes during planning, but its value can be calculated based on one or more genuine planning variables, without dispute. Color shadow relationships (or fields) purple.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Only one side of a bi-directional relationship can be a genuine planning variable. The other side will become an <a href="#bidirectionalVariable">inverse relation shadow variable</a> later on. Keep bi-directional relationships orange.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p><strong>Check for <a href="#chainedPlanningVariable">chained planning variables</a></strong>.
In a chained variable design, the focus is on deciding the order of a set of planning entity instances instead of assigning them to a date and time. However,  a shadow variable can assign the date and time.
A typical use case is <a href="#vehicleRouting">vehicle routing</a>.</p>
</li>
<li>
<p><strong>If there is an orange many-to-many relationship, replace it
with a one-to-many and a many-to-one relationship to a new intermediate class.</strong></p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Optaplanner does not currently support a <code>@PlanningVariable</code> annotation on a collection.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, in the Employee Rostering starter application the <code>ShiftAssignment</code> class is the many-to-many relationship between <code>Shift</code> and <code>Employee</code>.
<code>Shift</code> contains every shift time that needs to be filled with an employee.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./DesignPatterns/employeeShiftRosteringModelingGuideA.png" alt="employeeShiftRosteringModelingGuideA">
</div>
</div>
</li>
<li>
<p><strong>Annotate a many-to-one relationship with a <code>@PlanningEntity</code> annotation.</strong> Usually the <em>many</em> side of the relationship is the planning entity class that contains the planning variable. If the relationship is bi-directional, both sides are a planning entity class but usually the <em>many</em> side has the planning variable and the <em>one</em> side has the shadow variable. For example, in employee rostering, the <code>ShiftAssignment</code> class has an <code>@PlanningEntity</code> annotation.</p>
</li>
<li>
<p><strong>Make sure that the planning entity class has at least one problem property</strong>. A planning entity class cannot consist of only planning variables or an ID and only planning variables.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Remove any surplus <code>@PlanningVariable</code> annotations so that they become  problem properties. Doing this significantly decreases <a href="#searchSpaceSize">the search space size</a> and significantly increases solving efficiency. For example, in employee rostering, the <code>ShiftAssignment</code> class should not annotate both the <code>Shift</code> and <code>Employee</code> relationship with <code>@PlanningVariable</code>.</p>
</li>
<li>
<p>Make sure that when all planning variables have a value of <code>null</code>, the planning entity instance is describable to the business people. Planning variables have a value of <code>null</code> when the planning solution is uninitialized.</p>
<div class="ulist">
<ul>
<li>
<p>A surrogate ID does not suffice as the required minimum of one problem property.</p>
</li>
<li>
<p>There is no need to add a hard constraint to assure that two planning entities are different. They are already different due to their problem properties.</p>
</li>
<li>
<p>In some cases, multiple planning entity instances have the same set of problem properties. In such cases, it can be useful to create an extra problem property to distinguish them. For example, in employee rostering, the <code>ShiftAssignment</code> class has the problem property <code>Shift</code> as well as the problem property <code>indexInShift</code> which is an <code>int</code> class.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Choose the model in which the number of planning entities is fixed during planning</strong>. For example, in the employee rostering, it is impossible to know in advance how many shifts each employee will have before Optaplanner solves the model and the results can differ for each solution found.
On the other hand, the number of employees per shift is known in advance,
so it is better to make the <code>Shift</code> relationship a problem property
and the <code>Employee</code> relationship a planning variable as shown in the following examples.</p>
<div class="imageblock text-center">
<div class="content">
<img src="./DesignPatterns/employeeShiftRosteringModelingGuideB.png" alt="employeeShiftRosteringModelingGuideB">
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>In the following diagram, each row is a different example and shows the relationship in that example&#8217;s data model. For the <strong>N Queens</strong> example, the Queen entity has a Row planning variable, which stores objects of type <code>row</code>. Many Queens may point to one Row.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./DesignPatterns/entityVariableAndValueExamples.png" alt="entityVariableAndValueExamples">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Vehicle routing is different because it uses a <a href="#chainedPlanningVariable">chained planning variable</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="assigningTimeToPlanningEntities"><a class="anchor" href="#assigningTimeToPlanningEntities"></a><a class="link" href="#assigningTimeToPlanningEntities">20.3. Assigning time to planning entities</a></h3>
<div class="paragraph">
<p>Dealing with time and dates in planning problems may be problematic because it is dependent on the needs of your use case.</p>
</div>
<div class="paragraph">
<p>There are several representations of timestamps, dates, durations and periods in Java.
Choose the right representation type for your use case:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.util.Date</code> (deprecated): a slow, error-prone way to represent timestamps. Do not use.</p>
</li>
<li>
<p><code>java.time.LocalDateTime</code>, <code>LocalDate</code>, <code>DayOfWeek</code>, <code>Duration</code>, <code>Period</code>, &#8230;&#8203;: an accurate way to represent and calculate with timestamps, dates, &#8230;&#8203;</p>
<div class="ulist">
<ul>
<li>
<p>Supports timezones and DST (Daylight Saving Time).</p>
</li>
<li>
<p>Requires Java 8 or higher.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>int</code> or <code>long</code>: Caches a timestamp as a simplified number of coarse-grained time units (such as minutes) from the start of the global planning time window or the epoch.</p>
<div class="ulist">
<ul>
<li>
<p>For example: a <code>LocalDateTime</code> of <code>1-JAN 08:00:00</code> becomes an <code>int</code> of <code>400</code> minutes. Similarly <code>1-JAN 09:00:00</code> becomes <code>460</code> minutes.</p>
</li>
<li>
<p>It often represents an extra field in a class, alongside the <code>LocalDateTime</code> field from which it was calculated. The <code>LocalDateTime</code> is used for user visualization, but the <code>int</code> is used in the score constraints.</p>
</li>
<li>
<p>It is faster in calculations, which is especially useful in the TimeGrain pattern.</p>
</li>
<li>
<p>Do not use if timezones or DST affect the score constraints.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are also several designs for assigning a planning entity to a starting time (or date):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the starting time is fixed beforehand, it is not a planning variable (in that solver).</p>
<div class="ulist">
<ul>
<li>
<p>For example, in the <a href="#bedAllocation">hospital bed planning</a> example,
the arrival day of each patient is fixed beforehand.</p>
</li>
<li>
<p>This is common in <a href="#multiStagePlanning">multi stage planning</a>,
when the starting time has been decided already in an earlier planning stage.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If the starting time is not fixed, it is a planning variable (genuine or shadow).</p>
<div class="ulist">
<ul>
<li>
<p>If all planning entities have the same duration,
use the <a href="#timeslotPattern">Timeslot pattern</a>.</p>
<div class="ulist">
<ul>
<li>
<p>For example in course scheduling, all lectures take one hour. Therefore, each timeslot is one hour.</p>
</li>
<li>
<p>Even if the planning entities have different durations, but the same duration per type, it&#8217;s often appropriate.</p>
<div class="ulist">
<ul>
<li>
<p>For example in conference scheduling, breakout talks take one hour and lab talks take 2 hours.
But there&#8217;s an enumeration of the timeslots and each timeslot only accepts one talk type.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>If the duration differs and time is rounded to a specific time granularity (for example 5 minutes)
use the <a href="#timeGrainPattern">TimeGrain pattern</a>.</p>
<div class="ulist">
<ul>
<li>
<p>For example in meeting scheduling, all meetings start at 15 minute intervals. All meetings take 15, 30, 45, 60, 90 or 120 minutes.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If the duration differs and one task starts immediately after the previous task (assigned to the same executor) finishes,
use the <a href="#chainedThroughTimePattern">Chained Through Time pattern</a>.</p>
<div class="ulist">
<ul>
<li>
<p>For example in time windowed vehicle routing, each vehicle departs immediately to the next customer when the delivery for the previous customer finishes.</p>
</li>
<li>
<p>Even if the next task does not always start immediately, but the gap is deterministic, it applies.</p>
<div class="ulist">
<ul>
<li>
<p>For example in vehicle routing, each driver departs immediately to the next customer,
unless it&#8217;s the first departure after noon, in which case there&#8217;s first a 1 hour lunch.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>If the employees need to decide the order of theirs tasks per day, week or SCRUM sprint themselves,
use the <a href="#timeBucketPattern">Time Bucket pattern</a>.</p>
<div class="ulist">
<ul>
<li>
<p>For example in elevator maintenance scheduling, a mechanic gets up to 40 hours worth of tasks per week,
but there&#8217;s no point in ordering them within 1 week because there&#8217;s likely to be disruption from entrapments or other elevator outages.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Choose the right pattern depending on the use case:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./DesignPatterns/assigningTimeToPlanningEntities.png" alt="assigningTimeToPlanningEntities">
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./DesignPatterns/assigningTimeToPlanningEntities2.png" alt="assigningTimeToPlanningEntities2">
</div>
</div>
<div class="sect3">
<h4 id="timeslotPattern"><a class="anchor" href="#timeslotPattern"></a><a class="link" href="#timeslotPattern">20.3.1. Timeslot pattern:  assign to a fixed-length timeslot</a></h4>
<div class="paragraph">
<p>If all planning entities have <strong>the same duration</strong> (or can be inflated to the same duration), the Timeslot pattern is useful.
The planning entities are assigned to a timeslot rather than time.
For example in <a href="#curriculumCourse">course timetabling</a>, all lectures take one hour.</p>
</div>
<div class="paragraph">
<p>The timeslots can start at any time.
For example, the timeslots start at 8:00, 9:00, 10:15 (after a 15-minute break), 11:15, &#8230;&#8203; They can even overlap, but that is unusual.</p>
</div>
<div class="paragraph">
<p>It is also usable if all planning entities can be inflated to the same duration.
For example in <a href="#examination">exam timetabling</a>, some exams take 90 minutes and others 120 minutes, but all timeslots are 120 minutes.
When an exam of 90 minutes is assigned to a timeslot, for the remaining 30 minutes, its seats are occupied too and cannot be used by another exam.</p>
</div>
<div class="paragraph">
<p>Usually there is a second planning variable, for example the room.
In course timetabling, two lectures are in conflict if they share the same room at the same timeslot.
However, in exam timetabling, that is allowed, if there is enough seating capacity in the room (although mixed exam durations in the same room do inflict a soft score penalty).</p>
</div>
</div>
<div class="sect3">
<h4 id="timeGrainPattern"><a class="anchor" href="#timeGrainPattern"></a><a class="link" href="#timeGrainPattern">20.3.2. TimeGrain pattern: assign to a starting TimeGrain</a></h4>
<div class="paragraph">
<p>Assigning humans to start a meeting at four seconds after 9 o&#8217;clock is pointless because most human activities have a time granularity of five minutes or 15 minutes.
Therefore it is not necessary to allow a planning entity to be assigned subsecond, second or even one minute accuracy.
The five minute or 15 minutes accuracy suffices.
The TimeGrain pattern models such <strong>time accuracy</strong> by partitioning time as time grains.
For example in <a href="#meetingScheduling">meeting scheduling</a>, all meetings start/end in hour, half hour, or 15-minute intervals before or after each hour, therefore the optimal settings for time grains is 15 minutes.</p>
</div>
<div class="paragraph">
<p>Each planning entity is assigned to a start time grain.
The end time grain is calculated by adding the duration in grains to the starting time grain.
Overlap of two entities is determined by comparing their start and end time grains.</p>
</div>
<div class="paragraph">
<p>This pattern also works well with a coarser time granularity (such as days, half days, hours, &#8230;&#8203;).
With a finer time granularity (such as seconds, milliseconds, &#8230;&#8203;) and a long time window, the value range (and therefore <a href="#searchSpaceSize">the search space</a>) can become too high, which reduces efficiency and scalability.
However, such a solution is not impossible, as shown in <a href="#cheapTimeScheduling">cheap time scheduling</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="chainedThroughTimePattern"><a class="anchor" href="#chainedThroughTimePattern"></a><a class="link" href="#chainedThroughTimePattern">20.3.3. Chained through time pattern: assign in a chain that determines starting time</a></h4>
<div class="paragraph">
<p>If a person or a machine continuously works on <strong>one task at a time in sequence</strong>,
which means starting a task when the previous is finished (or with a deterministic delay), the Chained Through Time pattern is useful.
For example, in the vehicle routing with time windows example, a vehicle drives from customer to customer (thus it handles one customer at a time).</p>
</div>
<div class="paragraph">
<p>In this pattern, the planning entities are <a href="#chainedPlanningVariable">chained</a>.
The anchor determines the starting time of its first planning entity.
The second entity&#8217;s starting time is calculated based on the starting time and duration of the first entity.
For example, in task assignment, Beth (the anchor) starts working at 8:00, thus her first task starts at 8:00.
It lasts 52 mins, therefore her second task starts at 8:52.
The starting time of an entity is usually <a href="#shadowVariable">a shadow variable</a>.</p>
</div>
<div class="paragraph">
<p>An anchor has only one chain.
Although it is possible to split up the anchor into two separate anchors, for example split up Beth into Beth&#8217;s left hand and Beth&#8217;s right hand (because she can do two tasks at the same time), this model makes pooling resources difficult.
Consequently, using this model in the exam scheduling example to allow two or more exams to use the same room at the same time is problematic.</p>
</div>
<div class="paragraph">
<p>Between planning entities, there are three ways to create gaps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>No gaps: This is common when the anchor is a machine. For example, a build server always starts the next job when the previous finishes, without a break.</p>
</li>
<li>
<p>Only deterministic gaps: This is common for humans. For example, any task that crosses the 10:00 barrier gets an extra 15 minutes duration so the human can take a break.</p>
<div class="ulist">
<ul>
<li>
<p>A deterministic gap can be subjected to complex business logic. For example in vehicle routing, a cross-continent truck driver needs to rest 15 minutes after two hours of driving (which may also occur during loading or unloading time at a customer location) and also needs to rest 10 hours after 14 hours of work.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Planning variable gaps: This is uncommon, because that extra planning variable reduces efficiency and scalability,
(besides impacting the <a href="#searchSpaceSize">search space</a> too).</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="chainedThroughTimeAutomaticCollapse"><a class="anchor" href="#chainedThroughTimeAutomaticCollapse"></a><a class="link" href="#chainedThroughTimeAutomaticCollapse">20.3.3.1. Chained through time: automatic collapse</a></h5>
<div class="paragraph">
<p>In some use case there is an overhead time for certain tasks,
which can be shared by multiple tasks, of those are consecutively scheduled.
Basically, the solver receives a <em>discount</em> if it combines those tasks.</p>
</div>
<div class="paragraph">
<p>For example when delivering pizza to two different customers,
a food delivery service combines both deliveries into a single trip,
if those two customers ordered from the same restaurant around the same time and live in the same part of the city.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./DesignPatterns/chainedThroughTimeAutomaticCollapse.png" alt="chainedThroughTimeAutomaticCollapse">
</div>
</div>
<div class="paragraph">
<p>Implement the automatic collapse in the <a href="#customVariableListener">customer variable listener</a>
that calculates the start and end times of each task.</p>
</div>
</div>
<div class="sect4">
<h5 id="chainedThroughTimeAutomaticDelayUntilLast"><a class="anchor" href="#chainedThroughTimeAutomaticDelayUntilLast"></a><a class="link" href="#chainedThroughTimeAutomaticDelayUntilLast">20.3.3.2. Chained through time: automatic delay until last</a></h5>
<div class="paragraph">
<p>Some tasks require more than one person to execute.
In such cases, both employees need to be there at the same time,
before the work can start.</p>
</div>
<div class="paragraph">
<p>For example when assembling furniture, assembling a bed is a two-person job.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./DesignPatterns/chainedThroughTimeAutomaticDelayUntilLast.png" alt="chainedThroughTimeAutomaticDelayUntilLast">
</div>
</div>
<div class="paragraph">
<p>Implement the automatic delay in the <a href="#customVariableListener">customer variable listener</a>
that calculates the arrival, start and end times of each task.
<strong>Separate the arrival time from the start time.</strong>
Additionally, add loop detection to avoid an infinite loop:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./DesignPatterns/chainedThroughTimeAutomaticDelayUntilLastLoop.png" alt="chainedThroughTimeAutomaticDelayUntilLastLoop">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="timeBucketPattern"><a class="anchor" href="#timeBucketPattern"></a><a class="link" href="#timeBucketPattern">20.3.4. Time bucket pattern: assign to a capacitated bucket per time period</a></h4>
<div class="paragraph">
<p>In this pattern, the time of each employee is divided into <em>buckets</em>.
For example 1 bucket per week.
Each bucket has a capacity, depending on the FTE (Full Time Equivalent), holidays and the approved vacation of the employee.
For example, a bucket usually has 40 hours for a full time employee and 20 hours for a half time employee
but only 8 hours on a specific week if the employee takes vacation the rest of that week.</p>
</div>
<div class="paragraph">
<p>Each task is assigned to a bucket, which determines the employee and the coarse-grained time period for working on it.
<em>The tasks within one bucket are not ordered</em>: it&#8217;s up to the employee to decide the order.
This gives the employee more autonomy, but makes it harder to do certain optimization,
such as minimize travel time between task locations.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="multiStagePlanning"><a class="anchor" href="#multiStagePlanning"></a><a class="link" href="#multiStagePlanning">20.4. Multi-stage Planning</a></h3>
<div class="paragraph">
<p>For practical or organizational reasons (such as Conway&#8217;s law), complex planning problems are often broken down in multiple stages.
A typical example is train scheduling, where one department decides where and when a train will arrive or depart, and another department assigns the operators to the actual train cars/locomotives.</p>
</div>
<div class="paragraph">
<p>Each stage has its own solver configuration (and therefore its own <code>SolverFactory</code>). Do not confuse it with <a href="#solverPhase">multi-phase solving</a> which uses a one-solver configuration.</p>
</div>
<div class="paragraph">
<p>Similarly to <a href="#partitionedSearch">Partitioned Search</a>, multi-stage planning leads to suboptimal results.
Nevertheless, it may be beneficial in order to simplify the maintenance, ownership, and help to start a project.</p>
</div>
</div>
<div class="sect2">
<h3 id="cloudArchitecturePatterns"><a class="anchor" href="#cloudArchitecturePatterns"></a><a class="link" href="#cloudArchitecturePatterns">20.5. Cloud architecture patterns</a></h3>
<div class="paragraph">
<p>There are two common usage patterns of OptaPlanner in the cloud:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Batch planning</strong>:
Typically runs at night for hours to solve each tenant&#8217;s dataset
and deliver each schedule for the upcoming day(s) or week(s).
Only the final best solution is sent back to the client.
This is a good fit for a serverless cloud architecture.</p>
</li>
<li>
<p><strong>Real-time planning</strong>:
Typically runs during the day,
to handle unexpected problem changes as they occur in real-time
and sends best solutions as they are discovered to the client.</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./DesignPatterns/serverlessCloudArchitecture.png" alt="serverlessCloudArchitecture">
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./DesignPatterns/realTimePlanningCloudArchitecture.png" alt="realTimePlanningCloudArchitecture">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="development"><a class="anchor" href="#development"></a><a class="link" href="#development">21. Development</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="methodologyOverview"><a class="anchor" href="#methodologyOverview"></a><a class="link" href="#methodologyOverview">21.1. Methodology overview</a></h3>
<div class="paragraph">
<p>The diagram below explains the overall structure of the OptaPlanner source code:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./Development/methodologyOverview.png" alt="methodologyOverview">
</div>
</div>
<div class="paragraph">
<p>In the diagram above, it&#8217;s important to understand the clear separation between the configuration and runtime classes.</p>
</div>
<div class="paragraph">
<p>The development philosophy includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Reuse</strong>: The examples are reused as integration tests, stress tests and demos. The documentation images are reused as slides.</p>
</li>
<li>
<p><strong>Consistent terminology</strong>: Each example has a class <code>App</code> (executable class) and <code>Panel</code> (swing UI).</p>
</li>
<li>
<p><strong>Consistent structure</strong>: Each example has the same packages: <code>domain</code>, <code>persistence</code>, <code>app</code>, <code>solver</code> and <code>swingui</code>.</p>
</li>
<li>
<p><strong>Real world usefulness</strong>: Every feature is used in an example. Most examples are real world use cases with real world constraints, often with real world data.</p>
</li>
<li>
<p><strong>Automated testing</strong>: There are unit tests, integration tests, performance regressions tests and stress tests. The test coverage is high.</p>
</li>
<li>
<p><strong>Fail fast with an understandable error message</strong>: Invalid states are checked as early as possible.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="developmentGuidelines"><a class="anchor" href="#developmentGuidelines"></a><a class="link" href="#developmentGuidelines">21.2. Development guidelines</a></h3>
<div class="sect3">
<h4 id="_fail_fast"><a class="anchor" href="#_fail_fast"></a><a class="link" href="#_fail_fast">21.2.1. Fail fast</a></h4>
<div class="paragraph">
<p>There are several levels of fail fast, from better to worse:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Fail Fast at compile time</strong>. For example: Don&#8217;t accept an <code>Object</code> as a parameter if it needs to be a <code>String</code> or an <code>Integer</code>.</p>
</li>
<li>
<p><strong>Fail Fast at startup time</strong>. For example: if the configuration parameter needs to be a positive <code>int</code> and it&#8217;s negative, fail fast</p>
</li>
<li>
<p><strong>Fail Fast at runtime</strong>. For example: if the request needs to contain a double between <code>0.0</code> and <code>1.0</code> and it&#8217;s bigger than <code>1.0</code>, fail fast.</p>
</li>
<li>
<p><strong>Fail Fast at runtime in assertion mode</strong> if the detection performance cost is high. For example: If, after every low level iteration, the variable A needs to be equal to the square root of B, check it if and only if an assert flag is set to true (usually controlled by the <a href="#environmentMode">EnvironmentMode</a>).</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_exception_messages"><a class="anchor" href="#_exception_messages"></a><a class="link" href="#_exception_messages">21.2.2. Exception messages</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>Exception</code> message must include the name and state of each relevant variable. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">if (fooSize &lt; 0) {
    throw new IllegalArgumentException("The fooSize (" + fooSize + ") of bar (" + this + ") must be positive.");
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the output clearly explains what&#8217;s wrong:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">Exception in thread "main" java.lang.IllegalArgumentException: The fooSize (-5) of bar (myBar) must be positive.
    at ...</code></pre>
</div>
</div>
</li>
<li>
<p>Whenever possible, the <code>Exception</code> message must include context.</p>
</li>
<li>
<p>Whenever the fix is not obvious, the <code>Exception</code> message should include advice. Advice normally starts with the word <em>maybe</em> on a new line:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code data-lang="java" class="language-java hljs">Exception in thread "main" java.lang.IllegalStateException: The valueRangeDescriptor (fooRange) is nullable, but not countable (false).
Maybe the member (getFooRange) should return CountableValueRange.
    at ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The word <em>maybe</em> is to indicate that the advice is not guaranteed to be right in all cases.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_generics"><a class="anchor" href="#_generics"></a><a class="link" href="#_generics">21.2.3. Generics</a></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>@PlanningSolution</code> class is often passed as a generic type parameter to subsystems.</p>
</li>
<li>
<p>The <code>@PlanningEntity</code> class(es) are rarely passed as a generic type parameter because there could be multiple planning entities.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_lifecycle"><a class="anchor" href="#_lifecycle"></a><a class="link" href="#_lifecycle">21.2.4. Lifecycle</a></h4>
<div class="paragraph">
<p>One of the biggest challenges in multi-algorithm implementations (such as OptaPlanner)
is the lifecycle management of internal subsystems.
These guidelines avoid lifecycle complexity:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The subsystems are called in the same order in <code>*Started()</code> and <code>*Ended</code> methods.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>This avoids cyclic subsystem dependencies.</p>
</li>
</ol>
</div>
</li>
<li>
<p>The <code>*Scope</code> class&#8217;s fields are filled in piecemeal by the subsystems
as the algorithms discover more information about its current scope subject.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Therefore, a <code>*Scope</code> has mutable fields. It&#8217;s not an <code>Event</code>.</p>
</li>
<li>
<p>A subsystem can only depend on scope information provided by an earlier subsystem.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Global variables are sorted:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>First by volatility</p>
</li>
<li>
<p>Then by initialization time</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-06-29 08:55:07 +0200
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
<!-- Collapsed Table of Content -->
<script src="website/jquery/jquery.min.js"></script>
<script src="website/jstree/jstree.min.js"></script>
<script src="website/toc.js"></script>

<!-- Adobe Analytics for Red Hat - DPAL (DTM Property Auto-Loader) - part 2/2 -->
<script type="text/javascript">
    if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
        _satellite.pageBottom();
    }
</script>
</body>
</html>